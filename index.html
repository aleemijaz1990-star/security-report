<!DOCTYPE HTML SYSTEM>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>Security Report</title>
  <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
  <script type="text/javascript" src="https://cdn.datatables.net/1.10.9/js/jquery.dataTables.min.js"></script>
  <script type="text/javascript">
    function toggle(context) {
      var elem = document.getElementById(context);

      if (elem.style.display != "block") {
        elem.style.display = "block";

        elem.querySelectorAll("table").forEach(function(table) {
          $(table).DataTable().columns.adjust();
        });
      } else {
        elem.style.display = "none";
      }

      elem.parentNode.scrollIntoView();
    }

    $(document).ready(function() {
      $('table').DataTable({
        searching: false,
        paging:    false,
        info:      false
      });
    });
  </script>
  <style>
    /* CSS style used for HTML reports */

body {
  font-family: sans-serif;
  color: #161616;
}

a {
  color: #161616;
}

p {
  font-weight: bold;
  font-size: 11pt;
  color: #2D0200;
 }

 th {
   background-color: #980905;
   border-bottom: 5px solid #530200;
   color: white;
   font-size: 11pt;
   padding: 1px 8px 1px 8px;
 }

 td {
   border-bottom: 2px solid white;
   font-family: monospace;
   padding: 5px 8px 1px 8px;
 }

 table {
   background-color: #FCF4D4;
   border-collapse: collapse;
 }

 h1 {
   color: #2D0200;
   font-size: 14pt;
 }

 h2 {
   color: #2D0200;
   font-size: 12pt;
 }

 span.high-confidence {
   font-weight:bold;
   color: red;
 }

 span.med-confidence {
 }

 span.weak-confidence {
   color:gray;
 }

 div.warning_message {
   cursor: pointer;
 }

 div.warning_message:hover {
   background-color: white;
 }

 table caption {
   background-color: #FFE;
   padding: 2px;
 }

 table.context {
   margin-top: 5px;
   margin-bottom: 5px;
   border-left: 1px solid #90e960;
   color: #212121;
 }

 tr.context {
   background-color: white;
 }

 tr.first {
   border-top: 1px solid #7ecc54;
   padding-top: 2px;
 }

 tr.error {
  background-color: #f4c1c1 !important
 }

 tr.near_error {
  background-color: #f4d4d4 !important
 }

 tr.alt {
   background-color: #e8f4d4;
 }

 td.context {
   padding: 2px 10px 0px 6px;
   border-bottom: none;
 }

 td.context_line {
   padding: 2px 8px 0px 7px;
   border-right: 1px solid #b3bda4;
   border-bottom: none;
   color: #6e7465;
 }

 pre.context {
   margin-bottom: 1px;
 }

 .user_input {
   background-color: #fcecab;
 }

 div.render_path {
   display: none;
   background-color: #ffe;
   padding: 5px;
   margin: 2px 0px 2px 0px;
 }

 div.template_name {
   cursor: pointer;
 }

 div.template_name:hover {
   background-color: white;
 }

 span.code {
   font-family: monospace;
 }

 span.filename {
   font-family: monospace;
 }

  </style>
</head>
<body>

<h1>Brakeman Report</h1>
<table>
  <thead>
    <tr>
      <th>Application Path</th>
      <th>Rails Version</th>
      <th>Brakeman Version</th>
      <th>Report Time</th>
      <th>Checks Performed</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>/Users/muhammadaleem/Documents/projects/new_project/rws</td>
      <td>7.1.3.4</td>
      <td>7.1.1</td>
      <td>
        2025-11-25 18:08:06 +0500<br><br>
        6.139593 seconds
      </td>
      <td>BasicAuth, BasicAuthTimingAttack, CSRFTokenForgeryCVE, ContentTag, CookieSerialization, CreateWith, CrossSiteScripting, DefaultRoutes, Deserialize, DetailedExceptions, DigestDoS, DynamicFinders, EOLRails, EOLRuby, EscapeFunction, Evaluation, Execute, FileAccess, FileDisclosure, FilterSkipping, ForgerySetting, HeaderDoS, I18nXSS, JRubyXML, JSONEncoding, JSONEntityEscape, JSONParsing, LinkTo, LinkToHref, MailTo, MassAssignment, MimeTypeDoS, ModelAttrAccessible, ModelAttributes, ModelSerialize, NestedAttributes, NestedAttributesBypass, NumberToCurrency, PageCachingCVE, Pathname, PermitAttributes, QuoteTableName, Ransack, Redirect, RegexDoS, Render, RenderDoS, RenderInline, ResponseSplitting, RouteDoS, SQL, SQLCVEs, SSLVerify, SafeBufferManipulation, SanitizeConfigCve, SanitizeMethods, SelectTag, SelectVulnerability, Send, SendFile, SessionManipulation, SessionSettings, SimpleFormat, SingleQuotes, SkipBeforeFilter, SprocketsPathTraversal, StripTags, SymbolDoSCVE, TemplateInjection, TranslateBug, UnsafeReflection, UnsafeReflectionMethods, ValidationRegex, VerbConfusion, WeakRSAKey, WithoutProtection, XMLDoS, YAMLParsing</td>
    </tr>
  </tbody>
</table>
<br>
<h2 id='summary'>Summary</h2>
<table>
  <thead>
    <tr>
      <th>Scanned/Reported</th>
      <th>Total</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Controllers</td>
      <td>39</td>
    </tr>
    <tr>
      <td>Models</td>
      <td>112</td>
    </tr>
    <tr>
      <td>Templates</td>
      <td>9</td>
    </tr>
    <tr>
      <td>Errors</td>
      <td>0</td>
    </tr>
    <tr>
      <td>Security Warnings</td>
      <td>162 <span class='high-confidence'>(63)</span></td>
    </tr>
  
    <tr>
      <td>Ignored Warnings</td>
      <td>0</td>
    </tr>
  
  </tbody>
</table>
<br>
<table>
  <thead>
    <tr>
      <th>Warning Type</th>
      <th>Total</th>
    </tr>
  </thead>
  <tbody>
  
    <tr>
      <td>Command Injection</td>
      <td>2</td>
    </tr>
  
    <tr>
      <td>Dangerous Eval</td>
      <td>10</td>
    </tr>
  
    <tr>
      <td>Dynamic Render Path</td>
      <td>1</td>
    </tr>
  
    <tr>
      <td>File Access</td>
      <td>2</td>
    </tr>
  
    <tr>
      <td>Redirect</td>
      <td>2</td>
    </tr>
  
    <tr>
      <td>Remote Code Execution</td>
      <td>2</td>
    </tr>
  
    <tr>
      <td>SQL Injection</td>
      <td>142</td>
    </tr>
  
    <tr>
      <td>Unmaintained Dependency</td>
      <td>1</td>
    </tr>
  
  </tbody>
</table>
<br>
<h2>Security Warnings</h2>  
<table>
  <thead>
    <tr>
      <th>Confidence</th>
      <th>Class</th>
      <th>Method</th>
      <th>Warning Type</th>
      <th>CWE ID</th>
      <th>Message</th>
    </tr>
  </thead>
  <tbody>
  
    <tr>
      <td><span class='high-confidence'>High</span></td>
      <td>Api::MediaBuyController</td>
      <td>generate_list_url</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/command_injection/">Command Injection</a></td>
      <td>[77]</td>
      <td><div class='warning_message' onClick="toggle('context12');toggle('message12');toggle('full_message12')" ><span id='message12' style='display:block'>Possible command injection near line 213: ...</span><span id='full_message12' style='display:none'>Possible command injection near line 213: <span class="code">`cat #{&quot;#{generate_pull_file(cid, mid, smr, true, <span class="user_input">Client.find(cid).nickname</span>)}&quot;} &gt; #{&quot;log/mb_#{ids.split(&quot;,&quot;).first}_to_#{ids.split(&quot;,&quot;).last}_#{smr ? (&quot;sl&quot;) : (&quot;fl&quot;)}_#{DateTime.now.strftime(&quot;%Y%m%d%H%M%S&quot;)}&quot;}.csv`</span></span><table id='context12' class='context' style='display:none'><caption>app/controllers/api/media_buy_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>208</pre>
          </td>
          <td class='context'>
            <pre class='context'>		end</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>209</pre>
            </td>
            <td class='context'>
              <pre class='context'>		# if more than one file, combine all into an archive</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>210</pre>
            </td>
            <td class='context'>
              <pre class='context'>		if fs.length &gt; 1</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>211</pre>
            </td>
            <td class='context'>
              <pre class='context'>			ip = ids.split(&quot;,&quot;)</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>212</pre>
            </td>
            <td class='context'>
              <pre class='context'>			fn = &quot;log/mb_#{ip.first}_to_#{ip.last}_#{smr ? &#39;sl&#39; : &#39;fl&#39;}_#{DateTime.now.strftime(&#39;%Y%m%d%H%M%S&#39;)}&quot;</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>213</pre>
            </td>
            <td class='context'>
              <pre class='context'>			`cat #{fs.join(&#39; &#39;)} &gt; #{fn}.csv`</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>214</pre>
            </td>
            <td class='context'>
              <pre class='context'>			fs.each { |f| File.delete f }</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>215</pre>
            </td>
            <td class='context'>
              <pre class='context'>			`zip #{fn}.zip #{fn}.csv`</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>216</pre>
            </td>
            <td class='context'>
              <pre class='context'>			File.delete &quot;#{fn}.csv&quot;</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>217</pre>
            </td>
            <td class='context'>
              <pre class='context'>			fn += &quot;.zip&quot;</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>218</pre>
            </td>
            <td class='context'>
              <pre class='context'>			ct = &quot;application/zip&quot;</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='high-confidence'>High</span></td>
      <td>Api::NudgeController</td>
      <td>nudge_preview</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/dangerous_eval/">Dangerous Eval</a></td>
      <td>[913, 95]</td>
      <td><div class='warning_message' onClick="toggle('context2');toggle('message2');toggle('full_message2')" ><span id='message2' style='display:block'>Model attribute evaluated as code near line 302: ...</span><span id='full_message2' style='display:none'>Model attribute evaluated as code near line 302: <span class="code">eval(&quot;\&quot;#{calculate_annual_reach(@authorized_user.authorized_client(params[:client_id], [&quot;Administrator&quot;, &quot;User&quot;, &quot;Engagement&quot;]).query_types.find_by(:id =&gt; <span class="user_input">TouchStep.find_by(:id =&gt; params[:touch_step_id]).nudge</span>.query_type_id).target_query)}\&quot;&quot;)</span></span><table id='context2' class='context' style='display:none'><caption>app/controllers/api/nudge_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>297</pre>
          </td>
          <td class='context'>
            <pre class='context'>				start_date = nudge.start_date ? nudge.start_date.strftime(&#39;%Y-%m-%d&#39;) : Date.today().strftime(&#39;%Y-%m-%d&#39;)</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>298</pre>
            </td>
            <td class='context'>
              <pre class='context'>				tq = query_type.target_query</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>299</pre>
            </td>
            <td class='context'>
              <pre class='context'>				total_count = 0</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>300</pre>
            </td>
            <td class='context'>
              <pre class='context'>				if nn =~ /^patientwellness/</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>301</pre>
            </td>
            <td class='context'>
              <pre class='context'>					annual_query = calculate_annual_reach(tq)</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>302</pre>
            </td>
            <td class='context'>
              <pre class='context'>					annual_query = eval(&quot;\&quot;#{annual_query}\&quot;&quot;)</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>303</pre>
            </td>
            <td class='context'>
              <pre class='context'>					total_count = ActiveRecord::Base.connection.execute(annual_query).first[&#39;annual_count&#39;]</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>304</pre>
            </td>
            <td class='context'>
              <pre class='context'>				end</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>305</pre>
            </td>
            <td class='context'>
              <pre class='context'>				tq.gsub!(&#39;current_date&#39;, &#39;(current_date + 1)&#39;) if tq</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>306</pre>
            </td>
            <td class='context'>
              <pre class='context'>				query = eval(&quot;\&quot;#{tq}\&quot;&quot;)</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>307</pre>
            </td>
            <td class='context'>
              <pre class='context'>				target_patients = ActiveRecord::Base.connection.execute(query).to_a if query.present?</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='high-confidence'>High</span></td>
      <td>Api::NudgeController</td>
      <td>nudge_preview</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/dangerous_eval/">Dangerous Eval</a></td>
      <td>[913, 95]</td>
      <td><div class='warning_message' onClick="toggle('context3');toggle('message3');toggle('full_message3')" ><span id='message3' style='display:block'>Model attribute evaluated as code near line 306: ...</span><span id='full_message3' style='display:none'>Model attribute evaluated as code near line 306: <span class="code">eval(&quot;\&quot;#{@authorized_user.authorized_client(params[:client_id], [&quot;Administrator&quot;, &quot;User&quot;, &quot;Engagement&quot;]).query_types.find_by(:id =&gt; <span class="user_input">TouchStep.find_by(:id =&gt; params[:touch_step_id]).nudge</span>.query_type_id).target_query}\&quot;&quot;)</span></span><table id='context3' class='context' style='display:none'><caption>app/controllers/api/nudge_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>301</pre>
          </td>
          <td class='context'>
            <pre class='context'>					annual_query = calculate_annual_reach(tq)</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>302</pre>
            </td>
            <td class='context'>
              <pre class='context'>					annual_query = eval(&quot;\&quot;#{annual_query}\&quot;&quot;)</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>303</pre>
            </td>
            <td class='context'>
              <pre class='context'>					total_count = ActiveRecord::Base.connection.execute(annual_query).first[&#39;annual_count&#39;]</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>304</pre>
            </td>
            <td class='context'>
              <pre class='context'>				end</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>305</pre>
            </td>
            <td class='context'>
              <pre class='context'>				tq.gsub!(&#39;current_date&#39;, &#39;(current_date + 1)&#39;) if tq</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>306</pre>
            </td>
            <td class='context'>
              <pre class='context'>				query = eval(&quot;\&quot;#{tq}\&quot;&quot;)</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>307</pre>
            </td>
            <td class='context'>
              <pre class='context'>				target_patients = ActiveRecord::Base.connection.execute(query).to_a if query.present?</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>308</pre>
            </td>
            <td class='context'>
              <pre class='context'>				target_patients = target_patients.map do |ni|</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>309</pre>
            </td>
            <td class='context'>
              <pre class='context'>					if ni[&#39;appt_name&#39;]</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>310</pre>
            </td>
            <td class='context'>
              <pre class='context'>						instruc_url = {</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>311</pre>
            </td>
            <td class='context'>
              <pre class='context'>														&#39;Colon&#39; =&gt; &#39;https://tannerclinic.com/wp-content/uploads/Colon-Prep-Instructions-3-12-25-pdf.pdf&#39;,</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='high-confidence'>High</span></td>
      <td>Api::NudgeController</td>
      <td>nudge_missing_fields</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/dangerous_eval/">Dangerous Eval</a></td>
      <td>[913, 95]</td>
      <td><div class='warning_message' onClick="toggle('context4');toggle('message4');toggle('full_message4')" ><span id='message4' style='display:block'>Model attribute evaluated as code near line 359: ...</span><span id='full_message4' style='display:none'>Model attribute evaluated as code near line 359: <span class="code">eval(&quot;\&quot;#{fetch_annual_patients(@authorized_user.authorized_client(params[:client_id], [&quot;Administrator&quot;, &quot;User&quot;, &quot;Engagement&quot;]).query_types.find_by(:id =&gt; <span class="user_input">TouchStep.find_by(:id =&gt; params[:touch_step_id]).nudge</span>.query_type_id).target_query)}\&quot;&quot;)</span></span><table id='context4' class='context' style='display:none'><caption>app/controllers/api/nudge_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>354</pre>
          </td>
          <td class='context'>
            <pre class='context'>				start_date = nudge.start_date ? nudge.start_date.strftime(&#39;%Y-%m-%d&#39;) : Date.today().strftime(&#39;%Y-%m-%d&#39;)</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>355</pre>
            </td>
            <td class='context'>
              <pre class='context'>				tq = query_type.target_query</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>356</pre>
            </td>
            <td class='context'>
              <pre class='context'>				total_count = 0</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>357</pre>
            </td>
            <td class='context'>
              <pre class='context'>				if nn =~ /^patientwellness/</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>358</pre>
            </td>
            <td class='context'>
              <pre class='context'>					annual_query = fetch_annual_patients(tq)</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>359</pre>
            </td>
            <td class='context'>
              <pre class='context'>					annual_query = eval(&quot;\&quot;#{annual_query}\&quot;&quot;)</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>360</pre>
            </td>
            <td class='context'>
              <pre class='context'>					target_patients = ActiveRecord::Base.connection.execute(annual_query).to_a</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>361</pre>
            </td>
            <td class='context'>
              <pre class='context'>				end</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>363</pre>
            </td>
            <td class='context'>
              <pre class='context'>				prepared_patients = target_patients.map do |ni|</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>364</pre>
            </td>
            <td class='context'>
              <pre class='context'>					if ni[&#39;appt_name&#39;]</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='high-confidence'>High</span></td>
      <td>Api::MediaBuyController</td>
      <td>generate_list_url</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/file_access/">File Access</a></td>
      <td>[22]</td>
      <td><div class='warning_message' onClick="toggle('context14');toggle('message14');toggle('full_message14')" ><span id='message14' style='display:block'>Model attribute used in file name near line 224: ...</span><span id='full_message14' style='display:none'>Model attribute used in file name near line 224: <span class="code">File.read((&quot;./&quot; + (generate_pull_file(cid, mid, smr, true, <span class="user_input">Client.find(cid).nickname</span>) or (&quot;log/mb_#{ids.split(&quot;,&quot;).first}_to_#{ids.split(&quot;,&quot;).last}_#{smr ? (&quot;sl&quot;) : (&quot;fl&quot;)}_#{DateTime.now.strftime(&quot;%Y%m%d%H%M%S&quot;)}&quot; + &quot;.zip&quot;))))</span></span><table id='context14' class='context' style='display:none'><caption>app/controllers/api/media_buy_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>219</pre>
          </td>
          <td class='context'>
            <pre class='context'>		end</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>220</pre>
            </td>
            <td class='context'>
              <pre class='context'>		# upload the individual file or archive and return the presigned url</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>221</pre>
            </td>
            <td class='context'>
              <pre class='context'>		ky = &quot;#{Rails.env}/#{nn}/#{Time.now.year}/#{fn}&quot;</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>222</pre>
            </td>
            <td class='context'>
              <pre class='context'>		crd = Rails.application.credentials.aws</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>223</pre>
            </td>
            <td class='context'>
              <pre class='context'>		s3 = Aws::S3::Client.new :access_key_id =&gt; crd[:access_key_id], :secret_access_key =&gt; crd[:secret_access_key], :region =&gt; crd[:region]</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>224</pre>
            </td>
            <td class='context'>
              <pre class='context'>		s3.put_object :bucket =&gt; &quot;relevant-names&quot;, :key =&gt; ky, :body =&gt; File.read(&quot;./&quot; + fn), :acl =&gt; &#39;private&#39;, :content_type =&gt; ct</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>225</pre>
            </td>
            <td class='context'>
              <pre class='context'>		File.delete fn</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>226</pre>
            </td>
            <td class='context'>
              <pre class='context'>		ps = Aws::S3::Presigner.new :client =&gt; s3</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>227</pre>
            </td>
            <td class='context'>
              <pre class='context'>		ps.presigned_url :get_object, :bucket =&gt; &quot;relevant-names&quot;, :key =&gt; ky, :expires_in =&gt; 300</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>228</pre>
            </td>
            <td class='context'>
              <pre class='context'>	end</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='high-confidence'>High</span></td>
      <td>ReviewController</td>
      <td>index</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/redirect/">Redirect</a></td>
      <td>[601]</td>
      <td><div class='warning_message' onClick="toggle('context16');toggle('message16');toggle('full_message16')" >Possible unprotected redirect near line 19: <span class="code">redirect_to(&quot;https://search.google.com/local/writereview?placeid=#{<span class="user_input">Office.find(MessageOutDetail.find_by_uid(params[:id].gsub(/[^0-9a-z]/, &quot;&quot;)).office_id).g_place_id</span>}&quot;)</span><table id='context16' class='context' style='display:none'><caption>app/controllers/review_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>14</pre>
          </td>
          <td class='context'>
            <pre class='context'>			mor = MessageOutReview.create(message_out_detail_id: mod.id)</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>15</pre>
            </td>
            <td class='context'>
              <pre class='context'>			pl = Office.find(mod.office_id).g_place_id</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>16</pre>
            </td>
            <td class='context'>
              <pre class='context'>			rd = &quot;https://search.google.com/local/writereview?placeid=#{pl}&quot; unless pl.blank?</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>17</pre>
            </td>
            <td class='context'>
              <pre class='context'>		end</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>18</pre>
            </td>
            <td class='context'>
              <pre class='context'>		if rd</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>19</pre>
            </td>
            <td class='context'>
              <pre class='context'>			redirect_to rd</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>20</pre>
            </td>
            <td class='context'>
              <pre class='context'>		else</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>21</pre>
            </td>
            <td class='context'>
              <pre class='context'>			render &quot;/application/reviews/error&quot;</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>22</pre>
            </td>
            <td class='context'>
              <pre class='context'>		end</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>23</pre>
            </td>
            <td class='context'>
              <pre class='context'>	end</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>24</pre>
            </td>
            <td class='context'>
              <pre class='context'>end</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='high-confidence'>High</span></td>
      <td>ShortUrlController</td>
      <td>redirect</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/redirect/">Redirect</a></td>
      <td>[601]</td>
      <td><div class='warning_message' onClick="toggle('context17');toggle('message17');toggle('full_message17')" >Possible unprotected redirect near line 17: <span class="code">redirect_to(<span class="user_input">ShortUrl.where(:code =&gt; Sanitize.alpha_numeric(params[:code]).upcase).order(:updated_at =&gt; :desc).first.fwd_to</span>)</span><table id='context17' class='context' style='display:none'><caption>app/controllers/short_url_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>12</pre>
          </td>
          <td class='context'>
            <pre class='context'>		short_url = ShortUrl.where(code: code).order(updated_at: :desc).first</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>13</pre>
            </td>
            <td class='context'>
              <pre class='context'>		if short_url.nil? || Time.now &gt; short_url.created_at + 20.days</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>14</pre>
            </td>
            <td class='context'>
              <pre class='context'>			ErrorLog.create(client_id: 0, endpoint: &quot;short_url/redirect&quot;, details: &quot;An invalid or expired redirect code was used: #{code}&quot;, backtrace: &quot;&quot;)</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>15</pre>
            </td>
            <td class='context'>
              <pre class='context'>			render &#39;application/short_urls/expired&#39;</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>16</pre>
            </td>
            <td class='context'>
              <pre class='context'>		else</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>17</pre>
            </td>
            <td class='context'>
              <pre class='context'>			redirect_to short_url.fwd_to</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>18</pre>
            </td>
            <td class='context'>
              <pre class='context'>		end</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>19</pre>
            </td>
            <td class='context'>
              <pre class='context'>	end</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>20</pre>
            </td>
            <td class='context'>
              <pre class='context'>end</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='high-confidence'>High</span></td>
      <td>SurveyController</td>
      <td>index</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/remote_code_execution/">Remote Code Execution</a></td>
      <td>[470]</td>
      <td><div class='warning_message' onClick="toggle('context161');toggle('message161');toggle('full_message161')" >Unsafe reflection method <span class="code">constantize</span> called on parameter value near line 17: <span class="code"><span class="user_input">params[:t_type].camelize</span>.constantize</span><table id='context161' class='context' style='display:none'><caption>app/controllers/survey_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>12</pre>
          </td>
          <td class='context'>
            <pre class='context'>		trigger_type = params[:t_type].camelize</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>13</pre>
            </td>
            <td class='context'>
              <pre class='context'>		begin</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>14</pre>
            </td>
            <td class='context'>
              <pre class='context'>			@survey = Survey.find(params[:s_id])</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>15</pre>
            </td>
            <td class='context'>
              <pre class='context'>			@questions = @survey.survey_questions.order(:position)</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>16</pre>
            </td>
            <td class='context'>
              <pre class='context'>			if (trigger_type != &quot;Preview&quot;)</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>17</pre>
            </td>
            <td class='context'>
              <pre class='context'>				trigger = trigger_type.constantize.find_by_uuid(trigger_id)</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>18</pre>
            </td>
            <td class='context'>
              <pre class='context'>				@patient_name = trigger.patient.f_name + &quot; &quot; + trigger.patient.l_name</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>19</pre>
            </td>
            <td class='context'>
              <pre class='context'>				@event_date = trigger.event_date.strftime(&quot;%B %-e, %Y&quot;)</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>20</pre>
            </td>
            <td class='context'>
              <pre class='context'>			else</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>21</pre>
            </td>
            <td class='context'>
              <pre class='context'>				@event_date = &quot;[[Event Date]]&quot;</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>22</pre>
            </td>
            <td class='context'>
              <pre class='context'>				@patient_name = &quot;[[Patient&#39;s Name]]&quot;</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='high-confidence'>High</span></td>
      <td>Api::AutoReplyController</td>
      <td>index</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context121');toggle('message121');toggle('full_message121')" ><span id='message121' style='display:block'>Possible SQL injection near line 14: ...</span><span id='full_message121' style='display:none'>Possible SQL injection near line 14: <span class="code">AutoReplyText.where(:client_id =&gt; @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;User&quot;, &quot;Engagement&quot;]).id).where((&quot;office_id in (#{get_data_filters(@authorized_user, @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;User&quot;, &quot;Engagement&quot;]).id)})&quot; or &quot;&quot;))</span></span><table id='context121' class='context' style='display:none'><caption>app/controllers/api/auto_reply_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>9</pre>
          </td>
          <td class='context'>
            <pre class='context'>	def index</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>10</pre>
            </td>
            <td class='context'>
              <pre class='context'>		client = @authorized_user&amp;.authorized_client(params[:client_id], [&quot;Administrator&quot;, &quot;User&quot;, &quot;Engagement&quot;])</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>11</pre>
            </td>
            <td class='context'>
              <pre class='context'>		if client</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>12</pre>
            </td>
            <td class='context'>
              <pre class='context'>			df = get_data_filters(@authorized_user, client.id)</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>13</pre>
            </td>
            <td class='context'>
              <pre class='context'>			ws = df.length &gt; 0 ? &quot;office_id in (#{df})&quot; : &quot;&quot;</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>14</pre>
            </td>
            <td class='context'>
              <pre class='context'>			ars = AutoReplyText.where(client_id: client.id).where(ws).order(&quot;start_at&quot;) rescue nil</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>15</pre>
            </td>
            <td class='context'>
              <pre class='context'>			data = []</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>16</pre>
            </td>
            <td class='context'>
              <pre class='context'>			ars.each do |ar|</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>17</pre>
            </td>
            <td class='context'>
              <pre class='context'>				data.push(json_ar_with_office(ar))</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>18</pre>
            </td>
            <td class='context'>
              <pre class='context'>			end</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>19</pre>
            </td>
            <td class='context'>
              <pre class='context'>			render :json =&gt; {status: &quot;success&quot;, data: data}</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='high-confidence'>High</span></td>
      <td>Api::DashboardController</td>
      <td>update_datetime</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context19');toggle('message19');toggle('full_message19')" ><span id='message19' style='display:block'>Possible SQL injection near line 454: ...</span><span id='full_message19' style='display:none'>Possible SQL injection near line 454: <span class="code">General.find_by_sql([&quot;with gs as (\n\t#{generate_series((((((nil or 6) or 13) or &quot;YTD&quot;) or &quot;ALL&quot;) or <span class="user_input">params[:date_range]</span>))}\n)\nselect array[(month + interval &#39;1 day&#39;)::date::text, coalesce(sum(#{params[:column_selected]}), 0)::text] as #{params[:column_selected]} #{(&quot;, office&quot; or &quot;&quot;)}\nfrom (\n\tselect gs.month as month, mv.name as title, o.name as office, count(distinct mod_individual) as patients_messaged, count(distinct app_pt) as scheduled_appts, count(distinct app_pt) filter (where true #{Client.find(params[:client_id]).preferences.find_by_key(:ar_cond_completed_appt).value}) as completed_appts, count(distinct purch_pt) as patients_who_purchased, count(distinct purch_pt) filter (where returned_at is not null) as returned_purchase, coalesce(sum(price) filter (where returned_at is null)::integer, 0) as total_revenue\n\tfrom (select * from offices where client_id = :cid and active = &#39;t&#39; #{(&quot;and id in (#{params[:fc_ids]})&quot; or &quot;&quot;)}) o\n\tjoin gs on true\n\tleft join (select * from mv_ngdash_results mv\n\t\t#{if JSON.parse(params[:nudge]) then   &quot;join (select id, name from nudges where id = #{JSON.parse(params[:nudge])[&quot;id&quot;] if JSON.parse(params[:nudge])}) n on n.name = mv.nudge_name&quot; else   &quot;join (select id, name from query_types where nickname = :nickname) qt on qt.id = mv.query_type_id&quot; end}\n\t) mv on o.id = mv.office_id and gs.month = mv.month\n\tgroup by gs.month, mv.name, o.name\n\torder by gs.month, mv.name, o.name\n) sub\ngroup by sub.month #{(&quot;, office&quot; or &quot;&quot;)}\norder by sub.month\n&quot;, { :cid =&gt; @authorized_user.authorized_client(params[:client_id], [&quot;Administrator&quot;, &quot;User&quot;]).id.to_i, :nickname =&gt; params[:nickname] }])</span></span><table id='context19' class='context' style='display:none'><caption>app/controllers/api/dashboard_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>449</pre>
          </td>
          <td class='context'>
            <pre class='context'>			end</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>450</pre>
            </td>
            <td class='context'>
              <pre class='context'>			if nickname != &#39;aprm&#39;</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>451</pre>
            </td>
            <td class='context'>
              <pre class='context'>				rs = Rails.cache.fetch(&quot;update_datetime_#{client.id}_not_#{nickname}_#{date_range}&quot;, :expires_in =&gt; Rails.env.production? ? 60.minute : 20.seconds) do</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>452</pre>
            </td>
            <td class='context'>
              <pre class='context'>					General.find_by_sql [&lt;&lt;~SQL, {:cid =&gt; client.id.to_i, :nickname =&gt; nickname}]</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>453</pre>
            </td>
            <td class='context'>
              <pre class='context'>						with gs as (</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>454</pre>
            </td>
            <td class='context'>
              <pre class='context'>							#{gs}</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>455</pre>
            </td>
            <td class='context'>
              <pre class='context'>						)</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>456</pre>
            </td>
            <td class='context'>
              <pre class='context'>						select array[(month + interval &#39;1 day&#39;)::date::text, coalesce(sum(#{column}), 0)::text] as #{column} #{fc_gp}</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>457</pre>
            </td>
            <td class='context'>
              <pre class='context'>						from (</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>458</pre>
            </td>
            <td class='context'>
              <pre class='context'>							select gs.month as month, mv.name as title, o.name as office, count(distinct mod_individual) as patients_messaged, count(distinct app_pt) as scheduled_appts, count(distinct app_pt) filter (where true #{status_filter}) as completed_appts, count(distinct purch_pt) as patients_who_purchased, count(distinct purch_pt) filter (where returned_at is not null) as returned_purchase, coalesce(sum(price) filter (where returned_at is null)::integer, 0) as total_revenue</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>459</pre>
            </td>
            <td class='context'>
              <pre class='context'>							from (select * from offices where client_id = :cid and active = &#39;t&#39; #{fc_condition}) o</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='high-confidence'>High</span></td>
      <td>Api::DashboardController</td>
      <td>update_datetime</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context20');toggle('message20');toggle('full_message20')" ><span id='message20' style='display:block'>Possible SQL injection near line 477: ...</span><span id='full_message20' style='display:none'>Possible SQL injection near line 477: <span class="code">General.find_by_sql([&quot;with gs as (\n\t#{generate_series((((((nil or 6) or 13) or &quot;YTD&quot;) or &quot;ALL&quot;) or <span class="user_input">params[:date_range]</span>))}\n)\nselect array[(month + interval &#39;1 day&#39;)::date::text, coalesce(sum(#{params[:column_selected]}), 0)::text] as #{params[:column_selected]} #{(&quot;, office&quot; or &quot;&quot;)}\nfrom (\n\tselect gs.month, mo.nudge_name, o.name as office, count(distinct mo.individual_id) as patients_messaged, count(distinct app_id) filter (where app_conf is not null) as appt_reminder_confirmations, count(distinct app_pt) filter (where true #{Client.find(params[:client_id]).preferences.find_by_key(:ar_cond_completed_appt).value}) as completed_appointments, count (distinct purch_pt) as patients_who_purchased, coalesce(sum(price)::integer, 0) as total_revenue\n\tfrom (select * from offices where client_id = :cid and active = &#39;t&#39; #{(&quot;and id in (#{params[:fc_ids]})&quot; or &quot;&quot;)}) o\n\tjoin gs on true\n\tleft join (select * from mv_ngdash_aprm mo\n\t\tjoin (select id, name from nudges where id in (#{(JSON.parse(params[:nudge])[&quot;id&quot;] or Nudge.joins(:query_type).where(&quot;query_types.nickname = &#39;aprm&#39;&quot;).where(:active =&gt; true, :client_id =&gt; @authorized_user.authorized_client(params[:client_id], [&quot;Administrator&quot;, &quot;User&quot;]).id).map(&amp;:id).join(&quot;,&quot;))})) n on n.id = mo.nudge_id\n\t) mo on mo.office_id = o.id and gs.month = mo.month\n\tgroup by gs.month, mo.nudge_name, o.name\n\torder by gs.month desc, mo.nudge_name, o.name\n) sub\ngroup by sub.month #{(&quot;, office&quot; or &quot;&quot;)}\norder by sub.month desc\n&quot;, { :cid =&gt; @authorized_user.authorized_client(params[:client_id], [&quot;Administrator&quot;, &quot;User&quot;]).id.to_i }])</span></span><table id='context20' class='context' style='display:none'><caption>app/controllers/api/dashboard_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>472</pre>
          </td>
          <td class='context'>
            <pre class='context'>				aprm_nids = nudge ? nudge[&quot;id&quot;] : Nudge.joins(:query_type).where(&quot;query_types.nickname = &#39;aprm&#39;&quot;).where(active: true, client_id: client.id).map(&amp;:id).join(&quot;,&quot;)</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>474</pre>
            </td>
            <td class='context'>
              <pre class='context'>				rs = Rails.cache.fetch(&quot;update_datetime_#{client.id}_#{nickname}_#{date_range}&quot;, :expires_in =&gt; Rails.env.production? ? 60.minute : 20.seconds) do</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>475</pre>
            </td>
            <td class='context'>
              <pre class='context'>					General.find_by_sql [&lt;&lt;~SQL, {cid: client.id.to_i}]</pre>
            </td>
          </tr>
          <tr class='context alt near_error'>
            <td class='context_line'>
              <pre class='context'>476</pre>
            </td>
            <td class='context'>
              <pre class='context'>						with gs as (</pre>
            </td>
          </tr>
          <tr class='context error'>
            <td class='context_line'>
              <pre class='context'>477</pre>
            </td>
            <td class='context'>
              <pre class='context'>							#{gs}</pre>
            </td>
          </tr>
          <tr class='context alt near_error'>
            <td class='context_line'>
              <pre class='context'>478</pre>
            </td>
            <td class='context'>
              <pre class='context'>						)</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>479</pre>
            </td>
            <td class='context'>
              <pre class='context'>						select array[(month + interval &#39;1 day&#39;)::date::text, coalesce(sum(#{column}), 0)::text] as #{column} #{fc_gp}</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>480</pre>
            </td>
            <td class='context'>
              <pre class='context'>						from (</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>481</pre>
            </td>
            <td class='context'>
              <pre class='context'>							select gs.month, mo.nudge_name, o.name as office, count(distinct mo.individual_id) as patients_messaged, count(distinct app_id) filter (where app_conf is not null) as appt_reminder_confirmations, count(distinct app_pt) filter (where true #{status_filter}) as completed_appointments, count (distinct purch_pt) as patients_who_purchased, coalesce(sum(price)::integer, 0) as total_revenue</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>482</pre>
            </td>
            <td class='context'>
              <pre class='context'>							from (select * from offices where client_id = :cid and active = &#39;t&#39; #{fc_condition}) o</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='high-confidence'>High</span></td>
      <td>Api::DashboardController</td>
      <td>ab_datetime</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context22');toggle('message22');toggle('full_message22')" ><span id='message22' style='display:block'>Possible SQL injection near line 762: ...</span><span id='full_message22' style='display:none'>Possible SQL injection near line 762: <span class="code">General.find_by_sql([&quot;with gs as (\n\t#{generate_series(<span class="user_input">params[:month_range]</span>)}\n)\nselect array[(month + interval &#39;1 day&#39;)::date::text, coalesce(sum(#{params[:column_selected]}), 0)::text] as #{params[:column_selected]}, concat(&#39;Message&#39;, &#39; &#39;, test_type) as test_type\nfrom (\n\tselect gs.month, test_type, count(distinct mod_individual) as patients_messaged, count(distinct app_pt) as scheduled_appts, count(distinct app_pt) filter (where true #{status_filter(cid)}) as completed_appts, count(distinct purch_pt) as patients_who_purchased, coalesce(sum(price)::integer, 0) as total_revenue\n\tfrom (select id, name from offices where client_id = :cid and active = &#39;t&#39;) o\n\tjoin gs on true\n\tleft join (\n\t\tselect mv.month, mv.client_id, mv.message_id, mv.nudge_name, mv.office_id, mv.app_id, mv.mod_individual, mv.status, mv.category, mv.app_pt, mv.purch_id, mv.purch_pt, mv.price,  mod.id as mod_id, mod.message_type, mod.status as mes_status, mod.touch_step_id, mb.test_type\n\t\tfrom mv_ngdash_results mv\n\t\tjoin message_out_details mod on mod.id = mv.message_id\n\t\tjoin (\n\t\t\tselect recipient_id as individual_id, test_type\n\t\t\tfrom media_buys_recipients mr\n\t\t\tjoin media_buys mb on mr.media_buy_id = mb.id\n\t\t\twhere mb.client_id = :cid\n\t\t\tand mr.recipient_type = &#39;Individual&#39;\n\t\t\tand  mr.test_type in (&#39;A&#39;, &#39;B&#39;)\n\t\t) mb on mb.individual_id = mod.individual_id\n\t\twhere mv.client_id = :cid and touch_step_id = :ts_id\n\t) mv on gs.month = mv.month and mv.office_id = o.id\n\twhere test_type in (&#39;A&#39;, &#39;B&#39;)\n\tgroup by gs.month, test_type\n\torder by gs.month desc\n) sub\ngroup by sub.month, test_type\norder by sub.month\n&quot;, { :cid =&gt; cid.to_i, :ts_id =&gt; ts_id.to_i }])</span></span><table id='context22' class='context' style='display:none'><caption>app/controllers/api/dashboard_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>757</pre>
          </td>
          <td class='context'>
            <pre class='context'>		gs = generate_series(params[:month_range])</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>758</pre>
            </td>
            <td class='context'>
              <pre class='context'>		column = params[:column_selected]</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>759</pre>
            </td>
            <td class='context'>
              <pre class='context'>		status_filter = status_filter(cid)</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>760</pre>
            </td>
            <td class='context'>
              <pre class='context'>		rs = General.find_by_sql [&lt;&lt;~SQL, {:cid =&gt; cid.to_i, :ts_id =&gt; ts_id.to_i}]</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>761</pre>
            </td>
            <td class='context'>
              <pre class='context'>			with gs as (</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>762</pre>
            </td>
            <td class='context'>
              <pre class='context'>				#{gs}</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>763</pre>
            </td>
            <td class='context'>
              <pre class='context'>			)</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>764</pre>
            </td>
            <td class='context'>
              <pre class='context'>			select array[(month + interval &#39;1 day&#39;)::date::text, coalesce(sum(#{column}), 0)::text] as #{column}, concat(&#39;Message&#39;, &#39; &#39;, test_type) as test_type</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>765</pre>
            </td>
            <td class='context'>
              <pre class='context'>			from (</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>766</pre>
            </td>
            <td class='context'>
              <pre class='context'>				select gs.month, test_type, count(distinct mod_individual) as patients_messaged, count(distinct app_pt) as scheduled_appts, count(distinct app_pt) filter (where true #{status_filter}) as completed_appts, count(distinct purch_pt) as patients_who_purchased, coalesce(sum(price)::integer, 0) as total_revenue</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>767</pre>
            </td>
            <td class='context'>
              <pre class='context'>				from (select id, name from offices where client_id = :cid and active = &#39;t&#39;) o</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='high-confidence'>High</span></td>
      <td>Api::DashboardController</td>
      <td>provider_total</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context24');toggle('message24');toggle('full_message24')" ><span id='message24' style='display:block'>Possible SQL injection near line 831: ...</span><span id='full_message24' style='display:none'>Possible SQL injection near line 831: <span class="code">General.find_by_sql([&quot;select &#39;#{(((&quot;&quot; or &quot;Past Month&quot;) or &quot;Past 6 Months&quot;) or &quot;Past Year&quot;)}&#39; as title, provider, count(distinct appt_id) as completed_appts, count(distinct patient_id) filter (where 1 = 1 #{<span class="user_input">Client.find(cid).preferences</span>.find_by_key(:ar_cond_aidable_loss_identifier).value}) as aidable_loss, count(distinct patient_id) filter (where purch_id is not null and returned_at is null and price &gt; 0) as patients_purchased, round(count(distinct patient_id) filter (where purch_id is not null and price &gt; 0 and returned_at is null) / (count(distinct appt_id) * 1.0) * 100) as conversion, coalesce(sum(price) filter (where purchase_type not in (&#39;l_hearing_aid&#39;, &#39;r_hearing_aid&#39;)), 0)::integer as misc_purchases, coalesce(sum(price) filter (where purchase_type in (&#39;l_hearing_aid&#39;, &#39;r_hearing_aid&#39;)), 0)::integer as hearing_aid_purchases, coalesce(sum(price),0)::integer as total_revenue, case when count(distinct patient_id) filter (where purch_id is not null and returned_at is null and price &gt; 0) = 0 then 0 else coalesce(sum(price) / count(distinct patient_id) filter (where purch_id is not null and returned_at is null and price &gt; 0), 0)::integer end as avg_sale\nfrom (\n\tselect a.id as appt_id, a.patient_id, date_trunc(&#39;month&#39;, appt_at)::timestamp as month, concat(a.hcp_f_name, &#39; &#39;, a.hcp_l_name) as provider, r_loss_level, l_loss_level, pr.id as purch_id, pr.purchased_at, pr.price, pr.purchase_type, pr.returned_at\n\tfrom (select * from appointments where 1 = 1 #{status_filter(cid)} and appt_at between date_trunc(&#39;month&#39;, now() - interval #{(&quot;&#39;#{1} month&#39;&quot; or &quot;&#39;#{date_range} months&#39;&quot;)}) and now()) a\n\tjoin (select id, name, client_id from offices where client_id = :cid) o on o.id = a.office_id\n\tleft join purchases pr on pr.appointment_id = a.id or (pr.appointment_id is null and pr.patient_id = a.patient_id and pr.purchased_at between a.appt_at - interval &#39;1 day&#39; and a.appt_at + interval &#39;1 month&#39;)\n\twhere returned_at is null\n\torder by a.id, a.patient_id\n) qy\ngroup by provider\norder by provider\n&quot;, { :cid =&gt; cid.to_i }])</span></span><table id='context24' class='context' style='display:none'><caption>app/controllers/api/dashboard_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>826</pre>
          </td>
          <td class='context'>
            <pre class='context'>				when 1 then title = &#39;Past Month&#39;</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>827</pre>
            </td>
            <td class='context'>
              <pre class='context'>				when 6 then title = &#39;Past 6 Months&#39;</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>828</pre>
            </td>
            <td class='context'>
              <pre class='context'>				when 13 then title = &#39;Past Year&#39;</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>829</pre>
            </td>
            <td class='context'>
              <pre class='context'>			end</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>830</pre>
            </td>
            <td class='context'>
              <pre class='context'>			rs = General.find_by_sql [&lt;&lt;~SQL, {:cid =&gt; cid.to_i}]</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>831</pre>
            </td>
            <td class='context'>
              <pre class='context'>				select &#39;#{title}&#39; as title, provider, count(distinct appt_id) as completed_appts, count(distinct patient_id) filter (where 1 = 1 #{aidable_loss}) as aidable_loss, count(distinct patient_id) filter (where purch_id is not null and returned_at is null and price &gt; 0) as patients_purchased, round(count(distinct patient_id) filter (where purch_id is not null and price &gt; 0 and returned_at is null) / (count(distinct appt_id) * 1.0) * 100) as conversion, coalesce(sum(price) filter (where purchase_type not in (&#39;l_hearing_aid&#39;, &#39;r_hearing_aid&#39;)), 0)::integer as misc_purchases, coalesce(sum(price) filter (where purchase_type in (&#39;l_hearing_aid&#39;, &#39;r_hearing_aid&#39;)), 0)::integer as hearing_aid_purchases, coalesce(sum(price),0)::integer as total_revenue, case when count(distinct patient_id) filter (where purch_id is not null and returned_at is null and price &gt; 0) = 0 then 0 else coalesce(sum(price) / count(distinct patient_id) filter (where purch_id is not null and returned_at is null and price &gt; 0), 0)::integer end as avg_sale</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>832</pre>
            </td>
            <td class='context'>
              <pre class='context'>				from (</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>833</pre>
            </td>
            <td class='context'>
              <pre class='context'>					select a.id as appt_id, a.patient_id, date_trunc(&#39;month&#39;, appt_at)::timestamp as month, concat(a.hcp_f_name, &#39; &#39;, a.hcp_l_name) as provider, r_loss_level, l_loss_level, pr.id as purch_id, pr.purchased_at, pr.price, pr.purchase_type, pr.returned_at</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>834</pre>
            </td>
            <td class='context'>
              <pre class='context'>					from (select * from appointments where 1 = 1 #{status_filter} and appt_at between date_trunc(&#39;month&#39;, now() - interval #{date}) and now()) a</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>835</pre>
            </td>
            <td class='context'>
              <pre class='context'>					join (select id, name, client_id from offices where client_id = :cid) o on o.id = a.office_id</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>836</pre>
            </td>
            <td class='context'>
              <pre class='context'>					left join purchases pr on pr.appointment_id = a.id or (pr.appointment_id is null and pr.patient_id = a.patient_id and pr.purchased_at between a.appt_at - interval &#39;1 day&#39; and a.appt_at + interval &#39;1 month&#39;)</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='high-confidence'>High</span></td>
      <td>Api::DashboardController</td>
      <td>provider_overview</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context25');toggle('message25');toggle('full_message25')" ><span id='message25' style='display:block'>Possible SQL injection near line 860: ...</span><span id='full_message25' style='display:none'>Possible SQL injection near line 860: <span class="code">General.find_by_sql([&quot;select month, provider, count(distinct appt_id) as completed_appts, count(distinct patient_id) filter (where 1 = 1 #{<span class="user_input">Client.find(cid).preferences</span>.find_by_key(:ar_cond_aidable_loss_identifier).value}) as aidable_loss, count(distinct patient_id) filter (where purch_id is not null and returned_at is null and price &gt; 0) as patients_purchased, round(count(distinct patient_id) filter (where purch_id is not null and price &gt; 0 and returned_at is null) / (count(distinct appt_id) * 1.0) * 100) as conversion, coalesce(sum(price),0) as revenue\nfrom (\n\tselect a.id as appt_id, a.patient_id, date_trunc(&#39;month&#39;, appt_at)::timestamp as month, concat(a.hcp_f_name, &#39; &#39;, a.hcp_l_name) as provider, r_loss_level, l_loss_level, pr.id as purch_id, pr.purchased_at, pr.price, pr.purchase_type, pr.returned_at, pr.purchase_type\n\tfrom (select * from appointments where 1 = 1 #{status_filter(cid)} and appt_at between date_trunc(&#39;month&#39;, now() - interval #{(&quot;&#39;#{1} month&#39;&quot; or &quot;&#39;#{date_range} months&#39;&quot;)}) and now()) a\n\tjoin (select id, name, client_id from offices where client_id = :cid) o on o.id = a.office_id\n\tleft join purchases pr on pr.appointment_id = a.id or (pr.appointment_id is null and pr.patient_id = a.patient_id and pr.purchased_at between a.appt_at - interval &#39;1 day&#39; \t\tand a.appt_at + interval &#39;1 month&#39;)\n\twhere returned_at is null\n\torder by a.id, a.patient_id\n) qy\ngroup by month, provider\norder by month desc, provider\n&quot;, { :cid =&gt; cid.to_i }])</span></span><table id='context25' class='context' style='display:none'><caption>app/controllers/api/dashboard_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>855</pre>
          </td>
          <td class='context'>
            <pre class='context'>			table_columns = [NDT::NUMBER, NDT::NUMBER, NDT::NUMBER, NDT::NUMBER, NDT::CURRENCY]</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>856</pre>
            </td>
            <td class='context'>
              <pre class='context'>			status_filter = status_filter(cid)</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>857</pre>
            </td>
            <td class='context'>
              <pre class='context'>			aidable_loss = Client.find(cid).preferences&amp;.find_by_key(:ar_cond_aidable_loss_identifier)&amp;.value</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>858</pre>
            </td>
            <td class='context'>
              <pre class='context'>			date = date_range == 1 ? &quot;&#39;#{date_range} month&#39;&quot; : &quot;&#39;#{date_range} months&#39;&quot;</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>859</pre>
            </td>
            <td class='context'>
              <pre class='context'>			rs = General.find_by_sql [&lt;&lt;~SQL, {:cid =&gt; cid.to_i}]</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>860</pre>
            </td>
            <td class='context'>
              <pre class='context'>				select month, provider, count(distinct appt_id) as completed_appts, count(distinct patient_id) filter (where 1 = 1 #{aidable_loss}) as aidable_loss, count(distinct patient_id) filter (where purch_id is not null and returned_at is null and price &gt; 0) as patients_purchased, round(count(distinct patient_id) filter (where purch_id is not null and price &gt; 0 and returned_at is null) / (count(distinct appt_id) * 1.0) * 100) as conversion, coalesce(sum(price),0) as revenue</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>861</pre>
            </td>
            <td class='context'>
              <pre class='context'>				from (</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>862</pre>
            </td>
            <td class='context'>
              <pre class='context'>					select a.id as appt_id, a.patient_id, date_trunc(&#39;month&#39;, appt_at)::timestamp as month, concat(a.hcp_f_name, &#39; &#39;, a.hcp_l_name) as provider, r_loss_level, l_loss_level, pr.id as purch_id, pr.purchased_at, pr.price, pr.purchase_type, pr.returned_at, pr.purchase_type</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>863</pre>
            </td>
            <td class='context'>
              <pre class='context'>					from (select * from appointments where 1 = 1 #{status_filter} and appt_at between date_trunc(&#39;month&#39;, now() - interval #{date}) and now()) a</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>864</pre>
            </td>
            <td class='context'>
              <pre class='context'>					join (select id, name, client_id from offices where client_id = :cid) o on o.id = a.office_id</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>865</pre>
            </td>
            <td class='context'>
              <pre class='context'>					left join purchases pr on pr.appointment_id = a.id or (pr.appointment_id is null and pr.patient_id = a.patient_id and pr.purchased_at between a.appt_at - interval &#39;1 day&#39; 		and a.appt_at + interval &#39;1 month&#39;)</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='high-confidence'>High</span></td>
      <td>Api::DashboardController</td>
      <td>appointment_totals</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context55');toggle('message55');toggle('full_message55')" ><span id='message55' style='display:block'>Possible SQL injection near line 2092: ...</span><span id='full_message55' style='display:none'>Possible SQL injection near line 2092: <span class="code">General.find_by_sql([&quot;select &#39;Appointment Reminders&#39; as campaign, mo.month, mo.nudge_name, o.name, count(distinct mo.individual_id) as patients_messaged, count(distinct app_id) filter (where app_conf is not null) as appt_reminder_confirmations, count(distinct app_pt) filter (where true #{status_filter(<span class="user_input">params[:client_id]</span>)}) as completed_appointments #{(&quot;, count (distinct purch_pt) as patients_who_purchased, coalesce(sum(price)::integer, 0) as total_revenue&quot; or &quot;&quot;)}\nfrom (select * from offices where client_id = :cid and active = &#39;t&#39; #{(&quot;and id in (#{params[:fc_ids]})&quot; or &quot;&quot;)}) o\njoin mv_ngdash_aprm mo on mo.office_id = o.id\nwhere mo.nudge_id in (#{(nudge[&quot;id&quot;] or Nudge.joins(:query_type).where(&quot;query_types.nickname = &#39;aprm&#39;&quot;).where(:active =&gt; true, :client_id =&gt; cid).map(&amp;:id).join(&quot;,&quot;))}) and mo.month #{between_date_range}\ngroup by campaign, month, mo.nudge_name, o.name\norder by month desc, mo.nudge_name, o.name\n&quot;, { :cid =&gt; cid }])</span></span><table id='context55' class='context' style='display:none'><caption>app/controllers/api/dashboard_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>2087</pre>
          </td>
          <td class='context'>
            <pre class='context'>			fc_condition = fc_ids ? &quot;and id in (#{fc_ids})&quot; : &quot;&quot;</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2088</pre>
            </td>
            <td class='context'>
              <pre class='context'>			aprm_nids = nudge ? nudge[&quot;id&quot;] : Nudge.joins(:query_type).where(&quot;query_types.nickname = &#39;aprm&#39;&quot;).where(active: true, client_id: cid).map(&amp;:id).join(&quot;,&quot;)</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>2089</pre>
            </td>
            <td class='context'>
              <pre class='context'>			revenue_select = include_purchases ? &quot;, count (distinct purch_pt) as patients_who_purchased, coalesce(sum(price)::integer, 0) as total_revenue&quot; : &quot;&quot;</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2090</pre>
            </td>
            <td class='context'>
              <pre class='context'>			status_filter = status_filter(params[:client_id])</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>2091</pre>
            </td>
            <td class='context'>
              <pre class='context'>			unformatted_totals = General.find_by_sql [&lt;&lt;~SQL, {cid: cid}]</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>2092</pre>
            </td>
            <td class='context'>
              <pre class='context'>				select &#39;Appointment Reminders&#39; as campaign, mo.month, mo.nudge_name, o.name, count(distinct mo.individual_id) as patients_messaged, count(distinct app_id) filter (where app_conf is not null) as appt_reminder_confirmations, count(distinct app_pt) filter (where true #{status_filter}) as completed_appointments #{revenue_select}</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>2093</pre>
            </td>
            <td class='context'>
              <pre class='context'>				from (select * from offices where client_id = :cid and active = &#39;t&#39; #{fc_condition}) o</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2094</pre>
            </td>
            <td class='context'>
              <pre class='context'>				join mv_ngdash_aprm mo on mo.office_id = o.id</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>2095</pre>
            </td>
            <td class='context'>
              <pre class='context'>				where mo.nudge_id in (#{aprm_nids}) and mo.month #{between_date_range}</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2096</pre>
            </td>
            <td class='context'>
              <pre class='context'>				group by campaign, month, mo.nudge_name, o.name</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>2097</pre>
            </td>
            <td class='context'>
              <pre class='context'>				order by month desc, mo.nudge_name, o.name</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='high-confidence'>High</span></td>
      <td>Api::DashboardController</td>
      <td>text_email_nudge_totals</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context56');toggle('message56');toggle('full_message56')" ><span id='message56' style='display:block'>Possible SQL injection near line 2147: ...</span><span id='full_message56' style='display:none'>Possible SQL injection near line 2147: <span class="code">General.find_by_sql([&quot;select #{(&quot;nudge_name&quot; or &quot;qt.name&quot;)} as title, month, nudge_name, o.name as office, count(distinct mod_individual) as patients_messaged #{(&quot;&quot; or &quot;, count(distinct app_pt) as scheduled_appts, count(distinct app_pt) filter (where true #{status_filter(<span class="user_input">params[:client_id]</span>)}) as completed_appts&quot;)} #{(&quot;&quot; or &quot;, count(distinct purch_pt) as patients_who_purchased, count(distinct purch_pt) filter (where returned_at is not null) as returned_purchase, coalesce(sum(price) filter (where returned_at is null)::integer, 0) as total_revenue&quot;)}\nfrom (select * from offices where client_id = :cid and active = &#39;t&#39; #{(&quot;and id in (#{params[:fc_ids]})&quot; or &quot;&quot;)}) o\njoin mv_ngdash_results mv on o.id = mv.office_id\n#{if nudge then   &quot;join (select id, name from nudges where id = :nudge_id) n on n.name = mv.nudge_name&quot; else   &quot;join (select id, name from query_types where id = #{if (QueryType.where(:nickname =&gt; query_type, :client_id =&gt; (client or Client.find(<span class="user_input">params[:client_id]</span>)).id).first or QueryType.where(:nickname =&gt; params[:qt_nickname], :client_id =&gt; (client or Client.find(<span class="user_input">params[:client_id]</span>)).id).first) then     (QueryType.where(:nickname =&gt; query_type, :client_id =&gt; (client or Client.find(<span class="user_input">params[:client_id]</span>)).id).first or QueryType.where(:nickname =&gt; params[:qt_nickname], :client_id =&gt; (client or Client.find(<span class="user_input">params[:client_id]</span>)).id).first).id   end}) qt on qt.id = mv.query_type_id&quot; end}\nwhere mv.month #{between_date_range} and nudge_name not Ilike &#39;%Survey%&#39;\ngroup by month, nudge_name, office #{nudge ? (&quot;&quot;) : (&quot;, qt.name&quot;)}\norder by month desc, nudge_name, office\n&quot;, { :cid =&gt; (client or Client.find(<span class="user_input">params[:client_id]</span>)).id, :nudge_id =&gt; nudge[&quot;id&quot;] }])</span></span><table id='context56' class='context' style='display:none'><caption>app/controllers/api/dashboard_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>2142</pre>
          </td>
          <td class='context'>
            <pre class='context'>		else</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2143</pre>
            </td>
            <td class='context'>
              <pre class='context'>			revenue_union = &quot;(select distinct on (app_id) * from message_appt where app_id is not null order by app_id)&quot;</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>2144</pre>
            </td>
            <td class='context'>
              <pre class='context'>		end</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2145</pre>
            </td>
            <td class='context'>
              <pre class='context'>		fc_condition = fc_ids ? &quot;and id in (#{fc_ids})&quot; : &quot;&quot;</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>2146</pre>
            </td>
            <td class='context'>
              <pre class='context'>		totals = totals = General.find_by_sql [&lt;&lt;~SQL, {cid: client.id, nudge_id: nudge_id}]</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>2147</pre>
            </td>
            <td class='context'>
              <pre class='context'>			select #{title} as title, month, nudge_name, o.name as office, count(distinct mod_individual) as patients_messaged #{appt_select} #{revenue_select_outer}</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>2148</pre>
            </td>
            <td class='context'>
              <pre class='context'>			from (select * from offices where client_id = :cid and active = &#39;t&#39; #{fc_condition}) o</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2149</pre>
            </td>
            <td class='context'>
              <pre class='context'>			join mv_ngdash_results mv on o.id = mv.office_id</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>2150</pre>
            </td>
            <td class='context'>
              <pre class='context'>			#{nudge ? ndg_join : qt_join}</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2151</pre>
            </td>
            <td class='context'>
              <pre class='context'>			where mv.month #{between_date_range} and nudge_name not Ilike &#39;%Survey%&#39;</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>2152</pre>
            </td>
            <td class='context'>
              <pre class='context'>			group by month, nudge_name, office #{nudge ? &#39;&#39; : &#39;, qt.name&#39;}</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='high-confidence'>High</span></td>
      <td>Api::MiscellaneousController</td>
      <td>appt_summary_list</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context76');toggle('message76');toggle('full_message76')" ><span id='message76' style='display:block'>Possible SQL injection near line 460: ...</span><span id='full_message76' style='display:none'>Possible SQL injection near line 460: <span class="code">General.find_by_sql([&quot;SELECT appt.name, count(appt.id) as total,\n\tsum(CASE WHEN appt.category = &#39;Completed&#39; THEN 1 ELSE 0 END) as completed,\n\tsum(CASE WHEN appt.category = &#39;Rescheduled&#39; THEN 1 ELSE 0 END) as rescheduled,\n\tsum(CASE WHEN appt.category = &#39;Not Confirmed&#39; THEN 1 ELSE 0 END) as not_confirmed,\n\tsum(CASE WHEN appt.category = &#39;Canceled&#39; THEN 1 ELSE 0 END) as canceled,\n\tsum(CASE WHEN appt.category = &#39;No Show&#39; THEN 1 ELSE 0 END) as no_show,\n\tsum(CASE WHEN appt.category = &#39;Confirmed&#39; THEN 1 ELSE 0 END) as confirmed\nFROM public.appointments appt\n\nINNER JOIN patients p ON p.id = appt.patient_id\nINNER JOIN offices o ON o.id = appt.office_id\nINNER JOIN clients c ON c.id = o.client_id\n\nWHERE c.id = :cid #{(&quot;&quot; or (&quot;AND appt_at &gt; now() - interval &#39;1 year&#39;&quot; or &quot;AND appt_at between &#39;#{Sanitize.date(<span class="user_input">params[:start_date]</span>)}&#39; and &#39;#{Sanitize.date(params[:end_date])}&#39;&quot;))} #{(&quot;&quot; or &quot;AND o.id = #{params[:office_id]}&quot;)} #{(&quot;&quot; or &quot;AND concat(appt.hcp_f_name, &#39; &#39;, appt.hcp_l_name) = &#39;#{params[:provider]}&#39;&quot;)}\n#{if get_data_filters(@authorized_user, @authorized_user.authorized_client(params[:client_id], [&quot;Administrator&quot;, &quot;User&quot;, &quot;Engagement&quot;]).id).split(&quot;,&quot;).map(&amp;:to_i).present? then   &quot;AND p.office_id IN (:office_ids)&quot; end}\nGROUP BY appt.name\nORDER BY total DESC\n&quot;, { :cid =&gt; @authorized_user.authorized_client(params[:client_id], [&quot;Administrator&quot;, &quot;User&quot;, &quot;Engagement&quot;]).id, :office_ids =&gt; get_data_filters(@authorized_user, @authorized_user.authorized_client(params[:client_id], [&quot;Administrator&quot;, &quot;User&quot;, &quot;Engagement&quot;]).id).split(&quot;,&quot;).map(&amp;:to_i) }])</span></span><table id='context76' class='context' style='display:none'><caption>app/controllers/api/miscellaneous_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>456</pre>
          </td>
          <td class='context'>
            <pre class='context'>				INNER JOIN patients p ON p.id = appt.patient_id</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>457</pre>
            </td>
            <td class='context'>
              <pre class='context'>				INNER JOIN offices o ON o.id = appt.office_id</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>458</pre>
            </td>
            <td class='context'>
              <pre class='context'>				INNER JOIN clients c ON c.id = o.client_id</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>460</pre>
            </td>
            <td class='context'>
              <pre class='context'>				WHERE c.id = :cid #{appt_at_filter} #{office_filter} #{provider_filter}</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>461</pre>
            </td>
            <td class='context'>
              <pre class='context'>				#{&quot;AND p.office_id IN (:office_ids)&quot; if office_ids.present?}</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>462</pre>
            </td>
            <td class='context'>
              <pre class='context'>				GROUP BY appt.name</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>463</pre>
            </td>
            <td class='context'>
              <pre class='context'>				ORDER BY total DESC</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>464</pre>
            </td>
            <td class='context'>
              <pre class='context'>			SQL</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='high-confidence'>High</span></td>
      <td>Api::MiscellaneousController</td>
      <td>appt_summary_list</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context77');toggle('message77');toggle('full_message77')" ><span id='message77' style='display:block'>Possible SQL injection near line 480: ...</span><span id='full_message77' style='display:none'>Possible SQL injection near line 480: <span class="code">General.find_by_sql([&quot;SELECT distinct(concat(appt.hcp_f_name, &#39; &#39;, appt.hcp_l_name)) AS name\n\t\t\tFROM public.appointments appt\n\n\t\t\tINNER JOIN offices o ON o.id = appt.office_id\n\t\t\tINNER JOIN clients c ON c.id = o.client_id\n\n\t\t\tWHERE c.id = :cid #{(&quot;&quot; or (&quot;AND appt_at &gt; now() - interval &#39;1 year&#39;&quot; or &quot;AND appt_at between &#39;#{Sanitize.date(<span class="user_input">params[:start_date]</span>)}&#39; and &#39;#{Sanitize.date(params[:end_date])}&#39;&quot;))} #{(&quot;&quot; or &quot;AND o.id = #{params[:office_id]}&quot;)}\n\t\t\t#{if get_data_filters(@authorized_user, @authorized_user.authorized_client(params[:client_id], [&quot;Administrator&quot;, &quot;User&quot;, &quot;Engagement&quot;]).id).split(&quot;,&quot;).map(&amp;:to_i).present? then   &quot;AND o.id IN (:office_ids)&quot; end}\n\t\t\tORDER BY name\n&quot;, { :cid =&gt; @authorized_user.authorized_client(params[:client_id], [&quot;Administrator&quot;, &quot;User&quot;, &quot;Engagement&quot;]).id, :office_ids =&gt; get_data_filters(@authorized_user, @authorized_user.authorized_client(params[:client_id], [&quot;Administrator&quot;, &quot;User&quot;, &quot;Engagement&quot;]).id).split(&quot;,&quot;).map(&amp;:to_i) }])</span></span><table id='context77' class='context' style='display:none'><caption>app/controllers/api/miscellaneous_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>475</pre>
          </td>
          <td class='context'>
            <pre class='context'>				FROM public.appointments appt</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>477</pre>
            </td>
            <td class='context'>
              <pre class='context'>				INNER JOIN offices o ON o.id = appt.office_id</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>478</pre>
            </td>
            <td class='context'>
              <pre class='context'>				INNER JOIN clients c ON c.id = o.client_id</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>480</pre>
            </td>
            <td class='context'>
              <pre class='context'>				WHERE c.id = :cid #{appt_at_filter} #{office_filter}</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>481</pre>
            </td>
            <td class='context'>
              <pre class='context'>				#{&quot;AND o.id IN (:office_ids)&quot; if office_ids.present?}</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>482</pre>
            </td>
            <td class='context'>
              <pre class='context'>				ORDER BY name</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>483</pre>
            </td>
            <td class='context'>
              <pre class='context'>      SQL</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>485</pre>
            </td>
            <td class='context'>
              <pre class='context'>      # convert the numbers with delimiter</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='high-confidence'>High</span></td>
      <td>Api::MiscellaneousController</td>
      <td>callcenter_upgrade</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context78');toggle('message78');toggle('full_message78')" ><span id='message78' style='display:block'>Possible SQL injection near line 737: ...</span><span id='full_message78' style='display:none'>Possible SQL injection near line 737: <span class="code">Office.find_by_sql([&quot;select office_id as id, name\nfrom (select id as office_id, region_id, name from offices where client_id = :cid and active = &#39;t&#39; order by name) q\n#{unless (&quot;office_id in (#{get_data_filters(@authorized_user, @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;Call Center&quot;]).id)})&quot; or &quot;&quot;).blank? then   &quot;where #{(&quot;office_id in (#{get_data_filters(@authorized_user, @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;Call Center&quot;]).id)})&quot; or &quot;&quot;)}&quot; end};\n&quot;, { :cid =&gt; @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;Call Center&quot;]).id }])</span></span><table id='context78' class='context' style='display:none'><caption>app/controllers/api/miscellaneous_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>733</pre>
          </td>
          <td class='context'>
            <pre class='context'>			if params[:first] == &quot;true&quot;</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>734</pre>
            </td>
            <td class='context'>
              <pre class='context'>				dt[:offices] = Office.find_by_sql [&lt;&lt;~SQL, {:cid =&gt; client.id}]</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>735</pre>
            </td>
            <td class='context'>
              <pre class='context'>					select office_id as id, name</pre>
            </td>
          </tr>
          <tr class='context alt near_error'>
            <td class='context_line'>
              <pre class='context'>736</pre>
            </td>
            <td class='context'>
              <pre class='context'>					from (select id as office_id, region_id, name from offices where client_id = :cid and active = &#39;t&#39; order by name) q</pre>
            </td>
          </tr>
          <tr class='context error'>
            <td class='context_line'>
              <pre class='context'>737</pre>
            </td>
            <td class='context'>
              <pre class='context'>					#{&quot;where #{ws}&quot; unless ws.blank?};</pre>
            </td>
          </tr>
          <tr class='context alt near_error'>
            <td class='context_line'>
              <pre class='context'>738</pre>
            </td>
            <td class='context'>
              <pre class='context'>					SQL</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>739</pre>
            </td>
            <td class='context'>
              <pre class='context'>				dt[:providers] = General.find_by_sql [&lt;&lt;~SQL, {:cid =&gt; client.id}]</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>740</pre>
            </td>
            <td class='context'>
              <pre class='context'>					select distinct concat(hcp_f_name, &#39; &#39;, hcp_l_name) as pr</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>741</pre>
            </td>
            <td class='context'>
              <pre class='context'>					from mv_upgrades</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>742</pre>
            </td>
            <td class='context'>
              <pre class='context'>					where hcp_f_name is not null and hcp_l_name is not null and client_id = :cid order by pr;</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='high-confidence'>High</span></td>
      <td>Api::MiscellaneousController</td>
      <td>callcenter_cns</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context79');toggle('message79');toggle('full_message79')" ><span id='message79' style='display:block'>Possible SQL injection near line 798: ...</span><span id='full_message79' style='display:none'>Possible SQL injection near line 798: <span class="code">Office.find_by_sql([&quot;select office_id as id, name\nfrom (select id as office_id, region_id, name from offices where client_id = :cid and active = &#39;t&#39; order by name) q\n#{unless (&quot;office_id in (#{get_data_filters(@authorized_user, @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;Call Center&quot;]).id)})&quot; or &quot;&quot;).blank? then   &quot;where #{(&quot;office_id in (#{get_data_filters(@authorized_user, @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;Call Center&quot;]).id)})&quot; or &quot;&quot;)}&quot; end};\n&quot;, { :cid =&gt; @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;Call Center&quot;]).id }])</span></span><table id='context79' class='context' style='display:none'><caption>app/controllers/api/miscellaneous_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>794</pre>
          </td>
          <td class='context'>
            <pre class='context'>			if params[:first] == &quot;true&quot;</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>795</pre>
            </td>
            <td class='context'>
              <pre class='context'>				dt[:offices] = Office.find_by_sql [&lt;&lt;~SQL, {:cid =&gt; client.id}]</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>796</pre>
            </td>
            <td class='context'>
              <pre class='context'>					select office_id as id, name</pre>
            </td>
          </tr>
          <tr class='context alt near_error'>
            <td class='context_line'>
              <pre class='context'>797</pre>
            </td>
            <td class='context'>
              <pre class='context'>					from (select id as office_id, region_id, name from offices where client_id = :cid and active = &#39;t&#39; order by name) q</pre>
            </td>
          </tr>
          <tr class='context error'>
            <td class='context_line'>
              <pre class='context'>798</pre>
            </td>
            <td class='context'>
              <pre class='context'>					#{&quot;where #{ws}&quot; unless ws.blank?};</pre>
            </td>
          </tr>
          <tr class='context alt near_error'>
            <td class='context_line'>
              <pre class='context'>799</pre>
            </td>
            <td class='context'>
              <pre class='context'>					SQL</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>800</pre>
            </td>
            <td class='context'>
              <pre class='context'>				dt[:providers] = General.find_by_sql [&lt;&lt;~SQL, {:cid =&gt; client.id}]</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>801</pre>
            </td>
            <td class='context'>
              <pre class='context'>					select distinct concat(hcp_f_name, &#39; &#39;, hcp_l_name) as pr</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>802</pre>
            </td>
            <td class='context'>
              <pre class='context'>					from mv_cns</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>803</pre>
            </td>
            <td class='context'>
              <pre class='context'>					where hcp_f_name is not null and hcp_l_name is not null and client_id = :cid order by pr;</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='high-confidence'>High</span></td>
      <td>Api::MiscellaneousController</td>
      <td>callcenter_orientation</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context80');toggle('message80');toggle('full_message80')" ><span id='message80' style='display:block'>Possible SQL injection near line 902: ...</span><span id='full_message80' style='display:none'>Possible SQL injection near line 902: <span class="code">General.find_by_sql([&quot;select distinct nb.individual_id, fc.id as office_id, fc.region_id, fc.name as office_name, fc.sms_phone as office_phone, nb.f_name, nb.l_name, nb.phones, pt.age, pt.hcp_f_name, pt.hcp_l_name, pc.pvcm as prevcom, lv.last_appt_at, lc.message_type as last_com_type, lc.last_at as last_com_at\nfrom mv_nudge_base nb\njoin (\n\tselect pa.id as patient_id, pa.office_id, pa.hcp_f_name, pa.hcp_l_name, extract(&#39;year&#39; from age(birthdate)) as age\n\tfrom patients pa\n\tleft join (select * from appointments where appt_at &gt; now() and name like &#39;%Medicare Orientation%&#39;) a on pa.id = a.patient_id\n\twhere client_id = :cid\n\tand patient_type = &#39;Active&#39; and suppress = &#39;f&#39; and extract(&#39;year&#39; from age(birthdate)) &gt;= 64\n\tand a.patient_id is null\n) pt on nb.patient_id = pt.patient_id\njoin offices fc on nb.client_id = fc.client_id and pt.office_id = fc.id and fc.active = &#39;t&#39;\nleft join (\n\tselect client_id, regard_type, regard_id, individual_id, string_agg(distinct message_type, &#39; &#39;) as pvcm\n\tfrom message_out_details\n\twhere client_id = :cid\n\tand (message_type = &#39;Email&#39; and status = &#39;sent&#39;) or (message_type = &#39;Text&#39; and (status = &#39;sent&#39; or status = &#39;delivered&#39;))\n\tgroup by client_id, regard_type, regard_id, individual_id\n\torder by client_id, regard_type, regard_id, individual_id\n) pc on nb.client_id = pc.client_id and nb.individual_id = pc.individual_id\nleft join (\n\tselect distinct on (patient_id) patient_id, appt_at as last_appt_at\n\tfrom appointments a join patients p on a.patient_id = p.id\n\twhere client_id = :cid\n\tand appt_at::date between (now() - interval &#39;10 years&#39;)::date and now()::date\n\t#{@authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;Call Center&quot;]).preferences.find_by_key(:ar_cond_completed_appt).value rescue &quot;&quot;}\n\torder by patient_id, appt_at desc\n) lv on nb.patient_id = lv.patient_id\nleft join (\n\tselect distinct on (individual_id) individual_id, message_type, last_at from (\n\t\tselect individual_id, message_type, processed_at as last_at from message_out_details where client_id = :cid and individual_id is not null\n\tunion\n\t\tselect individual_id, &#39;Call&#39;::text as message_type, created_at as last_at from callcenter_logs where client_id = :cid and status not in (&#39;Invalid&#39;)\n\t) sq order by individual_id, last_at desc\n) lc on nb.individual_id = lc.individual_id\nwhere nb.client_id = :cid\n#{unless &quot;#{&quot;region_id in (#{&quot;#{r.filterable_id}&quot;})&quot;} and #{&quot;office_id in (#{&quot;#{r.filterable_id}&quot;})&quot;}&quot;.blank? then   &quot;and #{&quot;#{&quot;region_id in (#{&quot;#{r.filterable_id}&quot;})&quot;} and #{&quot;office_id in (#{&quot;#{r.filterable_id}&quot;})&quot;}&quot;}&quot; end}\norder by fc.name, pt.hcp_f_name, pt.hcp_l_name, nb.f_name, nb.l_name\n&quot;, { :cid =&gt; @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;Call Center&quot;]).id }])</span></span><table id='context80' class='context' style='display:none'><caption>app/controllers/api/miscellaneous_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>897</pre>
          </td>
          <td class='context'>
            <pre class='context'>				left join (</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>898</pre>
            </td>
            <td class='context'>
              <pre class='context'>					select distinct on (patient_id) patient_id, appt_at as last_appt_at</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>899</pre>
            </td>
            <td class='context'>
              <pre class='context'>					from appointments a join patients p on a.patient_id = p.id</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>900</pre>
            </td>
            <td class='context'>
              <pre class='context'>					where client_id = :cid</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>901</pre>
            </td>
            <td class='context'>
              <pre class='context'>					and appt_at::date between (now() - interval &#39;10 years&#39;)::date and now()::date</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>902</pre>
            </td>
            <td class='context'>
              <pre class='context'>					#{ca}</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>903</pre>
            </td>
            <td class='context'>
              <pre class='context'>					order by patient_id, appt_at desc</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>904</pre>
            </td>
            <td class='context'>
              <pre class='context'>				) lv on nb.patient_id = lv.patient_id</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>905</pre>
            </td>
            <td class='context'>
              <pre class='context'>				left join (</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>906</pre>
            </td>
            <td class='context'>
              <pre class='context'>					select distinct on (individual_id) individual_id, message_type, last_at from (</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>907</pre>
            </td>
            <td class='context'>
              <pre class='context'>						select individual_id, message_type, processed_at as last_at from message_out_details where client_id = :cid and individual_id is not null</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='high-confidence'>High</span></td>
      <td>Api::MiscellaneousController</td>
      <td>callcenter_turning_65</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context81');toggle('message81');toggle('full_message81')" ><span id='message81' style='display:block'>Possible SQL injection near line 940: ...</span><span id='full_message81' style='display:none'>Possible SQL injection near line 940: <span class="code">General.find_by_sql([&quot;select o.name as office, nb.f_name, nb.l_name, mv.hcp_f_name, mv.hcp_l_name, mv.individual_id, mv.birthdate, age(now(), birthdate), last_appt_at, message_type as last_com_type, lc.last_at as last_contact, nb.phone_text, nb.phones, o.sms_phone as office_phone, case when mv.hipaa_consent_id is null then false else true end as consent, ex.contacted\nfrom mv_nudge_base nb\n\tjoin mv_patients mv on mv.id = nb.patient_id\n\tjoin offices o on o.id = mv.office_id\n\tleft join (\n\t\tselect distinct on (patient_id) patient_id, appt_at as last_appt_at\n\t\tfrom appointments a join patients p on a.patient_id = p.id\n\t\twhere client_id = :cid\n\t\tand appt_at::date between (now() - interval &#39;10 years&#39;)::date and now()::date\n\t\t#{@authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;Call Center&quot;]).preferences.find_by_key(:ar_cond_completed_appt).value rescue &quot;&quot;}\n\t\torder by patient_id, appt_at desc\n\t) lv on nb.patient_id = lv.patient_id\n\tleft join (\n\t\tselect distinct on (individual_id) individual_id, message_type, last_at from (\n\t\t\tselect individual_id, message_type, processed_at as last_at from message_out_details where client_id = :cid and individual_id is not null\n\t\tunion\n\t\t\tselect individual_id, &#39;Call&#39;::text as message_type, created_at as last_at from callcenter_logs where client_id = :cid and status not in (&#39;Invalid&#39;)\n\t\t) sq order by individual_id, last_at desc\n\t) lc on nb.individual_id = lc.individual_id\n\tleft join (select distinct true as contacted, individual_id from callcenter_logs where client_id = :cid and tab_contacted_in = &#39;Turning 65&#39; and status = &#39;Contacted&#39;) ex on ex.individual_id = mv.individual_id\nwhere nb.client_id = :cid and contacted is null and patient_type in (&#39;Active&#39;, &#39;Current&#39;) and age(now(), birthdate) &gt;= interval &#39;64 years&#39; and age(now(), birthdate) &lt;= interval &#39;65 years&#39;\n#{unless (&quot;office_id in (#{get_data_filters(@authorized_user, @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;Call Center&quot;]).id)})&quot; or &quot;&quot;).blank? then   &quot;and #{(&quot;office_id in (#{get_data_filters(@authorized_user, @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;Call Center&quot;]).id)})&quot; or &quot;&quot;)}&quot; end}\n#{unless callcenter_search_param_query.blank? then   &quot;and #{callcenter_search_param_query}&quot; end}\norder by birthdate\n&quot;, { :cid =&gt; @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;Call Center&quot;]).id }])</span></span><table id='context81' class='context' style='display:none'><caption>app/controllers/api/miscellaneous_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>935</pre>
          </td>
          <td class='context'>
            <pre class='context'>					left join (</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>936</pre>
            </td>
            <td class='context'>
              <pre class='context'>						select distinct on (patient_id) patient_id, appt_at as last_appt_at</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>937</pre>
            </td>
            <td class='context'>
              <pre class='context'>						from appointments a join patients p on a.patient_id = p.id</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>938</pre>
            </td>
            <td class='context'>
              <pre class='context'>						where client_id = :cid</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>939</pre>
            </td>
            <td class='context'>
              <pre class='context'>						and appt_at::date between (now() - interval &#39;10 years&#39;)::date and now()::date</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>940</pre>
            </td>
            <td class='context'>
              <pre class='context'>						#{ca}</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>941</pre>
            </td>
            <td class='context'>
              <pre class='context'>						order by patient_id, appt_at desc</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>942</pre>
            </td>
            <td class='context'>
              <pre class='context'>					) lv on nb.patient_id = lv.patient_id</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>943</pre>
            </td>
            <td class='context'>
              <pre class='context'>					left join (</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>944</pre>
            </td>
            <td class='context'>
              <pre class='context'>						select distinct on (individual_id) individual_id, message_type, last_at from (</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>945</pre>
            </td>
            <td class='context'>
              <pre class='context'>							select individual_id, message_type, processed_at as last_at from message_out_details where client_id = :cid and individual_id is not null</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='high-confidence'>High</span></td>
      <td>Api::MiscellaneousController</td>
      <td>callcenter_turning_65</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context82');toggle('message82');toggle('full_message82')" ><span id='message82' style='display:block'>Possible SQL injection near line 961: ...</span><span id='full_message82' style='display:none'>Possible SQL injection near line 961: <span class="code">General.find_by_sql([&quot;select distinct concat(hcp_f_name, &#39; &#39;, hcp_l_name) as pr\nfrom mv_patients\nwhere hcp_f_name is not null and hcp_l_name is not null and client_id = :cid\n#{unless (&quot;office_id in (#{get_data_filters(@authorized_user, @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;Call Center&quot;]).id)})&quot; or &quot;&quot;).blank? then   &quot;and #{(&quot;office_id in (#{get_data_filters(@authorized_user, @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;Call Center&quot;]).id)})&quot; or &quot;&quot;)}&quot; end}\norder by pr\n&quot;, { :cid =&gt; @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;Call Center&quot;]).id }])</span></span><table id='context82' class='context' style='display:none'><caption>app/controllers/api/miscellaneous_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>957</pre>
          </td>
          <td class='context'>
            <pre class='context'>			prv = General.find_by_sql [&lt;&lt;~SQL, {:cid =&gt; client.id}]</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>958</pre>
            </td>
            <td class='context'>
              <pre class='context'>				select distinct concat(hcp_f_name, &#39; &#39;, hcp_l_name) as pr</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>959</pre>
            </td>
            <td class='context'>
              <pre class='context'>				from mv_patients</pre>
            </td>
          </tr>
          <tr class='context alt near_error'>
            <td class='context_line'>
              <pre class='context'>960</pre>
            </td>
            <td class='context'>
              <pre class='context'>				where hcp_f_name is not null and hcp_l_name is not null and client_id = :cid</pre>
            </td>
          </tr>
          <tr class='context error'>
            <td class='context_line'>
              <pre class='context'>961</pre>
            </td>
            <td class='context'>
              <pre class='context'>				#{&quot;and #{ws}&quot; unless ws.blank?}</pre>
            </td>
          </tr>
          <tr class='context alt near_error'>
            <td class='context_line'>
              <pre class='context'>962</pre>
            </td>
            <td class='context'>
              <pre class='context'>				order by pr</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>963</pre>
            </td>
            <td class='context'>
              <pre class='context'>				SQL</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>965</pre>
            </td>
            <td class='context'>
              <pre class='context'>			fcs = Office.find_by_sql [&lt;&lt;~SQL, {:cid =&gt; client.id}]</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>966</pre>
            </td>
            <td class='context'>
              <pre class='context'>				select office_id as id, name</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='high-confidence'>High</span></td>
      <td>Api::MiscellaneousController</td>
      <td>callcenter_turning_65</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context83');toggle('message83');toggle('full_message83')" ><span id='message83' style='display:block'>Possible SQL injection near line 968: ...</span><span id='full_message83' style='display:none'>Possible SQL injection near line 968: <span class="code">Office.find_by_sql([&quot;select office_id as id, name\nfrom (select id as office_id, region_id, name from offices where client_id = :cid and active = &#39;t&#39; order by name) q\n#{unless (&quot;office_id in (#{get_data_filters(@authorized_user, @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;Call Center&quot;]).id)})&quot; or &quot;&quot;).blank? then   &quot;where #{(&quot;office_id in (#{get_data_filters(@authorized_user, @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;Call Center&quot;]).id)})&quot; or &quot;&quot;)}&quot; end};\n&quot;, { :cid =&gt; @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;Call Center&quot;]).id }])</span></span><table id='context83' class='context' style='display:none'><caption>app/controllers/api/miscellaneous_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>963</pre>
          </td>
          <td class='context'>
            <pre class='context'>				SQL</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>965</pre>
            </td>
            <td class='context'>
              <pre class='context'>			fcs = Office.find_by_sql [&lt;&lt;~SQL, {:cid =&gt; client.id}]</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>966</pre>
            </td>
            <td class='context'>
              <pre class='context'>				select office_id as id, name</pre>
            </td>
          </tr>
          <tr class='context alt near_error'>
            <td class='context_line'>
              <pre class='context'>967</pre>
            </td>
            <td class='context'>
              <pre class='context'>				from (select id as office_id, region_id, name from offices where client_id = :cid and active = &#39;t&#39; order by name) q</pre>
            </td>
          </tr>
          <tr class='context error'>
            <td class='context_line'>
              <pre class='context'>968</pre>
            </td>
            <td class='context'>
              <pre class='context'>				#{&quot;where #{ws}&quot; unless ws.blank?};</pre>
            </td>
          </tr>
          <tr class='context alt near_error'>
            <td class='context_line'>
              <pre class='context'>969</pre>
            </td>
            <td class='context'>
              <pre class='context'>				SQL</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>970</pre>
            </td>
            <td class='context'>
              <pre class='context'>			render :json =&gt; {status: &quot;success&quot;, data: rs, providers: prv, offices: fcs}</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>971</pre>
            </td>
            <td class='context'>
              <pre class='context'>		else</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>972</pre>
            </td>
            <td class='context'>
              <pre class='context'>			render :json =&gt; {status: &quot;error&quot;, message: &quot;You are not authorized to use the &#39;miscellaneous/callcenter_turning_65&#39; endpoint.&quot;}</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>973</pre>
            </td>
            <td class='context'>
              <pre class='context'>		end</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='high-confidence'>High</span></td>
      <td>Api::MiscellaneousController</td>
      <td>chronic_care_patients</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context85');toggle('message85');toggle('full_message85')" ><span id='message85' style='display:block'>Possible SQL injection near line 1012: ...</span><span id='full_message85' style='display:none'>Possible SQL injection near line 1012: <span class="code">General.find_by_sql([&quot;select distinct concat(hcp_f_name, &#39; &#39;, hcp_l_name) as pr\nfrom mv_patients\nwhere hcp_f_name is not null and hcp_l_name is not null and client_id = :cid\n#{unless (&quot;office_id in (#{get_data_filters(@authorized_user, @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;Call Center&quot;]).id)})&quot; or &quot;&quot;).blank? then   &quot;and #{(&quot;office_id in (#{get_data_filters(@authorized_user, @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;Call Center&quot;]).id)})&quot; or &quot;&quot;)}&quot; end}\norder by pr\n&quot;, { :cid =&gt; @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;Call Center&quot;]).id }])</span></span><table id='context85' class='context' style='display:none'><caption>app/controllers/api/miscellaneous_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>1008</pre>
          </td>
          <td class='context'>
            <pre class='context'>			prv = General.find_by_sql [&lt;&lt;~SQL, {:cid =&gt; client.id}]</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1009</pre>
            </td>
            <td class='context'>
              <pre class='context'>				select distinct concat(hcp_f_name, &#39; &#39;, hcp_l_name) as pr</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1010</pre>
            </td>
            <td class='context'>
              <pre class='context'>				from mv_patients</pre>
            </td>
          </tr>
          <tr class='context alt near_error'>
            <td class='context_line'>
              <pre class='context'>1011</pre>
            </td>
            <td class='context'>
              <pre class='context'>				where hcp_f_name is not null and hcp_l_name is not null and client_id = :cid</pre>
            </td>
          </tr>
          <tr class='context error'>
            <td class='context_line'>
              <pre class='context'>1012</pre>
            </td>
            <td class='context'>
              <pre class='context'>				#{&quot;and #{ws}&quot; unless ws.blank?}</pre>
            </td>
          </tr>
          <tr class='context alt near_error'>
            <td class='context_line'>
              <pre class='context'>1013</pre>
            </td>
            <td class='context'>
              <pre class='context'>				order by pr</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1014</pre>
            </td>
            <td class='context'>
              <pre class='context'>				SQL</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1015</pre>
            </td>
            <td class='context'>
              <pre class='context'>			render :json =&gt; {status: &quot;success&quot;, data: rs, providers: prv}</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1016</pre>
            </td>
            <td class='context'>
              <pre class='context'>		else</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1017</pre>
            </td>
            <td class='context'>
              <pre class='context'>			render :json =&gt; {status: &quot;error&quot;, message: &quot;You are not authorized to use the &#39;miscellaneous/chronic_care_patients&#39; endpoint.&quot;}</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='high-confidence'>High</span></td>
      <td>Api::MiscellaneousController</td>
      <td>direct_mail_leads_data</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context86');toggle('message86');toggle('full_message86')" ><span id='message86' style='display:block'>Possible SQL injection near line 1069: ...</span><span id='full_message86' style='display:none'>Possible SQL injection near line 1069: <span class="code">General.find_by_sql([&quot;select r.name as key, sum(leads)::integer as value\nfrom cr_geo_counts cl join office_crs oc on oc.id = cl.office_cr_id join offices o on o.id = oc.office_id and o.client_id = cl.client_id join regions r on r.id = o.region_id\nwhere o.client_id = :cid and o.active = &#39;t&#39; and oc.priority in (1,2) #{if ((&quot;o.id in (#{get_data_filters(@authorized_user, @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;User&quot;]).id)})&quot; or &quot;&quot;).length &gt; 0) then   (&quot;and &quot; + (&quot;o.id in (#{get_data_filters(@authorized_user, @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;User&quot;]).id)})&quot; or &quot;&quot;)) end} group by r.name order by r.name;\n&quot;, { :cid =&gt; @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;User&quot;]).id }])</span></span><table id='context86' class='context' style='display:none'><caption>app/controllers/api/miscellaneous_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>1064</pre>
          </td>
          <td class='context'>
            <pre class='context'>				fq = df.length &gt; 0 ? &quot;o.id in (#{df})&quot; : &quot;&quot;</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1065</pre>
            </td>
            <td class='context'>
              <pre class='context'>				# leads by region and total</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1066</pre>
            </td>
            <td class='context'>
              <pre class='context'>				rs = General.find_by_sql [&lt;&lt;~SQL, {:cid =&gt; client.id}]</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1067</pre>
            </td>
            <td class='context'>
              <pre class='context'>					select r.name as key, sum(leads)::integer as value</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>1068</pre>
            </td>
            <td class='context'>
              <pre class='context'>					from cr_geo_counts cl join office_crs oc on oc.id = cl.office_cr_id join offices o on o.id = oc.office_id and o.client_id = cl.client_id join regions r on r.id = o.region_id</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>1069</pre>
            </td>
            <td class='context'>
              <pre class='context'>					where o.client_id = :cid and o.active = &#39;t&#39; and oc.priority in (1,2) #{&#39;and &#39; + fq if fq.length &gt; 0} group by r.name order by r.name;</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>1070</pre>
            </td>
            <td class='context'>
              <pre class='context'>					SQL</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1071</pre>
            </td>
            <td class='context'>
              <pre class='context'>				od[:leads_by_region] = {cols: [{label: &quot;Region&quot;, type: &quot;string&quot;}, {label: &quot;Leads&quot;, type: &quot;number&quot;}], rows: rs.as_json(:only =&gt; [:key, :value]), total: rs.sum(&amp;:value) }</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1072</pre>
            </td>
            <td class='context'>
              <pre class='context'>				# leads heatmap</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1073</pre>
            </td>
            <td class='context'>
              <pre class='context'>				rs = General.find_by_sql [&lt;&lt;~SQL, {:cid =&gt; client.id}]</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1074</pre>
            </td>
            <td class='context'>
              <pre class='context'>					select gc.zip, trunc(avg(gc.lat)::numeric,3)::float as lat, trunc(avg(gc.lon)::numeric,3)::float as lon, sum(gc.leads)::integer as weight</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='high-confidence'>High</span></td>
      <td>Api::MiscellaneousController</td>
      <td>direct_mail_leads_data</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context87');toggle('message87');toggle('full_message87')" ><span id='message87' style='display:block'>Possible SQL injection near line 1077: ...</span><span id='full_message87' style='display:none'>Possible SQL injection near line 1077: <span class="code">General.find_by_sql([&quot;select gc.zip, trunc(avg(gc.lat)::numeric,3)::float as lat, trunc(avg(gc.lon)::numeric,3)::float as lon, sum(gc.leads)::integer as weight\nfrom cr_geo_counts gc\njoin offices o on o.id = gc.office_id\nwhere gc.client_id = :cid #{if ((&quot;o.id in (#{get_data_filters(@authorized_user, @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;User&quot;]).id)})&quot; or &quot;&quot;).length &gt; 0) then   (&quot;and &quot; + (&quot;o.id in (#{get_data_filters(@authorized_user, @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;User&quot;]).id)})&quot; or &quot;&quot;)) end}\ngroup by gc.zip;\n&quot;, { :cid =&gt; @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;User&quot;]).id }])</span></span><table id='context87' class='context' style='display:none'><caption>app/controllers/api/miscellaneous_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>1072</pre>
          </td>
          <td class='context'>
            <pre class='context'>				# leads heatmap</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1073</pre>
            </td>
            <td class='context'>
              <pre class='context'>				rs = General.find_by_sql [&lt;&lt;~SQL, {:cid =&gt; client.id}]</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1074</pre>
            </td>
            <td class='context'>
              <pre class='context'>					select gc.zip, trunc(avg(gc.lat)::numeric,3)::float as lat, trunc(avg(gc.lon)::numeric,3)::float as lon, sum(gc.leads)::integer as weight</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1075</pre>
            </td>
            <td class='context'>
              <pre class='context'>					from cr_geo_counts gc</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>1076</pre>
            </td>
            <td class='context'>
              <pre class='context'>					join offices o on o.id = gc.office_id</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>1077</pre>
            </td>
            <td class='context'>
              <pre class='context'>					where gc.client_id = :cid #{&#39;and &#39; + fq if fq.length &gt; 0}</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>1078</pre>
            </td>
            <td class='context'>
              <pre class='context'>					group by gc.zip;</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1079</pre>
            </td>
            <td class='context'>
              <pre class='context'>				SQL</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1080</pre>
            </td>
            <td class='context'>
              <pre class='context'>				od[:leads_heatmap] = rs.as_json(:only =&gt; [:lat, :lon, :weight])</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1081</pre>
            </td>
            <td class='context'>
              <pre class='context'>				# frequency table</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1082</pre>
            </td>
            <td class='context'>
              <pre class='context'>				rs = General.find_by_sql [&lt;&lt;~SQL, {:cid =&gt; client.id}]</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='high-confidence'>High</span></td>
      <td>Api::MiscellaneousController</td>
      <td>direct_mail_leads_data</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context88');toggle('message88');toggle('full_message88')" ><span id='message88' style='display:block'>Possible SQL injection near line 1087: ...</span><span id='full_message88' style='display:none'>Possible SQL injection near line 1087: <span class="code">General.find_by_sql([&quot;with lq as\n\t(select sum(leads) as leads\n\tfrom cr_geo_counts gc\n\tjoin offices o on o.id = gc.office_id\n\twhere gc.client_id = :cid #{if ((&quot;o.id in (#{get_data_filters(@authorized_user, @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;User&quot;]).id)})&quot; or &quot;&quot;).length &gt; 0) then   (&quot;and &quot; + (&quot;o.id in (#{get_data_filters(@authorized_user, @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;User&quot;]).id)})&quot; or &quot;&quot;)) end})\nselect mpm, case when mpm = 0 then 0 else leads::float / mpm end as mpt, case when leads = 0 then 0 else mpm::float * 12 / leads end as tpy from lq, (select coalesce(sum(quantity) / 12, 0) as mpm\n\tfrom media_buys mb\n\tjoin media_buys_offices mo on mo.media_buy_id = mb.id\n\tjoin offices o on o.id = mo.office_id\n\twhere mb.client_id = :cid #{if ((&quot;o.id in (#{get_data_filters(@authorized_user, @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;User&quot;]).id)})&quot; or &quot;&quot;).length &gt; 0) then   (&quot;and &quot; + (&quot;o.id in (#{get_data_filters(@authorized_user, @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;User&quot;]).id)})&quot; or &quot;&quot;)) end} and (started_at + interval &#39;12 month&#39;) &gt;= now() and started_at &lt; now() ) mq1\nunion all\nselect mpm, case when mpm = 0 then 0 else leads::float / mpm end as mpt, case when leads = 0 then 0 else mpm::float * 12 / leads end as tpy from lq, (select coalesce(sum(quantity), 0) as mpm\n\tfrom media_buys mb\n\tjoin media_buys_offices mo on mo.media_buy_id = mb.id\n\tjoin offices o on o.id = mo.office_id\n\twhere mb.client_id = :cid #{if ((&quot;o.id in (#{get_data_filters(@authorized_user, @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;User&quot;]).id)})&quot; or &quot;&quot;).length &gt; 0) then   (&quot;and &quot; + (&quot;o.id in (#{get_data_filters(@authorized_user, @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;User&quot;]).id)})&quot; or &quot;&quot;)) end} and started_at between date_trunc(&#39;month&#39;, now()) - interval &#39;1 month&#39; and date_trunc(&#39;month&#39;, now()) - interval &#39;1 day&#39;) mq2\nunion all\nselect mpm, case when mpm = 0 then 0 else leads::float / mpm end as mpt, case when leads = 0 then 0 else mpm::float * 12 / leads end as tpy from lq, (select coalesce(sum(quantity), 0) as mpm\n\tfrom media_buys mb\n\tjoin media_buys_offices mo on mo.media_buy_id = mb.id\n\tjoin offices o on o.id = mo.office_id\n\twhere mb.client_id = :cid #{if ((&quot;o.id in (#{get_data_filters(@authorized_user, @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;User&quot;]).id)})&quot; or &quot;&quot;).length &gt; 0) then   (&quot;and &quot; + (&quot;o.id in (#{get_data_filters(@authorized_user, @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;User&quot;]).id)})&quot; or &quot;&quot;)) end} and started_at between date_trunc(&#39;month&#39;, now()) and date_trunc(&#39;month&#39;, now()) + interval &#39;1 month&#39; - interval &#39;1 day&#39;) mq3;\n&quot;, { :cid =&gt; @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;User&quot;]).id }])</span></span><table id='context88' class='context' style='display:none'><caption>app/controllers/api/miscellaneous_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>1082</pre>
          </td>
          <td class='context'>
            <pre class='context'>				rs = General.find_by_sql [&lt;&lt;~SQL, {:cid =&gt; client.id}]</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1083</pre>
            </td>
            <td class='context'>
              <pre class='context'>					with lq as</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1084</pre>
            </td>
            <td class='context'>
              <pre class='context'>						(select sum(leads) as leads</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1085</pre>
            </td>
            <td class='context'>
              <pre class='context'>						from cr_geo_counts gc</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>1086</pre>
            </td>
            <td class='context'>
              <pre class='context'>						join offices o on o.id = gc.office_id</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>1087</pre>
            </td>
            <td class='context'>
              <pre class='context'>						where gc.client_id = :cid #{&#39;and &#39; + fq if fq.length &gt; 0})</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>1088</pre>
            </td>
            <td class='context'>
              <pre class='context'>					select mpm, case when mpm = 0 then 0 else leads::float / mpm end as mpt, case when leads = 0 then 0 else mpm::float * 12 / leads end as tpy from lq, (select coalesce(sum(quantity) / 12, 0) as mpm</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1089</pre>
            </td>
            <td class='context'>
              <pre class='context'>						from media_buys mb</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1090</pre>
            </td>
            <td class='context'>
              <pre class='context'>						join media_buys_offices mo on mo.media_buy_id = mb.id</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1091</pre>
            </td>
            <td class='context'>
              <pre class='context'>						join offices o on o.id = mo.office_id</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1092</pre>
            </td>
            <td class='context'>
              <pre class='context'>						where mb.client_id = :cid #{&#39;and &#39; + fq if fq.length &gt; 0} and (started_at + interval &#39;12 month&#39;) &gt;= now() and started_at &lt; now() ) mq1</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='high-confidence'>High</span></td>
      <td>Api::MiscellaneousController</td>
      <td>direct_mail_leads_data</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context89');toggle('message89');toggle('full_message89')" ><span id='message89' style='display:block'>Possible SQL injection near line 1115: ...</span><span id='full_message89' style='display:none'>Possible SQL injection near line 1115: <span class="code">General.find_by_sql([&quot;select to_char(started_at, &#39;YYYY-MM-DD&#39;) as key, sum(quantity) as value\nfrom media_buys mb\njoin media_buys_offices mo on mo.media_buy_id = mb.id\njoin offices o on o.id = mo.office_id\nwhere mb.client_id = :cid #{if ((&quot;o.id in (#{get_data_filters(@authorized_user, @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;User&quot;]).id)})&quot; or &quot;&quot;).length &gt; 0) then   (&quot;and &quot; + (&quot;o.id in (#{get_data_filters(@authorized_user, @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;User&quot;]).id)})&quot; or &quot;&quot;)) end} and (started_at + interval &#39;12 month&#39;) &gt;= now()\ngroup by started_at order by started_at;\n&quot;, { :cid =&gt; @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;User&quot;]).id }])</span></span><table id='context89' class='context' style='display:none'><caption>app/controllers/api/miscellaneous_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>1110</pre>
          </td>
          <td class='context'>
            <pre class='context'>				rs = General.find_by_sql [&lt;&lt;~SQL, {:cid =&gt; client.id}]</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1111</pre>
            </td>
            <td class='context'>
              <pre class='context'>					select to_char(started_at, &#39;YYYY-MM-DD&#39;) as key, sum(quantity) as value</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1112</pre>
            </td>
            <td class='context'>
              <pre class='context'>					from media_buys mb</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1113</pre>
            </td>
            <td class='context'>
              <pre class='context'>					join media_buys_offices mo on mo.media_buy_id = mb.id</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>1114</pre>
            </td>
            <td class='context'>
              <pre class='context'>					join offices o on o.id = mo.office_id</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>1115</pre>
            </td>
            <td class='context'>
              <pre class='context'>					where mb.client_id = :cid #{&#39;and &#39; + fq if fq.length &gt; 0} and (started_at + interval &#39;12 month&#39;) &gt;= now()</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>1116</pre>
            </td>
            <td class='context'>
              <pre class='context'>					group by started_at order by started_at;</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1117</pre>
            </td>
            <td class='context'>
              <pre class='context'>				SQL</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1118</pre>
            </td>
            <td class='context'>
              <pre class='context'>				rs.each { |d| begin dy[d.key] += d.value; rescue; end }</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1119</pre>
            </td>
            <td class='context'>
              <pre class='context'>				ot = []</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1120</pre>
            </td>
            <td class='context'>
              <pre class='context'>				dy.each_pair { |k, v| ot &lt;&lt; {key: k, value: v} }</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='high-confidence'>High</span></td>
      <td>Api::MiscellaneousController</td>
      <td>direct_mail_leads_data</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context90');toggle('message90');toggle('full_message90')" ><span id='message90' style='display:block'>Possible SQL injection near line 1127: ...</span><span id='full_message90' style='display:none'>Possible SQL injection near line 1127: <span class="code">General.find_by_sql([&quot;select age as key, sum(mailed) as value\nfrom zip_mailed_names mn\njoin offices o on o.id = mn.office_id\nwhere mn.client_id = :cid #{if ((&quot;o.id in (#{get_data_filters(@authorized_user, @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;User&quot;]).id)})&quot; or &quot;&quot;).length &gt; 0) then   (&quot;and &quot; + (&quot;o.id in (#{get_data_filters(@authorized_user, @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;User&quot;]).id)})&quot; or &quot;&quot;)) end} and age between 50 and 110\ngroup by age order by age;\n&quot;, { :cid =&gt; @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;User&quot;]).id }])</span></span><table id='context90' class='context' style='display:none'><caption>app/controllers/api/miscellaneous_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>1122</pre>
          </td>
          <td class='context'>
            <pre class='context'>				# mailed by age</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1123</pre>
            </td>
            <td class='context'>
              <pre class='context'>				rs = General.find_by_sql [&lt;&lt;~SQL, {:cid =&gt; client.id}]</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1124</pre>
            </td>
            <td class='context'>
              <pre class='context'>					select age as key, sum(mailed) as value</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1125</pre>
            </td>
            <td class='context'>
              <pre class='context'>					from zip_mailed_names mn</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>1126</pre>
            </td>
            <td class='context'>
              <pre class='context'>					join offices o on o.id = mn.office_id</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>1127</pre>
            </td>
            <td class='context'>
              <pre class='context'>					where mn.client_id = :cid #{&#39;and &#39; + fq if fq.length &gt; 0} and age between 50 and 110</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>1128</pre>
            </td>
            <td class='context'>
              <pre class='context'>					group by age order by age;</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1129</pre>
            </td>
            <td class='context'>
              <pre class='context'>				SQL</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1130</pre>
            </td>
            <td class='context'>
              <pre class='context'>				od[:mailed_by_age] = {cols: [{label: &quot;Age&quot;, type: &quot;number&quot;}, {label: &quot;Mailed&quot;, type: &quot;number&quot;}], rows: rs.as_json(:only =&gt; [:key, :value]) }</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1131</pre>
            </td>
            <td class='context'>
              <pre class='context'>				# mailed by income</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1132</pre>
            </td>
            <td class='context'>
              <pre class='context'>				rs = General.find_by_sql [&lt;&lt;~SQL, {:cid =&gt; client.id}]</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='high-confidence'>High</span></td>
      <td>Api::MiscellaneousController</td>
      <td>direct_mail_leads_data</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context91');toggle('message91');toggle('full_message91')" ><span id='message91' style='display:block'>Possible SQL injection near line 1136: ...</span><span id='full_message91' style='display:none'>Possible SQL injection near line 1136: <span class="code">General.find_by_sql([&quot;select income as key, sum(mailed) as value\nfrom zip_mailed_names mn\njoin offices o on o.id = mn.office_id\nwhere mn.client_id = :cid #{if ((&quot;o.id in (#{get_data_filters(@authorized_user, @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;User&quot;]).id)})&quot; or &quot;&quot;).length &gt; 0) then   (&quot;and &quot; + (&quot;o.id in (#{get_data_filters(@authorized_user, @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;User&quot;]).id)})&quot; or &quot;&quot;)) end} and income != &#39;&#39;\ngroup by income\norder by substring(income from 2 for position(&#39; &#39; in income) - 2)::integer;\n&quot;, { :cid =&gt; @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;User&quot;]).id }])</span></span><table id='context91' class='context' style='display:none'><caption>app/controllers/api/miscellaneous_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>1131</pre>
          </td>
          <td class='context'>
            <pre class='context'>				# mailed by income</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1132</pre>
            </td>
            <td class='context'>
              <pre class='context'>				rs = General.find_by_sql [&lt;&lt;~SQL, {:cid =&gt; client.id}]</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1133</pre>
            </td>
            <td class='context'>
              <pre class='context'>					select income as key, sum(mailed) as value</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1134</pre>
            </td>
            <td class='context'>
              <pre class='context'>					from zip_mailed_names mn</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>1135</pre>
            </td>
            <td class='context'>
              <pre class='context'>					join offices o on o.id = mn.office_id</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>1136</pre>
            </td>
            <td class='context'>
              <pre class='context'>					where mn.client_id = :cid #{&#39;and &#39; + fq if fq.length &gt; 0} and income != &#39;&#39;</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>1137</pre>
            </td>
            <td class='context'>
              <pre class='context'>					group by income</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1138</pre>
            </td>
            <td class='context'>
              <pre class='context'>					order by substring(income from 2 for position(&#39; &#39; in income) - 2)::integer;</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1139</pre>
            </td>
            <td class='context'>
              <pre class='context'>				SQL</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1140</pre>
            </td>
            <td class='context'>
              <pre class='context'>				od[:mailed_by_income] = {cols: [{label: &quot;Income&quot;, type: &quot;string&quot;}, {label: &quot;Mailed&quot;, type: &quot;number&quot;}], rows: rs.as_json(:only =&gt; [:key, :value]) }</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1141</pre>
            </td>
            <td class='context'>
              <pre class='context'>				od</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='high-confidence'>High</span></td>
      <td>Api::MiscellaneousController</td>
      <td>roi_campaign_summary_prospects</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context92');toggle('message92');toggle('full_message92')" ><span id='message92' style='display:block'>Possible SQL injection near line 1603: ...</span><span id='full_message92' style='display:none'>Possible SQL injection near line 1603: <span class="code">General.find_by_sql([&quot;select distinct rc.event_month, rc.campaign_type, rc.campaign, rc.campaign_id, rc.is_creative, rc.media_buy_id, rc.offices, rc.event_date, rc.total_cost, rc.impressions, rc.calls, rc.prospects, rc.appointments\nfrom mv_roi_campaigns rc\njoin media_buys mb on mb.id = rc.media_buy_id\njoin media_buys_offices mo on mo.media_buy_id = mb.id\njoin offices on offices.id = mo.office_id\njoin regions on regions.id = offices.region_id\nwhere rc.client_id = :cid and pool_id in (select id from pools where name in (&#39;Lead&#39;)) and media_type = &#39;Direct Mail&#39; #{if (((&quot;offices.id in (#{get_data_filters(@authorized_user, @authorized_user.authorized_client(params[:client_id], [&quot;Administrator&quot;, &quot;User&quot;]).id)})&quot; or &quot;&quot;) or &quot;offices.id in (#{Sanitize.id_list(<span class="user_input">params[&quot;office_ids&quot;]</span>)})&quot;).length &gt; 0) then   (&quot;and &quot; + ((&quot;offices.id in (#{get_data_filters(@authorized_user, @authorized_user.authorized_client(params[:client_id], [&quot;Administrator&quot;, &quot;User&quot;]).id)})&quot; or &quot;&quot;) or &quot;offices.id in (#{Sanitize.id_list(<span class="user_input">params[&quot;office_ids&quot;]</span>)})&quot;)) end} and event_date::timestamp &gt; date_trunc(&#39;month&#39;, now()) - interval &#39;6 months&#39;\norder by rc.event_month desc, rc.campaign_type, rc.offices, rc.campaign, rc.media_buy_id;\n&quot;, { :cid =&gt; @authorized_user.authorized_client(params[:client_id], [&quot;Administrator&quot;, &quot;User&quot;]).id }])</span></span><table id='context92' class='context' style='display:none'><caption>app/controllers/api/miscellaneous_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>1598</pre>
          </td>
          <td class='context'>
            <pre class='context'>					from mv_roi_campaigns rc</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1599</pre>
            </td>
            <td class='context'>
              <pre class='context'>					join media_buys mb on mb.id = rc.media_buy_id</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1600</pre>
            </td>
            <td class='context'>
              <pre class='context'>					join media_buys_offices mo on mo.media_buy_id = mb.id</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1601</pre>
            </td>
            <td class='context'>
              <pre class='context'>					join offices on offices.id = mo.office_id</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>1602</pre>
            </td>
            <td class='context'>
              <pre class='context'>					join regions on regions.id = offices.region_id</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>1603</pre>
            </td>
            <td class='context'>
              <pre class='context'>					where rc.client_id = :cid and pool_id in (select id from pools where name in (&#39;Lead&#39;)) and media_type = &#39;Direct Mail&#39; #{&#39;and &#39; + qs if qs.length &gt; 0} and event_date::timestamp &gt; date_trunc(&#39;month&#39;, now()) - interval &#39;6 months&#39;</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>1604</pre>
            </td>
            <td class='context'>
              <pre class='context'>					order by rc.event_month desc, rc.campaign_type, rc.offices, rc.campaign, rc.media_buy_id;</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1605</pre>
            </td>
            <td class='context'>
              <pre class='context'>				SQL</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1606</pre>
            </td>
            <td class='context'>
              <pre class='context'>				dt[:roi] = process_roi_summary rs</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1607</pre>
            </td>
            <td class='context'>
              <pre class='context'>				dt = dt.merge(roi_filter_info client.id, qs) if params[:first] == &quot;true&quot;</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1608</pre>
            </td>
            <td class='context'>
              <pre class='context'>				dt</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='high-confidence'>High</span></td>
      <td>Api::MiscellaneousController</td>
      <td>roi_campaign_summary_customers</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context93');toggle('message93');toggle('full_message93')" ><span id='message93' style='display:block'>Possible SQL injection near line 1633: ...</span><span id='full_message93' style='display:none'>Possible SQL injection near line 1633: <span class="code">General.find_by_sql([&quot;select distinct rc.event_month, rc.campaign_type, rc.campaign, rc.campaign_id, rc.is_creative, rc.media_buy_id, rc.offices, rc.event_date, rc.total_cost, rc.impressions, rc.calls, rc.prospects, rc.appointments\nfrom mv_roi_campaigns rc\njoin media_buys mb on mb.id = rc.media_buy_id\njoin media_buys_offices mo on mo.media_buy_id = mb.id\njoin offices on offices.id = mo.office_id\njoin regions on regions.id = offices.region_id\nwhere rc.client_id = :cid and pool_id in (select id from pools where name in (&#39;Prospect&#39;,&#39;Customer&#39;)) and media_type = &#39;Direct Mail&#39; #{if (((&quot;offices.id in (#{get_data_filters(@authorized_user, @authorized_user.authorized_client(params[:client_id], [&quot;Administrator&quot;, &quot;User&quot;]).id)})&quot; or &quot;&quot;) or &quot;offices.id in (#{Sanitize.id_list(<span class="user_input">params[&quot;office_ids&quot;]</span>)})&quot;).length &gt; 0) then   (&quot;and &quot; + ((&quot;offices.id in (#{get_data_filters(@authorized_user, @authorized_user.authorized_client(params[:client_id], [&quot;Administrator&quot;, &quot;User&quot;]).id)})&quot; or &quot;&quot;) or &quot;offices.id in (#{Sanitize.id_list(<span class="user_input">params[&quot;office_ids&quot;]</span>)})&quot;)) end} and event_date::timestamp &gt; date_trunc(&#39;month&#39;, now()) - interval &#39;6 months&#39;\norder by rc.event_month desc, rc.campaign_type, rc.offices, rc.campaign, rc.media_buy_id;\n&quot;, { :cid =&gt; @authorized_user.authorized_client(params[:client_id], [&quot;Administrator&quot;, &quot;User&quot;]).id }])</span></span><table id='context93' class='context' style='display:none'><caption>app/controllers/api/miscellaneous_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>1628</pre>
          </td>
          <td class='context'>
            <pre class='context'>					from mv_roi_campaigns rc</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1629</pre>
            </td>
            <td class='context'>
              <pre class='context'>					join media_buys mb on mb.id = rc.media_buy_id</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1630</pre>
            </td>
            <td class='context'>
              <pre class='context'>					join media_buys_offices mo on mo.media_buy_id = mb.id</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1631</pre>
            </td>
            <td class='context'>
              <pre class='context'>					join offices on offices.id = mo.office_id</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>1632</pre>
            </td>
            <td class='context'>
              <pre class='context'>					join regions on regions.id = offices.region_id</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>1633</pre>
            </td>
            <td class='context'>
              <pre class='context'>					where rc.client_id = :cid and pool_id in (select id from pools where name in (&#39;Prospect&#39;,&#39;Customer&#39;)) and media_type = &#39;Direct Mail&#39; #{&#39;and &#39; + qs if qs.length &gt; 0} and event_date::timestamp &gt; date_trunc(&#39;month&#39;, now()) - interval &#39;6 months&#39;</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>1634</pre>
            </td>
            <td class='context'>
              <pre class='context'>					order by rc.event_month desc, rc.campaign_type, rc.offices, rc.campaign, rc.media_buy_id;</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1635</pre>
            </td>
            <td class='context'>
              <pre class='context'>				SQL</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1636</pre>
            </td>
            <td class='context'>
              <pre class='context'>				dt[:roi] = process_roi_summary rs</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1637</pre>
            </td>
            <td class='context'>
              <pre class='context'>				dt = dt.merge(roi_filter_info client.id, qs) if params[:first] == &quot;true&quot;</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1638</pre>
            </td>
            <td class='context'>
              <pre class='context'>				dt</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='high-confidence'>High</span></td>
      <td>Api::MiscellaneousController</td>
      <td>roi_campaign_summary_newspapers</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context94');toggle('message94');toggle('full_message94')" ><span id='message94' style='display:block'>Possible SQL injection near line 1663: ...</span><span id='full_message94' style='display:none'>Possible SQL injection near line 1663: <span class="code">General.find_by_sql([&quot;select distinct rc.event_month, rc.campaign_type, rc.campaign, rc.campaign_id, rc.is_creative, rc.media_buy_id, rc.offices, rc.event_date, rc.total_cost, rc.impressions, rc.calls, rc.prospects, rc.appointments\nfrom mv_roi_campaigns rc\njoin media_buys mb on mb.id = rc.media_buy_id\njoin media_buys_offices mo on mo.media_buy_id = mb.id\njoin offices on offices.id = mo.office_id\njoin regions on regions.id = offices.region_id\nwhere rc.client_id = :cid and pool_id in (select id from pools where name in (&#39;Lead&#39;)) and media_type = &#39;Newspaper&#39; #{if (((&quot;offices.id in (#{get_data_filters(@authorized_user, @authorized_user.authorized_client(params[:client_id], [&quot;Administrator&quot;, &quot;User&quot;]).id)})&quot; or &quot;&quot;) or &quot;offices.id in (#{Sanitize.id_list(<span class="user_input">params[&quot;office_ids&quot;]</span>)})&quot;).length &gt; 0) then   (&quot;and &quot; + ((&quot;offices.id in (#{get_data_filters(@authorized_user, @authorized_user.authorized_client(params[:client_id], [&quot;Administrator&quot;, &quot;User&quot;]).id)})&quot; or &quot;&quot;) or &quot;offices.id in (#{Sanitize.id_list(<span class="user_input">params[&quot;office_ids&quot;]</span>)})&quot;)) end} and event_date::timestamp &gt; date_trunc(&#39;month&#39;, now()) - interval &#39;6 months&#39;\norder by rc.event_month desc, rc.campaign_type, rc.offices, rc.campaign, rc.media_buy_id;\n&quot;, { :cid =&gt; @authorized_user.authorized_client(params[:client_id], [&quot;Administrator&quot;, &quot;User&quot;]).id }])</span></span><table id='context94' class='context' style='display:none'><caption>app/controllers/api/miscellaneous_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>1658</pre>
          </td>
          <td class='context'>
            <pre class='context'>					from mv_roi_campaigns rc</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1659</pre>
            </td>
            <td class='context'>
              <pre class='context'>					join media_buys mb on mb.id = rc.media_buy_id</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1660</pre>
            </td>
            <td class='context'>
              <pre class='context'>					join media_buys_offices mo on mo.media_buy_id = mb.id</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1661</pre>
            </td>
            <td class='context'>
              <pre class='context'>					join offices on offices.id = mo.office_id</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>1662</pre>
            </td>
            <td class='context'>
              <pre class='context'>					join regions on regions.id = offices.region_id</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>1663</pre>
            </td>
            <td class='context'>
              <pre class='context'>					where rc.client_id = :cid and pool_id in (select id from pools where name in (&#39;Lead&#39;)) and media_type = &#39;Newspaper&#39; #{&#39;and &#39; + qs if qs.length &gt; 0} and event_date::timestamp &gt; date_trunc(&#39;month&#39;, now()) - interval &#39;6 months&#39;</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>1664</pre>
            </td>
            <td class='context'>
              <pre class='context'>					order by rc.event_month desc, rc.campaign_type, rc.offices, rc.campaign, rc.media_buy_id;</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1665</pre>
            </td>
            <td class='context'>
              <pre class='context'>				SQL</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1666</pre>
            </td>
            <td class='context'>
              <pre class='context'>				dt[:roi] = process_roi_summary rs</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1667</pre>
            </td>
            <td class='context'>
              <pre class='context'>				dt = dt.merge(roi_filter_info client.id, qs) if params[:first] == &quot;true&quot;</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1668</pre>
            </td>
            <td class='context'>
              <pre class='context'>				dt</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='high-confidence'>High</span></td>
      <td>Api::MiscellaneousController</td>
      <td>roi_campaign_summary_online</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context95');toggle('message95');toggle('full_message95')" ><span id='message95' style='display:block'>Possible SQL injection near line 1744: ...</span><span id='full_message95' style='display:none'>Possible SQL injection near line 1744: <span class="code">General.find_by_sql([&quot;select ro.event_month, ro.campaign_type, ro.office, ro.cost, ro.calls, ro.forms, ro.appts\nfrom mv_roi_online ro\nleft join offices on offices.id = ro.office_id\nwhere ro.client_id = :cid\n#{if ((&quot;&quot; or &quot;offices.id in (#{((get_data_filters(@authorized_user, @authorized_user.authorized_client(params[:client_id], [&quot;Administrator&quot;, &quot;User&quot;]).id).split(&quot;,&quot;) or (Sanitize.id_list(<span class="user_input">params[&quot;office_ids&quot;]</span>).split(&quot;,&quot;) or [])) &amp; (Sanitize.id_list(<span class="user_input">params[&quot;office_ids&quot;]</span>).split(&quot;,&quot;) or [])).join(&quot;,&quot;)})&quot;).length &gt; 0) then   (&quot;and &quot; + (&quot;&quot; or &quot;offices.id in (#{((get_data_filters(@authorized_user, @authorized_user.authorized_client(params[:client_id], [&quot;Administrator&quot;, &quot;User&quot;]).id).split(&quot;,&quot;) or (Sanitize.id_list(<span class="user_input">params[&quot;office_ids&quot;]</span>).split(&quot;,&quot;) or [])) &amp; (Sanitize.id_list(<span class="user_input">params[&quot;office_ids&quot;]</span>).split(&quot;,&quot;) or [])).join(&quot;,&quot;)})&quot;)) end}\norder by event_month desc, campaign_type, office;\n&quot;, { :cid =&gt; @authorized_user.authorized_client(params[:client_id], [&quot;Administrator&quot;, &quot;User&quot;]).id }])</span></span><table id='context95' class='context' style='display:none'><caption>app/controllers/api/miscellaneous_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>1739</pre>
          </td>
          <td class='context'>
            <pre class='context'>				rs = General.find_by_sql [&lt;&lt;~SQL, {:cid =&gt; client.id}]</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1740</pre>
            </td>
            <td class='context'>
              <pre class='context'>					select ro.event_month, ro.campaign_type, ro.office, ro.cost, ro.calls, ro.forms, ro.appts</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1741</pre>
            </td>
            <td class='context'>
              <pre class='context'>					from mv_roi_online ro</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1742</pre>
            </td>
            <td class='context'>
              <pre class='context'>					left join offices on offices.id = ro.office_id</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>1743</pre>
            </td>
            <td class='context'>
              <pre class='context'>					where ro.client_id = :cid</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>1744</pre>
            </td>
            <td class='context'>
              <pre class='context'>					#{&#39;and &#39; + qs if qs.length &gt; 0}</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>1745</pre>
            </td>
            <td class='context'>
              <pre class='context'>					order by event_month desc, campaign_type, office;</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1746</pre>
            </td>
            <td class='context'>
              <pre class='context'>				SQL</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1747</pre>
            </td>
            <td class='context'>
              <pre class='context'>				dt[:roi] = process_roi_online_summary rs</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1748</pre>
            </td>
            <td class='context'>
              <pre class='context'>				dt = dt.merge(roi_filter_info client.id, qs) if params[:first] == &quot;true&quot;</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1749</pre>
            </td>
            <td class='context'>
              <pre class='context'>				dt</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='high-confidence'>High</span></td>
      <td>Api::MiscellaneousController</td>
      <td>callcenter_acquisition</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context123');toggle('message123');toggle('full_message123')" ><span id='message123' style='display:block'>Possible SQL injection near line 648: ...</span><span id='full_message123' style='display:none'>Possible SQL injection near line 648: <span class="code">MediaBuy.where(:client_id =&gt; @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;Call Center&quot;]).id).where((&quot;offices.id in (#{get_data_filters(@authorized_user, @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;Call Center&quot;]).id)})&quot; or &quot;&quot;))</span></span><table id='context123' class='context' style='display:none'><caption>app/controllers/api/miscellaneous_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>643</pre>
          </td>
          <td class='context'>
            <pre class='context'>		client = @authorized_user&amp;.authorized_client(params[:client_id], [&quot;Administrator&quot;, &quot;Call Center&quot;])</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>644</pre>
            </td>
            <td class='context'>
              <pre class='context'>		if client</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>645</pre>
            </td>
            <td class='context'>
              <pre class='context'>			dt, fc = {}, []</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>646</pre>
            </td>
            <td class='context'>
              <pre class='context'>			df = get_data_filters(@authorized_user, client.id)</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>647</pre>
            </td>
            <td class='context'>
              <pre class='context'>			ws = df.length &gt; 0 ? &quot;offices.id in (#{df})&quot; : &quot;&quot;</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>648</pre>
            </td>
            <td class='context'>
              <pre class='context'>			mb = MediaBuy.where(client_id: client.id).where(ws).where(&quot;pools.name = &#39;Lead&#39;&quot;).joins(:campaign, {:campaign =&gt; :pool}, :offices).order(&quot;inhome_at desc, id desc&quot;).distinct</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>649</pre>
            </td>
            <td class='context'>
              <pre class='context'>			gm = params[:grid_month] ? params[:grid_month].to_i : 1</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>650</pre>
            </td>
            <td class='context'>
              <pre class='context'>			mb = mb.where(&quot;to_char(media_buys.started_at, &#39;YYYYMM&#39;) = ?&quot;, (Date.today + gm.months).at_beginning_of_month.strftime(&quot;%Y%m&quot;))</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>651</pre>
            </td>
            <td class='context'>
              <pre class='context'>			mb = mb.where(&quot;concat(extract(&#39;year&#39; from media_buys.started_at), lpad(extract(&#39;month&#39; from media_buys.started_at)::varchar(2), 2, &#39;0&#39;), &#39;01&#39;) = ?&quot;, params[:event_month].to_i.to_s) if params[:event_month]</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>652</pre>
            </td>
            <td class='context'>
              <pre class='context'>			mb = mb.where(&quot;offices.state = ?&quot;, params[:state][0..1]) if params[:state]</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>653</pre>
            </td>
            <td class='context'>
              <pre class='context'>			mb = mb.where(&quot;offices.id = ?&quot;, params[:office].to_i) if params[:office]</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='high-confidence'>High</span></td>
      <td>Api::MiscellaneousController</td>
      <td>callcenter_acquisition</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context125');toggle('message125');toggle('full_message125')" ><span id='message125' style='display:block'>Possible SQL injection near line 671: ...</span><span id='full_message125' style='display:none'>Possible SQL injection near line 671: <span class="code">Office.where(:client_id =&gt; @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;Call Center&quot;]).id, :active =&gt; true).where((&quot;offices.id in (#{get_data_filters(@authorized_user, @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;Call Center&quot;]).id)})&quot; or &quot;&quot;))</span></span><table id='context125' class='context' style='display:none'><caption>app/controllers/api/miscellaneous_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>666</pre>
          </td>
          <td class='context'>
            <pre class='context'>			if params[:first] and params[:first] == &quot;true&quot;</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>667</pre>
            </td>
            <td class='context'>
              <pre class='context'>				ot = []</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>668</pre>
            </td>
            <td class='context'>
              <pre class='context'>				MediaBuy.where(client_id: client.id).group(&quot;concat(extract(&#39;year&#39; from started_at), lpad(extract(&#39;month&#39; from started_at)::varchar(2), 2, &#39;0&#39;), &#39;01&#39;)&quot;).count.map{ |k,v| k.to_i }.sort.reverse.each{ |d| ot &lt;&lt; {:id =&gt; d, :name =&gt; Date.parse(d.to_s).strftime(&quot;%B %Y&quot;)} }</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>669</pre>
            </td>
            <td class='context'>
              <pre class='context'>				dt[:event_months] = ot</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>670</pre>
            </td>
            <td class='context'>
              <pre class='context'>				ot = []</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>671</pre>
            </td>
            <td class='context'>
              <pre class='context'>				Office.where(client_id: client.id, active: true).where(ws).select(&quot;distinct state&quot;).map(&amp;:state).sort.each{ |s| ot &lt;&lt; {:id =&gt; s, :name =&gt; usa_states_hash.merge(canada_province_hash)[s]} }</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>672</pre>
            </td>
            <td class='context'>
              <pre class='context'>				dt[:states] = ot</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>673</pre>
            </td>
            <td class='context'>
              <pre class='context'>				ot = []</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>674</pre>
            </td>
            <td class='context'>
              <pre class='context'>				Office.where(client_id: client.id, active: true).where(ws).select(&quot;offices.id, offices.name&quot;).group(&quot;offices.id, offices.name&quot;).each{ |o| ot &lt;&lt; {id: o.id, name: o.name}}</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>675</pre>
            </td>
            <td class='context'>
              <pre class='context'>				dt[:offices] = ot.sort{ |a,b| a[:name] &lt;=&gt; b[:name] }</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>676</pre>
            </td>
            <td class='context'>
              <pre class='context'>				ot = []</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='high-confidence'>High</span></td>
      <td>Api::MiscellaneousController</td>
      <td>callcenter_acquisition</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context126');toggle('message126');toggle('full_message126')" ><span id='message126' style='display:block'>Possible SQL injection near line 674: ...</span><span id='full_message126' style='display:none'>Possible SQL injection near line 674: <span class="code">Office.where(:client_id =&gt; @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;Call Center&quot;]).id, :active =&gt; true).where((&quot;offices.id in (#{get_data_filters(@authorized_user, @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;Call Center&quot;]).id)})&quot; or &quot;&quot;))</span></span><table id='context126' class='context' style='display:none'><caption>app/controllers/api/miscellaneous_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>669</pre>
          </td>
          <td class='context'>
            <pre class='context'>				dt[:event_months] = ot</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>670</pre>
            </td>
            <td class='context'>
              <pre class='context'>				ot = []</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>671</pre>
            </td>
            <td class='context'>
              <pre class='context'>				Office.where(client_id: client.id, active: true).where(ws).select(&quot;distinct state&quot;).map(&amp;:state).sort.each{ |s| ot &lt;&lt; {:id =&gt; s, :name =&gt; usa_states_hash.merge(canada_province_hash)[s]} }</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>672</pre>
            </td>
            <td class='context'>
              <pre class='context'>				dt[:states] = ot</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>673</pre>
            </td>
            <td class='context'>
              <pre class='context'>				ot = []</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>674</pre>
            </td>
            <td class='context'>
              <pre class='context'>				Office.where(client_id: client.id, active: true).where(ws).select(&quot;offices.id, offices.name&quot;).group(&quot;offices.id, offices.name&quot;).each{ |o| ot &lt;&lt; {id: o.id, name: o.name}}</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>675</pre>
            </td>
            <td class='context'>
              <pre class='context'>				dt[:offices] = ot.sort{ |a,b| a[:name] &lt;=&gt; b[:name] }</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>676</pre>
            </td>
            <td class='context'>
              <pre class='context'>				ot = []</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>677</pre>
            </td>
            <td class='context'>
              <pre class='context'>				Office.where(client_id: client.id, active: true).where(ws).select(&quot;distinct filter1&quot;).map(&amp;:filter1).compact.sort.each{ |s| ot &lt;&lt; {:id =&gt; s, :name =&gt; s} }</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>678</pre>
            </td>
            <td class='context'>
              <pre class='context'>				dt[:filter1] = ot</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>679</pre>
            </td>
            <td class='context'>
              <pre class='context'>			end</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='high-confidence'>High</span></td>
      <td>Api::MiscellaneousController</td>
      <td>callcenter_acquisition</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context127');toggle('message127');toggle('full_message127')" ><span id='message127' style='display:block'>Possible SQL injection near line 677: ...</span><span id='full_message127' style='display:none'>Possible SQL injection near line 677: <span class="code">Office.where(:client_id =&gt; @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;Call Center&quot;]).id, :active =&gt; true).where((&quot;offices.id in (#{get_data_filters(@authorized_user, @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;Call Center&quot;]).id)})&quot; or &quot;&quot;))</span></span><table id='context127' class='context' style='display:none'><caption>app/controllers/api/miscellaneous_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>672</pre>
          </td>
          <td class='context'>
            <pre class='context'>				dt[:states] = ot</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>673</pre>
            </td>
            <td class='context'>
              <pre class='context'>				ot = []</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>674</pre>
            </td>
            <td class='context'>
              <pre class='context'>				Office.where(client_id: client.id, active: true).where(ws).select(&quot;offices.id, offices.name&quot;).group(&quot;offices.id, offices.name&quot;).each{ |o| ot &lt;&lt; {id: o.id, name: o.name}}</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>675</pre>
            </td>
            <td class='context'>
              <pre class='context'>				dt[:offices] = ot.sort{ |a,b| a[:name] &lt;=&gt; b[:name] }</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>676</pre>
            </td>
            <td class='context'>
              <pre class='context'>				ot = []</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>677</pre>
            </td>
            <td class='context'>
              <pre class='context'>				Office.where(client_id: client.id, active: true).where(ws).select(&quot;distinct filter1&quot;).map(&amp;:filter1).compact.sort.each{ |s| ot &lt;&lt; {:id =&gt; s, :name =&gt; s} }</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>678</pre>
            </td>
            <td class='context'>
              <pre class='context'>				dt[:filter1] = ot</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>679</pre>
            </td>
            <td class='context'>
              <pre class='context'>			end</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>680</pre>
            </td>
            <td class='context'>
              <pre class='context'>			render :json =&gt; {:status =&gt; &quot;success&quot;, :data =&gt; dt}</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>681</pre>
            </td>
            <td class='context'>
              <pre class='context'>		else</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>682</pre>
            </td>
            <td class='context'>
              <pre class='context'>			render :json =&gt; {:status =&gt; &quot;error&quot;, :message =&gt; &quot;You are not authorized to use the &#39;miscellaneous/callcenter_acquisition&#39; endpoint.&quot;}</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='high-confidence'>High</span></td>
      <td>Api::NameController</td>
      <td>index</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context128');toggle('message128');toggle('full_message128')" ><span id='message128' style='display:block'>Possible SQL injection near line 25: ...</span><span id='full_message128' style='display:none'>Possible SQL injection near line 25: <span class="code">MvName.select(:id, :household_id, :f_name, :m_name, :l_name, :street1, :street2, :city, :state, :zip4).order(:l_name).where(:client_id =&gt; @authorized_user.authorized_client(params[:client_id], [&quot;Administrator&quot;, &quot;User&quot;, &quot;Limited&quot;]).id, :zip =&gt; params[:zip].delete(&quot;^0-9&quot;)[(0...-4)][(0...5)].to_i).joins(:household =&gt; :lead).includes(:household =&gt; :suppressed_household).where(&quot;suppressed_households.household_id&quot; =&gt; nil).where(:zip4 =&gt; (&quot;#{params[:zip].delete(&quot;^0-9&quot;)[(0...-4)][(0...5)].to_i.to_s.rjust(5, &quot;0&quot;)}-#{params[:zip].delete(&quot;^0-9&quot;).last(4)}&quot;)).where(&quot;lower(l_name) like &#39;#{<span class="user_input">params[:pattern].downcase.delete(&quot;^a-z&quot;)</span>}%&#39;&quot;)</span></span><table id='context128' class='context' style='display:none'><caption>app/controllers/api/name_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>20</pre>
          </td>
          <td class='context'>
            <pre class='context'>					zp = zp[0...-4]</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>21</pre>
            </td>
            <td class='context'>
              <pre class='context'>				end</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>22</pre>
            </td>
            <td class='context'>
              <pre class='context'>				zp = zp[0...5].to_i</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>23</pre>
            </td>
            <td class='context'>
              <pre class='context'>				nm = MvName.select(:id, :household_id, :f_name, :m_name, :l_name, :street1, :street2, :city, :state, :zip4).order(:l_name).where(client_id: client.id, zip: zp).joins(:household =&gt; :lead).includes(:household =&gt; :suppressed_household).where(&quot;suppressed_households.household_id&quot; =&gt; nil)</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>24</pre>
            </td>
            <td class='context'>
              <pre class='context'>				nm = nm.where(zip4: &quot;#{zp.to_s.rjust(5, &#39;0&#39;)}-#{z4}&quot;) unless z4.nil?</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>25</pre>
            </td>
            <td class='context'>
              <pre class='context'>				nm = nm.where(&quot;lower(l_name) like &#39;#{pt}%&#39;&quot;) unless pt.nil?</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>26</pre>
            </td>
            <td class='context'>
              <pre class='context'>			end</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>27</pre>
            </td>
            <td class='context'>
              <pre class='context'>			render :json =&gt; {:status =&gt; &quot;success&quot;, :data =&gt; nm}</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>28</pre>
            </td>
            <td class='context'>
              <pre class='context'>		else</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>29</pre>
            </td>
            <td class='context'>
              <pre class='context'>			render :json =&gt; {:status =&gt; &quot;error&quot;, :message =&gt; &quot;You are not authorized to use the &#39;names/index&#39; endpoint.&quot;}</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>30</pre>
            </td>
            <td class='context'>
              <pre class='context'>		end</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='high-confidence'>High</span></td>
      <td>Api::NudgeController</td>
      <td>retrieve_send_log</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context96');toggle('message96');toggle('full_message96')" ><span id='message96' style='display:block'>Possible SQL injection near line 246: ...</span><span id='full_message96' style='display:none'>Possible SQL injection near line 246: <span class="code">General.find_by_sql([&quot;select mo.id as message_id, mo.processed_at as sent_at, g.name as nudge, o.name as office, concat(coalesce(a.hcp_f_name, p.hcp_f_name), &#39; &#39;, coalesce(a.hcp_l_name, p.hcp_l_name)) as provider, mo.message_type, coalesce(p.fullname, o.name) as sent_to\nfrom (select * from message_out_details where client_id = :cid) mo\njoin touch_steps ts on mo.touch_step_id = ts.id\njoin (select * from nudges where client_id = :cid) g on ts.nudge_id = g.id\njoin (select * from offices where client_id = :cid and active = &#39;t&#39;) o on mo.office_id = o.id\njoin pg_timezone_names tz on o.timezone = tz.name\nleft join (select individual_id, hcp_f_name, hcp_l_name, concat(f_name, &#39; &#39;, l_name) as fullname from mv_patients where client_id = :cid) p on mo.individual_id = p.individual_id\nleft join (select sa.id, sa.hcp_f_name, sa.hcp_l_name from appointments sa join patients sp on sa.patient_id = sp.id where sp.client_id = :cid) a on mo.regard_type = &#39;Appointment&#39; and mo.regard_id = a.id\nwhere mo.client_id = :cid\nand mo.person_id = :rl\n#{if (Office.where(:client_id =&gt; @authorized_user.authorized_client(params[:client_id], [&quot;Administrator&quot;, &quot;User&quot;, &quot;Engagement&quot;]).id, :active =&gt; true).where((&quot;offices.id in (#{get_data_filters(@authorized_user, @authorized_user.authorized_client(params[:client_id], [&quot;Administrator&quot;, &quot;User&quot;, &quot;Engagement&quot;]).id)})&quot; or &quot;&quot;)).where.not(:sms_enabled =&gt; false, :ses_enabled =&gt; false).select(:id, :name).order(:name).map(&amp;:id).join(&quot;,&quot;) == &quot;&quot;) then   &quot;&quot; else   &quot;and office_id in (#{Office.where(:client_id =&gt; @authorized_user.authorized_client(params[:client_id], [&quot;Administrator&quot;, &quot;User&quot;, &quot;Engagement&quot;]).id, :active =&gt; true).where((&quot;offices.id in (#{get_data_filters(@authorized_user, @authorized_user.authorized_client(params[:client_id], [&quot;Administrator&quot;, &quot;User&quot;, &quot;Engagement&quot;]).id)})&quot; or &quot;&quot;)).where.not(:sms_enabled =&gt; false, :ses_enabled =&gt; false).select(:id, :name).order(:name).map(&amp;:id).join(&quot;,&quot;)})&quot; end}\n#{if (&quot;#{&quot;nudge_id = #{Sanitize.id(JSON.parse(<span class="user_input">params[:sp]</span>)[&quot;nudge&quot;])}&quot;} and #{&quot;office_id = #{Sanitize.id(JSON.parse(<span class="user_input">params[:sp]</span>)[&quot;office&quot;])}&quot;} and #{&quot;concat(coalesce(a.hcp_f_name, p.hcp_f_name), &#39; &#39;, coalesce(a.hcp_l_name, p.hcp_l_name)) = &#39;#{Sanitize.name(JSON.parse(<span class="user_input">params[:sp]</span>)[&quot;provider&quot;])}&#39;&quot;} and #{&quot;(&#39;#{(Sanitize.date(JSON.parse(<span class="user_input">params[:sp]</span>)[&quot;date&quot;]) or Date.today.strftime(&quot;%Y-%m-%d&quot;))}&#39;)::date = (mo.processed_at + tz.utc_offset)::date&quot;}&quot; == &quot;&quot;) then   &quot;&quot; else   &quot;and #{&quot;#{&quot;nudge_id = #{Sanitize.id(JSON.parse(<span class="user_input">params[:sp]</span>)[&quot;nudge&quot;])}&quot;} and #{&quot;office_id = #{Sanitize.id(JSON.parse(<span class="user_input">params[:sp]</span>)[&quot;office&quot;])}&quot;} and #{&quot;concat(coalesce(a.hcp_f_name, p.hcp_f_name), &#39; &#39;, coalesce(a.hcp_l_name, p.hcp_l_name)) = &#39;#{Sanitize.name(JSON.parse(<span class="user_input">params[:sp]</span>)[&quot;provider&quot;])}&#39;&quot;} and #{&quot;(&#39;#{(Sanitize.date(JSON.parse(<span class="user_input">params[:sp]</span>)[&quot;date&quot;]) or Date.today.strftime(&quot;%Y-%m-%d&quot;))}&#39;)::date = (mo.processed_at + tz.utc_offset)::date&quot;}&quot;}&quot; end}\norder by mo.processed_at desc\n&quot;, { :cid =&gt; @authorized_user.authorized_client(params[:client_id], [&quot;Administrator&quot;, &quot;User&quot;, &quot;Engagement&quot;]).id, :rl =&gt; Person.find_by(:name =&gt; &quot;RelevantLocal&quot;).id }])</span></span><table id='context96' class='context' style='display:none'><caption>app/controllers/api/nudge_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>241</pre>
          </td>
          <td class='context'>
            <pre class='context'>				left join (select individual_id, hcp_f_name, hcp_l_name, concat(f_name, &#39; &#39;, l_name) as fullname from mv_patients where client_id = :cid) p on mo.individual_id = p.individual_id</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>242</pre>
            </td>
            <td class='context'>
              <pre class='context'>				left join (select sa.id, sa.hcp_f_name, sa.hcp_l_name from appointments sa join patients sp on sa.patient_id = sp.id where sp.client_id = :cid) a on mo.regard_type = &#39;Appointment&#39; and mo.regard_id = a.id</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>243</pre>
            </td>
            <td class='context'>
              <pre class='context'>				where mo.client_id = :cid</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>244</pre>
            </td>
            <td class='context'>
              <pre class='context'>				and mo.person_id = :rl</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>245</pre>
            </td>
            <td class='context'>
              <pre class='context'>				#{fcs == &quot;&quot; ? &quot;&quot; : &quot;and office_id in (#{fcs})&quot;}</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>246</pre>
            </td>
            <td class='context'>
              <pre class='context'>				#{query_filter == &quot;&quot; ? &quot;&quot; : &quot;and #{query_filter}&quot;}</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>247</pre>
            </td>
            <td class='context'>
              <pre class='context'>				order by mo.processed_at desc</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>248</pre>
            </td>
            <td class='context'>
              <pre class='context'>				SQL</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>249</pre>
            </td>
            <td class='context'>
              <pre class='context'>			ot[:message_details] = rs</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>250</pre>
            </td>
            <td class='context'>
              <pre class='context'>			render :json =&gt; {:status =&gt; &quot;success&quot;, :data =&gt; ot}</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>251</pre>
            </td>
            <td class='context'>
              <pre class='context'>		else</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='high-confidence'>High</span></td>
      <td>Api::NudgeController</td>
      <td>index</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context129');toggle('message129');toggle('full_message129')" ><span id='message129' style='display:block'>Possible SQL injection near line 21: ...</span><span id='full_message129' style='display:none'>Possible SQL injection near line 21: <span class="code">Office.where(:client_id =&gt; @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;User&quot;, &quot;Engagement&quot;]).id, :active =&gt; true).where((&quot;offices.id in (#{get_data_filters(@authorized_user, @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;User&quot;, &quot;Engagement&quot;]).id)})&quot; or &quot;&quot;))</span></span><table id='context129' class='context' style='display:none'><caption>app/controllers/api/nudge_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>16</pre>
          </td>
          <td class='context'>
            <pre class='context'>	def index</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>17</pre>
            </td>
            <td class='context'>
              <pre class='context'>		client = @authorized_user&amp;.authorized_client(params[:client_id], [&quot;Administrator&quot;, &quot;User&quot;, &quot;Engagement&quot;])</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>18</pre>
            </td>
            <td class='context'>
              <pre class='context'>		if client</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>19</pre>
            </td>
            <td class='context'>
              <pre class='context'>			df = get_data_filters(@authorized_user, client.id)</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>20</pre>
            </td>
            <td class='context'>
              <pre class='context'>			ws = df.length &gt; 0 ? &quot;offices.id in (#{df})&quot; : &quot;&quot;</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>21</pre>
            </td>
            <td class='context'>
              <pre class='context'>			fcl = Office.where(client_id: client.id, active: true).where(ws).where.not(sms_enabled: false, ses_enabled: false).select(:id, :name).order(:name)</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>22</pre>
            </td>
            <td class='context'>
              <pre class='context'>			fcs = fcl.map(&amp;:id).join &quot;,&quot;</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>23</pre>
            </td>
            <td class='context'>
              <pre class='context'>			ot = {}</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>24</pre>
            </td>
            <td class='context'>
              <pre class='context'>			ot[:nudge_names] = Nudge.where(client_id: client.id).order(:name).as_json(:only =&gt; [:id, :name])</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>25</pre>
            </td>
            <td class='context'>
              <pre class='context'>			ot[:offices] = fcl</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>26</pre>
            </td>
            <td class='context'>
              <pre class='context'>			po = Office.joins(:provider_offices).where(client_id: client.id).select(&quot;distinct concat(f_name, &#39; &#39;, l_name) as provider&quot;).order(Arel.sql(&quot;concat(f_name, &#39; &#39;, l_name)&quot;))</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='high-confidence'>High</span></td>
      <td>Api::NudgeController</td>
      <td>retrieve_send_log</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context130');toggle('message130');toggle('full_message130')" ><span id='message130' style='display:block'>Possible SQL injection near line 219: ...</span><span id='full_message130' style='display:none'>Possible SQL injection near line 219: <span class="code">Office.where(:client_id =&gt; @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;User&quot;, &quot;Engagement&quot;]).id, :active =&gt; true).where((&quot;offices.id in (#{get_data_filters(@authorized_user, @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;User&quot;, &quot;Engagement&quot;]).id)})&quot; or &quot;&quot;))</span></span><table id='context130' class='context' style='display:none'><caption>app/controllers/api/nudge_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>214</pre>
          </td>
          <td class='context'>
            <pre class='context'>	def retrieve_send_log</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>215</pre>
            </td>
            <td class='context'>
              <pre class='context'>		client = @authorized_user&amp;.authorized_client(params[:client_id], [&quot;Administrator&quot;, &quot;User&quot;, &quot;Engagement&quot;])</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>216</pre>
            </td>
            <td class='context'>
              <pre class='context'>		if client</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>217</pre>
            </td>
            <td class='context'>
              <pre class='context'>			df = get_data_filters(@authorized_user, client.id)</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>218</pre>
            </td>
            <td class='context'>
              <pre class='context'>			ws = df.length &gt; 0 ? &quot;offices.id in (#{df})&quot; : &quot;&quot;</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>219</pre>
            </td>
            <td class='context'>
              <pre class='context'>			fcl = Office.where(client_id: client.id, active: true).where(ws).where.not(sms_enabled: false, ses_enabled: false).select(:id, :name).order(:name)</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>220</pre>
            </td>
            <td class='context'>
              <pre class='context'>			fcs = fcl.map(&amp;:id).join &quot;,&quot;</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>221</pre>
            </td>
            <td class='context'>
              <pre class='context'>			pf = Person.find_by(name: &#39;RelevantLocal&#39;).id</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>223</pre>
            </td>
            <td class='context'>
              <pre class='context'>			ot = {message_details: []}</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>224</pre>
            </td>
            <td class='context'>
              <pre class='context'>			sp = JSON.parse(params[:sp]) if params[:sp]</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='high-confidence'>High</span></td>
      <td>Api::OfficeController</td>
      <td>office_url</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context100');toggle('message100');toggle('full_message100')" ><span id='message100' style='display:block'>Possible SQL injection near line 328: ...</span><span id='full_message100' style='display:none'>Possible SQL injection near line 328: <span class="code">OfficeCr.find_by_sql(&quot;select o.name, oc.zip, oc.cr, coalesce(cl.leads, 0) as leads, coalesce(zc.criteria, &#39;&#39;) as criteria \nfrom office_crs oc \njoin offices o on o.id = oc.office_id \nleft join cr_geo_counts cl on cl.office_cr_id = oc.id \nleft join zip_criteria zc on zc.zip = oc.zip and zc.client_id = o.client_id \nwhere o.client_id = #{@authorized_user.authorized_client(params[:client_id], [&quot;Administrator&quot;, &quot;User&quot;]).id} and o.id in (#{Sanitize.id_list(<span class="user_input">params[:offices]</span>)}) and oc.priority in (1,2) \norder by o.name, oc.zip, oc.cr;\n&quot;)</span></span><table id='context100' class='context' style='display:none'><caption>app/controllers/api/office_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>323</pre>
          </td>
          <td class='context'>
            <pre class='context'>				select o.name, oc.zip, oc.cr, coalesce(cl.leads, 0) as leads, coalesce(zc.criteria, &#39;&#39;) as criteria </pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>324</pre>
            </td>
            <td class='context'>
              <pre class='context'>				from office_crs oc </pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>325</pre>
            </td>
            <td class='context'>
              <pre class='context'>				join offices o on o.id = oc.office_id </pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>326</pre>
            </td>
            <td class='context'>
              <pre class='context'>				left join cr_geo_counts cl on cl.office_cr_id = oc.id </pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>327</pre>
            </td>
            <td class='context'>
              <pre class='context'>				left join zip_criteria zc on zc.zip = oc.zip and zc.client_id = o.client_id </pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>328</pre>
            </td>
            <td class='context'>
              <pre class='context'>				where o.client_id = #{client.id} and o.id in (#{fcs}) and oc.priority in (1,2) </pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>329</pre>
            </td>
            <td class='context'>
              <pre class='context'>				order by o.name, oc.zip, oc.cr;</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>330</pre>
            </td>
            <td class='context'>
              <pre class='context'>				SQL</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>331</pre>
            </td>
            <td class='context'>
              <pre class='context'>			fz.each { |oz| ot.puts &#39;&quot;&#39; + oz.name + &#39;&quot;,&quot;&#39; + (&quot;%.05d&quot; % oz.zip) + &#39;&quot;,&quot;&#39; + oz.cr + &#39;&quot;,&#39; + oz.leads.to_s + &#39;,&quot;&#39; + oz.criteria + &#39;&quot;&#39;}</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>332</pre>
            </td>
            <td class='context'>
              <pre class='context'>			ot.close</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>333</pre>
            </td>
            <td class='context'>
              <pre class='context'>			crd = Rails.application.credentials.aws</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='high-confidence'>High</span></td>
      <td>Api::OfficeController</td>
      <td>index</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context131');toggle('message131');toggle('full_message131')" ><span id='message131' style='display:block'>Possible SQL injection near line 20: ...</span><span id='full_message131' style='display:none'>Possible SQL injection near line 20: <span class="code">Office.where(:client_id =&gt; @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;User&quot;]).id, :active =&gt; true).where((&quot;id in (#{get_data_filters(@authorized_user, @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;User&quot;]).id)})&quot; or &quot;&quot;))</span></span><table id='context131' class='context' style='display:none'><caption>app/controllers/api/office_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>15</pre>
          </td>
          <td class='context'>
            <pre class='context'>		if client</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>16</pre>
            </td>
            <td class='context'>
              <pre class='context'>			dt = {}</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>17</pre>
            </td>
            <td class='context'>
              <pre class='context'>			df = get_data_filters(@authorized_user, client.id)</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>18</pre>
            </td>
            <td class='context'>
              <pre class='context'>			ws = df.length &gt; 0 ? &quot;id in (#{df})&quot; : &quot;&quot;</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>19</pre>
            </td>
            <td class='context'>
              <pre class='context'>			rq = df.length &gt; 0 ? &quot;offices.id in (#{df})&quot; : &quot;&quot;</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>20</pre>
            </td>
            <td class='context'>
              <pre class='context'>			dt[:offices] = Office.where(client_id: client.id, active: true).where(ws).order(&quot;name&quot;).as_json({:only =&gt; [:id, :name, :state, :region_id, :lat, :lon, :sms_phone, :sms_phone2, :sms_phone3, :ses_email, :txt_fwd_emails, :sms_enabled, :ses_enabled, :ses_pending]})</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>21</pre>
            </td>
            <td class='context'>
              <pre class='context'>			ot = []</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>22</pre>
            </td>
            <td class='context'>
              <pre class='context'>			Office.where(client_id: client.id, active: true).where(ws).select(&quot;distinct state&quot;).map(&amp;:state).sort.each{ |s| ot &lt;&lt; {:id =&gt; s, :name =&gt; usa_states_hash.merge(canada_province_hash)[s]} }</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>23</pre>
            </td>
            <td class='context'>
              <pre class='context'>			dt[:states] = ot</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>24</pre>
            </td>
            <td class='context'>
              <pre class='context'>			dt[:regions] = Region.joins(:offices).where(client_id: client.id).where(rq).select(&quot;distinct regions.id, regions.name&quot;).order(:name).as_json</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>25</pre>
            </td>
            <td class='context'>
              <pre class='context'>			dt[:regions_all] = Region.where(client_id: client.id).select(&quot;distinct regions.id, regions.name&quot;).order(:name).as_json</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='high-confidence'>High</span></td>
      <td>Api::OfficeController</td>
      <td>index</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context132');toggle('message132');toggle('full_message132')" ><span id='message132' style='display:block'>Possible SQL injection near line 22: ...</span><span id='full_message132' style='display:none'>Possible SQL injection near line 22: <span class="code">Office.where(:client_id =&gt; @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;User&quot;]).id, :active =&gt; true).where((&quot;id in (#{get_data_filters(@authorized_user, @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;User&quot;]).id)})&quot; or &quot;&quot;))</span></span><table id='context132' class='context' style='display:none'><caption>app/controllers/api/office_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>17</pre>
          </td>
          <td class='context'>
            <pre class='context'>			df = get_data_filters(@authorized_user, client.id)</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>18</pre>
            </td>
            <td class='context'>
              <pre class='context'>			ws = df.length &gt; 0 ? &quot;id in (#{df})&quot; : &quot;&quot;</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>19</pre>
            </td>
            <td class='context'>
              <pre class='context'>			rq = df.length &gt; 0 ? &quot;offices.id in (#{df})&quot; : &quot;&quot;</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>20</pre>
            </td>
            <td class='context'>
              <pre class='context'>			dt[:offices] = Office.where(client_id: client.id, active: true).where(ws).order(&quot;name&quot;).as_json({:only =&gt; [:id, :name, :state, :region_id, :lat, :lon, :sms_phone, :sms_phone2, :sms_phone3, :ses_email, :txt_fwd_emails, :sms_enabled, :ses_enabled, :ses_pending]})</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>21</pre>
            </td>
            <td class='context'>
              <pre class='context'>			ot = []</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>22</pre>
            </td>
            <td class='context'>
              <pre class='context'>			Office.where(client_id: client.id, active: true).where(ws).select(&quot;distinct state&quot;).map(&amp;:state).sort.each{ |s| ot &lt;&lt; {:id =&gt; s, :name =&gt; usa_states_hash.merge(canada_province_hash)[s]} }</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>23</pre>
            </td>
            <td class='context'>
              <pre class='context'>			dt[:states] = ot</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>24</pre>
            </td>
            <td class='context'>
              <pre class='context'>			dt[:regions] = Region.joins(:offices).where(client_id: client.id).where(rq).select(&quot;distinct regions.id, regions.name&quot;).order(:name).as_json</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>25</pre>
            </td>
            <td class='context'>
              <pre class='context'>			dt[:regions_all] = Region.where(client_id: client.id).select(&quot;distinct regions.id, regions.name&quot;).order(:name).as_json</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>26</pre>
            </td>
            <td class='context'>
              <pre class='context'>			render :json =&gt; {:status =&gt; &quot;success&quot;, :data =&gt; dt}</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>27</pre>
            </td>
            <td class='context'>
              <pre class='context'>		else</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='high-confidence'>High</span></td>
      <td>Api::OfficeController</td>
      <td>index</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context133');toggle('message133');toggle('full_message133')" ><span id='message133' style='display:block'>Possible SQL injection near line 24: ...</span><span id='full_message133' style='display:none'>Possible SQL injection near line 24: <span class="code">Region.joins(:offices).where(:client_id =&gt; @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;User&quot;]).id).where((&quot;offices.id in (#{get_data_filters(@authorized_user, @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;User&quot;]).id)})&quot; or &quot;&quot;))</span></span><table id='context133' class='context' style='display:none'><caption>app/controllers/api/office_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>19</pre>
          </td>
          <td class='context'>
            <pre class='context'>			rq = df.length &gt; 0 ? &quot;offices.id in (#{df})&quot; : &quot;&quot;</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>20</pre>
            </td>
            <td class='context'>
              <pre class='context'>			dt[:offices] = Office.where(client_id: client.id, active: true).where(ws).order(&quot;name&quot;).as_json({:only =&gt; [:id, :name, :state, :region_id, :lat, :lon, :sms_phone, :sms_phone2, :sms_phone3, :ses_email, :txt_fwd_emails, :sms_enabled, :ses_enabled, :ses_pending]})</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>21</pre>
            </td>
            <td class='context'>
              <pre class='context'>			ot = []</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>22</pre>
            </td>
            <td class='context'>
              <pre class='context'>			Office.where(client_id: client.id, active: true).where(ws).select(&quot;distinct state&quot;).map(&amp;:state).sort.each{ |s| ot &lt;&lt; {:id =&gt; s, :name =&gt; usa_states_hash.merge(canada_province_hash)[s]} }</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>23</pre>
            </td>
            <td class='context'>
              <pre class='context'>			dt[:states] = ot</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>24</pre>
            </td>
            <td class='context'>
              <pre class='context'>			dt[:regions] = Region.joins(:offices).where(client_id: client.id).where(rq).select(&quot;distinct regions.id, regions.name&quot;).order(:name).as_json</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>25</pre>
            </td>
            <td class='context'>
              <pre class='context'>			dt[:regions_all] = Region.where(client_id: client.id).select(&quot;distinct regions.id, regions.name&quot;).order(:name).as_json</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>26</pre>
            </td>
            <td class='context'>
              <pre class='context'>			render :json =&gt; {:status =&gt; &quot;success&quot;, :data =&gt; dt}</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>27</pre>
            </td>
            <td class='context'>
              <pre class='context'>		else</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>28</pre>
            </td>
            <td class='context'>
              <pre class='context'>			render :json =&gt; {:status =&gt; &quot;error&quot;, :message =&gt; &quot;You are not authorized to use the &#39;offices/index&#39; endpoint.&quot;}</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>29</pre>
            </td>
            <td class='context'>
              <pre class='context'>		end</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='high-confidence'>High</span></td>
      <td>Api::OfficeController</td>
      <td>office_details</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context134');toggle('message134');toggle('full_message134')" ><span id='message134' style='display:block'>Possible SQL injection near line 131: ...</span><span id='full_message134' style='display:none'>Possible SQL injection near line 131: <span class="code">Office.includes(:office_crs =&gt; :cr_geo_counts).where(:client_id =&gt; @authorized_user.authorized_client(params[:client_id], [&quot;Administrator&quot;, &quot;User&quot;]).id).where(&quot;offices.id in (#{Sanitize.id_list(<span class="user_input">params[:offices]</span>)})&quot;)</span></span><table id='context134' class='context' style='display:none'><caption>app/controllers/api/office_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>126</pre>
          </td>
          <td class='context'>
            <pre class='context'>	def office_details</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>127</pre>
            </td>
            <td class='context'>
              <pre class='context'>		client = @authorized_user&amp;.authorized_client(params[:client_id], [&quot;Administrator&quot;, &quot;User&quot;])</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>128</pre>
            </td>
            <td class='context'>
              <pre class='context'>		if client</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>129</pre>
            </td>
            <td class='context'>
              <pre class='context'>			dt = {}</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>130</pre>
            </td>
            <td class='context'>
              <pre class='context'>			fcs = Sanitize.id_list(params[:offices])</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>131</pre>
            </td>
            <td class='context'>
              <pre class='context'>			dt[:offices] = Office.includes(:office_crs =&gt; :cr_geo_counts).where(client_id: client.id).where(&quot;offices.id in (#{fcs})&quot;).order(&quot;name&quot;).as_json({:except =&gt; [:created_at, :updated_at], :include =&gt; {:office_crs =&gt; {:except =&gt; [:id, :office_id, :created_at, :updated_at], :include =&gt; {:cr_geo_counts =&gt; {:only =&gt; [:leads]}}}}})</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>132</pre>
            </td>
            <td class='context'>
              <pre class='context'>			render :json =&gt; {:status =&gt; &quot;success&quot;, :data =&gt; dt}</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>133</pre>
            </td>
            <td class='context'>
              <pre class='context'>		else</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>134</pre>
            </td>
            <td class='context'>
              <pre class='context'>			render :json =&gt; {:status =&gt; &quot;error&quot;, :message =&gt; &quot;You are not authorized to use the &#39;offices/office_details&#39; endpoint.&quot;}</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>135</pre>
            </td>
            <td class='context'>
              <pre class='context'>		end</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>136</pre>
            </td>
            <td class='context'>
              <pre class='context'>	end</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='high-confidence'>High</span></td>
      <td>Api::OfficeController</td>
      <td>all_office_details</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context135');toggle('message135');toggle('full_message135')" ><span id='message135' style='display:block'>Possible SQL injection near line 144: ...</span><span id='full_message135' style='display:none'>Possible SQL injection near line 144: <span class="code">Office.where(:client_id =&gt; @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;User&quot;]).id, :active =&gt; true).where(&quot;id in (#{get_data_filters(@authorized_user, @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;User&quot;]).id)})&quot;)</span></span><table id='context135' class='context' style='display:none'><caption>app/controllers/api/office_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>139</pre>
          </td>
          <td class='context'>
            <pre class='context'>		client = @authorized_user&amp;.authorized_client(params[:client_id], [&quot;Administrator&quot;, &quot;User&quot;])</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>140</pre>
            </td>
            <td class='context'>
              <pre class='context'>		if client</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>141</pre>
            </td>
            <td class='context'>
              <pre class='context'>			dt = {}</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>142</pre>
            </td>
            <td class='context'>
              <pre class='context'>			df = get_data_filters(@authorized_user, client.id)</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>143</pre>
            </td>
            <td class='context'>
              <pre class='context'>			ws = &quot;id in (#{df})&quot; unless df.empty?</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>144</pre>
            </td>
            <td class='context'>
              <pre class='context'>			dt[:offices] = Office.where(client_id: client.id, active: true).where(ws).order(&quot;name&quot;).as_json({:except =&gt; [:created_at, :updated_at]})</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>145</pre>
            </td>
            <td class='context'>
              <pre class='context'>			dt[:txt_fwd] = Preference.where(client_id: client.id, key: &quot;text_forwarding&quot;).first.value rescue nil</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>146</pre>
            </td>
            <td class='context'>
              <pre class='context'>			render :json =&gt; {:status =&gt; &quot;success&quot;, :data =&gt; dt}</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>147</pre>
            </td>
            <td class='context'>
              <pre class='context'>		else</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>148</pre>
            </td>
            <td class='context'>
              <pre class='context'>			render :json =&gt; {:status =&gt; &quot;error&quot;, :message =&gt; &quot;You are not authorized to use the &#39;offices/all_office_details&#39; endpoint.&quot;}</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>149</pre>
            </td>
            <td class='context'>
              <pre class='context'>		end</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='high-confidence'>High</span></td>
      <td>Api::OfficeController</td>
      <td>map_features</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context136');toggle('message136');toggle('full_message136')" ><span id='message136' style='display:block'>Possible SQL injection near line 201: ...</span><span id='full_message136' style='display:none'>Possible SQL injection near line 201: <span class="code">Office.where(:client_id =&gt; @authorized_user.authorized_client(params[:client_id], [&quot;Administrator&quot;, &quot;User&quot;]).id).where(&quot;id in (#{Sanitize.id_list(<span class="user_input">params[:offices]</span>)})&quot;)</span></span><table id='context136' class='context' style='display:none'><caption>app/controllers/api/office_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>196</pre>
          </td>
          <td class='context'>
            <pre class='context'>	def map_features</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>197</pre>
            </td>
            <td class='context'>
              <pre class='context'>		client = @authorized_user&amp;.authorized_client(params[:client_id], [&quot;Administrator&quot;, &quot;User&quot;])</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>198</pre>
            </td>
            <td class='context'>
              <pre class='context'>		if client</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>199</pre>
            </td>
            <td class='context'>
              <pre class='context'>			mf = {offices: {type: &quot;FeatureCollection&quot;, features: []}, competitors: {type: &quot;FeatureCollection&quot;, features: []}, zips: {type: &quot;FeatureCollection&quot;, features: []}, other_zips: {type: &quot;FeatureCollection&quot;, features: []}, crs: {type: &quot;FeatureCollection&quot;, features: []}, customers: {type: &quot;FeatureCollection&quot;, features: []}, prospects: {type: &quot;FeatureCollection&quot;, features: []}, leads: {}}</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>200</pre>
            </td>
            <td class='context'>
              <pre class='context'>			fcs = Sanitize.id_list(params[:offices])</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>201</pre>
            </td>
            <td class='context'>
              <pre class='context'>			fc = Office.where(:client_id =&gt; client.id).where(&quot;id in (#{fcs})&quot;)</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>202</pre>
            </td>
            <td class='context'>
              <pre class='context'>			overload = fc.length &gt; 5</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>203</pre>
            </td>
            <td class='context'>
              <pre class='context'>			az = []</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>204</pre>
            </td>
            <td class='context'>
              <pre class='context'>			for o in fc</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>205</pre>
            </td>
            <td class='context'>
              <pre class='context'>				ok = 0</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>206</pre>
            </td>
            <td class='context'>
              <pre class='context'>				gi = o.office_competitors.order(created_at: :desc).limit(1).first</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='high-confidence'>High</span></td>
      <td>Api::OfficeController</td>
      <td>map_features</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context137');toggle('message137');toggle('full_message137')" >Possible SQL injection near line 305: <span class="code">Office.joins(:office_crs =&gt; :cr_geo_counts).where(&quot;offices.id in (#{Sanitize.id_list(<span class="user_input">params[:offices]</span>)})&quot;)</span><table id='context137' class='context' style='display:none'><caption>app/controllers/api/office_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>300</pre>
          </td>
          <td class='context'>
            <pre class='context'>				join geographics g on g.individual_id = p.individual_id </pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>301</pre>
            </td>
            <td class='context'>
              <pre class='context'>				join offices o on o.id = p.office_id where o.client_id = #{client.id} and g.lat != 0 and g.lon != 0 and p.office_id in (#{fc.map(&amp;:id).join(&#39;,&#39;)});</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>302</pre>
            </td>
            <td class='context'>
              <pre class='context'>				SQL</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>303</pre>
            </td>
            <td class='context'>
              <pre class='context'>			pg.each { |g| mf[:prospects][:features] &lt;&lt; {type: &quot;Feature&quot;, properties: {clr: g.color}, geometry: {type: &quot;Point&quot;, coordinates: [eval(g.lon.round(4).to_s), eval(g.lat.round(4).to_s)]}}}</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>304</pre>
            </td>
            <td class='context'>
              <pre class='context'>			# add lead counts to the results</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>305</pre>
            </td>
            <td class='context'>
              <pre class='context'>			ol = Office.joins(:office_crs =&gt; :cr_geo_counts).where(&quot;offices.id in (#{fcs})&quot;)</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>306</pre>
            </td>
            <td class='context'>
              <pre class='context'>			mf[:leads][:zips] = ol.group(&quot;offices.id, office_crs.zip&quot;).sum(:leads).inject({}) { |h, (k,v)| h[k.to_s.rjust(5, &#39;0&#39;)] = v.to_i; h }</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>307</pre>
            </td>
            <td class='context'>
              <pre class='context'>			mf[:leads][:crs]  = ol.group(&quot;offices.id, office_crs.cr&quot;).sum(:leads).inject({}) { |h, (k,v)| h[k.to_s.rjust(5, &#39;0&#39;)] = v.to_i; h }</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>308</pre>
            </td>
            <td class='context'>
              <pre class='context'>			render :json =&gt; {:status =&gt; &quot;success&quot;, :data =&gt; mf}</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>309</pre>
            </td>
            <td class='context'>
              <pre class='context'>		else</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>310</pre>
            </td>
            <td class='context'>
              <pre class='context'>			render :json =&gt; {:status =&gt; &quot;error&quot;, :message =&gt; &quot;You are not authorized to use the &#39;offices/map_features&#39; endpoint.&quot;}</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='high-confidence'>High</span></td>
      <td>Api::PatientController</td>
      <td>provider_list</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context103');toggle('message103');toggle('full_message103')" ><span id='message103' style='display:block'>Possible SQL injection near line 141: ...</span><span id='full_message103' style='display:none'>Possible SQL injection near line 141: <span class="code">General.find_by_sql([&quot;select distinct hcp_f_name as f_name, hcp_l_name as l_name\nfrom appointments a\njoin offices o on a.office_id = o.id\nwhere #{(&quot;o.id in (#{get_data_filters(@authorized_user, @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;User&quot;, &quot;Engagement&quot;]).id)}) and &quot; or &quot;&quot;)} client_id = :cid and sms_phone is not null\n&quot;, { :cid =&gt; @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;User&quot;, &quot;Engagement&quot;]).id }])</span></span><table id='context103' class='context' style='display:none'><caption>app/controllers/api/patient_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>136</pre>
          </td>
          <td class='context'>
            <pre class='context'>			office_query = offices.length &gt; 0 ? &quot;o.id in (#{offices}) and &quot; : &quot;&quot;</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>137</pre>
            </td>
            <td class='context'>
              <pre class='context'>			pl = General.find_by_sql [&lt;&lt;~SQL, {cid: client.id}]</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>138</pre>
            </td>
            <td class='context'>
              <pre class='context'>				select distinct hcp_f_name as f_name, hcp_l_name as l_name</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>139</pre>
            </td>
            <td class='context'>
              <pre class='context'>				from appointments a</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>140</pre>
            </td>
            <td class='context'>
              <pre class='context'>				join offices o on a.office_id = o.id</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>141</pre>
            </td>
            <td class='context'>
              <pre class='context'>				where #{office_query} client_id = :cid and sms_phone is not null</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>142</pre>
            </td>
            <td class='context'>
              <pre class='context'>			SQL</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>143</pre>
            </td>
            <td class='context'>
              <pre class='context'>			render json: {status: &quot;success&quot;, data: pl}</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>144</pre>
            </td>
            <td class='context'>
              <pre class='context'>		else</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>145</pre>
            </td>
            <td class='context'>
              <pre class='context'>			render json: {status: &quot;error&quot;, message: &quot;You are not authorized to use the &#39;patients/provider_list&#39; endpoint.&quot;}</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>146</pre>
            </td>
            <td class='context'>
              <pre class='context'>		end</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='high-confidence'>High</span></td>
      <td>Api::PatientController</td>
      <td>waitlist_patients</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context104');toggle('message104');toggle('full_message104')" ><span id='message104' style='display:block'>Possible SQL injection near line 166: ...</span><span id='full_message104' style='display:none'>Possible SQL injection near line 166: <span class="code">General.find_by_sql([&quot;select p.id, concat(p.f_name, &#39; &#39;, p.l_name) as name, p.email, appt_at, status, array_agg(concat(pp.phone_type, &#39;: &#39;, pp.phone)) as phone_list, array_agg(concat(pp.phone_type, &#39;: &#39;, pp.phone)) filter(where pp.textable) as textable_phones, o.sms_phone as office_phone\nfrom (select patient_id, appt_at, status, office_id\n\tfrom appointments a\n\twhere #{(&quot;office_id in (#{get_data_filters(@authorized_user, @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;User&quot;, &quot;Engagement&quot;]).id)}) and&quot; or &quot;&quot;)} appt_at between :min_time and :max_time and hcp_f_name = :pf_name and hcp_l_name = :pl_name #{@authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;User&quot;, &quot;Engagement&quot;]).preferences.find_by_key(:ar_cond_valid_appt).value}) a\njoin patients p on p.id = a.patient_id\nleft join offices o on o.id = a.office_Id\nleft join (select patient_id, textable, phone_type, concat(substring(phone from 1 for 3), &#39;-&#39;, substring(phone from 4 for 3), &#39;-&#39;, substring(phone from 7 for 4)) as phone from patients_phones) pp on pp.patient_id = p.id\ngroup by p.id, name, appt_at, status, o.sms_phone\norder by appt_at\n&quot;, { :cid =&gt; @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;User&quot;, &quot;Engagement&quot;]).id, :min_time =&gt; Time.current.in_time_zone(@authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;User&quot;, &quot;Engagement&quot;]).appointments.where(:hcp_f_name =&gt; Sanitize.name(params[:pf_name]), :hcp_l_name =&gt; Sanitize.name(params[:pl_name])).order(:appt_at =&gt; :desc).first.office.timezone).strftime(&quot;%Y-%m-%d %H:%M&quot;), :max_time =&gt; (Date.today + 1.day), :pf_name =&gt; Sanitize.name(params[:pf_name]), :pl_name =&gt; Sanitize.name(params[:pl_name]) }])</span></span><table id='context104' class='context' style='display:none'><caption>app/controllers/api/patient_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>161</pre>
          </td>
          <td class='context'>
            <pre class='context'>			timezone = client.appointments.where(hcp_f_name: pf_name, hcp_l_name: pl_name).order(appt_at: :desc).first.office.timezone</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>162</pre>
            </td>
            <td class='context'>
              <pre class='context'>			tp = General.find_by_sql [&lt;&lt;~SQL, {cid: client.id, min_time: Time.current.in_time_zone(timezone).strftime(&quot;%Y-%m-%d %H:%M&quot;), max_time: Date.today + 1.day, pf_name: pf_name, pl_name: pl_name}]</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>163</pre>
            </td>
            <td class='context'>
              <pre class='context'>				select p.id, concat(p.f_name, &#39; &#39;, p.l_name) as name, p.email, appt_at, status, array_agg(concat(pp.phone_type, &#39;: &#39;, pp.phone)) as phone_list, array_agg(concat(pp.phone_type, &#39;: &#39;, pp.phone)) filter(where pp.textable) as textable_phones, o.sms_phone as office_phone</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>164</pre>
            </td>
            <td class='context'>
              <pre class='context'>				from (select patient_id, appt_at, status, office_id</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>165</pre>
            </td>
            <td class='context'>
              <pre class='context'>					from appointments a</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>166</pre>
            </td>
            <td class='context'>
              <pre class='context'>					where #{office_query} appt_at between :min_time and :max_time and hcp_f_name = :pf_name and hcp_l_name = :pl_name #{valid_appt}) a</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>167</pre>
            </td>
            <td class='context'>
              <pre class='context'>				join patients p on p.id = a.patient_id</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>168</pre>
            </td>
            <td class='context'>
              <pre class='context'>				left join offices o on o.id = a.office_Id</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>169</pre>
            </td>
            <td class='context'>
              <pre class='context'>				left join (select patient_id, textable, phone_type, concat(substring(phone from 1 for 3), &#39;-&#39;, substring(phone from 4 for 3), &#39;-&#39;, substring(phone from 7 for 4)) as phone from patients_phones) pp on pp.patient_id = p.id</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>170</pre>
            </td>
            <td class='context'>
              <pre class='context'>				group by p.id, name, appt_at, status, o.sms_phone</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>171</pre>
            </td>
            <td class='context'>
              <pre class='context'>				order by appt_at</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='high-confidence'>High</span></td>
      <td>Api::PatientController</td>
      <td>index</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context138');toggle('message138');toggle('full_message138')" ><span id='message138' style='display:block'>Possible SQL injection near line 14: ...</span><span id='full_message138' style='display:none'>Possible SQL injection near line 14: <span class="code">Office.where(:client_id =&gt; @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;User&quot;, &quot;Engagement&quot;]).id, :active =&gt; true, :sms_enabled =&gt; true).where((&quot;offices.id in (#{get_data_filters(@authorized_user, @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;User&quot;, &quot;Engagement&quot;]).id)})&quot; or &quot;&quot;))</span></span><table id='context138' class='context' style='display:none'><caption>app/controllers/api/patient_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>9</pre>
          </td>
          <td class='context'>
            <pre class='context'>	def index</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>10</pre>
            </td>
            <td class='context'>
              <pre class='context'>		client = @authorized_user&amp;.authorized_client(params[:client_id], [&quot;Administrator&quot;, &quot;User&quot;, &quot;Engagement&quot;])</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>11</pre>
            </td>
            <td class='context'>
              <pre class='context'>		if client</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>12</pre>
            </td>
            <td class='context'>
              <pre class='context'>			df = get_data_filters(@authorized_user, client.id)</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>13</pre>
            </td>
            <td class='context'>
              <pre class='context'>			ws = df.length &gt; 0 ? &quot;offices.id in (#{df})&quot; : &quot;&quot;</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>14</pre>
            </td>
            <td class='context'>
              <pre class='context'>			fcs = Office.where(client_id: client.id, active: true, sms_enabled: true).where(ws).select(:id, :name).order(&quot;name&quot;)</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>15</pre>
            </td>
            <td class='context'>
              <pre class='context'>			# rs = ::GetPatients.new(client_id: client.id, df_query: ws, with_paginate: true).execute</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>16</pre>
            </td>
            <td class='context'>
              <pre class='context'>			# render :json =&gt; {:status =&gt; &quot;success&quot;, :data =&gt; {fcs: fcs, patients: rs}}</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>17</pre>
            </td>
            <td class='context'>
              <pre class='context'>			render :json =&gt; {:status =&gt; &quot;success&quot;, :data =&gt; {fcs: fcs}}</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>18</pre>
            </td>
            <td class='context'>
              <pre class='context'>		else</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>19</pre>
            </td>
            <td class='context'>
              <pre class='context'>			render :json =&gt; {:status =&gt; &quot;error&quot;, :message =&gt; &quot;You are not authorized to use the &#39;patients/index&#39; endpoint.&quot;}</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='high-confidence'>High</span></td>
      <td>Api::PersonController</td>
      <td>create</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context149');toggle('message149');toggle('full_message149')" >Possible SQL injection near line 43: <span class="code">PersonAuthorization.find_or_initialize_by(<span class="user_input">params.permit(:email).merge(:person_id =&gt; Person.find_or_initialize_by(params.permit(:name)).id)</span>)</span><table id='context149' class='context' style='display:none'><caption>app/controllers/api/person_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>38</pre>
          </td>
          <td class='context'>
            <pre class='context'>					pr.save</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>39</pre>
            </td>
            <td class='context'>
              <pre class='context'>					params[:email] = nil if params[:email] == &quot;&quot;</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>40</pre>
            </td>
            <td class='context'>
              <pre class='context'>					params[:token] = nil if params[:token] == &quot;&quot;</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>41</pre>
            </td>
            <td class='context'>
              <pre class='context'>					cp = ClientsPeople.new({client_id: client.id, person_id: pr.id})</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>42</pre>
            </td>
            <td class='context'>
              <pre class='context'>					cp.save</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>43</pre>
            </td>
            <td class='context'>
              <pre class='context'>					pa = PersonAuthorization.find_or_initialize_by(params.permit(:email).merge({person_id: pr.id}))</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>44</pre>
            </td>
            <td class='context'>
              <pre class='context'>					pa.token = params[:token]</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>45</pre>
            </td>
            <td class='context'>
              <pre class='context'>					pa.save</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>46</pre>
            </td>
            <td class='context'>
              <pre class='context'>					if params[:roles]</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>47</pre>
            </td>
            <td class='context'>
              <pre class='context'>						params[:roles].split(&quot;,&quot;).each { |rl|</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>48</pre>
            </td>
            <td class='context'>
              <pre class='context'>							po = PeopleRoles.new(person_id: pr.id, role_id: rl)</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='high-confidence'>High</span></td>
      <td>Api::PhoneController</td>
      <td>validate_numbers</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context139');toggle('message139');toggle('full_message139')" ><span id='message139' style='display:block'>Possible SQL injection near line 118: ...</span><span id='full_message139' style='display:none'>Possible SQL injection near line 118: <span class="code">Office.where(:client_id =&gt; @authorized_user.authorized_client(params[:client_id], [&quot;Administrator&quot;, &quot;Call Center&quot;, &quot;User&quot;]).id, :sms_enabled =&gt; true).where(&quot;regexp_replace(sms_phone, &#39;[^0-9]&#39;, &#39;&#39;, &#39;g&#39;)=&#39;#{(Sanitize.phone(<span class="user_input">params[:from_number]</span>) or nil)}&#39;&quot;)</span></span><table id='context139' class='context' style='display:none'><caption>app/controllers/api/phone_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>113</pre>
          </td>
          <td class='context'>
            <pre class='context'>				return</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>114</pre>
            </td>
            <td class='context'>
              <pre class='context'>			end</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>115</pre>
            </td>
            <td class='context'>
              <pre class='context'>			# Have Twilio lookup the destination number and see if it is valid. If it isn&#39;t, it throws a RestError which is rescued below</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>116</pre>
            </td>
            <td class='context'>
              <pre class='context'>			twilio_client().lookups.phone_numbers(to_number).fetch(country_code: &#39;US&#39;)</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>117</pre>
            </td>
            <td class='context'>
              <pre class='context'>			# Check for a relevant phone or sms enabled office phone with the origin number. If this fails, we aren&#39;t calling correctly from the browser</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>118</pre>
            </td>
            <td class='context'>
              <pre class='context'>			op = Office.where(client_id: client.id, sms_enabled: true).where(&quot;regexp_replace(sms_phone, &#39;[^0-9]&#39;, &#39;&#39;, &#39;g&#39;)=&#39;#{from_number}&#39;&quot;)</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>119</pre>
            </td>
            <td class='context'>
              <pre class='context'>			rp = RelevantPhone.where(client_id: client.id, phone: from_number)</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>120</pre>
            </td>
            <td class='context'>
              <pre class='context'>			if (op.length == 0 and rp.length == 0)</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>121</pre>
            </td>
            <td class='context'>
              <pre class='context'>				unenabled_office = Office.where(client_id: client.id).where(&quot;regexp_replace(phone, &#39;[^0-9]&#39;, &#39;&#39;, &#39;g&#39;)=&#39;#{from_number}&#39;&quot;).first</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>122</pre>
            </td>
            <td class='context'>
              <pre class='context'>				if unenabled_office</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>123</pre>
            </td>
            <td class='context'>
              <pre class='context'>					render :json =&gt; {:status =&gt; &quot;error&quot;, :message =&gt; &quot;Click-to-call is not currently enabled for the #{unenabled_office.name} office.&quot;}</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='high-confidence'>High</span></td>
      <td>Api::PhoneController</td>
      <td>validate_numbers</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context140');toggle('message140');toggle('full_message140')" ><span id='message140' style='display:block'>Possible SQL injection near line 121: ...</span><span id='full_message140' style='display:none'>Possible SQL injection near line 121: <span class="code">Office.where(:client_id =&gt; @authorized_user.authorized_client(params[:client_id], [&quot;Administrator&quot;, &quot;Call Center&quot;, &quot;User&quot;]).id).where(&quot;regexp_replace(phone, &#39;[^0-9]&#39;, &#39;&#39;, &#39;g&#39;)=&#39;#{(Sanitize.phone(<span class="user_input">params[:from_number]</span>) or nil)}&#39;&quot;)</span></span><table id='context140' class='context' style='display:none'><caption>app/controllers/api/phone_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>116</pre>
          </td>
          <td class='context'>
            <pre class='context'>			twilio_client().lookups.phone_numbers(to_number).fetch(country_code: &#39;US&#39;)</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>117</pre>
            </td>
            <td class='context'>
              <pre class='context'>			# Check for a relevant phone or sms enabled office phone with the origin number. If this fails, we aren&#39;t calling correctly from the browser</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>118</pre>
            </td>
            <td class='context'>
              <pre class='context'>			op = Office.where(client_id: client.id, sms_enabled: true).where(&quot;regexp_replace(sms_phone, &#39;[^0-9]&#39;, &#39;&#39;, &#39;g&#39;)=&#39;#{from_number}&#39;&quot;)</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>119</pre>
            </td>
            <td class='context'>
              <pre class='context'>			rp = RelevantPhone.where(client_id: client.id, phone: from_number)</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>120</pre>
            </td>
            <td class='context'>
              <pre class='context'>			if (op.length == 0 and rp.length == 0)</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>121</pre>
            </td>
            <td class='context'>
              <pre class='context'>				unenabled_office = Office.where(client_id: client.id).where(&quot;regexp_replace(phone, &#39;[^0-9]&#39;, &#39;&#39;, &#39;g&#39;)=&#39;#{from_number}&#39;&quot;).first</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>122</pre>
            </td>
            <td class='context'>
              <pre class='context'>				if unenabled_office</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>123</pre>
            </td>
            <td class='context'>
              <pre class='context'>					render :json =&gt; {:status =&gt; &quot;error&quot;, :message =&gt; &quot;Click-to-call is not currently enabled for the #{unenabled_office.name} office.&quot;}</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>124</pre>
            </td>
            <td class='context'>
              <pre class='context'>				else</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>125</pre>
            </td>
            <td class='context'>
              <pre class='context'>					render :json =&gt; {:status =&gt; &quot;error&quot;, :message =&gt; &quot;#{from_number} is an invalid outbound click-to-call number. Please contact support for more information.&quot;}</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>126</pre>
            </td>
            <td class='context'>
              <pre class='context'>				end</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='high-confidence'>High</span></td>
      <td>Api::TextController</td>
      <td>index</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context141');toggle('message141');toggle('full_message141')" ><span id='message141' style='display:block'>Possible SQL injection near line 20: ...</span><span id='full_message141' style='display:none'>Possible SQL injection near line 20: <span class="code">Office.where(:client_id =&gt; @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;User&quot;, &quot;Engagement&quot;]).id, :active =&gt; true, :sms_enabled =&gt; true).where((&quot;id in (#{get_data_filters(@authorized_user, @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;User&quot;, &quot;Engagement&quot;]).id)})&quot; or &quot;&quot;))</span></span><table id='context141' class='context' style='display:none'><caption>app/controllers/api/text_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>15</pre>
          </td>
          <td class='context'>
            <pre class='context'>			dt = []</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>16</pre>
            </td>
            <td class='context'>
              <pre class='context'>			refresh = params[:refresh] == &quot;true&quot;</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>17</pre>
            </td>
            <td class='context'>
              <pre class='context'>			data_filters = get_data_filters(@authorized_user, client.id)</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>18</pre>
            </td>
            <td class='context'>
              <pre class='context'>			ws = data_filters.length &gt; 0 ? &quot;id in (#{data_filters})&quot; : &quot;&quot;</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>19</pre>
            </td>
            <td class='context'>
              <pre class='context'>			active_offices = Office.where(client_id: client.id, active: true, sms_enabled: true)</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>20</pre>
            </td>
            <td class='context'>
              <pre class='context'>			office_list = active_offices.where(ws).select(:id, :name, :sms_enabled, :sms_phone, :sms_phone2, :sms_phone3, :street1, :street2, :city, :state).order(&quot;name&quot;)</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>21</pre>
            </td>
            <td class='context'>
              <pre class='context'>			office_ids = office_list.map(&amp;:id).join &quot;,&quot;</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>23</pre>
            </td>
            <td class='context'>
              <pre class='context'>			au = @authorized_user.reload</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>24</pre>
            </td>
            <td class='context'>
              <pre class='context'>			atf = au.active_text_filter</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>25</pre>
            </td>
            <td class='context'>
              <pre class='context'>			if atf</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='high-confidence'>High</span></td>
      <td>Api::TextController</td>
      <td>all_messages</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context142');toggle('message142');toggle('full_message142')" ><span id='message142' style='display:block'>Possible SQL injection near line 305: ...</span><span id='full_message142' style='display:none'>Possible SQL injection near line 305: <span class="code">Office.where(:client_id =&gt; @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;User&quot;, &quot;Engagement&quot;]).id, :active =&gt; true, :sms_enabled =&gt; true).where((&quot;id in (#{get_data_filters(@authorized_user, @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;User&quot;, &quot;Engagement&quot;]).id)})&quot; or &quot;&quot;))</span></span><table id='context142' class='context' style='display:none'><caption>app/controllers/api/text_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>300</pre>
          </td>
          <td class='context'>
            <pre class='context'>		client = @authorized_user&amp;.authorized_client(params[:client_id], [&quot;Administrator&quot;, &quot;User&quot;, &quot;Engagement&quot;])</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>301</pre>
            </td>
            <td class='context'>
              <pre class='context'>		if client</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>302</pre>
            </td>
            <td class='context'>
              <pre class='context'>			fc = []</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>303</pre>
            </td>
            <td class='context'>
              <pre class='context'>			df = get_data_filters(@authorized_user, client.id)</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>304</pre>
            </td>
            <td class='context'>
              <pre class='context'>			ws = df.length &gt; 0 ? &quot;id in (#{df})&quot; : &quot;&quot;</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>305</pre>
            </td>
            <td class='context'>
              <pre class='context'>			fcs = Office.where(client_id: client.id, active: true, sms_enabled: true).where(ws)</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>306</pre>
            </td>
            <td class='context'>
              <pre class='context'>			fcs = fcs.where(&quot;office_id = ?&quot;, params[:office_id]) if params[:office_id]</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>307</pre>
            </td>
            <td class='context'>
              <pre class='context'>			fcs = fcs.select(:id, :name, :sms_phone).order(&quot;name&quot;)</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>308</pre>
            </td>
            <td class='context'>
              <pre class='context'>			fch = {}</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>309</pre>
            </td>
            <td class='context'>
              <pre class='context'>			fcs.each { |office| fch[office.id] = {onm: office.name, oph: office.sms_phone} }</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='high-confidence'>High</span></td>
      <td>Api::TextController</td>
      <td>undelivered_messages</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context143');toggle('message143');toggle('full_message143')" ><span id='message143' style='display:block'>Possible SQL injection near line 435: ...</span><span id='full_message143' style='display:none'>Possible SQL injection near line 435: <span class="code">Office.where(:client_id =&gt; @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;User&quot;, &quot;Engagement&quot;]).id, :active =&gt; true, :sms_enabled =&gt; true).where((&quot;id in (#{get_data_filters(@authorized_user, @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;User&quot;, &quot;Engagement&quot;]).id)})&quot; or &quot;&quot;))</span></span><table id='context143' class='context' style='display:none'><caption>app/controllers/api/text_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>430</pre>
          </td>
          <td class='context'>
            <pre class='context'>	def undelivered_messages</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>431</pre>
            </td>
            <td class='context'>
              <pre class='context'>		client = @authorized_user&amp;.authorized_client(params[:client_id], [&quot;Administrator&quot;, &quot;User&quot;, &quot;Engagement&quot;])</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>432</pre>
            </td>
            <td class='context'>
              <pre class='context'>		if client</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>433</pre>
            </td>
            <td class='context'>
              <pre class='context'>			df = get_data_filters(@authorized_user, client.id)</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>434</pre>
            </td>
            <td class='context'>
              <pre class='context'>			ws = df.length &gt; 0 ? &quot;id in (#{df})&quot; : &quot;&quot;</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>435</pre>
            </td>
            <td class='context'>
              <pre class='context'>			fcl = Office.where(client_id: client.id, active: true, sms_enabled: true).where(ws)</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>436</pre>
            </td>
            <td class='context'>
              <pre class='context'>			fcs = fcl.map(&amp;:id).join &quot;,&quot;</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>437</pre>
            </td>
            <td class='context'>
              <pre class='context'>			offices_query = &quot; and o.id in (#{fcs})&quot; if fcs.present?</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>438</pre>
            </td>
            <td class='context'>
              <pre class='context'>			um = General.find_by_sql [&lt;&lt;~SQL, {cid: client.id}]</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>439</pre>
            </td>
            <td class='context'>
              <pre class='context'>				select mod.id, mod.client_id, mod.to, mod.message, mod.individual_id, concat(nm.f_name, &#39; &#39;, nm.l_name) as name, o.name as office, processed_at as sent_at</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>440</pre>
            </td>
            <td class='context'>
              <pre class='context'>				from message_out_details mod</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='high-confidence'>High</span></td>
      <td>Api::TextController</td>
      <td>pending_messages</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context144');toggle('message144');toggle('full_message144')" ><span id='message144' style='display:block'>Possible SQL injection near line 461: ...</span><span id='full_message144' style='display:none'>Possible SQL injection near line 461: <span class="code">Office.where(:client_id =&gt; @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;User&quot;, &quot;Engagement&quot;]).id, :active =&gt; true, :sms_enabled =&gt; true).where((&quot;id in (#{get_data_filters(@authorized_user, @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;User&quot;, &quot;Engagement&quot;]).id)})&quot; or &quot;&quot;))</span></span><table id='context144' class='context' style='display:none'><caption>app/controllers/api/text_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>456</pre>
          </td>
          <td class='context'>
            <pre class='context'>	def pending_messages</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>457</pre>
            </td>
            <td class='context'>
              <pre class='context'>		client = @authorized_user&amp;.authorized_client(params[:client_id], [&quot;Administrator&quot;, &quot;User&quot;, &quot;Engagement&quot;])</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>458</pre>
            </td>
            <td class='context'>
              <pre class='context'>		if client</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>459</pre>
            </td>
            <td class='context'>
              <pre class='context'>			df = get_data_filters(@authorized_user, client.id)</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>460</pre>
            </td>
            <td class='context'>
              <pre class='context'>			ws = df.length &gt; 0 ? &quot;id in (#{df})&quot; : &quot;&quot;</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>461</pre>
            </td>
            <td class='context'>
              <pre class='context'>			fcl = Office.where(client_id: client.id, active: true, sms_enabled: true).where(ws)</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>462</pre>
            </td>
            <td class='context'>
              <pre class='context'>			fcs = fcl.map(&amp;:id).join &quot;,&quot;</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>463</pre>
            </td>
            <td class='context'>
              <pre class='context'>			pm = General.find_by_sql &lt;&lt;~SQL</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>464</pre>
            </td>
            <td class='context'>
              <pre class='context'>				select mod.id, &quot;to&quot;, o.name as office, message, send_at_local::timestamp without time zone as send_at from message_out_details mod</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>465</pre>
            </td>
            <td class='context'>
              <pre class='context'>				join offices o on o.id = mod.office_id</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>466</pre>
            </td>
            <td class='context'>
              <pre class='context'>				where touch_step_id is null and send_at_local &gt; timezone(o.timezone, now()) and office_id in (#{fcs}) and message_type=&#39;Text&#39;</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='high-confidence'>High</span></td>
      <td>Api::TextTemplateController</td>
      <td>index</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context145');toggle('message145');toggle('full_message145')" ><span id='message145' style='display:block'>Possible SQL injection near line 16: ...</span><span id='full_message145' style='display:none'>Possible SQL injection near line 16: <span class="code">Office.where(:client_id =&gt; @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;User&quot;, &quot;Engagement&quot;]).id, :active =&gt; true, :sms_enabled =&gt; true).where((&quot;offices.id in (#{get_data_filters(@authorized_user, @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;User&quot;, &quot;Engagement&quot;]).id)})&quot; or &quot;&quot;))</span></span><table id='context145' class='context' style='display:none'><caption>app/controllers/api/text_template_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>11</pre>
          </td>
          <td class='context'>
            <pre class='context'>	def index</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>12</pre>
            </td>
            <td class='context'>
              <pre class='context'>		client = @authorized_user&amp;.authorized_client(params[:client_id], [&quot;Administrator&quot;, &quot;User&quot;, &quot;Engagement&quot;])</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>13</pre>
            </td>
            <td class='context'>
              <pre class='context'>		if client</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>14</pre>
            </td>
            <td class='context'>
              <pre class='context'>			df = get_data_filters(@authorized_user, client.id)</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>15</pre>
            </td>
            <td class='context'>
              <pre class='context'>			ws = df.length &gt; 0 ? &quot;offices.id in (#{df})&quot; : &quot;&quot;</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>16</pre>
            </td>
            <td class='context'>
              <pre class='context'>			fcs = Office.where(client_id: client.id, active: true, sms_enabled: true).where(ws).select(:id, :name).order(&quot;name&quot;)</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>17</pre>
            </td>
            <td class='context'>
              <pre class='context'>			oid = fcs.map(&amp;:id).join(&quot;,&quot;)</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>18</pre>
            </td>
            <td class='context'>
              <pre class='context'>			rs = General.find_by_sql [&lt;&lt;~SQL, {:cid =&gt; client.id}]</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>19</pre>
            </td>
            <td class='context'>
              <pre class='context'>				select tt.*, o.id as office_id, o.name as office_name, tf.filterable_id, tf.filterable_type </pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>20</pre>
            </td>
            <td class='context'>
              <pre class='context'>				from text_templates tt </pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>21</pre>
            </td>
            <td class='context'>
              <pre class='context'>				left join template_filters tf on tf.text_template_id = tt.id</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='high-confidence'>High</span></td>
      <td></td>
      <td></td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/unmaintained_dependency/">Unmaintained Dependency</a></td>
      <td>[1104]</td>
      <td><div class='warning_message' onClick="toggle('context1');toggle('message1');toggle('full_message1')" >Support for Rails 7.1.3.4 ended on 2025-10-01 near line 278<table id='context1' class='context' style='display:none'><caption>Gemfile.lock</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>273</pre>
          </td>
          <td class='context'>
            <pre class='context'>    rack-test (2.1.0)</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>274</pre>
            </td>
            <td class='context'>
              <pre class='context'>      rack (&gt;= 1.3)</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>275</pre>
            </td>
            <td class='context'>
              <pre class='context'>    rackup (1.0.0)</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>276</pre>
            </td>
            <td class='context'>
              <pre class='context'>      rack (&lt; 3)</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>277</pre>
            </td>
            <td class='context'>
              <pre class='context'>      webrick</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>278</pre>
            </td>
            <td class='context'>
              <pre class='context'>    rails (7.1.3.4)</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>279</pre>
            </td>
            <td class='context'>
              <pre class='context'>      actioncable (= 7.1.3.4)</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>280</pre>
            </td>
            <td class='context'>
              <pre class='context'>      actionmailbox (= 7.1.3.4)</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>281</pre>
            </td>
            <td class='context'>
              <pre class='context'>      actionmailer (= 7.1.3.4)</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>282</pre>
            </td>
            <td class='context'>
              <pre class='context'>      actionpack (= 7.1.3.4)</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>283</pre>
            </td>
            <td class='context'>
              <pre class='context'>      actiontext (= 7.1.3.4)</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>Api::MediaBuyController</td>
      <td>generate_list_url</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/command_injection/">Command Injection</a></td>
      <td>[77]</td>
      <td><div class='warning_message' onClick="toggle('context13');toggle('message13');toggle('full_message13')" ><span id='message13' style='display:block'>Possible command injection near line 215: ...</span><span id='full_message13' style='display:none'>Possible command injection near line 215: <span class="code">`zip #{&quot;log/mb_#{<span class="user_input">ids.split(&quot;,&quot;).first</span>}_to_#{ids.split(&quot;,&quot;).last}_#{smr ? (&quot;sl&quot;) : (&quot;fl&quot;)}_#{DateTime.now.strftime(&quot;%Y%m%d%H%M%S&quot;)}&quot;}.zip #{&quot;log/mb_#{<span class="user_input">ids.split(&quot;,&quot;).first</span>}_to_#{ids.split(&quot;,&quot;).last}_#{smr ? (&quot;sl&quot;) : (&quot;fl&quot;)}_#{DateTime.now.strftime(&quot;%Y%m%d%H%M%S&quot;)}&quot;}.csv`</span></span><table id='context13' class='context' style='display:none'><caption>app/controllers/api/media_buy_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>210</pre>
          </td>
          <td class='context'>
            <pre class='context'>		if fs.length &gt; 1</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>211</pre>
            </td>
            <td class='context'>
              <pre class='context'>			ip = ids.split(&quot;,&quot;)</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>212</pre>
            </td>
            <td class='context'>
              <pre class='context'>			fn = &quot;log/mb_#{ip.first}_to_#{ip.last}_#{smr ? &#39;sl&#39; : &#39;fl&#39;}_#{DateTime.now.strftime(&#39;%Y%m%d%H%M%S&#39;)}&quot;</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>213</pre>
            </td>
            <td class='context'>
              <pre class='context'>			`cat #{fs.join(&#39; &#39;)} &gt; #{fn}.csv`</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>214</pre>
            </td>
            <td class='context'>
              <pre class='context'>			fs.each { |f| File.delete f }</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>215</pre>
            </td>
            <td class='context'>
              <pre class='context'>			`zip #{fn}.zip #{fn}.csv`</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>216</pre>
            </td>
            <td class='context'>
              <pre class='context'>			File.delete &quot;#{fn}.csv&quot;</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>217</pre>
            </td>
            <td class='context'>
              <pre class='context'>			fn += &quot;.zip&quot;</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>218</pre>
            </td>
            <td class='context'>
              <pre class='context'>			ct = &quot;application/zip&quot;</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>219</pre>
            </td>
            <td class='context'>
              <pre class='context'>		end</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>220</pre>
            </td>
            <td class='context'>
              <pre class='context'>		# upload the individual file or archive and return the presigned url</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>TestController</td>
      <td>index</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/dynamic_render_path/">Dynamic Render Path</a></td>
      <td>[22]</td>
      <td><div class='warning_message' onClick="toggle('context18');toggle('message18');toggle('full_message18')" >Render path contains parameter value near line 16: <span class="code">render(action =&gt; &quot;/application/tests/#{<span class="user_input">params[:type].downcase.gsub(/[^0-9a-z]/, &quot;&quot;).strip</span>}&quot;, {})</span><table id='context18' class='context' style='display:none'><caption>app/controllers/test_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>11</pre>
          </td>
          <td class='context'>
            <pre class='context'>		ty = params[:type].downcase.gsub(/[^0-9a-z]/, &quot;&quot;).strip</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>12</pre>
            </td>
            <td class='context'>
              <pre class='context'>		id = params[:id].downcase.gsub(/[^0-9a-z]/, &quot;&quot;).strip</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>13</pre>
            </td>
            <td class='context'>
              <pre class='context'>		if ty and id</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>14</pre>
            </td>
            <td class='context'>
              <pre class='context'>			# TODO find appointment and patient and pass name and appointment time into view</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>15</pre>
            </td>
            <td class='context'>
              <pre class='context'>			@id = id</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>16</pre>
            </td>
            <td class='context'>
              <pre class='context'>			render &quot;/application/tests/#{ty}&quot;</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>17</pre>
            </td>
            <td class='context'>
              <pre class='context'>		else</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>18</pre>
            </td>
            <td class='context'>
              <pre class='context'>			render &quot;/application/tests/error&quot;</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>19</pre>
            </td>
            <td class='context'>
              <pre class='context'>		end</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>20</pre>
            </td>
            <td class='context'>
              <pre class='context'>	end</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>21</pre>
            </td>
            <td class='context'>
              <pre class='context'>end</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>SurveyController</td>
      <td>create</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/remote_code_execution/">Remote Code Execution</a></td>
      <td>[470]</td>
      <td><div class='warning_message' onClick="toggle('context162');toggle('message162');toggle('full_message162')" >Unsafe reflection method <span class="code">constantize</span> called on parameter value near line 37: <span class="code">Sanitize.alpha_numeric(<span class="user_input">params[:t_type]</span>).camelize.constantize</span><table id='context162' class='context' style='display:none'><caption>app/controllers/survey_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>32</pre>
          </td>
          <td class='context'>
            <pre class='context'>	def create</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>33</pre>
            </td>
            <td class='context'>
              <pre class='context'>		if params[:t_type] == &quot;preview&quot;</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>34</pre>
            </td>
            <td class='context'>
              <pre class='context'>			render &quot;/application/surveys/success&quot;</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>35</pre>
            </td>
            <td class='context'>
              <pre class='context'>			return</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>36</pre>
            </td>
            <td class='context'>
              <pre class='context'>		end</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>37</pre>
            </td>
            <td class='context'>
              <pre class='context'>		survey_trigger = Sanitize.alpha_numeric(params[:t_type]).camelize.constantize.find_by_uuid(params[:t_id])</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>38</pre>
            </td>
            <td class='context'>
              <pre class='context'>		survey = nil</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>39</pre>
            </td>
            <td class='context'>
              <pre class='context'>		email_body = &quot;&lt;p&gt;Office: #{survey_trigger.office.name}&lt;/p&gt;&lt;p&gt;Provider: #{survey_trigger.hcp_f_name} #{survey_trigger.hcp_l_name}&lt;/p&gt;&lt;p&gt;Patient: &quot;</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>40</pre>
            </td>
            <td class='context'>
              <pre class='context'>		survey_patient = survey_trigger.patient</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>41</pre>
            </td>
            <td class='context'>
              <pre class='context'>		if survey_patient.nil? </pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>42</pre>
            </td>
            <td class='context'>
              <pre class='context'>			email_body += &quot;Unknown&quot;</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>Api::DashboardController</td>
      <td>returns_overview</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context21');toggle('message21');toggle('full_message21')" ><span id='message21' style='display:block'>Possible SQL injection near line 740: ...</span><span id='full_message21' style='display:none'>Possible SQL injection near line 740: <span class="code">General.find_by_sql([&quot;select &#39;#{(((&quot;&quot; or &quot;Past Month&quot;) or &quot;Past 6 Months&quot;) or &quot;Past Year&quot;)}&#39; as title, date_trunc(&#39;month&#39;, purchased_at)::timestamp as month, office, concat(hcp_f_name, &#39; &#39;, hcp_l_name) as provider, count(distinct patient_id) as patients_purchased, count(distinct patient_id) filter (where returned_at is not null) as returns\nfrom (\n\tselect pr.patient_id, purchased_at, price, returned_at, coalesce(pr.hcp_f_name, mv.hcp_f_name, o.hcp_f_name) as hcp_f_name,  coalesce(pr.hcp_l_name, \t\t\t\tmv.hcp_l_name, o.hcp_l_name) as hcp_l_name, o.name as office\n\tfrom (select id, patient_id, purchased_at, price, returned_at, hcp_f_name, hcp_l_name, purchase_type from purchases) pr\n\tjoin mv_patients mv on mv.id = pr.patient_id\n\tjoin (select id, name, hcp_f_name, hcp_l_name from offices) o on o.id = mv.office_id\n\twhere mv.client_id = :cid and purchased_at between date_trunc(&#39;month&#39;, now() - interval #{(&quot;&#39;#{1} month&#39;&quot; or &quot;&#39;#{<span class="user_input">date_range</span>} months&#39;&quot;)}) and now()\n\tand purchase_type in (&#39;l_hearing_aid&#39;, &#39;r_hearing_aid&#39;)\n) qy\ngroup by month, office, provider\norder by month desc, office, provider\n&quot;, { :cid =&gt; cid.to_i }])</span></span><table id='context21' class='context' style='display:none'><caption>app/controllers/api/dashboard_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>735</pre>
          </td>
          <td class='context'>
            <pre class='context'>				from (</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>736</pre>
            </td>
            <td class='context'>
              <pre class='context'>					select pr.patient_id, purchased_at, price, returned_at, coalesce(pr.hcp_f_name, mv.hcp_f_name, o.hcp_f_name) as hcp_f_name,  coalesce(pr.hcp_l_name, 				mv.hcp_l_name, o.hcp_l_name) as hcp_l_name, o.name as office</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>737</pre>
            </td>
            <td class='context'>
              <pre class='context'>					from (select id, patient_id, purchased_at, price, returned_at, hcp_f_name, hcp_l_name, purchase_type from purchases) pr</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>738</pre>
            </td>
            <td class='context'>
              <pre class='context'>					join mv_patients mv on mv.id = pr.patient_id</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>739</pre>
            </td>
            <td class='context'>
              <pre class='context'>					join (select id, name, hcp_f_name, hcp_l_name from offices) o on o.id = mv.office_id</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>740</pre>
            </td>
            <td class='context'>
              <pre class='context'>					where mv.client_id = :cid and purchased_at between date_trunc(&#39;month&#39;, now() - interval #{date}) and now()</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>741</pre>
            </td>
            <td class='context'>
              <pre class='context'>					and purchase_type in (&#39;l_hearing_aid&#39;, &#39;r_hearing_aid&#39;)</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>742</pre>
            </td>
            <td class='context'>
              <pre class='context'>				) qy</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>743</pre>
            </td>
            <td class='context'>
              <pre class='context'>				group by month, office, provider</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>744</pre>
            </td>
            <td class='context'>
              <pre class='context'>				order by month desc, office, provider</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>745</pre>
            </td>
            <td class='context'>
              <pre class='context'>			SQL</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>Api::DashboardController</td>
      <td>touch_step_ab</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context23');toggle('message23');toggle('full_message23')" ><span id='message23' style='display:block'>Possible SQL injection near line 797: ...</span><span id='full_message23' style='display:none'>Possible SQL injection near line 797: <span class="code">General.find_by_sql([&quot;select nudge_name, month, count(distinct mod_individual) filter (where test_type = &#39;A&#39;) messaged_a, count(distinct mod_individual) filter (where test_type = &#39;B&#39;) messaged_b, count(distinct app_pt) filter (where test_type = &#39;A&#39;) as scheduled_appts_a, count(distinct app_pt) filter (where test_type = &#39;B&#39;) as scheduled_appts_b, count(distinct app_pt) filter (where test_type = &#39;A&#39; #{<span class="user_input">status_filter(cid)</span>}) completed_appts_a, count(distinct app_pt) filter (where test_type = &#39;B&#39; #{<span class="user_input">status_filter(cid)</span>}) completed_appts_b, count(distinct purch_pt) filter (where test_type = &#39;A&#39;) as purchases_a, count(distinct purch_pt) filter (where test_type = &#39;B&#39;) as purchases_b, coalesce(sum(price) filter (where test_type = &#39;A&#39;)::integer, 0) as revenue_a, coalesce(sum(price) filter (where test_type = &#39;B&#39;)::integer, 0) as revenue_b\nfrom (\n\tselect mv.month, mv.client_id, mv.message_id, mv.nudge_name, mv.office_id, mv.app_id, mv.mod_individual, mv.status, mv.category, mv.app_pt, mv.purch_id, mv.purch_pt, mv.price, o.name, mod.id as mod_id, mod.\&quot;to\&quot;, mod.message, mod.message_type, mod.status as mes_status, mod.touch_step_id, mb.test_type\n\tfrom (select id, name from offices where client_id = :cid and active = &#39;t&#39;) o\n\tjoin mv_ngdash_results mv on mv.office_id = o.id\n\tjoin message_out_details mod on mod.id = mv.message_id\n\tjoin (select id, recipient_id, test_type from media_buys_recipients where test_type in (&#39;A&#39;, &#39;B&#39;)) mb on mb.recipient_id = mod.individual_id\n\twhere mv.month #{between_date_range} and mv.client_id = :cid and touch_step_id = :ts_id\n) qy\ngroup by nudge_name, month\norder by month desc\n&quot;, { :cid =&gt; cid.to_i, :ts_id =&gt; ts_id.to_i }])</span></span><table id='context23' class='context' style='display:none'><caption>app/controllers/api/dashboard_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>793</pre>
          </td>
          <td class='context'>
            <pre class='context'>	def touch_step_ab(cid, ts_id)</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>794</pre>
            </td>
            <td class='context'>
              <pre class='context'>		table_columns = [NDT::NUMBER, NDT::NUMBER, NDT::NUMBER, NDT::NUMBER, NDT::NUMBER, NDT::NUMBER, NDT::NUMBER, NDT::NUMBER, NDT::CURRENCY, NDT::CURRENCY]</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>795</pre>
            </td>
            <td class='context'>
              <pre class='context'>		status_filter = status_filter(cid)</pre>
            </td>
          </tr>
          <tr class='context alt near_error'>
            <td class='context_line'>
              <pre class='context'>796</pre>
            </td>
            <td class='context'>
              <pre class='context'>		rs = General.find_by_sql [&lt;&lt;~SQL, {:cid =&gt; cid.to_i, :ts_id =&gt; ts_id.to_i}]</pre>
            </td>
          </tr>
          <tr class='context error'>
            <td class='context_line'>
              <pre class='context'>797</pre>
            </td>
            <td class='context'>
              <pre class='context'>			select nudge_name, month, count(distinct mod_individual) filter (where test_type = &#39;A&#39;) messaged_a, count(distinct mod_individual) filter (where test_type = &#39;B&#39;) messaged_b, count(distinct app_pt) filter (where test_type = &#39;A&#39;) as scheduled_appts_a, count(distinct app_pt) filter (where test_type = &#39;B&#39;) as scheduled_appts_b, count(distinct app_pt) filter (where test_type = &#39;A&#39; #{status_filter}) completed_appts_a, count(distinct app_pt) filter (where test_type = &#39;B&#39; #{status_filter}) completed_appts_b, count(distinct purch_pt) filter (where test_type = &#39;A&#39;) as purchases_a, count(distinct purch_pt) filter (where test_type = &#39;B&#39;) as purchases_b, coalesce(sum(price) filter (where test_type = &#39;A&#39;)::integer, 0) as revenue_a, coalesce(sum(price) filter (where test_type = &#39;B&#39;)::integer, 0) as revenue_b</pre>
            </td>
          </tr>
          <tr class='context alt near_error'>
            <td class='context_line'>
              <pre class='context'>798</pre>
            </td>
            <td class='context'>
              <pre class='context'>			from (</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>799</pre>
            </td>
            <td class='context'>
              <pre class='context'>				select mv.month, mv.client_id, mv.message_id, mv.nudge_name, mv.office_id, mv.app_id, mv.mod_individual, mv.status, mv.category, mv.app_pt, mv.purch_id, mv.purch_pt, mv.price, o.name, mod.id as mod_id, mod.&quot;to&quot;, mod.message, mod.message_type, mod.status as mes_status, mod.touch_step_id, mb.test_type</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>800</pre>
            </td>
            <td class='context'>
              <pre class='context'>				from (select id, name from offices where client_id = :cid and active = &#39;t&#39;) o</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>801</pre>
            </td>
            <td class='context'>
              <pre class='context'>				join mv_ngdash_results mv on mv.office_id = o.id</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>802</pre>
            </td>
            <td class='context'>
              <pre class='context'>				join message_out_details mod on mod.id = mv.message_id</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>Api::DashboardController</td>
      <td>nudge_summary_dashboard</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context26');toggle('message26');toggle('full_message26')" >Possible SQL injection near line 907: <span class="code">General.find_by_sql([&quot;select to_char(gs.month::date, &#39;Mon YYYY&#39;) as month, coalesce(revenue, 0) as revenue\nfrom (\n\t#{<span class="user_input">date_range</span>}\n) gs\nleft join\n(select date_trunc(&#39;month&#39;, pu.purchased_at::date) as month, coalesce(sum(pu.price)::integer, 0) as revenue\n\tfrom (\n\t\tselect patient_id, purchased_at, price, returned_at from purchases p\n\t\tjoin mv_patients mv on mv.id = p.patient_id\n\t\twhere mv.client_id = :cid and returned_at is null\n\t\tand purchased_at &gt;= date_trunc(&#39;month&#39;, &#39;#{date_string}&#39;::date) and purchased_at &lt;= date_trunc(&#39;month&#39;, &#39;#{date_string}&#39;::date + interval &#39;1 year&#39;)\n\t) pu\n\tgroup by month\n\torder by month\n) qy on qy.month = gs.month\norder by gs.month::date\n&quot;, { :cid =&gt; cid }])</span><table id='context26' class='context' style='display:none'><caption>app/controllers/api/dashboard_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>902</pre>
          </td>
          <td class='context'>
            <pre class='context'>		dt[:years] = years</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>904</pre>
            </td>
            <td class='context'>
              <pre class='context'>		rv = General.find_by_sql [&lt;&lt;~SQL, {:cid =&gt; cid}]</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>905</pre>
            </td>
            <td class='context'>
              <pre class='context'>			select to_char(gs.month::date, &#39;Mon YYYY&#39;) as month, coalesce(revenue, 0) as revenue</pre>
            </td>
          </tr>
          <tr class='context alt near_error'>
            <td class='context_line'>
              <pre class='context'>906</pre>
            </td>
            <td class='context'>
              <pre class='context'>			from (</pre>
            </td>
          </tr>
          <tr class='context error'>
            <td class='context_line'>
              <pre class='context'>907</pre>
            </td>
            <td class='context'>
              <pre class='context'>				#{date_range}</pre>
            </td>
          </tr>
          <tr class='context alt near_error'>
            <td class='context_line'>
              <pre class='context'>908</pre>
            </td>
            <td class='context'>
              <pre class='context'>			) gs</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>909</pre>
            </td>
            <td class='context'>
              <pre class='context'>			left join</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>910</pre>
            </td>
            <td class='context'>
              <pre class='context'>			(select date_trunc(&#39;month&#39;, pu.purchased_at::date) as month, coalesce(sum(pu.price)::integer, 0) as revenue</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>911</pre>
            </td>
            <td class='context'>
              <pre class='context'>				from (</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>912</pre>
            </td>
            <td class='context'>
              <pre class='context'>					select patient_id, purchased_at, price, returned_at from purchases p</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>Api::DashboardController</td>
      <td>nudge_summary_dashboard</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context27');toggle('message27');toggle('full_message27')" >Possible SQL injection near line 927: <span class="code">General.find_by_sql([&quot;select to_char(gs.month::date, &#39;Mon YYYY&#39;) as month, coalesce(revenue, 0) as revenue\n\tfrom (\n\t\t#{<span class="user_input">date_range</span>}\n\t) gs\nleft join\n\t(select date_trunc(&#39;month&#39;, month) as month, coalesce(sum(price), 0)::integer as revenue\n\t\tfrom mv_ngdash_results mv\n\t\tjoin query_types qt on qt.id = mv.query_type_id\n\t\twhere mv.client_id = :cid and month is not null\n\t\tand qt.dashboard = &#39;t&#39; and dashboard_type = &#39;purchase&#39;\n\t\tgroup by month\n\t\torder by month\n\t) qy on qy.month = gs.month\norder by gs.month::date\n&quot;, { :cid =&gt; cid }])</span><table id='context27' class='context' style='display:none'><caption>app/controllers/api/dashboard_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>922</pre>
          </td>
          <td class='context'>
            <pre class='context'>		dt[:sparklines].push({name: &quot;Total Revenue&quot;, chart_type: &quot;sparkline&quot;, data: rv.map(&amp;:revenue), total: rv.map(&amp;:revenue).sum, categories: rv.map(&amp;:month)})</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>924</pre>
            </td>
            <td class='context'>
              <pre class='context'>		nr = General.find_by_sql [&lt;&lt;~SQL, {:cid =&gt; cid}]</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>925</pre>
            </td>
            <td class='context'>
              <pre class='context'>			select to_char(gs.month::date, &#39;Mon YYYY&#39;) as month, coalesce(revenue, 0) as revenue</pre>
            </td>
          </tr>
          <tr class='context alt near_error'>
            <td class='context_line'>
              <pre class='context'>926</pre>
            </td>
            <td class='context'>
              <pre class='context'>				from (</pre>
            </td>
          </tr>
          <tr class='context error'>
            <td class='context_line'>
              <pre class='context'>927</pre>
            </td>
            <td class='context'>
              <pre class='context'>					#{date_range}</pre>
            </td>
          </tr>
          <tr class='context alt near_error'>
            <td class='context_line'>
              <pre class='context'>928</pre>
            </td>
            <td class='context'>
              <pre class='context'>				) gs</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>929</pre>
            </td>
            <td class='context'>
              <pre class='context'>			left join</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>930</pre>
            </td>
            <td class='context'>
              <pre class='context'>				(select date_trunc(&#39;month&#39;, month) as month, coalesce(sum(price), 0)::integer as revenue</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>931</pre>
            </td>
            <td class='context'>
              <pre class='context'>					from mv_ngdash_results mv</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>932</pre>
            </td>
            <td class='context'>
              <pre class='context'>					join query_types qt on qt.id = mv.query_type_id</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>Api::DashboardController</td>
      <td>nudge_summary_dashboard</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context28');toggle('message28');toggle('full_message28')" >Possible SQL injection near line 945: <span class="code">General.find_by_sql([&quot;select query_type, case sum(resulting_appts) when 0 then 0 else round(sum(patients_who_purchased)/sum(resulting_appts) * 100) end as close_rate\nfrom (\n\tselect month, nudge_name, qt.id as qt_id, qt.name as query_type, o.name as office, count(distinct mod_individual) as patients_messaged, count(distinct app_pt) filter (where true #{<span class="user_input">status_filter(cid)</span>}) as resulting_appts, count(distinct purch_pt) as patients_who_purchased, coalesce(sum(price)::integer, 0) as total_revenue\n\tfrom (select * from offices where client_id = :cid and active = &#39;t&#39;) o\n\tjoin mv_ngdash_results mv on o.id = mv.office_id\n\tjoin (select id, name, dashboard from query_types where dashboard = &#39;t&#39; and dashboard_type = &#39;purchase&#39;) qt on qt.id = mv.query_type_id\n\twhere month between date_trunc(&#39;year&#39;, &#39;#{date_string}&#39;::date) and now()\n\tgroup by month, nudge_name, office, qt.id, qt.name\n\torder by month desc, nudge_name, office\n) qy\ngroup by query_type\norder by query_type\n&quot;, { :cid =&gt; cid }])</span><table id='context28' class='context' style='display:none'><caption>app/controllers/api/dashboard_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>940</pre>
          </td>
          <td class='context'>
            <pre class='context'>		dt[:sparklines].push({name: &quot;Nudge Revenue&quot;, chart_type: &quot;sparkline&quot;, data: nr.map(&amp;:revenue), total: nr.map(&amp;:revenue).sum, categories: nr.map(&amp;:month)})</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>942</pre>
            </td>
            <td class='context'>
              <pre class='context'>		cr = General.find_by_sql [&lt;&lt;~SQL, {:cid =&gt; cid}]</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>943</pre>
            </td>
            <td class='context'>
              <pre class='context'>			select query_type, case sum(resulting_appts) when 0 then 0 else round(sum(patients_who_purchased)/sum(resulting_appts) * 100) end as close_rate</pre>
            </td>
          </tr>
          <tr class='context alt near_error'>
            <td class='context_line'>
              <pre class='context'>944</pre>
            </td>
            <td class='context'>
              <pre class='context'>			from (</pre>
            </td>
          </tr>
          <tr class='context error'>
            <td class='context_line'>
              <pre class='context'>945</pre>
            </td>
            <td class='context'>
              <pre class='context'>				select month, nudge_name, qt.id as qt_id, qt.name as query_type, o.name as office, count(distinct mod_individual) as patients_messaged, count(distinct app_pt) filter (where true #{status_filter}) as resulting_appts, count(distinct purch_pt) as patients_who_purchased, coalesce(sum(price)::integer, 0) as total_revenue</pre>
            </td>
          </tr>
          <tr class='context alt near_error'>
            <td class='context_line'>
              <pre class='context'>946</pre>
            </td>
            <td class='context'>
              <pre class='context'>				from (select * from offices where client_id = :cid and active = &#39;t&#39;) o</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>947</pre>
            </td>
            <td class='context'>
              <pre class='context'>				join mv_ngdash_results mv on o.id = mv.office_id</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>948</pre>
            </td>
            <td class='context'>
              <pre class='context'>				join (select id, name, dashboard from query_types where dashboard = &#39;t&#39; and dashboard_type = &#39;purchase&#39;) qt on qt.id = mv.query_type_id</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>949</pre>
            </td>
            <td class='context'>
              <pre class='context'>				where month between date_trunc(&#39;year&#39;, &#39;#{date_string}&#39;::date) and now()</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>950</pre>
            </td>
            <td class='context'>
              <pre class='context'>				group by month, nudge_name, office, qt.id, qt.name</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>Api::DashboardController</td>
      <td>nudge_summary_dashboard</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context29');toggle('message29');toggle('full_message29')" >Possible SQL injection near line 962: <span class="code">General.find_by_sql([&quot;select to_char(gs.month::date, &#39;Mon YYYY&#39;) as month, coalesce(sum(price)/count(distinct purch_pt), 0) as avg_sale\nfrom (\n\t#{<span class="user_input">date_range</span>}\n) gs\nleft join (\n\tselect date_trunc(&#39;month&#39;, month) as month, purch_pt, price\n\tfrom mv_ngdash_results\n\twhere client_id = :cid and price is not null\n\tand month between date_trunc(&#39;year&#39;, &#39;#{date_string}&#39;::date) and now()\n\torder by month\n) mv on mv.month = gs.month\ngroup by gs.month\norder by gs.month\n&quot;, { :cid =&gt; cid }])</span><table id='context29' class='context' style='display:none'><caption>app/controllers/api/dashboard_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>957</pre>
          </td>
          <td class='context'>
            <pre class='context'>		dt[:sparklines].push({name: &quot;Close Rate&quot;, chart_type: &quot;donut&quot;, data: close_rate, total: close_rate.sum &gt; 0 ? close_rate.sum/close_rate.count : 0, categories: cr.map(&amp;:query_type)})</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>959</pre>
            </td>
            <td class='context'>
              <pre class='context'>		avg = General.find_by_sql [&lt;&lt;~SQL, {:cid =&gt; cid}]</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>960</pre>
            </td>
            <td class='context'>
              <pre class='context'>			select to_char(gs.month::date, &#39;Mon YYYY&#39;) as month, coalesce(sum(price)/count(distinct purch_pt), 0) as avg_sale</pre>
            </td>
          </tr>
          <tr class='context alt near_error'>
            <td class='context_line'>
              <pre class='context'>961</pre>
            </td>
            <td class='context'>
              <pre class='context'>			from (</pre>
            </td>
          </tr>
          <tr class='context error'>
            <td class='context_line'>
              <pre class='context'>962</pre>
            </td>
            <td class='context'>
              <pre class='context'>				#{date_range}</pre>
            </td>
          </tr>
          <tr class='context alt near_error'>
            <td class='context_line'>
              <pre class='context'>963</pre>
            </td>
            <td class='context'>
              <pre class='context'>			) gs</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>964</pre>
            </td>
            <td class='context'>
              <pre class='context'>			left join (</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>965</pre>
            </td>
            <td class='context'>
              <pre class='context'>				select date_trunc(&#39;month&#39;, month) as month, purch_pt, price</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>966</pre>
            </td>
            <td class='context'>
              <pre class='context'>				from mv_ngdash_results</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>967</pre>
            </td>
            <td class='context'>
              <pre class='context'>				where client_id = :cid and price is not null</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>Api::DashboardController</td>
      <td>nudge_summary_table</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context30');toggle('message30');toggle('full_message30')" >Possible SQL injection near line 991: <span class="code">General.find_by_sql([&quot;select tr.year, tr.name, tr.total_revenue, query_type_id, cr.close_rate::integer\nfrom (\n\tselect to_char(date_trunc(&#39;year&#39;, month), &#39;YYYY&#39;) as year, qt.name, qt.id as query_type_id, coalesce(sum(price), 0) as total_revenue\n\tfrom mv_ngdash_results mv\n\tjoin query_types qt on qt.id = mv.query_type_id\n\twhere mv.client_id = :cid\n\tand qt.dashboard = &#39;t&#39; and dashboard_type = &#39;purchase&#39;\n\tand month between date_trunc(&#39;month&#39;, &#39;#{<span class="user_input">date_string</span>}&#39;::date) and date_trunc(&#39;month&#39;, &#39;#{<span class="user_input">date_string</span>}&#39;::date + interval &#39;11 months&#39;)\n\tgroup by year, qt.name, qt.id\n\torder by year, qt.name\n) tr\nleft join (\n\tselect query_type, case sum(resulting_appts) when 0 then 0 else round(sum(patients_who_purchased)/sum(resulting_appts) * 100) end as close_rate\n\tfrom (\n\t\tselect month, nudge_name, qt.id as qt_id, qt.name as query_type, o.name as office, count(distinct mod_individual) as patients_messaged, count(distinct app_pt) filter (where true #{status_filter(cid)}) as resulting_appts, count(distinct purch_pt) as patients_who_purchased, coalesce(sum(price)::integer, 0) as total_revenue\n\t\tfrom (select * from offices where client_id = :cid and active = &#39;t&#39;) o\n\t\tjoin mv_ngdash_results mv on o.id = mv.office_id\n\t\tjoin (select id, name, dashboard from query_types where dashboard = &#39;t&#39; and dashboard_type = &#39;purchase&#39;) qt on qt.id = mv.query_type_id\n\t\twhere month between date_trunc(&#39;year&#39;, &#39;#{<span class="user_input">date_string</span>}&#39;::date) and now()\n\t\tgroup by month, nudge_name, office, qt.id, qt.name\n\t\torder by month desc, nudge_name, office\n\t) qy\n\tgroup by query_type\n\torder by query_type\n) cr on cr.query_type = tr.name\norder by year\n&quot;, { :cid =&gt; cid }])</span><table id='context30' class='context' style='display:none'><caption>app/controllers/api/dashboard_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>986</pre>
          </td>
          <td class='context'>
            <pre class='context'>				select to_char(date_trunc(&#39;year&#39;, month), &#39;YYYY&#39;) as year, qt.name, qt.id as query_type_id, coalesce(sum(price), 0) as total_revenue</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>987</pre>
            </td>
            <td class='context'>
              <pre class='context'>				from mv_ngdash_results mv</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>988</pre>
            </td>
            <td class='context'>
              <pre class='context'>				join query_types qt on qt.id = mv.query_type_id</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>989</pre>
            </td>
            <td class='context'>
              <pre class='context'>				where mv.client_id = :cid</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>990</pre>
            </td>
            <td class='context'>
              <pre class='context'>				and qt.dashboard = &#39;t&#39; and dashboard_type = &#39;purchase&#39;</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>991</pre>
            </td>
            <td class='context'>
              <pre class='context'>				and month between date_trunc(&#39;month&#39;, &#39;#{date_string}&#39;::date) and date_trunc(&#39;month&#39;, &#39;#{date_string}&#39;::date + interval &#39;11 months&#39;)</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>992</pre>
            </td>
            <td class='context'>
              <pre class='context'>				group by year, qt.name, qt.id</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>993</pre>
            </td>
            <td class='context'>
              <pre class='context'>				order by year, qt.name</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>994</pre>
            </td>
            <td class='context'>
              <pre class='context'>			) tr</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>995</pre>
            </td>
            <td class='context'>
              <pre class='context'>			left join (</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>996</pre>
            </td>
            <td class='context'>
              <pre class='context'>				select query_type, case sum(resulting_appts) when 0 then 0 else round(sum(patients_who_purchased)/sum(resulting_appts) * 100) end as close_rate</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>Api::DashboardController</td>
      <td>nudge_summary_table</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context31');toggle('message31');toggle('full_message31')" >Possible SQL injection near line 1019: <span class="code">General.find_by_sql([&quot;select to_char(gs.month::date, &#39;Mon YYYY&#39;) as month, qy.name, coalesce(total_revenue, 0)::integer as revenue\nfrom (\n\t#{<span class="user_input">date_range</span>}\n) gs\nleft join (\n\tselect month, qt.name, coalesce(sum(price), 0) as total_revenue\n\tfrom mv_ngdash_results mv\n\tjoin query_types qt on qt.id = mv.query_type_id\n\twhere mv.client_id = :cid and qt.id = #{rw.query_type_id}\n\tand qt.dashboard = &#39;t&#39; and dashboard_type = &#39;purchase&#39;\n\tand month between date_trunc(&#39;month&#39;, &#39;#{date_string}&#39;::date) and date_trunc(&#39;month&#39;, &#39;#{date_string}&#39;::date + interval &#39;11 months&#39;)\n\tgroup by month, qt.name\n\torder by month\n) qy on qy.month = gs.month\norder by gs.month\n&quot;, { :cid =&gt; cid }])</span><table id='context31' class='context' style='display:none'><caption>app/controllers/api/dashboard_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>1014</pre>
          </td>
          <td class='context'>
            <pre class='context'>				qt = rw.query_type_id</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1015</pre>
            </td>
            <td class='context'>
              <pre class='context'>				table_obj = {year: nil, name: nil, total_revenue: nil, query_type_id: nil, close_rate: nil, chart_data: [], categories: [], chart_name: nil}</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1016</pre>
            </td>
            <td class='context'>
              <pre class='context'>				ytd = General.find_by_sql [&lt;&lt;~SQL, {:cid =&gt; cid}]</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1017</pre>
            </td>
            <td class='context'>
              <pre class='context'>					select to_char(gs.month::date, &#39;Mon YYYY&#39;) as month, qy.name, coalesce(total_revenue, 0)::integer as revenue</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>1018</pre>
            </td>
            <td class='context'>
              <pre class='context'>					from (</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>1019</pre>
            </td>
            <td class='context'>
              <pre class='context'>						#{date_range}</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>1020</pre>
            </td>
            <td class='context'>
              <pre class='context'>					) gs</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1021</pre>
            </td>
            <td class='context'>
              <pre class='context'>					left join (</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1022</pre>
            </td>
            <td class='context'>
              <pre class='context'>						select month, qt.name, coalesce(sum(price), 0) as total_revenue</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1023</pre>
            </td>
            <td class='context'>
              <pre class='context'>						from mv_ngdash_results mv</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1024</pre>
            </td>
            <td class='context'>
              <pre class='context'>						join query_types qt on qt.id = mv.query_type_id</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>Api::DashboardController</td>
      <td>nudge_close_rate</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context32');toggle('message32');toggle('full_message32')" >Possible SQL injection near line 1137: <span class="code">General.find_by_sql([&quot;select query_type, case sum(resulting_appts) when 0 then 0 else round(sum(patients_who_purchased)/sum(resulting_appts) * 100) end as close_rate\nfrom (\n\tselect month, nudge_name, qt.id as qt_id, qt.name as query_type, o.name as office, count(distinct mod_individual) as patients_messaged, count(distinct app_pt) filter (where true #{<span class="user_input">status_filter(cid)</span>}) as resulting_appts, count(distinct purch_pt) as patients_who_purchased, coalesce(sum(price)::integer, 0) as total_revenue\n\tfrom (select * from offices where client_id = :cid and active = &#39;t&#39;) o\n\tjoin mv_ngdash_results mv on o.id = mv.office_id\n\tjoin (select id, name, dashboard from query_types where dashboard = &#39;t&#39;) qt on qt.id = mv.query_type_id\n\twhere nudge_name not Ilike &#39;%Survey%&#39; and month between date_trunc(&#39;year&#39;, now()) and now()\n\tgroup by month, nudge_name, office, qt.id, qt.name\n\torder by month desc, nudge_name, office\n) qy\ngroup by query_type\norder by query_type\n&quot;, { :cid =&gt; cid.to_i }])</span><table id='context32' class='context' style='display:none'><caption>app/controllers/api/dashboard_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>1132</pre>
          </td>
          <td class='context'>
            <pre class='context'>			dt = {categories: [], total: []}</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1133</pre>
            </td>
            <td class='context'>
              <pre class='context'>			status_filter = status_filter(cid)</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1134</pre>
            </td>
            <td class='context'>
              <pre class='context'>			rs = General.find_by_sql [&lt;&lt;~SQL, {:cid =&gt; cid.to_i}]</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1135</pre>
            </td>
            <td class='context'>
              <pre class='context'>				select query_type, case sum(resulting_appts) when 0 then 0 else round(sum(patients_who_purchased)/sum(resulting_appts) * 100) end as close_rate</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>1136</pre>
            </td>
            <td class='context'>
              <pre class='context'>				from (</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>1137</pre>
            </td>
            <td class='context'>
              <pre class='context'>					select month, nudge_name, qt.id as qt_id, qt.name as query_type, o.name as office, count(distinct mod_individual) as patients_messaged, count(distinct app_pt) filter (where true #{status_filter}) as resulting_appts, count(distinct purch_pt) as patients_who_purchased, coalesce(sum(price)::integer, 0) as total_revenue</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>1138</pre>
            </td>
            <td class='context'>
              <pre class='context'>					from (select * from offices where client_id = :cid and active = &#39;t&#39;) o</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1139</pre>
            </td>
            <td class='context'>
              <pre class='context'>					join mv_ngdash_results mv on o.id = mv.office_id</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1140</pre>
            </td>
            <td class='context'>
              <pre class='context'>					join (select id, name, dashboard from query_types where dashboard = &#39;t&#39;) qt on qt.id = mv.query_type_id</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1141</pre>
            </td>
            <td class='context'>
              <pre class='context'>					where nudge_name not Ilike &#39;%Survey%&#39; and month between date_trunc(&#39;year&#39;, now()) and now()</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1142</pre>
            </td>
            <td class='context'>
              <pre class='context'>					group by month, nudge_name, office, qt.id, qt.name</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>Api::DashboardController</td>
      <td>touch_step_graph</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context33');toggle('message33');toggle('full_message33')" >Possible SQL injection near line 1207: <span class="code">General.find_by_sql([&quot;select gs.month as month, coalesce(action_ofs, 0) as action_ofs, coalesce(ms_sent, 0) as ms_sent\nfrom (\n\t#{<span class="user_input">generate_series(date_range)</span>}\n) gs\nleft join (\n\tselect date_trunc(&#39;month&#39;, processed_at) as month, action_ofs, coalesce(count(distinct(qy.id)), 0) as ms_sent\n\t\tfrom (\n\t\t\tselect mod.processed_at, mod.id, ts.action_ofs\n\t\t\tfrom (select id, action_ofs, nudge_id from touch_steps) ts\n\t\t\tjoin (select id, name from nudges) n on n.id = ts.nudge_id\n\t\t\tjoin (select id, processed_at, client_id, status, touch_step_id from message_out_details) mod on mod.touch_step_id = ts.id\n\t\t\twhere n.id = :nid and mod.client_id = :cid and mod.status in (&#39;sent&#39;, &#39;delivered&#39;)\n\t\t\tgroup by mod.processed_at, action_ofs, mod.id\n\t\t\torder by mod.processed_at, action_ofs\n\t\t) qy\n\t\tgroup by month, action_ofs\n\t\torder by month, action_ofs\n) jn on jn.month = gs.month\norder by month, action_ofs\n&quot;, { :cid =&gt; client.id.to_i, :nid =&gt; nid }])</span><table id='context33' class='context' style='display:none'><caption>app/controllers/api/dashboard_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>1202</pre>
          </td>
          <td class='context'>
            <pre class='context'>			ts_data[:type] = &quot;opt_outs&quot;</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1203</pre>
            </td>
            <td class='context'>
              <pre class='context'>		when &quot;total_sent&quot;</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1204</pre>
            </td>
            <td class='context'>
              <pre class='context'>			ts = General.find_by_sql [&lt;&lt;~SQL, {:cid =&gt; client.id.to_i, :nid =&gt; nid}]</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1205</pre>
            </td>
            <td class='context'>
              <pre class='context'>				select gs.month as month, coalesce(action_ofs, 0) as action_ofs, coalesce(ms_sent, 0) as ms_sent</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>1206</pre>
            </td>
            <td class='context'>
              <pre class='context'>				from (</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>1207</pre>
            </td>
            <td class='context'>
              <pre class='context'>					#{generate_series(date_range)}</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>1208</pre>
            </td>
            <td class='context'>
              <pre class='context'>				) gs</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1209</pre>
            </td>
            <td class='context'>
              <pre class='context'>				left join (</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1210</pre>
            </td>
            <td class='context'>
              <pre class='context'>					select date_trunc(&#39;month&#39;, processed_at) as month, action_ofs, coalesce(count(distinct(qy.id)), 0) as ms_sent</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1211</pre>
            </td>
            <td class='context'>
              <pre class='context'>						from (</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1212</pre>
            </td>
            <td class='context'>
              <pre class='context'>							select mod.processed_at, mod.id, ts.action_ofs</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>Api::DashboardController</td>
      <td>touch_step_graph</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context34');toggle('message34');toggle('full_message34')" >Possible SQL injection near line 1231: <span class="code">General.find_by_sql([&quot;select gs.month as month, coalesce(action_ofs, 0) as action_ofs, coalesce(appts, 0) as appts\nfrom (\n\t#{<span class="user_input">generate_series(date_range)</span>}\n) gs\nleft join (\n\tselect date_trunc(&#39;month&#39;, processed_at) as month, action_ofs, count(distinct(app_pt)) as appts\n\t\tfrom (\n\t\t\tselect *\n\t\t\tfrom (select id, action_ofs, nudge_id from touch_steps) ts\n\t\t\tjoin (select id, name from nudges) n on n.id = ts.nudge_id\n\t\t\tjoin (select id, client_id, processed_at, touch_step_id, status from message_out_details) mod on mod.touch_step_id = ts.id\n\t\t\tleft join (select app_id, app_pt, message_id, price from mv_ngdash_results where client_id = :cid #{status_filter(client.id)}) mv on mv.message_id = mod.id\n\t\t\twhere n.id = :nid and mod.client_id = :cid and mod.status in (&#39;sent&#39;, &#39;delivered&#39;)\n\t\t) qy\n\t\tgroup by month, action_ofs\n\t\torder by month, action_ofs\n) jn on jn.month = gs.month\norder by month, action_ofs\n&quot;, { :cid =&gt; client.id.to_i, :nid =&gt; nid }])</span><table id='context34' class='context' style='display:none'><caption>app/controllers/api/dashboard_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>1226</pre>
          </td>
          <td class='context'>
            <pre class='context'>			ts_data = format_ts_data(ts, &quot;ms_sent&quot;)</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1227</pre>
            </td>
            <td class='context'>
              <pre class='context'>		when &quot;appts&quot;</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1228</pre>
            </td>
            <td class='context'>
              <pre class='context'>			dt = General.find_by_sql [&lt;&lt;~SQL, {:cid =&gt; client.id.to_i, :nid =&gt; nid}]</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1229</pre>
            </td>
            <td class='context'>
              <pre class='context'>				select gs.month as month, coalesce(action_ofs, 0) as action_ofs, coalesce(appts, 0) as appts</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>1230</pre>
            </td>
            <td class='context'>
              <pre class='context'>				from (</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>1231</pre>
            </td>
            <td class='context'>
              <pre class='context'>					#{generate_series(date_range)}</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>1232</pre>
            </td>
            <td class='context'>
              <pre class='context'>				) gs</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1233</pre>
            </td>
            <td class='context'>
              <pre class='context'>				left join (</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1234</pre>
            </td>
            <td class='context'>
              <pre class='context'>					select date_trunc(&#39;month&#39;, processed_at) as month, action_ofs, count(distinct(app_pt)) as appts</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1235</pre>
            </td>
            <td class='context'>
              <pre class='context'>						from (</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1236</pre>
            </td>
            <td class='context'>
              <pre class='context'>							select *</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>Api::DashboardController</td>
      <td>touch_step_graph</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context35');toggle('message35');toggle('full_message35')" >Possible SQL injection near line 1254: <span class="code">General.find_by_sql([&quot;select gs.month as month, coalesce(action_ofs, 0) as action_ofs, coalesce(sales, 0) as sales\nfrom (\n\t#{<span class="user_input">generate_series(date_range)</span>}\n) gs\nleft join (\n\tselect date_trunc(&#39;month&#39;, processed_at) as month, action_ofs, coalesce(sum(price), 0) as sales\n\t\tfrom (\n\t\t\tselect distinct on (mod.id) mod.processed_at, ts.action_ofs, sum(price) as price\n\t\t\tfrom (select id, action_ofs, nudge_id from touch_steps) ts\n\t\t\tjoin (select id, name from nudges) n on n.id = ts.nudge_id\n\t\t\tjoin (select id, client_id, processed_at, touch_step_id, status from message_out_details) mod on mod.touch_step_id = ts.id\n\t\t\tleft join (select app_id, message_id, price from mv_ngdash_results where client_id = :cid #{status_filter(client.id)}) mv on mv.message_id = mod.id\n\t\t\twhere n.id = :nid and mod.client_id = :cid and mod.status in (&#39;sent&#39;, &#39;delivered&#39;)\n\t\t\tgroup by mod.id, mod.processed_at, action_ofs\n\t\t\torder by mod.id, mod.processed_at, action_ofs\n\t\t) qy\n\t\tgroup by month, action_ofs\n\t\torder by month, action_ofs\n) jn on jn.month = gs.month\norder by month, action_ofs\n&quot;, { :cid =&gt; client.id.to_i, :nid =&gt; nid }])</span><table id='context35' class='context' style='display:none'><caption>app/controllers/api/dashboard_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>1249</pre>
          </td>
          <td class='context'>
            <pre class='context'>			ts_data = format_ts_data(dt, category)</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1250</pre>
            </td>
            <td class='context'>
              <pre class='context'>		when &quot;sales&quot;</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1251</pre>
            </td>
            <td class='context'>
              <pre class='context'>			dt = General.find_by_sql [&lt;&lt;~SQL, {:cid =&gt; client.id.to_i, :nid =&gt; nid}]</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1252</pre>
            </td>
            <td class='context'>
              <pre class='context'>				select gs.month as month, coalesce(action_ofs, 0) as action_ofs, coalesce(sales, 0) as sales</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>1253</pre>
            </td>
            <td class='context'>
              <pre class='context'>				from (</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>1254</pre>
            </td>
            <td class='context'>
              <pre class='context'>					#{generate_series(date_range)}</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>1255</pre>
            </td>
            <td class='context'>
              <pre class='context'>				) gs</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1256</pre>
            </td>
            <td class='context'>
              <pre class='context'>				left join (</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1257</pre>
            </td>
            <td class='context'>
              <pre class='context'>					select date_trunc(&#39;month&#39;, processed_at) as month, action_ofs, coalesce(sum(price), 0) as sales</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1258</pre>
            </td>
            <td class='context'>
              <pre class='context'>						from (</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1259</pre>
            </td>
            <td class='context'>
              <pre class='context'>							select distinct on (mod.id) mod.processed_at, ts.action_ofs, sum(price) as price</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>Api::DashboardController</td>
      <td>touch_step_alltime</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context36');toggle('message36');toggle('full_message36')" >Possible SQL injection near line 1309: <span class="code">General.find_by_sql([&quot;select action_ofs, count(distinct(app_pt)) as appts\nfrom (\n\tselect *\n\tfrom (select id, action_ofs, nudge_id from touch_steps) ts\n\tjoin (select id, name from nudges) n on n.id = ts.nudge_id\n\tjoin (select id, client_id, processed_at, touch_step_id, status from message_out_details) mod on mod.touch_step_id = ts.id\n\tleft join (select app_id, app_pt, message_id, price from mv_ngdash_results where client_id = :cid #{<span class="user_input">status_filter(cid)</span>}) mv on mv.message_id = mod.id\n\twhere n.id = :nid and mod.client_id = :cid and mod.status in (&#39;sent&#39;, &#39;delivered&#39;)\n) qy\ngroup by action_ofs\norder by action_ofs\n&quot;, { :cid =&gt; cid, :nid =&gt; nid }])</span><table id='context36' class='context' style='display:none'><caption>app/controllers/api/dashboard_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>1304</pre>
          </td>
          <td class='context'>
            <pre class='context'>				from (</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1305</pre>
            </td>
            <td class='context'>
              <pre class='context'>					select *</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1306</pre>
            </td>
            <td class='context'>
              <pre class='context'>					from (select id, action_ofs, nudge_id from touch_steps) ts</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1307</pre>
            </td>
            <td class='context'>
              <pre class='context'>					join (select id, name from nudges) n on n.id = ts.nudge_id</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>1308</pre>
            </td>
            <td class='context'>
              <pre class='context'>					join (select id, client_id, processed_at, touch_step_id, status from message_out_details) mod on mod.touch_step_id = ts.id</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>1309</pre>
            </td>
            <td class='context'>
              <pre class='context'>					left join (select app_id, app_pt, message_id, price from mv_ngdash_results where client_id = :cid #{status_filter}) mv on mv.message_id = mod.id</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>1310</pre>
            </td>
            <td class='context'>
              <pre class='context'>					where n.id = :nid and mod.client_id = :cid and mod.status in (&#39;sent&#39;, &#39;delivered&#39;)</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1311</pre>
            </td>
            <td class='context'>
              <pre class='context'>				) qy</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1312</pre>
            </td>
            <td class='context'>
              <pre class='context'>				group by action_ofs</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1313</pre>
            </td>
            <td class='context'>
              <pre class='context'>				order by action_ofs</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1314</pre>
            </td>
            <td class='context'>
              <pre class='context'>			SQL</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>Api::DashboardController</td>
      <td>touch_step_alltime</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context37');toggle('message37');toggle('full_message37')" >Possible SQL injection near line 1324: <span class="code">General.find_by_sql([&quot;select action_ofs, coalesce(sum(price), 0) as sales\nfrom (\n\tselect distinct on (mod.id) mod.processed_at, ts.action_ofs, sum(price) as price\n\tfrom (select id, action_ofs, nudge_id from touch_steps) ts\n\tjoin (select id, name from nudges) n on n.id = ts.nudge_id\n\tjoin (select id, client_id, processed_at, touch_step_id, status from message_out_details) mod on mod.touch_step_id = ts.id\n\tleft join (select app_id, message_id, price from mv_ngdash_results where client_id = :cid #{<span class="user_input">status_filter(cid)</span>}) mv on mv.message_id = mod.id\n\twhere n.id = :nid and mod.client_id = :cid and mod.status in (&#39;sent&#39;, &#39;delivered&#39;)\n\tgroup by mod.id, mod.processed_at, action_ofs\n\torder by mod.id, mod.processed_at, action_ofs\n) qy\ngroup by action_ofs\norder by action_ofs\n&quot;, { :cid =&gt; cid, :nid =&gt; nid }])</span><table id='context37' class='context' style='display:none'><caption>app/controllers/api/dashboard_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>1319</pre>
          </td>
          <td class='context'>
            <pre class='context'>				from (</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1320</pre>
            </td>
            <td class='context'>
              <pre class='context'>					select distinct on (mod.id) mod.processed_at, ts.action_ofs, sum(price) as price</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1321</pre>
            </td>
            <td class='context'>
              <pre class='context'>					from (select id, action_ofs, nudge_id from touch_steps) ts</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1322</pre>
            </td>
            <td class='context'>
              <pre class='context'>					join (select id, name from nudges) n on n.id = ts.nudge_id</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>1323</pre>
            </td>
            <td class='context'>
              <pre class='context'>					join (select id, client_id, processed_at, touch_step_id, status from message_out_details) mod on mod.touch_step_id = ts.id</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>1324</pre>
            </td>
            <td class='context'>
              <pre class='context'>					left join (select app_id, message_id, price from mv_ngdash_results where client_id = :cid #{status_filter}) mv on mv.message_id = mod.id</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>1325</pre>
            </td>
            <td class='context'>
              <pre class='context'>					where n.id = :nid and mod.client_id = :cid and mod.status in (&#39;sent&#39;, &#39;delivered&#39;)</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1326</pre>
            </td>
            <td class='context'>
              <pre class='context'>					group by mod.id, mod.processed_at, action_ofs</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1327</pre>
            </td>
            <td class='context'>
              <pre class='context'>					order by mod.id, mod.processed_at, action_ofs</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1328</pre>
            </td>
            <td class='context'>
              <pre class='context'>				) qy</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1329</pre>
            </td>
            <td class='context'>
              <pre class='context'>				group by action_ofs</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>Api::DashboardController</td>
      <td>channel_summary</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context38');toggle('message38');toggle('full_message38')" ><span id='message38' style='display:block'>Possible SQL injection near line 1356: ...</span><span id='full_message38' style='display:none'>Possible SQL injection near line 1356: <span class="code">General.find_by_sql([&quot;select call_month, channel_type, office, calls, prospects, appointments\nfrom mv_channel_responses\nwhere client_id = :cid and call_month in\n\t(select to_char(month, &#39;YYYY-MM&#39;)\n\tfrom generate_series(date_trunc(&#39;month&#39;,now() - interval &#39;6 months&#39;), now(), &#39;1 month&#39;) month)\n#{<span class="user_input">if ((&quot;office_id in (#{get_data_filters(@authorized_user, cid)})&quot; or &quot;&quot;).length &gt; 0) then   (&quot;and &quot; + (&quot;office_id in (#{get_data_filters(@authorized_user, cid)})&quot; or &quot;&quot;)) end</span>}\norder by call_month desc, channel_type, office;\n&quot;, { :cid =&gt; cid }])</span></span><table id='context38' class='context' style='display:none'><caption>app/controllers/api/dashboard_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>1351</pre>
          </td>
          <td class='context'>
            <pre class='context'>				select call_month, channel_type, office, calls, prospects, appointments</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1352</pre>
            </td>
            <td class='context'>
              <pre class='context'>				from mv_channel_responses</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1353</pre>
            </td>
            <td class='context'>
              <pre class='context'>				where client_id = :cid and call_month in</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1354</pre>
            </td>
            <td class='context'>
              <pre class='context'>					(select to_char(month, &#39;YYYY-MM&#39;)</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>1355</pre>
            </td>
            <td class='context'>
              <pre class='context'>					from generate_series(date_trunc(&#39;month&#39;,now() - interval &#39;6 months&#39;), now(), &#39;1 month&#39;) month)</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>1356</pre>
            </td>
            <td class='context'>
              <pre class='context'>				#{&#39;and &#39; + fq if fq.length &gt; 0}</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>1357</pre>
            </td>
            <td class='context'>
              <pre class='context'>				order by call_month desc, channel_type, office;</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1358</pre>
            </td>
            <td class='context'>
              <pre class='context'>			SQL</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1359</pre>
            </td>
            <td class='context'>
              <pre class='context'>			fc = {calls: 0, prsps: 0, appts: 0}</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1360</pre>
            </td>
            <td class='context'>
              <pre class='context'>			tp = {calls: 0, prsps: 0, appts: 0, ofics: []}</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1361</pre>
            </td>
            <td class='context'>
              <pre class='context'>			mn = {calls: 0, prsps: 0, appts: 0, types: []}</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>Api::DashboardController</td>
      <td>prospect_calls</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context39');toggle('message39');toggle('full_message39')" ><span id='message39' style='display:block'>Possible SQL injection near line 1425: ...</span><span id='full_message39' style='display:none'>Possible SQL injection near line 1425: <span class="code">General.find_by_sql([&quot;select st.call_type, st.called_at, count(*) prospects\nfrom (\n\tselect ce.client_id, ch.office_id, ch.type call_type, to_char(ce.call_date, &#39;YYYY-MM-DD&#39;) called_at\n\tfrom call_extracts ce\n\tjoin channels ch on ch.phone = ce.call_dnis\n\tjoin call_types ct on ct.group = ce.type and ct.call_type = ce.call_type\n\twhere ct.is_prospect = true\n\tand to_char(ce.call_date, &#39;YYYYMM&#39;) = :month\n\tunion all\n\tselect client_id, office_id, &#39;Online&#39; call_type, to_char(created_at, &#39;YYYY-MM-DD&#39;) called_at\n\tfrom form_extracts\n\twhere category = &#39;Prospect&#39;\n\tand to_char(created_at, &#39;YYYYMM&#39;) = :month\n) st\nleft join offices o on o.id = st.office_id\nwhere st.client_id = :cid\n#{<span class="user_input">if (((&quot;office_id in (#{get_data_filters(@authorized_user, cid)})&quot; or &quot;&quot;) or &quot;office_id = #{oi}&quot;).length &gt; 0) then   (&quot;and &quot; + ((&quot;office_id in (#{get_data_filters(@authorized_user, cid)})&quot; or &quot;&quot;) or &quot;office_id = #{oi}&quot;)) end</span>}\ngroup by st.call_type, st.called_at order by st.call_type, st.called_at;\n&quot;, { :cid =&gt; cid, :month =&gt; (Date.today + mn.months).at_beginning_of_month.strftime(&quot;%Y%m&quot;) }])</span></span><table id='context39' class='context' style='display:none'><caption>app/controllers/api/dashboard_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>1420</pre>
          </td>
          <td class='context'>
            <pre class='context'>					where category = &#39;Prospect&#39;</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1421</pre>
            </td>
            <td class='context'>
              <pre class='context'>					and to_char(created_at, &#39;YYYYMM&#39;) = :month</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1422</pre>
            </td>
            <td class='context'>
              <pre class='context'>				) st</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1423</pre>
            </td>
            <td class='context'>
              <pre class='context'>				left join offices o on o.id = st.office_id</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>1424</pre>
            </td>
            <td class='context'>
              <pre class='context'>				where st.client_id = :cid</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>1425</pre>
            </td>
            <td class='context'>
              <pre class='context'>				#{&#39;and &#39; + fq if fq.length &gt; 0}</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>1426</pre>
            </td>
            <td class='context'>
              <pre class='context'>				group by st.call_type, st.called_at order by st.call_type, st.called_at;</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1427</pre>
            </td>
            <td class='context'>
              <pre class='context'>			SQL</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1428</pre>
            </td>
            <td class='context'>
              <pre class='context'>			rs = [{call_type: &quot;none&quot;, called_at: Date.today.strftime(&quot;%Y-%m-%d&quot;), prospects: 0}] if rs.count == 0</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1429</pre>
            </td>
            <td class='context'>
              <pre class='context'>			ts, tl, ot = {}, [], []</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1430</pre>
            </td>
            <td class='context'>
              <pre class='context'>			rs.each { |d| ts[d[&quot;call_type&quot;]] = {} unless ts.has_key?(d[&quot;call_type&quot;]); ts[d[&quot;call_type&quot;]][d[&quot;called_at&quot;]] = d[&quot;prospects&quot;] }</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>Api::DashboardController</td>
      <td>prospect_trend_12mo</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context40');toggle('message40');toggle('full_message40')" ><span id='message40' style='display:block'>Possible SQL injection near line 1477: ...</span><span id='full_message40' style='display:none'>Possible SQL injection near line 1477: <span class="code">General.find_by_sql([&quot;select st.call_type, st.called_at, count(*) prospects\nfrom (\n\tselect ce.client_id, ch.office_id, ch.type call_type, to_char(ce.call_date, &#39;YYYY-MM&#39;) called_at\n\tfrom call_extracts ce\n\tjoin channels ch on ch.phone = ce.call_dnis\n\tjoin call_types ct on ct.group = ce.type and ct.call_type = ce.call_type\n\twhere ct.is_prospect = true\n\tand ce.call_date between date_trunc(&#39;month&#39;, now() - interval &#39;12 months&#39;) and now()\n\tunion all\n\tselect client_id, office_id, &#39;Online&#39; call_type, to_char(created_at, &#39;YYYY-MM&#39;) called_at\n\tfrom form_extracts\n\twhere category = &#39;Prospect&#39;\n\tand created_at between date_trunc(&#39;month&#39;, now() - interval &#39;12 months&#39;) and now()\n) st\nleft join offices o on o.id = st.office_id\nwhere st.client_id = :cid\n#{<span class="user_input">if ((&quot;office_id in (#{get_data_filters(@authorized_user, cid)})&quot; or &quot;&quot;).length &gt; 0) then   (&quot;and &quot; + (&quot;office_id in (#{get_data_filters(@authorized_user, cid)})&quot; or &quot;&quot;)) end</span>}\ngroup by st.call_type, st.called_at order by st.call_type, st.called_at;\n&quot;, { :cid =&gt; cid }])</span></span><table id='context40' class='context' style='display:none'><caption>app/controllers/api/dashboard_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>1472</pre>
          </td>
          <td class='context'>
            <pre class='context'>					where category = &#39;Prospect&#39;</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1473</pre>
            </td>
            <td class='context'>
              <pre class='context'>					and created_at between date_trunc(&#39;month&#39;, now() - interval &#39;12 months&#39;) and now()</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1474</pre>
            </td>
            <td class='context'>
              <pre class='context'>				) st</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1475</pre>
            </td>
            <td class='context'>
              <pre class='context'>				left join offices o on o.id = st.office_id</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>1476</pre>
            </td>
            <td class='context'>
              <pre class='context'>				where st.client_id = :cid</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>1477</pre>
            </td>
            <td class='context'>
              <pre class='context'>				#{&#39;and &#39; + fq if fq.length &gt; 0}</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>1478</pre>
            </td>
            <td class='context'>
              <pre class='context'>				group by st.call_type, st.called_at order by st.call_type, st.called_at;</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1479</pre>
            </td>
            <td class='context'>
              <pre class='context'>			SQL</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1480</pre>
            </td>
            <td class='context'>
              <pre class='context'>		end</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1481</pre>
            </td>
            <td class='context'>
              <pre class='context'>		ts, tl, ot = {}, [], []</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1482</pre>
            </td>
            <td class='context'>
              <pre class='context'>		rs.each { |d| ts[d.call_type] = {} unless ts.has_key?(d.call_type); ts[d.call_type][d.called_at] = d.prospects }</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>Api::DashboardController</td>
      <td>weekly_new_patients_expanded</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context41');toggle('message41');toggle('full_message41')" ><span id='message41' style='display:block'>Possible SQL injection near line 1598: ...</span><span id='full_message41' style='display:none'>Possible SQL injection near line 1598: <span class="code">General.find_by_sql([&quot;select &#39;New Patients&#39; as title, #{(&quot;date_trunc(&#39;week&#39;, source_created_at)::date as week,&quot; or &quot;date_trunc(&#39;month&#39;, source_created_at)::timestamp as month,&quot;)} o.name as office, count(*) as new_patients\nfrom mv_patients mv\njoin offices o on o.id = mv.office_id\nwhere source_created_at is not null and source_created_at #{<span class="user_input">between_week_range</span>}\nand patient_type in (&#39;Active&#39;, &#39;Current&#39;)\nand mv.client_id = :cid\ngroup by #{((&quot;&quot; or &quot;week&quot;) or &quot;month&quot;)}, office\norder by #{((&quot;&quot; or &quot;week&quot;) or &quot;month&quot;)} desc, office\n&quot;, { :cid =&gt; cid.to_i }])</span></span><table id='context41' class='context' style='display:none'><caption>app/controllers/api/dashboard_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>1593</pre>
          </td>
          <td class='context'>
            <pre class='context'>		table_columns = [NDT::NUMBER]</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1594</pre>
            </td>
            <td class='context'>
              <pre class='context'>		rs = General.find_by_sql [&lt;&lt;~SQL, {:cid =&gt; cid.to_i}]</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1595</pre>
            </td>
            <td class='context'>
              <pre class='context'>			select &#39;New Patients&#39; as title, #{sl} o.name as office, count(*) as new_patients</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1596</pre>
            </td>
            <td class='context'>
              <pre class='context'>			from mv_patients mv</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>1597</pre>
            </td>
            <td class='context'>
              <pre class='context'>			join offices o on o.id = mv.office_id</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>1598</pre>
            </td>
            <td class='context'>
              <pre class='context'>			where source_created_at is not null and source_created_at #{between_week_range}</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>1599</pre>
            </td>
            <td class='context'>
              <pre class='context'>			and patient_type in (&#39;Active&#39;, &#39;Current&#39;)</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1600</pre>
            </td>
            <td class='context'>
              <pre class='context'>			and mv.client_id = :cid</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1601</pre>
            </td>
            <td class='context'>
              <pre class='context'>			group by #{date}, office</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1602</pre>
            </td>
            <td class='context'>
              <pre class='context'>			order by #{date} desc, office</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1603</pre>
            </td>
            <td class='context'>
              <pre class='context'>		SQL</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>Api::DashboardController</td>
      <td>weekly_new_patients</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context42');toggle('message42');toggle('full_message42')" >Possible SQL injection near line 1622: <span class="code">General.find_by_sql([&quot;select array[(week + interval &#39;1 day&#39;)::date::text, coalesce(sum(new_patients), 0)::text] as data\nfrom (\n\tselect gs.week::date, coalesce(new_patients, 0) as new_patients\n\tfrom (\n\t\t#{<span class="user_input">generate_weekly_series(date_range)</span>}\n\t) gs\n\tleft join (\n\t\tselect date_trunc(&#39;week&#39;, source_created_at)::date as week, count(*) as new_patients\n\t\tfrom mv_patients\n\t\twhere source_created_at is not null\n\t\tand patient_type in (&#39;Active&#39;, &#39;Current&#39;)\n\t\tand client_id = :cid\n\t\tgroup by week\n\t\torder by week\n\t) mv on mv.week = gs.week\n\torder by mv.week\n) query\ngroup by week\norder by week\n&quot;, { :cid =&gt; cid.to_i }])</span><table id='context42' class='context' style='display:none'><caption>app/controllers/api/dashboard_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>1617</pre>
          </td>
          <td class='context'>
            <pre class='context'>			General.find_by_sql [&lt;&lt;~SQL, {:cid =&gt; cid.to_i}]</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1618</pre>
            </td>
            <td class='context'>
              <pre class='context'>				select array[(week + interval &#39;1 day&#39;)::date::text, coalesce(sum(new_patients), 0)::text] as data</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1619</pre>
            </td>
            <td class='context'>
              <pre class='context'>				from (</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1620</pre>
            </td>
            <td class='context'>
              <pre class='context'>					select gs.week::date, coalesce(new_patients, 0) as new_patients</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>1621</pre>
            </td>
            <td class='context'>
              <pre class='context'>					from (</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>1622</pre>
            </td>
            <td class='context'>
              <pre class='context'>						#{generate_weekly_series(date_range)}</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>1623</pre>
            </td>
            <td class='context'>
              <pre class='context'>					) gs</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1624</pre>
            </td>
            <td class='context'>
              <pre class='context'>					left join (</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1625</pre>
            </td>
            <td class='context'>
              <pre class='context'>						select date_trunc(&#39;week&#39;, source_created_at)::date as week, count(*) as new_patients</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1626</pre>
            </td>
            <td class='context'>
              <pre class='context'>						from mv_patients</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1627</pre>
            </td>
            <td class='context'>
              <pre class='context'>						where source_created_at is not null</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>Api::DashboardController</td>
      <td>weekly_appts_table</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context43');toggle('message43');toggle('full_message43')" ><span id='message43' style='display:block'>Possible SQL injection near line 1663: ...</span><span id='full_message43' style='display:none'>Possible SQL injection near line 1663: <span class="code">General.find_by_sql([&quot;select &#39;Appointments&#39; as title, #{(&quot;date_trunc(&#39;week&#39;, appt_at)::date as week,&quot; or &quot;date_trunc(&#39;month&#39;, appt_at)::timestamp as month,&quot;)} o.name as office, count(case when category = &#39;Completed&#39; then 1 end) as completed, count(case when category in (&#39;Confirmed&#39;, &#39;Not Confirmed&#39;) then 1 end) as scheduled, count(case when category in (&#39;No Show&#39;) then 1 end) as no_show, count(case when category in (&#39;Canceled&#39;) then 1 end) as cancelled from appointments a\njoin offices o on o.id = a.office_id\nwhere o.client_id = :cid and date_trunc(&#39;week&#39;, appt_at) #{<span class="user_input">between_week_range</span>}\ngroup by #{((&quot;&quot; or &quot;week&quot;) or &quot;month&quot;)}, office\norder by #{((&quot;&quot; or &quot;week&quot;) or &quot;month&quot;)} desc, office\n&quot;, { :cid =&gt; cid.to_i }])</span></span><table id='context43' class='context' style='display:none'><caption>app/controllers/api/dashboard_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>1658</pre>
          </td>
          <td class='context'>
            <pre class='context'>		end</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1659</pre>
            </td>
            <td class='context'>
              <pre class='context'>		table_columns = [NDT::NUMBER, NDT::NUMBER, NDT::NUMBER, NDT::NUMBER]</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1660</pre>
            </td>
            <td class='context'>
              <pre class='context'>		rs = General.find_by_sql [&lt;&lt;~SQL, {:cid =&gt; cid.to_i}]</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1661</pre>
            </td>
            <td class='context'>
              <pre class='context'>			select &#39;Appointments&#39; as title, #{sl} o.name as office, count(case when category = &#39;Completed&#39; then 1 end) as completed, count(case when category in (&#39;Confirmed&#39;, &#39;Not Confirmed&#39;) then 1 end) as scheduled, count(case when category in (&#39;No Show&#39;) then 1 end) as no_show, count(case when category in (&#39;Canceled&#39;) then 1 end) as cancelled from appointments a</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>1662</pre>
            </td>
            <td class='context'>
              <pre class='context'>			join offices o on o.id = a.office_id</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>1663</pre>
            </td>
            <td class='context'>
              <pre class='context'>			where o.client_id = :cid and date_trunc(&#39;week&#39;, appt_at) #{between_week_range}</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>1664</pre>
            </td>
            <td class='context'>
              <pre class='context'>			group by #{date}, office</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1665</pre>
            </td>
            <td class='context'>
              <pre class='context'>			order by #{date} desc, office</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1666</pre>
            </td>
            <td class='context'>
              <pre class='context'>		SQL</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1667</pre>
            </td>
            <td class='context'>
              <pre class='context'>		if rs.length == 0</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1668</pre>
            </td>
            <td class='context'>
              <pre class='context'>			return nil</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>Api::DashboardController</td>
      <td>weekly_appts</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context44');toggle('message44');toggle('full_message44')" >Possible SQL injection near line 1697: <span class="code">General.find_by_sql([&quot;#{(&quot;select gs.week::date, coalesce(completed, 0) as completed, coalesce(scheduled, 0) as scheduled, coalesce(no_show, 0) as no_show, coalesce(cancelled, 0) as cancelled\n\t\t\t\tfrom (\n\t\t\t\t\tselect date_trunc(&#39;week&#39;, mn.date)::date as week\n\t\t\t\t\tfrom generate_series (now()::date - interval &#39;2 weeks&#39;, now()::date + interval &#39;2 weeks&#39;, &#39;1 week&#39;) mn\n\t\t\t\t) gs&quot; or &quot;select (gs.week + interval &#39;1 day&#39;)::date as week, coalesce(completed, 0) as completed, coalesce(scheduled, 0) as scheduled, coalesce(no_show, 0) as no_show, coalesce(cancelled, 0) as cancelled\n\t\t\t\tfrom (\n\t\t\t\t\t#{<span class="user_input">generate_weekly_series(date_range)</span>}\n\t\t\t\t) gs&quot;)}\nleft join (\n\tselect date_trunc(&#39;week&#39;, appt_at)::date as week, count(case when category = &#39;Completed&#39; then 1 end) as completed, count(case when category in (&#39;Confirmed&#39;, &#39;Not Confirmed&#39;) then 1 end) as scheduled, count(case when category in (&#39;No Show&#39;) then 1 end) as no_show, count(case when category in (&#39;Canceled&#39;) then 1 end) as cancelled from appointments a\n\tjoin offices o on o.id = a.office_id\n\twhere o.client_id = :cid\n\tgroup by week\n\torder by week\n) sub on sub.week = gs.week\norder by gs.week\n&quot;, { :cid =&gt; cid.to_i }])</span><table id='context44' class='context' style='display:none'><caption>app/controllers/api/dashboard_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>1692</pre>
          </td>
          <td class='context'>
            <pre class='context'>					#{generate_weekly_series(date_range)}</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1693</pre>
            </td>
            <td class='context'>
              <pre class='context'>				) gs&quot;</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1694</pre>
            </td>
            <td class='context'>
              <pre class='context'>		end</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1695</pre>
            </td>
            <td class='context'>
              <pre class='context'>		rs = Rails.cache.fetch(&quot;weekly_appts_#{cid}_#{date_range}&quot;, :expires_in =&gt; Rails.env.production? ? 60.minute : 30.seconds) do</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>1696</pre>
            </td>
            <td class='context'>
              <pre class='context'>			General.find_by_sql [&lt;&lt;~SQL, {:cid =&gt; cid.to_i}]</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>1697</pre>
            </td>
            <td class='context'>
              <pre class='context'>				#{sl}</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>1698</pre>
            </td>
            <td class='context'>
              <pre class='context'>				left join (</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1699</pre>
            </td>
            <td class='context'>
              <pre class='context'>					select date_trunc(&#39;week&#39;, appt_at)::date as week, count(case when category = &#39;Completed&#39; then 1 end) as completed, count(case when category in (&#39;Confirmed&#39;, &#39;Not Confirmed&#39;) then 1 end) as scheduled, count(case when category in (&#39;No Show&#39;) then 1 end) as no_show, count(case when category in (&#39;Canceled&#39;) then 1 end) as cancelled from appointments a</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1700</pre>
            </td>
            <td class='context'>
              <pre class='context'>					join offices o on o.id = a.office_id</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1701</pre>
            </td>
            <td class='context'>
              <pre class='context'>					where o.client_id = :cid</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1702</pre>
            </td>
            <td class='context'>
              <pre class='context'>					group by week</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>Api::DashboardController</td>
      <td>new_patient_expanded</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context45');toggle('message45');toggle('full_message45')" >Possible SQL injection near line 1732: <span class="code">General.find_by_sql([&quot;select &#39;New Patients&#39; as title, date_trunc(&#39;month&#39;, source_created_at)::timestamp as month, o.name as office, count(distinct mv.id) as new_patients\nfrom mv_patients mv\njoin offices o on o.id = mv.office_id\nwhere source_created_at is not null and source_created_at #{<span class="user_input">between_date_range</span>}\nand patient_type in (&#39;Active&#39;, &#39;Current&#39;)\nand mv.client_id = :cid\ngroup by month, office\norder by month desc, office\n&quot;, { :cid =&gt; cid.to_i }])</span><table id='context45' class='context' style='display:none'><caption>app/controllers/api/dashboard_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>1727</pre>
          </td>
          <td class='context'>
            <pre class='context'>			table_columns = [NDT::NUMBER]</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1728</pre>
            </td>
            <td class='context'>
              <pre class='context'>			rs = General.find_by_sql [&lt;&lt;~SQL, {:cid =&gt; cid.to_i}]</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1729</pre>
            </td>
            <td class='context'>
              <pre class='context'>				select &#39;New Patients&#39; as title, date_trunc(&#39;month&#39;, source_created_at)::timestamp as month, o.name as office, count(distinct mv.id) as new_patients</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1730</pre>
            </td>
            <td class='context'>
              <pre class='context'>				from mv_patients mv</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>1731</pre>
            </td>
            <td class='context'>
              <pre class='context'>				join offices o on o.id = mv.office_id</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>1732</pre>
            </td>
            <td class='context'>
              <pre class='context'>				where source_created_at is not null and source_created_at #{between_date_range}</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>1733</pre>
            </td>
            <td class='context'>
              <pre class='context'>				and patient_type in (&#39;Active&#39;, &#39;Current&#39;)</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1734</pre>
            </td>
            <td class='context'>
              <pre class='context'>				and mv.client_id = :cid</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1735</pre>
            </td>
            <td class='context'>
              <pre class='context'>				group by month, office</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1736</pre>
            </td>
            <td class='context'>
              <pre class='context'>				order by month desc, office</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1737</pre>
            </td>
            <td class='context'>
              <pre class='context'>			SQL</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>Api::DashboardController</td>
      <td>monthly_new_patients</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context46');toggle('message46');toggle('full_message46')" >Possible SQL injection near line 1789: <span class="code">General.find_by_sql([&quot;#{(&quot;select gs.month, coalesce(new_patients, 0) as new_patients\nfrom (\n\tselect date_trunc(&#39;month&#39;, mn.date)::date as month\n\tfrom generate_series (now()::date - interval &#39;5 months&#39;, now()::date, &#39;1 month&#39;) mn\n) gs\nleft join (\n\tselect date_trunc(&#39;month&#39;, p.source_created_at) as month, count(distinct p.source_id) as new_patients\n\tfrom pfm_patient_list pf\n\tjoin (select client_id, source_id, source_created_at, patient_type from mv_patients where source_created_at between date_trunc(&#39;month&#39;, now() - interval &#39;5 months&#39;) and now() and patient_type in (&#39;Active&#39;, &#39;Current&#39;) and client_id = :cid) p on p.source_id = pf.patientid\n\twhere p.source_created_at is not null\n\tand pf.patientstatus = &#39;Active&#39; and pf.urgentcareonly = &#39;false&#39; and lastvisitdate is null\n\tgroup by month\n\torder by month\n) qy on qy.month = gs.month\norder by qy.month\n&quot; or &quot;select array[(month + interval &#39;1 day&#39;)::date::text, new_patients::text] as data\nfrom(\n\tselect gs.month as month, coalesce(new_patients, 0) as new_patients\n\tfrom (\n\t\t#{<span class="user_input">generate_series(date_range)</span>}\n\t) gs\n\tleft join (\n\t\tselect date_trunc(&#39;month&#39;, source_created_at)::date as month, count(distinct id) as new_patients\n\t\tfrom mv_patients\n\t\twhere source_created_at is not null and source_created_at #{between_date_range}\n\t\tand patient_type in (&#39;Active&#39;, &#39;Current&#39;)\n\t\tand client_id = :cid\n\t\tgroup by month\n\t\torder by month\n\t) mv on mv.month = gs.month\n) query\norder by month asc\n&quot;)}\n&quot;, { :cid =&gt; cid.to_i }])</span><table id='context46' class='context' style='display:none'><caption>app/controllers/api/dashboard_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>1784</pre>
          </td>
          <td class='context'>
            <pre class='context'>				order by month asc</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1785</pre>
            </td>
            <td class='context'>
              <pre class='context'>				SQL</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1786</pre>
            </td>
            <td class='context'>
              <pre class='context'>			qr = cid == 35 ? pfm_np : og_np</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1787</pre>
            </td>
            <td class='context'>
              <pre class='context'>			dt = []</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>1788</pre>
            </td>
            <td class='context'>
              <pre class='context'>			np = General.find_by_sql [&lt;&lt;~SQL, {:cid =&gt; cid.to_i}]</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>1789</pre>
            </td>
            <td class='context'>
              <pre class='context'>				#{qr}</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>1790</pre>
            </td>
            <td class='context'>
              <pre class='context'>				SQL</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1791</pre>
            </td>
            <td class='context'>
              <pre class='context'>			if expand</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1792</pre>
            </td>
            <td class='context'>
              <pre class='context'>				data = np</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1793</pre>
            </td>
            <td class='context'>
              <pre class='context'>			else</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1794</pre>
            </td>
            <td class='context'>
              <pre class='context'>				if cid == 35</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>Api::DashboardController</td>
      <td>monthly_prospects_expanded</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context47');toggle('message47');toggle('full_message47')" >Possible SQL injection near line 1814: <span class="code">General.find_by_sql([&quot;select &#39;Prospects&#39; as title, date_trunc(&#39;month&#39;, source_created_at)::timestamp as month, o.name as office, count(distinct mv.id) as prospects\nfrom mv_patients mv\njoin offices o on o.id = mv.office_id\nwhere source_created_at is not null and source_created_at #{<span class="user_input">between_date_range</span>}\nand patient_type in (&#39;Prospect&#39;)\nand mv.client_id = :cid\ngroup by month, office\norder by month desc, office\n&quot;, { :cid =&gt; cid.to_i }])</span><table id='context47' class='context' style='display:none'><caption>app/controllers/api/dashboard_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>1809</pre>
          </td>
          <td class='context'>
            <pre class='context'>			table_columns = [NDT::NUMBER]</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1810</pre>
            </td>
            <td class='context'>
              <pre class='context'>			rs = General.find_by_sql [&lt;&lt;~SQL, {:cid =&gt; cid.to_i}]</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1811</pre>
            </td>
            <td class='context'>
              <pre class='context'>				select &#39;Prospects&#39; as title, date_trunc(&#39;month&#39;, source_created_at)::timestamp as month, o.name as office, count(distinct mv.id) as prospects</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1812</pre>
            </td>
            <td class='context'>
              <pre class='context'>				from mv_patients mv</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>1813</pre>
            </td>
            <td class='context'>
              <pre class='context'>				join offices o on o.id = mv.office_id</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>1814</pre>
            </td>
            <td class='context'>
              <pre class='context'>				where source_created_at is not null and source_created_at #{between_date_range}</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>1815</pre>
            </td>
            <td class='context'>
              <pre class='context'>				and patient_type in (&#39;Prospect&#39;)</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1816</pre>
            </td>
            <td class='context'>
              <pre class='context'>				and mv.client_id = :cid</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1817</pre>
            </td>
            <td class='context'>
              <pre class='context'>				group by month, office</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1818</pre>
            </td>
            <td class='context'>
              <pre class='context'>				order by month desc, office</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1819</pre>
            </td>
            <td class='context'>
              <pre class='context'>			SQL</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>Api::DashboardController</td>
      <td>monthly_prospects</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context48');toggle('message48');toggle('full_message48')" >Possible SQL injection near line 1838: <span class="code">General.find_by_sql([&quot;select array[(month + interval &#39;1 day&#39;)::date::text, prospects::text] as data\nfrom(\n\tselect gs.month as month, coalesce(prospects, 0) as prospects\n\tfrom (\n\t\t#{<span class="user_input">generate_series(date_range)</span>}\n\t) gs\n\tleft join (\n\t\tselect date_trunc(&#39;month&#39;, source_created_at)::date as month, count(distinct id) as prospects\n\t\tfrom mv_patients\n\t\twhere source_created_at is not null and source_created_at #{between_date_range}\n\t\tand patient_type in (&#39;Prospect&#39;)\n\t\tand client_id = :cid\n\t\tgroup by month\n\t\torder by month\n\t) mv on mv.month = gs.month\n) query\norder by month asc\n&quot;, { :cid =&gt; cid.to_i }])</span><table id='context48' class='context' style='display:none'><caption>app/controllers/api/dashboard_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>1833</pre>
          </td>
          <td class='context'>
            <pre class='context'>			pr = General.find_by_sql [&lt;&lt;~SQL, {:cid =&gt; cid.to_i}]</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1834</pre>
            </td>
            <td class='context'>
              <pre class='context'>				select array[(month + interval &#39;1 day&#39;)::date::text, prospects::text] as data</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1835</pre>
            </td>
            <td class='context'>
              <pre class='context'>				from(</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1836</pre>
            </td>
            <td class='context'>
              <pre class='context'>					select gs.month as month, coalesce(prospects, 0) as prospects</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>1837</pre>
            </td>
            <td class='context'>
              <pre class='context'>					from (</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>1838</pre>
            </td>
            <td class='context'>
              <pre class='context'>						#{generate_series(date_range)}</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>1839</pre>
            </td>
            <td class='context'>
              <pre class='context'>					) gs</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1840</pre>
            </td>
            <td class='context'>
              <pre class='context'>					left join (</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1841</pre>
            </td>
            <td class='context'>
              <pre class='context'>						select date_trunc(&#39;month&#39;, source_created_at)::date as month, count(distinct id) as prospects</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1842</pre>
            </td>
            <td class='context'>
              <pre class='context'>						from mv_patients</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1843</pre>
            </td>
            <td class='context'>
              <pre class='context'>						where source_created_at is not null and source_created_at #{between_date_range}</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>Api::DashboardController</td>
      <td>monthly_revenue_expanded</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context49');toggle('message49');toggle('full_message49')" >Possible SQL injection near line 1874: <span class="code">General.find_by_sql([&quot;select &#39;Total Revenue&#39; as title, date_trunc(&#39;month&#39;, pu.purchased_at)::timestamp as month, office, coalesce(sum(pu.price)::integer, 0) as revenue\nfrom (\n\tselect patient_id, purchased_at, price, returned_at, o.name as office from purchases p\n\tjoin mv_patients mv on mv.id = p.patient_id\n\tjoin offices o on o.id = mv.office_id\n\twhere mv.client_id = :cid and returned_at is null\n\tand purchased_at #{<span class="user_input">between_date_range</span>}\n) pu\ngroup by month, office\norder by month desc, office\n&quot;, { :cid =&gt; cid.to_i }])</span><table id='context49' class='context' style='display:none'><caption>app/controllers/api/dashboard_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>1869</pre>
          </td>
          <td class='context'>
            <pre class='context'>			from (</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1870</pre>
            </td>
            <td class='context'>
              <pre class='context'>				select patient_id, purchased_at, price, returned_at, o.name as office from purchases p</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1871</pre>
            </td>
            <td class='context'>
              <pre class='context'>				join mv_patients mv on mv.id = p.patient_id</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1872</pre>
            </td>
            <td class='context'>
              <pre class='context'>				join offices o on o.id = mv.office_id</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>1873</pre>
            </td>
            <td class='context'>
              <pre class='context'>				where mv.client_id = :cid and returned_at is null</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>1874</pre>
            </td>
            <td class='context'>
              <pre class='context'>				and purchased_at #{between_date_range}</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>1875</pre>
            </td>
            <td class='context'>
              <pre class='context'>			) pu</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1876</pre>
            </td>
            <td class='context'>
              <pre class='context'>			group by month, office</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1877</pre>
            </td>
            <td class='context'>
              <pre class='context'>			order by month desc, office</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1878</pre>
            </td>
            <td class='context'>
              <pre class='context'>			SQL</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1879</pre>
            </td>
            <td class='context'>
              <pre class='context'>			if rs.length == 0</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>Api::DashboardController</td>
      <td>monthly_revenue</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context50');toggle('message50');toggle('full_message50')" >Possible SQL injection near line 1897: <span class="code">General.find_by_sql([&quot;select array[(month + interval &#39;1 day&#39;)::date::text, revenue::text] as data\nfrom(\n\tselect gs.month as month, coalesce(revenue, 0) as revenue\n\tfrom (\n\t\t#{<span class="user_input">generate_series(date_range)</span>}\n\t) gs\n\tleft join\n\t\t(select date_trunc(&#39;month&#39;, pu.purchased_at::date) as month, coalesce(sum(pu.price)::integer, 0) as revenue\n\t\t\tfrom (\n\t\t\t\tselect patient_id, purchased_at, price, returned_at from purchases p\n\t\t\t\tjoin mv_patients mv on mv.id = p.patient_id\n\t\t\t\twhere mv.client_id = :cid and returned_at is null\n\t\t\t\tand purchased_at #{between_date_range}\n\t\t\t) pu\n\t\t\tgroup by month\n\t\t\torder by month\n\t\t) qy on qy.month = gs.month\n) query\norder by month\n&quot;, { :cid =&gt; cid.to_i }])</span><table id='context50' class='context' style='display:none'><caption>app/controllers/api/dashboard_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>1892</pre>
          </td>
          <td class='context'>
            <pre class='context'>			rv = General.find_by_sql [&lt;&lt;~SQL, {:cid =&gt; cid.to_i}]</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1893</pre>
            </td>
            <td class='context'>
              <pre class='context'>				select array[(month + interval &#39;1 day&#39;)::date::text, revenue::text] as data</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1894</pre>
            </td>
            <td class='context'>
              <pre class='context'>				from(</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1895</pre>
            </td>
            <td class='context'>
              <pre class='context'>					select gs.month as month, coalesce(revenue, 0) as revenue</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>1896</pre>
            </td>
            <td class='context'>
              <pre class='context'>					from (</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>1897</pre>
            </td>
            <td class='context'>
              <pre class='context'>						#{generate_series(date_range)}</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>1898</pre>
            </td>
            <td class='context'>
              <pre class='context'>					) gs</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1899</pre>
            </td>
            <td class='context'>
              <pre class='context'>					left join</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1900</pre>
            </td>
            <td class='context'>
              <pre class='context'>						(select date_trunc(&#39;month&#39;, pu.purchased_at::date) as month, coalesce(sum(pu.price)::integer, 0) as revenue</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1901</pre>
            </td>
            <td class='context'>
              <pre class='context'>							from (</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1902</pre>
            </td>
            <td class='context'>
              <pre class='context'>								select patient_id, purchased_at, price, returned_at from purchases p</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>Api::DashboardController</td>
      <td>avg_appts_expanded</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context51');toggle('message51');toggle('full_message51')" >Possible SQL injection near line 1936: <span class="code">General.find_by_sql([&quot;select &#39;Appointments&#39; as title, month, provider, sum(appts) as total_appts\nfrom\n\t(select date_trunc(&#39;month&#39;, ap.appt_at) as month, count(*) as appts, concat(ap.hcp_f_name, &#39; &#39;, ap.hcp_l_name) as provider\n\tfrom (\n\t\tselect patient_id, appt_at, a.hcp_f_name, a.hcp_l_name from appointments a\n\t\tjoin offices o on o.id = a.office_id\n\t\twhere appt_at::date #{<span class="user_input">between_date_range</span>}\n\t\t#{status_filter(cid)}\n\t\tand client_id = :cid\n\t) ap\n\tgroup by month, provider\n\torder by month\n) rs\ngroup by month, provider\norder by month desc, provider\n&quot;, { :cid =&gt; cid.to_i }])</span><table id='context51' class='context' style='display:none'><caption>app/controllers/api/dashboard_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>1931</pre>
          </td>
          <td class='context'>
            <pre class='context'>				from</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1932</pre>
            </td>
            <td class='context'>
              <pre class='context'>					(select date_trunc(&#39;month&#39;, ap.appt_at) as month, count(*) as appts, concat(ap.hcp_f_name, &#39; &#39;, ap.hcp_l_name) as provider</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1933</pre>
            </td>
            <td class='context'>
              <pre class='context'>					from (</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1934</pre>
            </td>
            <td class='context'>
              <pre class='context'>						select patient_id, appt_at, a.hcp_f_name, a.hcp_l_name from appointments a</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>1935</pre>
            </td>
            <td class='context'>
              <pre class='context'>						join offices o on o.id = a.office_id</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>1936</pre>
            </td>
            <td class='context'>
              <pre class='context'>						where appt_at::date #{between_date_range}</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>1937</pre>
            </td>
            <td class='context'>
              <pre class='context'>						#{status_filter}</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1938</pre>
            </td>
            <td class='context'>
              <pre class='context'>						and client_id = :cid</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1939</pre>
            </td>
            <td class='context'>
              <pre class='context'>					) ap</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1940</pre>
            </td>
            <td class='context'>
              <pre class='context'>					group by month, provider</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1941</pre>
            </td>
            <td class='context'>
              <pre class='context'>					order by month</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>Api::DashboardController</td>
      <td>avg_appts_per_provider</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context52');toggle('message52');toggle('full_message52')" >Possible SQL injection near line 1965: <span class="code">General.find_by_sql([&quot;select array[(month + interval &#39;1 day&#39;)::date::text, avg_appts::text] as data\nfrom(\n\tselect gs.month as month, coalesce(avg_appts, 0) as avg_appts\n\tfrom (\n\t\t#{<span class="user_input">generate_series(date_range)</span>}\n\t) gs\n\tleft join (\n\t\tselect month, round(sum(appts)/count(provider)) as avg_appts\n\t\tfrom\n\t\t\t(select date_trunc(&#39;month&#39;, qy.appt_at) as month, count(*) as appts, concat(qy.hcp_f_name, &#39; &#39;, qy.hcp_l_name) as provider\n\t\t\tfrom (\n\t\t\t\tselect patient_id, appt_at, a.hcp_f_name, a.hcp_l_name from appointments a\n\t\t\t\tjoin mv_patients mv on mv.id = a.patient_id\n\t\t\t\twhere appt_at::date #{between_date_range}\n\t\t\t\tand mv.client_id = :cid #{status_filter(cid)}\n\t\t\t) qy\n\t\t\tgroup by provider, month\n\t\t\torder by month\n\t\t) rs\n\t\tgroup by month\n\t\torder by month\n\t) qy on qy.month = gs.month\n) query\norder by month asc\n&quot;, { :cid =&gt; cid.to_i }])</span><table id='context52' class='context' style='display:none'><caption>app/controllers/api/dashboard_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>1960</pre>
          </td>
          <td class='context'>
            <pre class='context'>			ap = General.find_by_sql [&lt;&lt;~SQL, {:cid =&gt; cid.to_i}]</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1961</pre>
            </td>
            <td class='context'>
              <pre class='context'>				select array[(month + interval &#39;1 day&#39;)::date::text, avg_appts::text] as data</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1962</pre>
            </td>
            <td class='context'>
              <pre class='context'>				from(</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1963</pre>
            </td>
            <td class='context'>
              <pre class='context'>					select gs.month as month, coalesce(avg_appts, 0) as avg_appts</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>1964</pre>
            </td>
            <td class='context'>
              <pre class='context'>					from (</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>1965</pre>
            </td>
            <td class='context'>
              <pre class='context'>						#{generate_series(date_range)}</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>1966</pre>
            </td>
            <td class='context'>
              <pre class='context'>					) gs</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1967</pre>
            </td>
            <td class='context'>
              <pre class='context'>					left join (</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1968</pre>
            </td>
            <td class='context'>
              <pre class='context'>						select month, round(sum(appts)/count(provider)) as avg_appts</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1969</pre>
            </td>
            <td class='context'>
              <pre class='context'>						from</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1970</pre>
            </td>
            <td class='context'>
              <pre class='context'>							(select date_trunc(&#39;month&#39;, qy.appt_at) as month, count(*) as appts, concat(qy.hcp_f_name, &#39; &#39;, qy.hcp_l_name) as provider</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>Api::DashboardController</td>
      <td>sends_per_nudge_table</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context53');toggle('message53');toggle('full_message53')" >Possible SQL injection near line 2005: <span class="code">General.find_by_sql([&quot;select &#39;Sends Per Nudge&#39; as title, mo.month, o.name as office, c.description as campaign, coalesce(count(distinct mo.individual_id), 0) as total\nfrom campaigns c\njoin touch_steps ts on ts.campaign_id = c.id\njoin (select *, date_trunc(&#39;month&#39;, processed_at) as month from message_out_details where processed_at #{<span class="user_input">between_date_range</span>} and status in (&#39;sent&#39;, &#39;delivered&#39;, &#39;reserved&#39;)) mo on mo.touch_step_id = ts.id\njoin offices o on o.id = mo.office_id\nwhere c.client_id = :cid and description not in (&#39;Appointment Reminder Email&#39;, &#39;Appointment Reminder Text&#39;)\ngroup by month, office, campaign\norder by month desc, office, campaign\n&quot;, { :cid =&gt; cid.to_i }])</span><table id='context53' class='context' style='display:none'><caption>app/controllers/api/dashboard_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>2000</pre>
          </td>
          <td class='context'>
            <pre class='context'>			table_columns = [NDT::NUMBER]</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2001</pre>
            </td>
            <td class='context'>
              <pre class='context'>			rs = General.find_by_sql [&lt;&lt;~SQL, {:cid =&gt; cid.to_i}]</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>2002</pre>
            </td>
            <td class='context'>
              <pre class='context'>				select &#39;Sends Per Nudge&#39; as title, mo.month, o.name as office, c.description as campaign, coalesce(count(distinct mo.individual_id), 0) as total</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2003</pre>
            </td>
            <td class='context'>
              <pre class='context'>				from campaigns c</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>2004</pre>
            </td>
            <td class='context'>
              <pre class='context'>				join touch_steps ts on ts.campaign_id = c.id</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>2005</pre>
            </td>
            <td class='context'>
              <pre class='context'>				join (select *, date_trunc(&#39;month&#39;, processed_at) as month from message_out_details where processed_at #{between_date_range} and status in (&#39;sent&#39;, &#39;delivered&#39;, &#39;reserved&#39;)) mo on mo.touch_step_id = ts.id</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>2006</pre>
            </td>
            <td class='context'>
              <pre class='context'>				join offices o on o.id = mo.office_id</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2007</pre>
            </td>
            <td class='context'>
              <pre class='context'>				where c.client_id = :cid and description not in (&#39;Appointment Reminder Email&#39;, &#39;Appointment Reminder Text&#39;)</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>2008</pre>
            </td>
            <td class='context'>
              <pre class='context'>				group by month, office, campaign</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2009</pre>
            </td>
            <td class='context'>
              <pre class='context'>				order by month desc, office, campaign</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>2010</pre>
            </td>
            <td class='context'>
              <pre class='context'>			SQL</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>Api::DashboardController</td>
      <td>sends_per_nudge_expanded</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context54');toggle('message54');toggle('full_message54')" >Possible SQL injection near line 2029: <span class="code">General.find_by_sql([&quot;select array[(month + interval &#39;1 day&#39;)::date::text, coalesce(sum(total), 0)::text] as data, campaign\nfrom(\n\tselect mo.month, c.description as campaign, count(distinct mo.individual_id) filter(where mo.status in (&#39;sent&#39;, &#39;delivered&#39;, &#39;reserved&#39;)) as total\n\tfrom campaigns c\n\tjoin touch_steps ts on ts.campaign_id = c.id\n\tjoin (select *, date_trunc(&#39;month&#39;, processed_at) as month from message_out_details where processed_at #{<span class="user_input">between_date_range</span>}) mo on mo.touch_step_id = ts.id\n\tjoin offices o on o.id = mo.office_id\n\twhere c.client_id = :cid and description not in (&#39;Appointment Reminder Email&#39;, &#39;Appointment Reminder Text&#39;)\n\tgroup by month, campaign\n\torder by month\n)qy\ngroup by month, campaign\norder by month\n&quot;, { :cid =&gt; cid.to_i }])</span><table id='context54' class='context' style='display:none'><caption>app/controllers/api/dashboard_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>2024</pre>
          </td>
          <td class='context'>
            <pre class='context'>			select array[(month + interval &#39;1 day&#39;)::date::text, coalesce(sum(total), 0)::text] as data, campaign</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2025</pre>
            </td>
            <td class='context'>
              <pre class='context'>			from(</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>2026</pre>
            </td>
            <td class='context'>
              <pre class='context'>				select mo.month, c.description as campaign, count(distinct mo.individual_id) filter(where mo.status in (&#39;sent&#39;, &#39;delivered&#39;, &#39;reserved&#39;)) as total</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2027</pre>
            </td>
            <td class='context'>
              <pre class='context'>				from campaigns c</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>2028</pre>
            </td>
            <td class='context'>
              <pre class='context'>				join touch_steps ts on ts.campaign_id = c.id</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>2029</pre>
            </td>
            <td class='context'>
              <pre class='context'>				join (select *, date_trunc(&#39;month&#39;, processed_at) as month from message_out_details where processed_at #{between_date_range}) mo on mo.touch_step_id = ts.id</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>2030</pre>
            </td>
            <td class='context'>
              <pre class='context'>				join offices o on o.id = mo.office_id</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2031</pre>
            </td>
            <td class='context'>
              <pre class='context'>				where c.client_id = :cid and description not in (&#39;Appointment Reminder Email&#39;, &#39;Appointment Reminder Text&#39;)</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>2032</pre>
            </td>
            <td class='context'>
              <pre class='context'>				group by month, campaign</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2033</pre>
            </td>
            <td class='context'>
              <pre class='context'>				order by month</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>2034</pre>
            </td>
            <td class='context'>
              <pre class='context'>			)qy</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>Api::DashboardController</td>
      <td>nudge_send_summary</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context57');toggle('message57');toggle('full_message57')" >Possible SQL injection near line 2172: <span class="code">General.find_by_sql([&quot;select mo.month, c.description as campaign, count(distinct mo.individual_id) filter(where mo.status in (&#39;sent&#39;, &#39;delivered&#39;, &#39;reserved&#39;)) as total\nfrom campaigns c\njoin touch_steps ts on ts.campaign_id = c.id\njoin (select *, date_trunc(&#39;month&#39;, processed_at) as month from message_out_details where processed_at #{<span class="user_input">between_date_range</span>}) mo on mo.touch_step_id = ts.id\nwhere c.client_id = :cid\ngroup by month, campaign\norder by month\n&quot;, { :cid =&gt; (client or Client.find(params[:client_id])).id }])</span><table id='context57' class='context' style='display:none'><caption>app/controllers/api/dashboard_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>2167</pre>
          </td>
          <td class='context'>
            <pre class='context'>		gc = []</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2168</pre>
            </td>
            <td class='context'>
              <pre class='context'>		rs = General.find_by_sql [&lt;&lt;~SQL, {:cid =&gt; client.id}]</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>2169</pre>
            </td>
            <td class='context'>
              <pre class='context'>			select mo.month, c.description as campaign, count(distinct mo.individual_id) filter(where mo.status in (&#39;sent&#39;, &#39;delivered&#39;, &#39;reserved&#39;)) as total</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2170</pre>
            </td>
            <td class='context'>
              <pre class='context'>			from campaigns c</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>2171</pre>
            </td>
            <td class='context'>
              <pre class='context'>			join touch_steps ts on ts.campaign_id = c.id</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>2172</pre>
            </td>
            <td class='context'>
              <pre class='context'>			join (select *, date_trunc(&#39;month&#39;, processed_at) as month from message_out_details where processed_at #{between_date_range()}) mo on mo.touch_step_id = ts.id</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>2173</pre>
            </td>
            <td class='context'>
              <pre class='context'>			where c.client_id = :cid</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2174</pre>
            </td>
            <td class='context'>
              <pre class='context'>			group by month, campaign</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>2175</pre>
            </td>
            <td class='context'>
              <pre class='context'>			order by month</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2176</pre>
            </td>
            <td class='context'>
              <pre class='context'>			SQL</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>2177</pre>
            </td>
            <td class='context'>
              <pre class='context'>		campaigns = rs.map(&amp;:campaign).uniq</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>Api::DashboardController</td>
      <td>nudge_opt_outs</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context58');toggle('message58');toggle('full_message58')" ><span id='message58' style='display:block'>Possible SQL injection near line 2190: ...</span><span id='full_message58' style='display:none'>Possible SQL injection near line 2190: <span class="code">General.find_by_sql([&quot;select mo.month, qt.name as nudge, count(*) as total_opt_outs\nfrom (select *, date_trunc(&#39;month&#39;, created_at) as month from message_opt_outs\n\twhere created_at #{<span class="user_input">between_date_range</span>} #{(&quot;and message_type = &#39;#{type}&#39;&quot; or &quot;&quot;)}\n\tand client_id = :cid) mo\njoin (select distinct on (\&quot;to\&quot;) \&quot;to\&quot;, touch_step_id from message_out_details order by \&quot;to\&quot;, processed_at desc) md on md.\&quot;to\&quot; = mo.\&quot;from\&quot;\njoin touch_steps ts on ts.id = md.touch_step_id\njoin (select id, query_type_id from nudges where active = &#39;true&#39; and client_id = :cid) ng on ng.id = ts.nudge_id\njoin query_types qt on qt.id = ng.query_type_id\ngroup by month, nudge\norder by month\n&quot;, { :cid =&gt; (client or Client.find(params[:client_id])).id }])</span></span><table id='context58' class='context' style='display:none'><caption>app/controllers/api/dashboard_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>2185</pre>
          </td>
          <td class='context'>
            <pre class='context'>		client = client ? client : Client.find(params[:client_id])</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2186</pre>
            </td>
            <td class='context'>
              <pre class='context'>		ms_type = type &amp;&amp; type != &#39;Text &amp; Email&#39; ? &quot;and message_type = &#39;#{type}&#39;&quot; : &quot;&quot;</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>2187</pre>
            </td>
            <td class='context'>
              <pre class='context'>		rs = General.find_by_sql [&lt;&lt;~SQL, {:cid =&gt; client.id}]</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2188</pre>
            </td>
            <td class='context'>
              <pre class='context'>			select mo.month, qt.name as nudge, count(*) as total_opt_outs</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>2189</pre>
            </td>
            <td class='context'>
              <pre class='context'>			from (select *, date_trunc(&#39;month&#39;, created_at) as month from message_opt_outs</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>2190</pre>
            </td>
            <td class='context'>
              <pre class='context'>				where created_at #{between_date_range()} #{ms_type}</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>2191</pre>
            </td>
            <td class='context'>
              <pre class='context'>				and client_id = :cid) mo</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2192</pre>
            </td>
            <td class='context'>
              <pre class='context'>			join (select distinct on (\&quot;to\&quot;) \&quot;to\&quot;, touch_step_id from message_out_details order by \&quot;to\&quot;, processed_at desc) md on md.\&quot;to\&quot; = mo.\&quot;from\&quot;</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>2193</pre>
            </td>
            <td class='context'>
              <pre class='context'>			join touch_steps ts on ts.id = md.touch_step_id</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2194</pre>
            </td>
            <td class='context'>
              <pre class='context'>			join (select id, query_type_id from nudges where active = &#39;true&#39; and client_id = :cid) ng on ng.id = ts.nudge_id</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>2195</pre>
            </td>
            <td class='context'>
              <pre class='context'>			join query_types qt on qt.id = ng.query_type_id</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>Api::DashboardController</td>
      <td>online_cost_per_appt_expanded</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context59');toggle('message59');toggle('full_message59')" >Possible SQL injection near line 2216: <span class="code">General.find_by_sql([&quot;select &#39;Cost Per Appointment&#39; as title, date::timestamp as month, office, coalesce(sum(cost), 0) as cost, coalesce(sum(appts), 0) as appts, case sum(appts) when 0 then avg(cost) else sum(cost)/sum(appts) end as cost_per_appt from (\n\tselect to_date(ro.event_month, &#39;yyyy-mm&#39;) as date, office, sum(cost) as cost, sum(appts) as appts\n\tfrom mv_roi_online ro\n\twhere ro.client_id = :cid\n\tgroup by ro.event_month, office\n\torder by ro.event_month desc, office\n) sub\nwhere date #{<span class="user_input">between_date_range</span>}\ngroup by month, office\norder by month desc, office\n&quot;, { :cid =&gt; cid }])</span><table id='context59' class='context' style='display:none'><caption>app/controllers/api/dashboard_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>2211</pre>
          </td>
          <td class='context'>
            <pre class='context'>				from mv_roi_online ro</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2212</pre>
            </td>
            <td class='context'>
              <pre class='context'>				where ro.client_id = :cid</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>2213</pre>
            </td>
            <td class='context'>
              <pre class='context'>				group by ro.event_month, office</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2214</pre>
            </td>
            <td class='context'>
              <pre class='context'>				order by ro.event_month desc, office</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>2215</pre>
            </td>
            <td class='context'>
              <pre class='context'>			) sub</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>2216</pre>
            </td>
            <td class='context'>
              <pre class='context'>			where date #{between_date_range}</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>2217</pre>
            </td>
            <td class='context'>
              <pre class='context'>			group by month, office</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2218</pre>
            </td>
            <td class='context'>
              <pre class='context'>			order by month desc, office</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>2219</pre>
            </td>
            <td class='context'>
              <pre class='context'>		SQL</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2220</pre>
            </td>
            <td class='context'>
              <pre class='context'>		if rs.length == 0</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>2221</pre>
            </td>
            <td class='context'>
              <pre class='context'>			return nil</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>Api::DashboardController</td>
      <td>online_cost_per_appt_expanded</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context60');toggle('message60');toggle('full_message60')" >Possible SQL injection near line 2234: <span class="code">General.find_by_sql([&quot;select month::timestamp, sum(cost)/sum(appts) as avg\nfrom (\n\tselect to_date(event_month, &#39;yyyy-mm&#39;) as month, cost, appts\n\tfrom mv_roi_online\n\twhere client_id = :cid\n)sub\nwhere month #{<span class="user_input">between_date_range</span>}\ngroup by month\norder by month\n&quot;, { :cid =&gt; cid }])</span><table id='context60' class='context' style='display:none'><caption>app/controllers/api/dashboard_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>2229</pre>
          </td>
          <td class='context'>
            <pre class='context'>				from (</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2230</pre>
            </td>
            <td class='context'>
              <pre class='context'>					select to_date(event_month, &#39;yyyy-mm&#39;) as month, cost, appts</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>2231</pre>
            </td>
            <td class='context'>
              <pre class='context'>					from mv_roi_online</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2232</pre>
            </td>
            <td class='context'>
              <pre class='context'>					where client_id = :cid</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>2233</pre>
            </td>
            <td class='context'>
              <pre class='context'>				)sub</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>2234</pre>
            </td>
            <td class='context'>
              <pre class='context'>				where month #{between_date_range}</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>2235</pre>
            </td>
            <td class='context'>
              <pre class='context'>				group by month</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2236</pre>
            </td>
            <td class='context'>
              <pre class='context'>				order by month</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>2237</pre>
            </td>
            <td class='context'>
              <pre class='context'>			SQL</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2238</pre>
            </td>
            <td class='context'>
              <pre class='context'>		month_avg.each do |month_res|</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>2239</pre>
            </td>
            <td class='context'>
              <pre class='context'>			table.data.find {|table_item| table_item[:name] == month_res.month}[:cost_per_appt] = month_res.avg</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>Api::DashboardController</td>
      <td>online_cost_per_appointment</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context61');toggle('message61');toggle('full_message61')" >Possible SQL injection near line 2252: <span class="code">General.find_by_sql([&quot;select array[(month + interval &#39;1 day&#39;)::date::text, coalesce(cost_per_appt, 0)::text] as data\nfrom(\n\tselect gs.month, coalesce(round(cost_per_appt, 2), 0) as cost_per_appt\n\tfrom (\n\t\t#{<span class="user_input">generate_series(date_range)</span>}\n\t) gs\n\tleft join (\n\t\tselect date, cost/appts as cost_per_appt from (\n\t\t\tselect to_date(ro.event_month, &#39;yyyy-mm&#39;) as date, sum(cost) as cost, case sum(appts) when 0 then 1 else sum(appts) end as appts\n\t\t\tfrom mv_roi_online ro\n\t\t\tleft join offices on offices.id = ro.office_id\n\t\t\twhere ro.client_id = :cid\n\t\t\tgroup by ro.event_month\n\t\t\torder by ro.event_month\n\t\t) sub\n\t\twhere date #{between_date_range}\n\t\torder by date\n\t) qy on qy.date = gs.month\n) query\norder by month\n&quot;, { :cid =&gt; cid }])</span><table id='context61' class='context' style='display:none'><caption>app/controllers/api/dashboard_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>2247</pre>
          </td>
          <td class='context'>
            <pre class='context'>		rs = General.find_by_sql [&lt;&lt;~SQL, {:cid =&gt; cid}]</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2248</pre>
            </td>
            <td class='context'>
              <pre class='context'>			select array[(month + interval &#39;1 day&#39;)::date::text, coalesce(cost_per_appt, 0)::text] as data</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>2249</pre>
            </td>
            <td class='context'>
              <pre class='context'>			from(</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2250</pre>
            </td>
            <td class='context'>
              <pre class='context'>				select gs.month, coalesce(round(cost_per_appt, 2), 0) as cost_per_appt</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>2251</pre>
            </td>
            <td class='context'>
              <pre class='context'>				from (</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>2252</pre>
            </td>
            <td class='context'>
              <pre class='context'>					#{generate_series(date_range)}</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>2253</pre>
            </td>
            <td class='context'>
              <pre class='context'>				) gs</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2254</pre>
            </td>
            <td class='context'>
              <pre class='context'>				left join (</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>2255</pre>
            </td>
            <td class='context'>
              <pre class='context'>					select date, cost/appts as cost_per_appt from (</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2256</pre>
            </td>
            <td class='context'>
              <pre class='context'>						select to_date(ro.event_month, &#39;yyyy-mm&#39;) as date, sum(cost) as cost, case sum(appts) when 0 then 1 else sum(appts) end as appts</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>2257</pre>
            </td>
            <td class='context'>
              <pre class='context'>						from mv_roi_online ro</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>Api::DashboardController</td>
      <td>online_appts_expanded</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context62');toggle('message62');toggle('full_message62')" >Possible SQL injection near line 2291: <span class="code">General.find_by_sql([&quot;select &#39;Online Appointments&#39; as title, date::timestamp, office, appts from (\n\tselect to_date(ro.event_month, &#39;yyyy-mm&#39;) as date, o.name as office, sum(appts) as appts\n\tfrom mv_roi_online ro\n\tjoin offices o on o.id = ro.office_id\n\twhere ro.client_id = :cid\n\tgroup by ro.event_month, o.name\n\torder by ro.event_month, o.name\n) sub\nwhere date #{<span class="user_input">between_date_range</span>}\norder by date desc\n&quot;, { :cid =&gt; cid }])</span><table id='context62' class='context' style='display:none'><caption>app/controllers/api/dashboard_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>2286</pre>
          </td>
          <td class='context'>
            <pre class='context'>				join offices o on o.id = ro.office_id</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2287</pre>
            </td>
            <td class='context'>
              <pre class='context'>				where ro.client_id = :cid</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>2288</pre>
            </td>
            <td class='context'>
              <pre class='context'>				group by ro.event_month, o.name</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2289</pre>
            </td>
            <td class='context'>
              <pre class='context'>				order by ro.event_month, o.name</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>2290</pre>
            </td>
            <td class='context'>
              <pre class='context'>			) sub</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>2291</pre>
            </td>
            <td class='context'>
              <pre class='context'>			where date #{between_date_range}</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>2292</pre>
            </td>
            <td class='context'>
              <pre class='context'>			order by date desc</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2293</pre>
            </td>
            <td class='context'>
              <pre class='context'>		SQL</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>2294</pre>
            </td>
            <td class='context'>
              <pre class='context'>		if rs.length == 0</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2295</pre>
            </td>
            <td class='context'>
              <pre class='context'>			return nil</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>2296</pre>
            </td>
            <td class='context'>
              <pre class='context'>		end</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>Api::DashboardController</td>
      <td>total_online_appts</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context63');toggle('message63');toggle('full_message63')" >Possible SQL injection near line 2310: <span class="code">General.find_by_sql([&quot;select array[(month + interval &#39;1 day&#39;)::date::text, appts::text] as data\nfrom (\n\tselect gs.month as month, coalesce(appts, 0) as appts\n\tfrom (\n\t\t#{<span class="user_input">generate_series(date_range)</span>}\n\t) gs\n\tleft join (\n\t\tselect date, appts from (\n\t\t\tselect to_date(ro.event_month, &#39;yyyy-mm&#39;) as date, sum(appts) as appts\n\t\t\tfrom mv_roi_online ro\n\t\t\tleft join offices on offices.id = ro.office_id\n\t\t\twhere ro.client_id = :cid\n\t\t\tgroup by ro.event_month\n\t\t\torder by ro.event_month\n\t\t) sub\n\t\twhere date #{between_date_range}\n\t) qy on qy.date = gs.month\n) query\norder by month asc\n&quot;, { :cid =&gt; cid }])</span><table id='context63' class='context' style='display:none'><caption>app/controllers/api/dashboard_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>2305</pre>
          </td>
          <td class='context'>
            <pre class='context'>		rs = General.find_by_sql [&lt;&lt;~SQL, {:cid =&gt; cid}]</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2306</pre>
            </td>
            <td class='context'>
              <pre class='context'>			select array[(month + interval &#39;1 day&#39;)::date::text, appts::text] as data</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>2307</pre>
            </td>
            <td class='context'>
              <pre class='context'>			from (</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2308</pre>
            </td>
            <td class='context'>
              <pre class='context'>				select gs.month as month, coalesce(appts, 0) as appts</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>2309</pre>
            </td>
            <td class='context'>
              <pre class='context'>				from (</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>2310</pre>
            </td>
            <td class='context'>
              <pre class='context'>					#{generate_series(date_range)}</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>2311</pre>
            </td>
            <td class='context'>
              <pre class='context'>				) gs</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2312</pre>
            </td>
            <td class='context'>
              <pre class='context'>				left join (</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>2313</pre>
            </td>
            <td class='context'>
              <pre class='context'>					select date, appts from (</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2314</pre>
            </td>
            <td class='context'>
              <pre class='context'>						select to_date(ro.event_month, &#39;yyyy-mm&#39;) as date, sum(appts) as appts</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>2315</pre>
            </td>
            <td class='context'>
              <pre class='context'>						from mv_roi_online ro</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>Api::DashboardController</td>
      <td>dm_cost_per_appt_expanded</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context64');toggle('message64');toggle('full_message64')" >Possible SQL injection near line 2351: <span class="code">General.find_by_sql([&quot;select &#39;Cost Per Appt&#39; as title, date_trunc(&#39;month&#39;, date::timestamp) as date, office, coalesce(cost, 0) as cost, coalesce(appts, 0) as appts, coalesce(cost/appts, cost, 0) as cost_per_appt from (\n\tselect distinct to_date(rc.event_month, &#39;yyyy-mm&#39;) as date, offices.name as office, sum(rc.total_cost) as cost, case sum(appointments) when 0 then 1 else sum(appointments) end as appts\n\tfrom mv_roi_campaigns rc\n\tjoin media_buys mb on mb.id = rc.media_buy_id\n\tjoin media_buys_offices mo on mo.media_buy_id = mb.id\n\tjoin offices on offices.id = mo.office_id\n\tjoin regions on regions.id = offices.region_id\n\twhere rc.client_id = :cid and pool_id in (select id from pools where name in (&#39;Lead&#39;)) and media_type = &#39;Direct Mail&#39;\n\tgroup by date, office\n\torder by date desc, office\n) sub\nwhere date #{<span class="user_input">between_date_range</span>}\n&quot;, { :cid =&gt; cid }])</span><table id='context64' class='context' style='display:none'><caption>app/controllers/api/dashboard_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>2346</pre>
          </td>
          <td class='context'>
            <pre class='context'>				join regions on regions.id = offices.region_id</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2347</pre>
            </td>
            <td class='context'>
              <pre class='context'>				where rc.client_id = :cid and pool_id in (select id from pools where name in (&#39;Lead&#39;)) and media_type = &#39;Direct Mail&#39;</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>2348</pre>
            </td>
            <td class='context'>
              <pre class='context'>				group by date, office</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2349</pre>
            </td>
            <td class='context'>
              <pre class='context'>				order by date desc, office</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>2350</pre>
            </td>
            <td class='context'>
              <pre class='context'>			) sub</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>2351</pre>
            </td>
            <td class='context'>
              <pre class='context'>			where date #{between_date_range}</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>2352</pre>
            </td>
            <td class='context'>
              <pre class='context'>		SQL</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2353</pre>
            </td>
            <td class='context'>
              <pre class='context'>		if rs.length == 0</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>2354</pre>
            </td>
            <td class='context'>
              <pre class='context'>			return nil</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2355</pre>
            </td>
            <td class='context'>
              <pre class='context'>		end</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>2356</pre>
            </td>
            <td class='context'>
              <pre class='context'>		tab_desc = &quot;Cost per appointment for direct mail.&quot;</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>Api::DashboardController</td>
      <td>dm_cost_per_appt_expanded</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context65');toggle('message65');toggle('full_message65')" >Possible SQL injection near line 2368: <span class="code">General.find_by_sql([&quot;select date_trunc(&#39;month&#39;, date::timestamp) as date, cost_per_appt from (\n\tselect distinct to_date(rc.event_month, &#39;yyyy-mm&#39;) as date, sum(rc.total_cost)/sum(rc.appointments) as cost_per_appt\n\tfrom mv_roi_campaigns rc\n\twhere rc.client_id = :cid and pool_id in (select id from pools where name in (&#39;Lead&#39;)) and media_type = &#39;Direct Mail&#39;\n\tgroup by date\n\torder by date\n) sub\nwhere date #{<span class="user_input">between_date_range</span>}\n&quot;, { :cid =&gt; cid }])</span><table id='context65' class='context' style='display:none'><caption>app/controllers/api/dashboard_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>2363</pre>
          </td>
          <td class='context'>
            <pre class='context'>				from mv_roi_campaigns rc</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2364</pre>
            </td>
            <td class='context'>
              <pre class='context'>				where rc.client_id = :cid and pool_id in (select id from pools where name in (&#39;Lead&#39;)) and media_type = &#39;Direct Mail&#39;</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>2365</pre>
            </td>
            <td class='context'>
              <pre class='context'>				group by date</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2366</pre>
            </td>
            <td class='context'>
              <pre class='context'>				order by date</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>2367</pre>
            </td>
            <td class='context'>
              <pre class='context'>			) sub</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>2368</pre>
            </td>
            <td class='context'>
              <pre class='context'>			where date #{between_date_range}</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>2369</pre>
            </td>
            <td class='context'>
              <pre class='context'>		SQL</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2370</pre>
            </td>
            <td class='context'>
              <pre class='context'>		month_avg.each do |month_res|</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>2371</pre>
            </td>
            <td class='context'>
              <pre class='context'>			table.data.find {|table_item| table_item[:name] == month_res.date}[:cost_per_appt] = month_res.cost_per_appt</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2372</pre>
            </td>
            <td class='context'>
              <pre class='context'>		end</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>2373</pre>
            </td>
            <td class='context'>
              <pre class='context'>		table.data.first[:cost_per_appt] = table.data.first[&quot;cost&quot;] / table.data.first[&quot;appts&quot;]</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>Api::DashboardController</td>
      <td>dm_cost_per_appointment</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context66');toggle('message66');toggle('full_message66')" >Possible SQL injection near line 2385: <span class="code">General.find_by_sql([&quot;select array[(month + interval &#39;1 day&#39;)::date::text, cost_per_appt::text] as data\nfrom (\n\tselect gs.month, coalesce(round(cost_per_appt, 2), 0) as cost_per_appt\n\tfrom (\n\t\t#{<span class="user_input">generate_series(date_range)</span>}\n\t) gs\n\tleft join (\n\t\tselect date_trunc(&#39;month&#39;, date) as date, cost_per_appt from (\n\t\t\tselect distinct to_date(rc.event_month, &#39;yyyy-mm&#39;) as date, sum(rc.total_cost)/sum(rc.appointments) as cost_per_appt\n\t\t\tfrom mv_roi_campaigns rc\n\t\t\tjoin media_buys mb on mb.id = rc.media_buy_id\n\t\t\tjoin media_buys_offices mo on mo.media_buy_id = mb.id\n\t\t\tjoin offices on offices.id = mo.office_id\n\t\t\tjoin regions on regions.id = offices.region_id\n\t\t\twhere rc.client_id = :cid and pool_id in (select id from pools where name in (&#39;Lead&#39;)) and media_type = &#39;Direct Mail&#39;\n\t\t\tgroup by date\n\t\t\torder by date\n\t\t) sub\n\t\twhere date #{between_date_range}\n\t) qy on qy.date = gs.month\n) query\norder by month\n&quot;, { :cid =&gt; cid }])</span><table id='context66' class='context' style='display:none'><caption>app/controllers/api/dashboard_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>2380</pre>
          </td>
          <td class='context'>
            <pre class='context'>			rs = General.find_by_sql [&lt;&lt;~SQL, {:cid =&gt; cid}]</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2381</pre>
            </td>
            <td class='context'>
              <pre class='context'>				select array[(month + interval &#39;1 day&#39;)::date::text, cost_per_appt::text] as data</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>2382</pre>
            </td>
            <td class='context'>
              <pre class='context'>				from (</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2383</pre>
            </td>
            <td class='context'>
              <pre class='context'>					select gs.month, coalesce(round(cost_per_appt, 2), 0) as cost_per_appt</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>2384</pre>
            </td>
            <td class='context'>
              <pre class='context'>					from (</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>2385</pre>
            </td>
            <td class='context'>
              <pre class='context'>						#{generate_series(date_range)}</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>2386</pre>
            </td>
            <td class='context'>
              <pre class='context'>					) gs</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2387</pre>
            </td>
            <td class='context'>
              <pre class='context'>					left join (</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>2388</pre>
            </td>
            <td class='context'>
              <pre class='context'>						select date_trunc(&#39;month&#39;, date) as date, cost_per_appt from (</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2389</pre>
            </td>
            <td class='context'>
              <pre class='context'>							select distinct to_date(rc.event_month, &#39;yyyy-mm&#39;) as date, sum(rc.total_cost)/sum(rc.appointments) as cost_per_appt</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>2390</pre>
            </td>
            <td class='context'>
              <pre class='context'>							from mv_roi_campaigns rc</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>Api::DashboardController</td>
      <td>dm_appts_expanded</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context67');toggle('message67');toggle('full_message67')" >Possible SQL injection near line 2427: <span class="code">General.find_by_sql([&quot;select &#39;Direct Mail&#39; as title, date_trunc(&#39;month&#39;, date) as date::timestamp, office, coalesce(appts, 0) as appts from (\n\tselect distinct to_date(rc.event_month, &#39;yyyy-mm&#39;) as date, offices.name as office, sum(rc.appointments) as appts\n\tfrom mv_roi_campaigns rc\n\tjoin media_buys mb on mb.id = rc.media_buy_id\n\tjoin media_buys_offices mo on mo.media_buy_id = mb.id\n\tjoin offices on offices.id = mo.office_id\n\tjoin regions on regions.id = offices.region_id\n\twhere rc.client_id = :cid and pool_id in (select id from pools where name in (&#39;Lead&#39;))\n\tand media_type = &#39;Direct Mail&#39; and to_date(rc.event_month, &#39;yyyy-mm&#39;) #{<span class="user_input">between_date_range</span>}\n\tgroup by date, office\n\torder by date, office\n) qy\norder by date desc, office\n&quot;, { :cid =&gt; cid }])</span><table id='context67' class='context' style='display:none'><caption>app/controllers/api/dashboard_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>2422</pre>
          </td>
          <td class='context'>
            <pre class='context'>				join media_buys mb on mb.id = rc.media_buy_id</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2423</pre>
            </td>
            <td class='context'>
              <pre class='context'>				join media_buys_offices mo on mo.media_buy_id = mb.id</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>2424</pre>
            </td>
            <td class='context'>
              <pre class='context'>				join offices on offices.id = mo.office_id</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2425</pre>
            </td>
            <td class='context'>
              <pre class='context'>				join regions on regions.id = offices.region_id</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>2426</pre>
            </td>
            <td class='context'>
              <pre class='context'>				where rc.client_id = :cid and pool_id in (select id from pools where name in (&#39;Lead&#39;))</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>2427</pre>
            </td>
            <td class='context'>
              <pre class='context'>				and media_type = &#39;Direct Mail&#39; and to_date(rc.event_month, &#39;yyyy-mm&#39;) #{between_date_range}</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>2428</pre>
            </td>
            <td class='context'>
              <pre class='context'>				group by date, office</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2429</pre>
            </td>
            <td class='context'>
              <pre class='context'>				order by date, office</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>2430</pre>
            </td>
            <td class='context'>
              <pre class='context'>			) qy</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2431</pre>
            </td>
            <td class='context'>
              <pre class='context'>			order by date desc, office</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>2432</pre>
            </td>
            <td class='context'>
              <pre class='context'>		SQL</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>Api::DashboardController</td>
      <td>total_dm_appointments</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context68');toggle('message68');toggle('full_message68')" >Possible SQL injection near line 2449: <span class="code">General.find_by_sql([&quot;select array[(month + interval &#39;1 day&#39;)::date::text, appts::text] as data\nfrom (\n\tselect gs.month, coalesce(appts, 0) as appts\n\tfrom (\n\t\t#{<span class="user_input">generate_series(date_range)</span>}\n\t) gs\n\tleft join (\n\t\tselect date_trunc(&#39;month&#39;, date) as date, appts from (\n\t\t\tselect distinct to_date(rc.event_month, &#39;yyyy-mm&#39;) as date, sum(rc.appointments) as appts\n\t\t\tfrom mv_roi_campaigns rc\n\t\t\tjoin media_buys mb on mb.id = rc.media_buy_id\n\t\t\tjoin media_buys_offices mo on mo.media_buy_id = mb.id\n\t\t\tjoin offices on offices.id = mo.office_id\n\t\t\tjoin regions on regions.id = offices.region_id\n\t\t\twhere rc.client_id = :cid and pool_id in (select id from pools where name in (&#39;Lead&#39;))\n\t\t\tand media_type = &#39;Direct Mail&#39; and to_date(rc.event_month, &#39;yyyy-mm&#39;) #{between_date_range}\n\t\t\tgroup by date\n\t\t\torder by date\n\t\t) sub\n\t) qy on qy.date = gs.month\n\torder by month\n) query\norder by month asc\n&quot;, { :cid =&gt; cid }])</span><table id='context68' class='context' style='display:none'><caption>app/controllers/api/dashboard_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>2444</pre>
          </td>
          <td class='context'>
            <pre class='context'>		rs = General.find_by_sql [&lt;&lt;~SQL, {:cid =&gt; cid}]</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2445</pre>
            </td>
            <td class='context'>
              <pre class='context'>			select array[(month + interval &#39;1 day&#39;)::date::text, appts::text] as data</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>2446</pre>
            </td>
            <td class='context'>
              <pre class='context'>			from (</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2447</pre>
            </td>
            <td class='context'>
              <pre class='context'>				select gs.month, coalesce(appts, 0) as appts</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>2448</pre>
            </td>
            <td class='context'>
              <pre class='context'>				from (</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>2449</pre>
            </td>
            <td class='context'>
              <pre class='context'>					#{generate_series(date_range)}</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>2450</pre>
            </td>
            <td class='context'>
              <pre class='context'>				) gs</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2451</pre>
            </td>
            <td class='context'>
              <pre class='context'>				left join (</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>2452</pre>
            </td>
            <td class='context'>
              <pre class='context'>					select date_trunc(&#39;month&#39;, date) as date, appts from (</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2453</pre>
            </td>
            <td class='context'>
              <pre class='context'>						select distinct to_date(rc.event_month, &#39;yyyy-mm&#39;) as date, sum(rc.appointments) as appts</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>2454</pre>
            </td>
            <td class='context'>
              <pre class='context'>						from mv_roi_campaigns rc</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>Api::DashboardController</td>
      <td>monthly_qt_appts_expanded</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context69');toggle('message69');toggle('full_message69')" ><span id='message69' style='display:block'>Possible SQL injection near line 2496: ...</span><span id='full_message69' style='display:none'>Possible SQL injection near line 2496: <span class="code">General.find_by_sql([&quot;select &#39;#{(((&quot;&quot; or &quot;TNS Appointments&quot;) or &quot;Upgrade Appointments&quot;) or &quot;No Show Appointments&quot;)}&#39; as title, date_trunc(&#39;month&#39;, sub.month) as month, office, coalesce(sum(sub.resulting_appts), 0) as total_appts\nfrom (\n\tselect qt.name as title, month, nudge_name, o.name as office, count(distinct mod_individual) as patients_messaged, count(distinct app_pt) as resulting_appts, count(distinct purch_pt) as patients_who_purchased, coalesce(sum(price)::integer, 0) as total_revenue\n\tfrom (select * from offices where client_id = :cid and active = &#39;t&#39;) o\n\tjoin mv_ngdash_results mv on o.id = mv.office_id\n\tjoin (select id, name from query_types where nickname = :qt_nickname) qt on qt.id = mv.query_type_id\n\twhere month #{<span class="user_input">between_date_range</span>}\n\tgroup by month, nudge_name, office, qt.name\n\torder by month desc, nudge_name, office\n) sub\ngroup by month, office\norder by month desc, office\n&quot;, { :cid =&gt; cid, :qt_nickname =&gt; (((&quot;tns&quot; or &quot;upg&quot;) or &quot;ns&quot;)) }])</span></span><table id='context69' class='context' style='display:none'><caption>app/controllers/api/dashboard_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>2491</pre>
          </td>
          <td class='context'>
            <pre class='context'>			from (</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2492</pre>
            </td>
            <td class='context'>
              <pre class='context'>				select qt.name as title, month, nudge_name, o.name as office, count(distinct mod_individual) as patients_messaged, count(distinct app_pt) as resulting_appts, count(distinct purch_pt) as patients_who_purchased, coalesce(sum(price)::integer, 0) as total_revenue</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>2493</pre>
            </td>
            <td class='context'>
              <pre class='context'>				from (select * from offices where client_id = :cid and active = &#39;t&#39;) o</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2494</pre>
            </td>
            <td class='context'>
              <pre class='context'>				join mv_ngdash_results mv on o.id = mv.office_id</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>2495</pre>
            </td>
            <td class='context'>
              <pre class='context'>				join (select id, name from query_types where nickname = :qt_nickname) qt on qt.id = mv.query_type_id</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>2496</pre>
            </td>
            <td class='context'>
              <pre class='context'>				where month #{between_date_range}</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>2497</pre>
            </td>
            <td class='context'>
              <pre class='context'>				group by month, nudge_name, office, qt.name</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2498</pre>
            </td>
            <td class='context'>
              <pre class='context'>				order by month desc, nudge_name, office</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>2499</pre>
            </td>
            <td class='context'>
              <pre class='context'>			) sub</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2500</pre>
            </td>
            <td class='context'>
              <pre class='context'>			group by month, office</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>2501</pre>
            </td>
            <td class='context'>
              <pre class='context'>			order by month desc, office</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>Api::DashboardController</td>
      <td>monthly_qt_appts</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context70');toggle('message70');toggle('full_message70')" >Possible SQL injection near line 2521: <span class="code">General.find_by_sql([&quot;select array[(month + interval &#39;1 day&#39;)::date::text, total_appts::text] as data\nfrom (\n\tselect gs.month, coalesce(total_appts, 0) as total_appts\n\tfrom (\n\t\t#{<span class="user_input">generate_series(date_range)</span>}\n\t) gs\n\tleft join (\n\t\tselect date_trunc(&#39;month&#39;, sub.month) as month, sum(sub.resulting_appts) as total_appts\n\t\tfrom (\n\t\t\tselect qt.name as title, month, nudge_name, o.name as office, count(distinct mod_individual) as patients_messaged, count(distinct app_pt) as resulting_appts, count(distinct purch_pt) as patients_who_purchased, coalesce(sum(price)::integer, 0) as total_revenue\n\t\t\tfrom (select * from offices where client_id = :cid and active = &#39;t&#39;) o\n\t\t\tjoin mv_ngdash_results mv on o.id = mv.office_id\n\t\t\tjoin (select id, name from query_types where nickname = :qt_nickname) qt on qt.id = mv.query_type_id\n\t\t\twhere mv.month #{between_date_range}\n\t\t\tgroup by month, nudge_name, office, qt.name\n\t\t\torder by month desc, nudge_name, office\n\t\t) sub\n\t\tgroup by month\n\t\torder by month\n\t) qy on qy.month = gs.month\n) query\norder by month\n&quot;, { :cid =&gt; cid, :qt_nickname =&gt; qt_nickname }])</span><table id='context70' class='context' style='display:none'><caption>app/controllers/api/dashboard_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>2516</pre>
          </td>
          <td class='context'>
            <pre class='context'>			General.find_by_sql [&lt;&lt;~SQL, {:cid =&gt; cid, :qt_nickname =&gt; qt_nickname}]</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2517</pre>
            </td>
            <td class='context'>
              <pre class='context'>				select array[(month + interval &#39;1 day&#39;)::date::text, total_appts::text] as data</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>2518</pre>
            </td>
            <td class='context'>
              <pre class='context'>				from (</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2519</pre>
            </td>
            <td class='context'>
              <pre class='context'>					select gs.month, coalesce(total_appts, 0) as total_appts</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>2520</pre>
            </td>
            <td class='context'>
              <pre class='context'>					from (</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>2521</pre>
            </td>
            <td class='context'>
              <pre class='context'>						#{generate_series(date_range)}</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>2522</pre>
            </td>
            <td class='context'>
              <pre class='context'>					) gs</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2523</pre>
            </td>
            <td class='context'>
              <pre class='context'>					left join (</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>2524</pre>
            </td>
            <td class='context'>
              <pre class='context'>						select date_trunc(&#39;month&#39;, sub.month) as month, sum(sub.resulting_appts) as total_appts</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2525</pre>
            </td>
            <td class='context'>
              <pre class='context'>						from (</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>2526</pre>
            </td>
            <td class='context'>
              <pre class='context'>							select qt.name as title, month, nudge_name, o.name as office, count(distinct mod_individual) as patients_messaged, count(distinct app_pt) as resulting_appts, count(distinct purch_pt) as patients_who_purchased, coalesce(sum(price)::integer, 0) as total_revenue</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>Api::DashboardController</td>
      <td>monthly_returns</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context71');toggle('message71');toggle('full_message71')" >Possible SQL injection near line 2560: <span class="code">General.find_by_sql([&quot;select array[(month + interval &#39;1 day&#39;)::date::text, returns::text] as data\nfrom(\n\tselect gs.month as month, coalesce(returns, 0) as returns\n\tfrom (\n\t\t#{<span class="user_input">generate_series(date_range)</span>}\n\t) gs\n\tleft join (\n\t\tselect date_trunc(&#39;month&#39;, purchased_at)::date as month, count(distinct patient_id) as returns\n\t\tfrom purchases pr\n\t\tjoin mv_patients mv on mv.id = pr.patient_id\n\t\twhere mv.client_id = :cid and returned_at is not null and purchased_at #{between_date_range}\n\t\tand purchase_type in (&#39;l_hearing_aid&#39;, &#39;r_hearing_aid&#39;)\n\t\tgroup by month\n\t\torder by month\n\t) mv on mv.month = gs.month\n) query\norder by month asc\n&quot;, { :cid =&gt; cid.to_i }])</span><table id='context71' class='context' style='display:none'><caption>app/controllers/api/dashboard_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>2555</pre>
          </td>
          <td class='context'>
            <pre class='context'>			rs = General.find_by_sql [&lt;&lt;~SQL, {:cid =&gt; cid.to_i}]</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2556</pre>
            </td>
            <td class='context'>
              <pre class='context'>				select array[(month + interval &#39;1 day&#39;)::date::text, returns::text] as data</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>2557</pre>
            </td>
            <td class='context'>
              <pre class='context'>				from(</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2558</pre>
            </td>
            <td class='context'>
              <pre class='context'>					select gs.month as month, coalesce(returns, 0) as returns</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>2559</pre>
            </td>
            <td class='context'>
              <pre class='context'>					from (</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>2560</pre>
            </td>
            <td class='context'>
              <pre class='context'>						#{generate_series(date_range)}</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>2561</pre>
            </td>
            <td class='context'>
              <pre class='context'>					) gs</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2562</pre>
            </td>
            <td class='context'>
              <pre class='context'>					left join (</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>2563</pre>
            </td>
            <td class='context'>
              <pre class='context'>						select date_trunc(&#39;month&#39;, purchased_at)::date as month, count(distinct patient_id) as returns</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2564</pre>
            </td>
            <td class='context'>
              <pre class='context'>						from purchases pr</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>2565</pre>
            </td>
            <td class='context'>
              <pre class='context'>						join mv_patients mv on mv.id = pr.patient_id</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>Api::DashboardController</td>
      <td>monthly_returns_expanded</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context72');toggle('message72');toggle('full_message72')" >Possible SQL injection near line 2594: <span class="code">General.find_by_sql([&quot;select &#39;Returns&#39; as title, date_trunc(&#39;month&#39;, purchased_at)::timestamp as month, o.name as office, count(distinct patient_id) as purchases, count(distinct patient_id) filter (where returned_at is not null) as returns\nfrom purchases pr\njoin (select id, office_id, client_id from mv_patients) mv on mv.id = pr.patient_id\njoin (select id, name from offices) o on o.id = mv.office_id\nwhere mv.client_id = :cid and purchased_at #{<span class="user_input">between_date_range</span>}\nand purchase_type in (&#39;l_hearing_aid&#39;, &#39;r_hearing_aid&#39;)\ngroup by month, office\norder by month desc, office\n&quot;, { :cid =&gt; cid.to_i }])</span><table id='context72' class='context' style='display:none'><caption>app/controllers/api/dashboard_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>2589</pre>
          </td>
          <td class='context'>
            <pre class='context'>			rs = General.find_by_sql [&lt;&lt;~SQL, {:cid =&gt; cid.to_i}]</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2590</pre>
            </td>
            <td class='context'>
              <pre class='context'>				select &#39;Returns&#39; as title, date_trunc(&#39;month&#39;, purchased_at)::timestamp as month, o.name as office, count(distinct patient_id) as purchases, count(distinct patient_id) filter (where returned_at is not null) as returns</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>2591</pre>
            </td>
            <td class='context'>
              <pre class='context'>				from purchases pr</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2592</pre>
            </td>
            <td class='context'>
              <pre class='context'>				join (select id, office_id, client_id from mv_patients) mv on mv.id = pr.patient_id</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>2593</pre>
            </td>
            <td class='context'>
              <pre class='context'>				join (select id, name from offices) o on o.id = mv.office_id</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>2594</pre>
            </td>
            <td class='context'>
              <pre class='context'>				where mv.client_id = :cid and purchased_at #{between_date_range}</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>2595</pre>
            </td>
            <td class='context'>
              <pre class='context'>				and purchase_type in (&#39;l_hearing_aid&#39;, &#39;r_hearing_aid&#39;)</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2596</pre>
            </td>
            <td class='context'>
              <pre class='context'>				group by month, office</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>2597</pre>
            </td>
            <td class='context'>
              <pre class='context'>				order by month desc, office</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2598</pre>
            </td>
            <td class='context'>
              <pre class='context'>			SQL</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>2599</pre>
            </td>
            <td class='context'>
              <pre class='context'>			if rs.length == 0</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>Api::DashboardController</td>
      <td>revenue_per_nudge_expanded</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context73');toggle('message73');toggle('full_message73')" >Possible SQL injection near line 2617: <span class="code">General.find_by_sql([&quot;select array[(month + interval &#39;1 day&#39;)::date::text, coalesce(sum(total_revenue), 0)::text] as data, campaign\nfrom(\n\tselect month, qt.name as campaign, coalesce(sum(price)::integer, 0) as total_revenue\n\tfrom (select * from offices where client_id = :cid and active = &#39;t&#39;) o\n\tjoin mv_ngdash_results mv on o.id = mv.office_id\n\tjoin (select id, name from query_types) qt on qt.id = mv.query_type_id\n\twhere mv.month #{<span class="user_input">between_date_range</span>}\n\tand qt.name not in (&#39;Completed Appointment Survey&#39;, &#39;HA Review&#39;)\n\tgroup by month, campaign\n\torder by month, campaign\n) query\ngroup by month, campaign\norder by month, campaign\n&quot;, { :cid =&gt; cid.to_i }])</span><table id='context73' class='context' style='display:none'><caption>app/controllers/api/dashboard_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>2612</pre>
          </td>
          <td class='context'>
            <pre class='context'>			from(</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2613</pre>
            </td>
            <td class='context'>
              <pre class='context'>				select month, qt.name as campaign, coalesce(sum(price)::integer, 0) as total_revenue</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>2614</pre>
            </td>
            <td class='context'>
              <pre class='context'>				from (select * from offices where client_id = :cid and active = &#39;t&#39;) o</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2615</pre>
            </td>
            <td class='context'>
              <pre class='context'>				join mv_ngdash_results mv on o.id = mv.office_id</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>2616</pre>
            </td>
            <td class='context'>
              <pre class='context'>				join (select id, name from query_types) qt on qt.id = mv.query_type_id</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>2617</pre>
            </td>
            <td class='context'>
              <pre class='context'>				where mv.month #{between_date_range}</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>2618</pre>
            </td>
            <td class='context'>
              <pre class='context'>				and qt.name not in (&#39;Completed Appointment Survey&#39;, &#39;HA Review&#39;)</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2619</pre>
            </td>
            <td class='context'>
              <pre class='context'>				group by month, campaign</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>2620</pre>
            </td>
            <td class='context'>
              <pre class='context'>				order by month, campaign</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2621</pre>
            </td>
            <td class='context'>
              <pre class='context'>			) query</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>2622</pre>
            </td>
            <td class='context'>
              <pre class='context'>			group by month, campaign</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>Api::DashboardController</td>
      <td>revenue_per_nudge_table</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context74');toggle('message74');toggle('full_message74')" >Possible SQL injection near line 2634: <span class="code">General.find_by_sql([&quot;select &#39;Revenue Per Nudge&#39; as title, month, qt.name as campaign, o.name as office, coalesce(sum(price)::integer, 0) as total_revenue\nfrom (select * from offices where client_id = :cid and active = &#39;t&#39;) o\njoin mv_ngdash_results mv on o.id = mv.office_id\njoin (select id, name from query_types) qt on qt.id = mv.query_type_id\nwhere mv.month #{<span class="user_input">between_date_range</span>}\nand qt.name not in (&#39;Completed Appointment Survey&#39;, &#39;HA Review&#39;)\ngroup by month, campaign, office\norder by month desc, campaign, office\n&quot;, { :cid =&gt; cid.to_i }])</span><table id='context74' class='context' style='display:none'><caption>app/controllers/api/dashboard_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>2629</pre>
          </td>
          <td class='context'>
            <pre class='context'>		rs = General.find_by_sql [&lt;&lt;~SQL, {:cid =&gt; cid.to_i}]</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2630</pre>
            </td>
            <td class='context'>
              <pre class='context'>			select &#39;Revenue Per Nudge&#39; as title, month, qt.name as campaign, o.name as office, coalesce(sum(price)::integer, 0) as total_revenue</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>2631</pre>
            </td>
            <td class='context'>
              <pre class='context'>			from (select * from offices where client_id = :cid and active = &#39;t&#39;) o</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2632</pre>
            </td>
            <td class='context'>
              <pre class='context'>			join mv_ngdash_results mv on o.id = mv.office_id</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>2633</pre>
            </td>
            <td class='context'>
              <pre class='context'>			join (select id, name from query_types) qt on qt.id = mv.query_type_id</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>2634</pre>
            </td>
            <td class='context'>
              <pre class='context'>			where mv.month #{between_date_range}</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>2635</pre>
            </td>
            <td class='context'>
              <pre class='context'>			and qt.name not in (&#39;Completed Appointment Survey&#39;, &#39;HA Review&#39;)</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2636</pre>
            </td>
            <td class='context'>
              <pre class='context'>			group by month, campaign, office</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>2637</pre>
            </td>
            <td class='context'>
              <pre class='context'>			order by month desc, campaign, office</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>2638</pre>
            </td>
            <td class='context'>
              <pre class='context'>		SQL</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>2639</pre>
            </td>
            <td class='context'>
              <pre class='context'>		if rs.length == 0</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>Api::DashboardController</td>
      <td>prospect_calls</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context122');toggle('message122');toggle('full_message122')" >Possible SQL injection near line 1447: <span class="code">Office.where(:client_id =&gt; cid, :active =&gt; true).where((&quot;offices.id in (#{<span class="user_input">get_data_filters(@authorized_user, cid)</span>})&quot; or &quot;&quot;))</span><table id='context122' class='context' style='display:none'><caption>app/controllers/api/dashboard_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>1442</pre>
          </td>
          <td class='context'>
            <pre class='context'>			dt[:prospect_calls] = {cols: cl, rows: ot}</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1443</pre>
            </td>
            <td class='context'>
              <pre class='context'>			if params[:first] == &quot;true&quot;</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1444</pre>
            </td>
            <td class='context'>
              <pre class='context'>				ot = []</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1445</pre>
            </td>
            <td class='context'>
              <pre class='context'>				df = get_data_filters(@authorized_user, cid)</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>1446</pre>
            </td>
            <td class='context'>
              <pre class='context'>				fq = df.length &gt; 0 ? &quot;offices.id in (#{df})&quot; : &quot;&quot;</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>1447</pre>
            </td>
            <td class='context'>
              <pre class='context'>				Office.where(client_id: cid, active: true).where(fq).select(&quot;offices.id, offices.name&quot;).group(&quot;offices.id, offices.name&quot;).each{ |o| ot &lt;&lt; {id: o.id, name: o.name}}</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>1448</pre>
            </td>
            <td class='context'>
              <pre class='context'>				dt[:offices] = ot.sort{ |a,b| a[:name] &lt;=&gt; b[:name] }</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1449</pre>
            </td>
            <td class='context'>
              <pre class='context'>				dt[:offices].unshift({id: nil, name: &quot;All Offices&quot;})</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1450</pre>
            </td>
            <td class='context'>
              <pre class='context'>			end</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1451</pre>
            </td>
            <td class='context'>
              <pre class='context'>			dt</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1452</pre>
            </td>
            <td class='context'>
              <pre class='context'>		end</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>Api::IntegrationController</td>
      <td>check_notification</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context148');toggle('message148');toggle('full_message148')" ><span id='message148' style='display:block'>Possible SQL injection near line 853: ...</span><span id='full_message148' style='display:none'>Possible SQL injection near line 853: <span class="code">Person.find(user_id.id).notification_filters.find_by(&quot;(\&quot;filter_type\&quot; = &#39;office&#39; and \&quot;filter_info\&quot; = &#39;#{<span class="user_input">fc.name</span>}&#39;) or (\&quot;filter_type\&quot; = &#39;phone number&#39; and \&quot;filter_info\&quot; = &#39;#{mie.from}&#39;) or (\&quot;filter_type\&quot; = &#39;provider&#39; and \&quot;filter_info\&quot; = &#39;#{((&quot;&quot; or &quot;#{(nil or patient.appointments.order(:created_at =&gt; :desc).first).hcp_f_name} #{(nil or patient.appointments.order(:created_at =&gt; :desc).first).hcp_l_name}&quot;.gsub(/&#39;+/, &quot;&#39;&#39;&quot;)) or &quot;Unknown Provider&quot;)}&#39;)&quot;)</span></span><table id='context148' class='context' style='display:none'><caption>app/controllers/api/integration_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>848</pre>
          </td>
          <td class='context'>
            <pre class='context'>						end</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>849</pre>
            </td>
            <td class='context'>
              <pre class='context'>					end</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>850</pre>
            </td>
            <td class='context'>
              <pre class='context'>					provider = &quot;#{recent_appt.hcp_f_name} #{recent_appt.hcp_l_name}&quot;.gsub(/&#39;+/,&quot;&#39;&#39;&quot;) if recent_appt</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>851</pre>
            </td>
            <td class='context'>
              <pre class='context'>					provider = &quot;Unknown Provider&quot; if provider.empty?</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>852</pre>
            </td>
            <td class='context'>
              <pre class='context'>					# If the user has notification filters related to this message, then we only want to send the token and data</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>853</pre>
            </td>
            <td class='context'>
              <pre class='context'>					if user.notification_filters.find_by(&quot;(\&quot;filter_type\&quot; = &#39;office&#39; and \&quot;filter_info\&quot; = &#39;#{fc.name}&#39;) or (\&quot;filter_type\&quot; = &#39;phone number&#39; and \&quot;filter_info\&quot; = &#39;#{mie.from}&#39;) or (\&quot;filter_type\&quot; = &#39;provider&#39; and \&quot;filter_info\&quot; = &#39;#{provider}&#39;)&quot;)</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>854</pre>
            </td>
            <td class='context'>
              <pre class='context'>						payload[:message].delete(:notification)</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>855</pre>
            </td>
            <td class='context'>
              <pre class='context'>						payload[:message].delete(:android)</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>856</pre>
            </td>
            <td class='context'>
              <pre class='context'>						payload[:message].delete(:apns)</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>857</pre>
            </td>
            <td class='context'>
              <pre class='context'>					end</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>858</pre>
            </td>
            <td class='context'>
              <pre class='context'>					payload[:message][:data][:debug] = &quot;Office: #{fc.name}\nProvider: #{provider}&quot;</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>Api::MiscellaneousController</td>
      <td>patient_stats</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context75');toggle('message75');toggle('full_message75')" ><span id='message75' style='display:block'>Possible SQL injection near line 373: ...</span><span id='full_message75' style='display:none'>Possible SQL injection near line 373: <span class="code">General.find_by_sql([&quot;\t\tWITH invalid_patients AS (\n\t\tSELECT\n\t\t\t\tDISTINCT ON (p.id)\n\t\t\t\tp.id,\n\t\t\t\tCASE\n\t\t\t\t\tWHEN (p.f_name IS NULL OR TRIM(p.f_name) = &#39;&#39; OR p.l_name IS NULL OR TRIM(p.l_name) = &#39;&#39;) THEN 1\n\t\t\t\t\tELSE 0\n\t\t\t\tEND AS patient_missing_name,\n\t\t\t\tCASE\n\t\t\t\t\tWHEN pr.patient_id IS NULL THEN 1\n\t\t\t\t\tELSE 0\n\t\t\t\tEND AS minor_missing_parent,\n\t\t\t\tCASE WHEN p.gender IS NULL OR p.gender = &#39;U&#39; OR p.gender = &#39;O&#39; THEN 1 ELSE 0 END AS other_gender,\n\t\t\t\tCASE WHEN p.gender = &#39;F&#39; THEN 1 ELSE 0 END AS female_gender,\n\t\t\t\tCASE WHEN p.gender = &#39;M&#39; THEN 1 ELSE 0 END AS male_gender,\n\t\t\t\tCASE WHEN p.phone_text IS NULL OR p.phone_text !~ &#39;^[0-9]{10}$&#39; THEN 1 ELSE 0 END AS not_textable_phone,\n\t\t\t\tCASE WHEN p.email IS NULL OR p.email NOT LIKE &#39;%@%.%&#39; THEN 1 ELSE 0 END AS not_valid_email,\n\t\t\t\tCASE\n\t\t\t\t\tWHEN p.street1 IS NULL OR TRIM(p.street1) = &#39;&#39;\n\t\t\t\t\t\tOR p.city IS NULL OR TRIM(p.city) = &#39;&#39;\n\t\t\t\t\t\tOR p.state IS NULL OR TRIM(p.state) = &#39;&#39;\n\t\t\t\t\t\tOR (p.zip IS NULL OR TRIM(p.zip) !~ &#39;^\\d{5}(?:-\\d{4})?$&#39;)\n\t\t\t\t\tTHEN 1\n\t\t\t\t\tELSE 0\n\t\t\t\t\tEND AS not_valid_address,\n\t\t\t\tCASE WHEN p.hipaa_consent_id IS NULL THEN 1 ELSE 0 END AS not_consented,\n\t\t\t\tCASE WHEN (moo_email.id IS NULL AND moo_phone.id IS NULL) THEN 0 ELSE 1 END AS opt_out,\n\t\t\t\tCASE WHEN mod.id IS NOT NULL THEN 1 ELSE 0 END AS touched_annually,\n\t\t\t\tCASE WHEN appt.id IS NOT NULL THEN 1 ELSE 0 END AS seen_annually,\n\t\t\t\tCASE\n\t\t\t\t\tWHEN geo.lat IS NULL OR geo.lon IS NULL THEN 0\n\t\t\t\t\tWHEN o.lat IS NULL OR o.lon IS NULL THEN 0\n\t\t\t\t\tWHEN ST_DWithin(\n\t\t\t\t\t\tST_SetSRID(ST_MakePoint(o.lon, o.lat), 4326)::geography,\n\t\t\t\t\t\tST_SetSRID(ST_MakePoint(geo.lon, geo.lat), 4326)::geography,\n\t\t\t\t\t\t160934\n\t\t\t\t\t)\n\t\t\t\t\tTHEN 0\n\t\t\t\t\tELSE 1\n\t\t\t\tEND AS outside_radius\n\t\tFROM\n\t\t\t\tmv_patients p\n\t\t-- Separate LEFT JOINs for email and phone_text to avoid using OR\n\t\tLEFT JOIN message_opt_outs moo_email ON moo_email.client_id = :cid AND moo_email.\&quot;from\&quot; = p.email\n\t\tLEFT JOIN message_opt_outs moo_phone ON moo_phone.client_id = :cid AND moo_phone.\&quot;from\&quot; = p.phone_text\n\t\tLEFT JOIN message_out_details mod ON mod.client_id = :cid AND mod.to = p.phone_text AND touch_step_id IS NOT NULL AND processed_at &gt;= CURRENT_DATE - INTERVAL &#39;1 year&#39;\n\t\tLEFT JOIN appointments appt ON appt.patient_id = p.id AND appt_at &gt;= CURRENT_DATE - INTERVAL &#39;1 year&#39;\n\t\tLEFT JOIN offices o ON o.id = p.office_id\n\t\tLEFT JOIN geographics geo ON geo.individual_id = p.individual_id\n\t\tLEFT JOIN (\n\t\t\tSELECT DISTINCT ON (child.id)\n\t\t\t\tchild.id as patient_id,\n\t\t\t\tparent.f_name as parent_f_name,\n\t\t\t\tparent.l_name as parent_l_name\n\t\t\tFROM patients parent\n\t\t\tJOIN patients_phones parent_phones ON parent.id = parent_phones.patient_id\n\t\t\tJOIN patients_phones child_phones ON parent_phones.phone = child_phones.phone AND parent.id != child_phones.patient_id\n\t\t\tJOIN patients child ON child_phones.patient_id = child.id AND child.client_id = parent.client_id\n\t\t\tWHERE parent.patient_type = &#39;Relation&#39;\n\t\t\t\tAND parent.rel_priority IN (1, 2, 3)\n\t\t\tORDER BY child.id, parent.rel_priority  -- Prefer mother (1) over father (2)\n\t\t) pr ON pr.patient_id = p.id\n\t\tWHERE\n\t\t\t\tp.client_id = :cid #{<span class="user_input">created_at_filter</span>} #{office_filter} #{provider_filter} #{minor_filter}\n\t\t\t\t#{if get_data_filters(@authorized_user, @authorized_user.authorized_client(params[:client_id], [&quot;Administrator&quot;, &quot;User&quot;, &quot;Engagement&quot;]).id).split(&quot;,&quot;).map(&amp;:to_i).present? then   &quot;AND p.office_id IN (:office_ids)&quot; end}\n)\nSELECT\n\t\tCOUNT(id) AS total_patients,\n\t\tSUM(patient_missing_name) AS patients_missing_name,\n\t\tSUM(minor_missing_parent) AS minors_missing_parent,\n\t\tSUM(male_gender) AS male_patients,\n\t\tSUM(female_gender) AS female_patients,\n\t\tSUM(other_gender) AS other_patients,\n\t\tSUM(not_textable_phone) AS without_textable_phone,\n\t\tSUM(not_valid_email) AS with_invalid_email,\n\t\tSUM(not_valid_address) AS with_invalid_address,\n\t\tSUM(not_consented) AS without_consent,\n\t\tSUM(opt_out) AS with_opt_out,\n\t\tSUM(touched_annually) AS touched_annually,\n\t\tSUM(seen_annually) AS seen_annually,\n\t\tSUM(outside_radius) AS outside_radius\nFROM\n\t\tinvalid_patients;\n&quot;, { :cid =&gt; @authorized_user.authorized_client(params[:client_id], [&quot;Administrator&quot;, &quot;User&quot;, &quot;Engagement&quot;]).id, :office_ids =&gt; get_data_filters(@authorized_user, @authorized_user.authorized_client(params[:client_id], [&quot;Administrator&quot;, &quot;User&quot;, &quot;Engagement&quot;]).id).split(&quot;,&quot;).map(&amp;:to_i) }])</span></span><table id='context75' class='context' style='display:none'><caption>app/controllers/api/miscellaneous_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>368</pre>
          </td>
          <td class='context'>
            <pre class='context'>					WHERE parent.patient_type = &#39;Relation&#39;</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>369</pre>
            </td>
            <td class='context'>
              <pre class='context'>						AND parent.rel_priority IN (1, 2, 3)</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>370</pre>
            </td>
            <td class='context'>
              <pre class='context'>					ORDER BY child.id, parent.rel_priority  -- Prefer mother (1) over father (2)</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>371</pre>
            </td>
            <td class='context'>
              <pre class='context'>				) pr ON pr.patient_id = p.id</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>372</pre>
            </td>
            <td class='context'>
              <pre class='context'>				WHERE</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>373</pre>
            </td>
            <td class='context'>
              <pre class='context'>						p.client_id = :cid #{created_at_filter} #{office_filter} #{provider_filter} #{minor_filter}</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>374</pre>
            </td>
            <td class='context'>
              <pre class='context'>						#{&quot;AND p.office_id IN (:office_ids)&quot; if office_ids.present?}</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>375</pre>
            </td>
            <td class='context'>
              <pre class='context'>		)</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>376</pre>
            </td>
            <td class='context'>
              <pre class='context'>		SELECT</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>377</pre>
            </td>
            <td class='context'>
              <pre class='context'>				COUNT(id) AS total_patients,</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>378</pre>
            </td>
            <td class='context'>
              <pre class='context'>				SUM(patient_missing_name) AS patients_missing_name,</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>Api::MiscellaneousController</td>
      <td>chronic_care_patients</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context84');toggle('message84');toggle('full_message84')" ><span id='message84' style='display:block'>Possible SQL injection near line 1004: ...</span><span id='full_message84' style='display:none'>Possible SQL injection near line 1004: <span class="code">General.find_by_sql([&quot;select p.id, p.f_name, p.l_name, p.hcp_f_name, p.hcp_l_name, p.office_id, o.name as office_name, o.sms_phone as office_phone, p.phones, apt.next_appt, p.individual_id, lc.last_at as last_called, lc.status\nfrom mv_patients p\njoin (select id from tags where name = &#39;picm chronic care 2020-02-25&#39;) tg on 1 = 1\njoin (select id, name, sms_phone from offices) o on o.id = p.office_id\nleft join model_tags mt on mt.model_type = &#39;Patient&#39; and p.id = mt.model_id and tg.id = mt.tag_id\nleft join (\n\tselect distinct on (patient_id) patient_id, appt_at as next_appt\n\tfrom appointments\n\twhere appt_at::date &gt; now()::date\n\tand category in (&#39;Confirmed&#39;, &#39;Not Confirmed&#39;)\n\torder by patient_id, appt_at asc\n) apt on apt.patient_id = p.id\nleft join (\n\tselect distinct on (individual_id) individual_id, &#39;Call&#39;::text as message_type, created_at as last_at, status\n\tfrom callcenter_logs\n\twhere client_id = :cid and tab_contacted_in = &#39;Chronic Care&#39;\n\torder by individual_id, last_at desc nulls last\n) lc on p.individual_id = lc.individual_id\nwhere p.client_id = :cid and p.patient_type = &#39;Active&#39; and p.suppress = &#39;f&#39; and mt.id is not null\nand (date_trunc(&#39;month&#39;, lc.last_at::date) &lt; date_trunc(&#39;month&#39;, now()::date) or lc.last_at is null or status != &#39;Contacted&#39; or status is null)\n#{<span class="user_input">unless callcenter_search_param_query.blank? then   &quot;and #{callcenter_search_param_query}&quot; end</span>}\norder by p.l_name, p.f_name\n&quot;, { :cid =&gt; @authorized_user.authorized_client(params[:client_id], [&quot;Administrator&quot;, &quot;Call Center&quot;]).id }])</span></span><table id='context84' class='context' style='display:none'><caption>app/controllers/api/miscellaneous_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>999</pre>
          </td>
          <td class='context'>
            <pre class='context'>					where client_id = :cid and tab_contacted_in = &#39;Chronic Care&#39;</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1000</pre>
            </td>
            <td class='context'>
              <pre class='context'>					order by individual_id, last_at desc nulls last</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1001</pre>
            </td>
            <td class='context'>
              <pre class='context'>				) lc on p.individual_id = lc.individual_id</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1002</pre>
            </td>
            <td class='context'>
              <pre class='context'>				where p.client_id = :cid and p.patient_type = &#39;Active&#39; and p.suppress = &#39;f&#39; and mt.id is not null</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>1003</pre>
            </td>
            <td class='context'>
              <pre class='context'>				and (date_trunc(&#39;month&#39;, lc.last_at::date) &lt; date_trunc(&#39;month&#39;, now()::date) or lc.last_at is null or status != &#39;Contacted&#39; or status is null)</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>1004</pre>
            </td>
            <td class='context'>
              <pre class='context'>				#{&quot;and #{wr}&quot; unless wr.blank?}</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>1005</pre>
            </td>
            <td class='context'>
              <pre class='context'>				order by p.l_name, p.f_name</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1006</pre>
            </td>
            <td class='context'>
              <pre class='context'>				SQL</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1008</pre>
            </td>
            <td class='context'>
              <pre class='context'>			prv = General.find_by_sql [&lt;&lt;~SQL, {:cid =&gt; client.id}]</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1009</pre>
            </td>
            <td class='context'>
              <pre class='context'>				select distinct concat(hcp_f_name, &#39; &#39;, hcp_l_name) as pr</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>Api::MiscellaneousController</td>
      <td>callcenter_acquisition</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context124');toggle('message124');toggle('full_message124')" >Possible SQL injection near line 658: <span class="code">m.offices.where((&quot;offices.id in (#{get_data_filters(@authorized_user, @authorized_user.authorized_client(<span class="user_input">params[:client_id]</span>, [&quot;Administrator&quot;, &quot;Call Center&quot;]).id)})&quot; or &quot;&quot;))</span><table id='context124' class='context' style='display:none'><caption>app/controllers/api/miscellaneous_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>653</pre>
          </td>
          <td class='context'>
            <pre class='context'>			mb = mb.where(&quot;offices.id = ?&quot;, params[:office].to_i) if params[:office]</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>654</pre>
            </td>
            <td class='context'>
              <pre class='context'>			mb = mb.where(&quot;offices.filter1 = ?&quot;, params[:filter1]) if params[:filter1]</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>655</pre>
            </td>
            <td class='context'>
              <pre class='context'>			mo = []</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>656</pre>
            </td>
            <td class='context'>
              <pre class='context'>			mb.each do |m|</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>657</pre>
            </td>
            <td class='context'>
              <pre class='context'>				fo = []</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>658</pre>
            </td>
            <td class='context'>
              <pre class='context'>				fc = m.offices.where(ws).order(&quot;name&quot;).distinct</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>659</pre>
            </td>
            <td class='context'>
              <pre class='context'>				fc = fc.where(&quot;state = ?&quot;, params[:state][0..1]) if params[:state]</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>660</pre>
            </td>
            <td class='context'>
              <pre class='context'>				fc = fc.where(&quot;id = ?&quot;, params[:office].to_i) if params[:office]</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>661</pre>
            </td>
            <td class='context'>
              <pre class='context'>				fc = fc.where(&quot;filter1 = ?&quot;, params[:filter1]) if params[:filter1]</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>662</pre>
            </td>
            <td class='context'>
              <pre class='context'>				fc.each { |o| fo &lt;&lt; {id: o.id, name: o.name} }</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>663</pre>
            </td>
            <td class='context'>
              <pre class='context'>				mo &lt;&lt; {id: m.id, started_at: m.started_at, inhome_at: m.inhome_at, dnis: m.dnis, campaign: m.campaign.description, campaign_id: m.campaign.id, type: m.campaign.media_type.name, pool: m.campaign.pool.name, creative_fn: m.creative_fn, offices: fo}</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>Api::MiscellaneousHelper</td>
      <td>generate_appointment_stats</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context107');toggle('message107');toggle('full_message107')" ><span id='message107' style='display:block'>Possible SQL injection near line 75: ...</span><span id='full_message107' style='display:none'>Possible SQL injection near line 75: <span class="code">General.find_by_sql([&quot;WITH invalid_patients AS (\n  SELECT\n    DISTINCT ON (p.id) p.id AS pid,\n    p.phone_text, p.email, p.zip4, p.street1, p.street2, p.city, p.state, p.zip,\n    moo_email.id AS moo_email_id,\n    moo_phone.id AS moo_phone_id\n  FROM\n    mv_patients p\n  -- Separate LEFT JOINs for email and phone_text to avoid using OR\n  LEFT JOIN message_opt_outs moo_email\n    ON moo_email.client_id = :cid AND moo_email.\&quot;from\&quot; = p.email\n  LEFT JOIN message_opt_outs moo_phone\n    ON moo_phone.client_id = :cid AND moo_phone.\&quot;from\&quot; = p.phone_text\n  LEFT JOIN offices o\n    ON o.id = p.office_id\n  WHERE\n    p.client_id = :cid\n),\nunique_invalid_patients AS (\n  SELECT DISTINCT\n    p.pid, p.phone_text, p.email,\n    p.zip4, p.moo_email_id,\n    p.moo_phone_id, p.street1, p.street2, p.city, p.state, p.zip\n  FROM\n    invalid_patients p\n  INNER JOIN appointments appt\n    ON p.pid = appt.patient_id\n  INNER JOIN offices o\n    ON o.id = appt.office_id\n  WHERE\n    appt.name = :name AND appt.category = :category #{<span class="user_input">date_filter</span>} #{office_filter} #{provider_filter}\n)\nSELECT\n  COUNT(p.pid) AS total_patients,\n  SUM(CASE WHEN p.phone_text IS NULL OR p.phone_text !~ &#39;^[0-9]{10}$&#39; THEN 1 ELSE 0 END) AS without_textable_phone,\n  SUM(CASE WHEN p.email IS NULL OR p.email NOT LIKE &#39;%@%.%&#39; THEN 1 ELSE 0 END) AS with_invalid_email,\n  SUM(CASE WHEN p.street1 IS NULL OR TRIM(p.street1) = &#39;&#39;\n\t\t\t\t\t\t\t\t\tOR p.city IS NULL OR TRIM(p.city) = &#39;&#39;\n\t\t\t\t\t\t\t\t\tOR p.state IS NULL OR TRIM(p.state) = &#39;&#39;\n\t\t\t\t\t\t\t\t\tOR (p.zip IS NULL OR TRIM(p.zip) !~ &#39;^\\d{5}(?:-\\d{4})?$&#39;) THEN 1 ELSE 0 END) AS with_invalid_address,\n  SUM(CASE WHEN (p.moo_email_id IS NULL AND p.moo_phone_id IS NULL) THEN 1 ELSE 0 END) AS without_opt_out\nFROM\n  unique_invalid_patients p\n&quot;, { :cid =&gt; client.id, :category =&gt; params[:category], :name =&gt; params[:name] }])</span></span><table id='context107' class='context' style='display:none'><caption>app/helpers/api/miscellaneous_helper.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>70</pre>
          </td>
          <td class='context'>
            <pre class='context'>        INNER JOIN appointments appt</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>71</pre>
            </td>
            <td class='context'>
              <pre class='context'>          ON p.pid = appt.patient_id</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>72</pre>
            </td>
            <td class='context'>
              <pre class='context'>        INNER JOIN offices o</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>73</pre>
            </td>
            <td class='context'>
              <pre class='context'>          ON o.id = appt.office_id</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>74</pre>
            </td>
            <td class='context'>
              <pre class='context'>        WHERE</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>75</pre>
            </td>
            <td class='context'>
              <pre class='context'>          appt.name = :name AND appt.category = :category #{date_filter} #{office_filter} #{provider_filter}</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>76</pre>
            </td>
            <td class='context'>
              <pre class='context'>      )</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>77</pre>
            </td>
            <td class='context'>
              <pre class='context'>      SELECT</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>78</pre>
            </td>
            <td class='context'>
              <pre class='context'>        COUNT(p.pid) AS total_patients,</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>79</pre>
            </td>
            <td class='context'>
              <pre class='context'>        SUM(CASE WHEN p.phone_text IS NULL OR p.phone_text !~ &#39;^[0-9]{10}$&#39; THEN 1 ELSE 0 END) AS without_textable_phone,</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>80</pre>
            </td>
            <td class='context'>
              <pre class='context'>        SUM(CASE WHEN p.email IS NULL OR p.email NOT LIKE &#39;%@%.%&#39; THEN 1 ELSE 0 END) AS with_invalid_email,</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>Api::MiscellaneousHelper</td>
      <td>generate_patient_report</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context108');toggle('message108');toggle('full_message108')" ><span id='message108' style='display:block'>Possible SQL injection near line 183: ...</span><span id='full_message108' style='display:none'>Possible SQL injection near line 183: <span class="code">General.find_by_sql([&quot;WITH invalid_patients AS (\n  SELECT\n    #{&quot;DISTINCT ON (p.id) p.id, p.client_id, p.f_name, p.l_name, p.source_id,\np.phone_text, p.phones, p.email,\np.hcp_f_name, p.hcp_l_name, p.street1,\np.street2, p.city, p.state, p.zip4,\np.country, o.id AS office_id,\no.name AS office_name,\no.sms_phone AS office_phone,\np.created_at, p.birthdate, p.gender\n&quot;} #{if (report_type == &quot;patient_detailed&quot;) and (not get_pages) then   &quot;, mod.processed_at as last_touch&quot; end}\n  FROM\n    mv_patients p\n  LEFT JOIN message_opt_outs moo_email ON moo_email.client_id = :cid AND moo_email.from = p.email\n  LEFT JOIN message_opt_outs moo_phone ON moo_phone.client_id = :cid AND moo_phone.from = p.phone_text\n  LEFT JOIN (\n\t\t\t\t\tSELECT DISTINCT ON (child.id)\n\t\t\t\t\t\tchild.id as patient_id,\n\t\t\t\t\t\tparent.f_name as parent_f_name,\n\t\t\t\t\t\tparent.l_name as parent_l_name\n\t\t\t\t\tFROM patients parent\n\t\t\t\t\tJOIN patients_phones parent_phones ON parent.id = parent_phones.patient_id\n\t\t\t\t\tJOIN patients_phones child_phones ON parent_phones.phone = child_phones.phone AND parent.id != child_phones.patient_id\n\t\t\t\t\tJOIN patients child ON child_phones.patient_id = child.id AND child.client_id = parent.client_id\n\t\t\t\t\tWHERE parent.patient_type = &#39;Relation&#39;\n\t\t\t\t\t\tAND parent.rel_priority IN (1, 2, 3)\n\t\t\t\t\tORDER BY child.id, parent.rel_priority  -- Prefer mother (1) over father (2)\n\t\t\t\t) pr ON pr.patient_id = p.id\n  LEFT JOIN offices o ON o.id = p.office_id\n  #{&quot;LEFT JOIN message_out_details mod ON mod.client_id = :cid AND mod.to = p.phone_text AND touch_step_id IS NOT NULL AND processed_at &gt;= CURRENT_DATE - INTERVAL &#39;1 year&#39;\n    LEFT JOIN appointments appt ON appt.patient_id = p.id AND appt_at &gt;= CURRENT_DATE - INTERVAL &#39;1 year&#39;\n    LEFT JOIN geographics geo ON geo.individual_id = p.individual_id&quot;}\n  WHERE p.client_id = :cid AND #{(((((((((((((&quot;p.phone_text IS NULL OR p.phone_text !~ &#39;^[0-9]{10}$&#39;&quot; or &quot;p.email IS NULL OR p.email NOT LIKE &#39;%@%.%&#39;&quot;) or &quot;(p.f_name IS NULL OR TRIM(p.f_name) = &#39;&#39; OR p.l_name IS NULL OR TRIM(p.l_name) = &#39;&#39;)&quot;) or &quot;pr.patient_id IS NULL&quot;) or &quot;p.gender = &#39;M&#39;&quot;) or &quot;p.gender = &#39;F&#39;&quot;) or &quot;p.gender IS NULL OR p.gender = &#39;U&#39; OR p.gender = &#39;O&#39;&quot;) or &quot;p.street1 IS NULL OR TRIM(p.street1) = &#39;&#39;\n                                                          OR p.city IS NULL OR TRIM(p.city) = &#39;&#39;\n                                                          OR p.state IS NULL OR TRIM(p.state) = &#39;&#39;\n                                                          OR (p.zip IS NULL OR TRIM(p.zip) !~ &#39;^\\d{5}(?:-\\d{4})?$&#39;)&quot;) or &quot;(moo_email.id IS NULL AND moo_phone.id IS NULL)&quot;) or &quot;mod.id IS NOT NULL&quot;) or &quot;appt.id IS NOT NULL&quot;) or &quot;(\n                                                          o.lat IS NOT NULL AND o.lon IS NOT NULL AND\n                                                          geo.lat IS NOT NULL AND geo.lon IS NOT NULL AND\n                                                          NOT ST_DWithin(\n                                                            ST_SetSRID(ST_MakePoint(o.lon, o.lat), 4326)::geography,\n                                                            ST_SetSRID(ST_MakePoint(geo.lon, geo.lat), 4326)::geography,\n                                                            160934\n                                                          )\n                                                        )&quot;) or &quot;p.hipaa_consent_id IS NULL&quot;) or &quot;1=1&quot;)}\n  ORDER BY p.id\n)\nSELECT\n  #{if get_pages then   &quot;COUNT(DISTINCT p.id)&quot; else   &quot;DISTINCT ON (p.id) p.id, p.client_id, p.f_name, p.l_name, p.source_id,\np.phone_text, p.phones, p.email,\np.hcp_f_name, p.hcp_l_name, p.street1,\np.street2, p.city, p.state, p.zip4,\np.country, o.id AS office_id,\no.name AS office_name,\no.sms_phone AS office_phone,\np.created_at, p.birthdate, p.gender\n&quot; end} #{if (report_type == &quot;patient_detailed&quot;) and (not get_pages) then   &quot;, p.last_touch as last_touch&quot; end}\nFROM\n  invalid_patients p\n#{(&quot;LEFT JOIN offices o ON o.id = p.office_id&quot; or &quot;INNER JOIN appointments appt ON p.id = appt.patient_id\n                    INNER JOIN offices o ON o.id = appt.office_id&quot;)}\n--INNER JOIN clients c ON c.id = o.client_id\nWHERE p.client_id = :cid #{<span class="user_input">date_filter</span>} #{office_filter} #{provider_filter} #{&quot;AND appt.name = :name AND appt.category = :category&quot;} #{minor_filter}\n#{unless ((report_type == &quot;patient_detailed&quot;) or get_pages) then   &quot;ORDER BY p.id, appt.name DESC&quot; end}\n#{&quot;LIMIT 50 OFFSET :offset&quot; unless get_pages}\n&quot;, { :cid =&gt; client.id, :category =&gt; params[:category], :name =&gt; params[:name], :offset =&gt; ((params[:page].to_i - 1) * 50) }])</span></span><table id='context108' class='context' style='display:none'><caption>app/helpers/api/miscellaneous_helper.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>178</pre>
          </td>
          <td class='context'>
            <pre class='context'>        #{ get_pages ? &quot;COUNT(DISTINCT p.id)&quot; : select_fields } #{&#39;, p.last_touch as last_touch&#39; if report_type == &#39;patient_detailed&#39; and !get_pages}</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>179</pre>
            </td>
            <td class='context'>
              <pre class='context'>      FROM</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>180</pre>
            </td>
            <td class='context'>
              <pre class='context'>        invalid_patients p</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>181</pre>
            </td>
            <td class='context'>
              <pre class='context'>      #{offices_join}</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>182</pre>
            </td>
            <td class='context'>
              <pre class='context'>      --INNER JOIN clients c ON c.id = o.client_id</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>183</pre>
            </td>
            <td class='context'>
              <pre class='context'>      WHERE p.client_id = :cid #{date_filter} #{office_filter} #{provider_filter} #{appt_clause} #{minor_filter}</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>184</pre>
            </td>
            <td class='context'>
              <pre class='context'>      #{&#39;ORDER BY p.id, appt.name DESC&#39; unless report_type == &#39;patient_detailed&#39; or get_pages}</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>185</pre>
            </td>
            <td class='context'>
              <pre class='context'>      #{&quot;LIMIT 50 OFFSET :offset&quot; unless get_pages}</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>186</pre>
            </td>
            <td class='context'>
              <pre class='context'>    SQL</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>188</pre>
            </td>
            <td class='context'>
              <pre class='context'>    return get_pages ? (results.first.count.to_f / NUMBER_OF_RECORDS).ceil : results</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>Api::OfficeController</td>
      <td>map_features</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context97');toggle('message97');toggle('full_message97')" ><span id='message97' style='display:block'>Possible SQL injection near line 230: ...</span><span id='full_message97' style='display:none'>Possible SQL injection near line 230: <span class="code">ZipBoundary.find_by_sql(&quot;select zip, lat, lon, ST_AsGeoJSON(ST_Simplify(geom, 0.001)) geom \nfrom zip_boundaries \nwhere zip in (#{<span class="user_input">o.office_crs.map do  &quot;&#39;#{z.zip.to_s.rjust(5, &quot;0&quot;)}&#39;&quot;  end.join(&quot;,&quot;)</span>});\n&quot;)</span></span><table id='context97' class='context' style='display:none'><caption>app/controllers/api/office_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>225</pre>
          </td>
          <td class='context'>
            <pre class='context'>					az &lt;&lt; zm</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>226</pre>
            </td>
            <td class='context'>
              <pre class='context'>					zr = Hash[oc.pluck(:zip, :priority)]</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>227</pre>
            </td>
            <td class='context'>
              <pre class='context'>					bd = ZipBoundary.find_by_sql(&lt;&lt;~SQL)</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>228</pre>
            </td>
            <td class='context'>
              <pre class='context'>						select zip, lat, lon, ST_AsGeoJSON(ST_Simplify(geom, 0.001)) geom </pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>229</pre>
            </td>
            <td class='context'>
              <pre class='context'>						from zip_boundaries </pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>230</pre>
            </td>
            <td class='context'>
              <pre class='context'>						where zip in (#{zm});</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>231</pre>
            </td>
            <td class='context'>
              <pre class='context'>						SQL</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>232</pre>
            </td>
            <td class='context'>
              <pre class='context'>					bd.each { |z| mf[:zips][:features] &lt;&lt; {type: &quot;Feature&quot;, properties: {type: &quot;zip&quot;, zip: z.zip, o_clr: o.color, f_clr: (zr[z.zip.to_i] == 9 ? 6 : o.color), lat: z.lat.round(4), lon: z.lon.round(4), o_id: o.id }, geometry: eval(small_geom(z.geom))} if z.geom }</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>233</pre>
            </td>
            <td class='context'>
              <pre class='context'>				end</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>234</pre>
            </td>
            <td class='context'>
              <pre class='context'>				unless overload</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>235</pre>
            </td>
            <td class='context'>
              <pre class='context'>					cm = oc.map { |z| z.cr.blank? ? nil : &quot;&#39;#{z.cr}&#39;&quot; }.compact.join &#39;,&#39;</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>Api::OfficeController</td>
      <td>map_features</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context98');toggle('message98');toggle('full_message98')" ><span id='message98' style='display:block'>Possible SQL injection near line 241: ...</span><span id='full_message98' style='display:none'>Possible SQL injection near line 241: <span class="code">CrBoundary.find_by_sql(&quot;select zipcrid, lat, lon, ST_AsGeoJSON(ST_Simplify(geom, 0.0004)) geom \nfrom cr_boundaries \nwhere zipcrid in (#{<span class="user_input">o.office_crs.map do  z.cr.blank? ? (nil) : (&quot;&#39;#{z.cr}&#39;&quot;)  end.compact.join(&quot;,&quot;)</span>});\n&quot;)</span></span><table id='context98' class='context' style='display:none'><caption>app/controllers/api/office_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>236</pre>
          </td>
          <td class='context'>
            <pre class='context'>					unless cm.blank?</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>237</pre>
            </td>
            <td class='context'>
              <pre class='context'>						pr = Hash[oc.pluck(:cr, :priority)]</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>238</pre>
            </td>
            <td class='context'>
              <pre class='context'>						bd = CrBoundary.find_by_sql(&lt;&lt;~SQL)</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>239</pre>
            </td>
            <td class='context'>
              <pre class='context'>							select zipcrid, lat, lon, ST_AsGeoJSON(ST_Simplify(geom, 0.0004)) geom </pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>240</pre>
            </td>
            <td class='context'>
              <pre class='context'>							from cr_boundaries </pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>241</pre>
            </td>
            <td class='context'>
              <pre class='context'>							where zipcrid in (#{cm});</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>242</pre>
            </td>
            <td class='context'>
              <pre class='context'>							SQL</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>243</pre>
            </td>
            <td class='context'>
              <pre class='context'>						bd.each { |cr| mf[:crs][:features] &lt;&lt; {type: &quot;Feature&quot;, properties: {type: &quot;cr&quot;, cr: cr.zipcrid, o_clr: o.color, f_clr: (pr[cr.zipcrid] == 9 ? 6 : o.color), lat: cr.lat.round(4), lon: cr.lon.round(4), o_id: o.id }, geometry: eval(small_geom(cr.geom))} if cr.geom }</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>244</pre>
            </td>
            <td class='context'>
              <pre class='context'>					end</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>245</pre>
            </td>
            <td class='context'>
              <pre class='context'>				end</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>246</pre>
            </td>
            <td class='context'>
              <pre class='context'>			end</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>Api::OfficeController</td>
      <td>map_features</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context99');toggle('message99');toggle('full_message99')" ><span id='message99' style='display:block'>Possible SQL injection near line 260: ...</span><span id='full_message99' style='display:none'>Possible SQL injection near line 260: <span class="code">ZipBoundary.find_by_sql(&quot;select * from (\n\tselect distinct on (zb.zip) zb.zip, zb.lat, zb.lon, ST_AsGeoJSON(ST_Simplify(zb.geom, 0.001)) geom, o.id as office_id, o.color, ow.name as owner, ST_Distance(ST_SetSRID(ST_Point(o.lon, o.lat),4326)::geography, ST_SetSRID(ST_Point(zb.lon, zb.lat),4326)::geography) as dist \n\tfrom offices o \n\tjoin zip_boundaries zb on ST_DWithin(ST_SetSRID(ST_Point(o.lon, o.lat),4326)::geography, ST_SetSRID(ST_Point(zb.lon, zb.lat),4326)::geography, 80467) \n\tleft join (\n\t\tselect lpad(oc.zip::varchar,5,&#39;0&#39;) as zip, oo.name \n\t\tfrom office_crs oc \n\t\tjoin offices oo on oo.id = oc.office_id \n\t\twhere oo.client_id = #{@authorized_user.authorized_client(params[:client_id], [&quot;Administrator&quot;, &quot;User&quot;]).id} and oo.active = &#39;t&#39;\n\t) ow on ow.zip = zb.zip \n\twhere zb.zip not in (#{<span class="user_input">if (([o.office_crs.map do  &quot;&#39;#{z.zip.to_s.rjust(5, &quot;0&quot;)}&#39;&quot;  end.join(&quot;,&quot;)].length == 0)) then   &quot;&#39;&#39;&quot; else   &quot;#{o.office_crs.map do    &quot;&#39;#{z.zip.to_s.rjust(5, &quot;0&quot;)}&#39;&quot;    end.join(&quot;,&quot;)}&quot; end</span>}) and o.id in (#{Office.where(:client_id =&gt; @authorized_user.authorized_client(params[:client_id], [&quot;Administrator&quot;, &quot;User&quot;]).id).where(&quot;id in (#{Sanitize.id_list(params[:offices])})&quot;).map(&amp;:id).join(&quot;,&quot;)}) \n\torder by zb.zip, dist) sq \nwhere geom is not null \norder by dist \nlimit #{(Office.where(:client_id =&gt; @authorized_user.authorized_client(params[:client_id], [&quot;Administrator&quot;, &quot;User&quot;]).id).where(&quot;id in (#{Sanitize.id_list(params[:offices])})&quot;).length * 50)};\n&quot;)</span></span><table id='context99' class='context' style='display:none'><caption>app/controllers/api/office_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>255</pre>
          </td>
          <td class='context'>
            <pre class='context'>							select lpad(oc.zip::varchar,5,&#39;0&#39;) as zip, oo.name </pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>256</pre>
            </td>
            <td class='context'>
              <pre class='context'>							from office_crs oc </pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>257</pre>
            </td>
            <td class='context'>
              <pre class='context'>							join offices oo on oo.id = oc.office_id </pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>258</pre>
            </td>
            <td class='context'>
              <pre class='context'>							where oo.client_id = #{client.id} and oo.active = &#39;t&#39;</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>259</pre>
            </td>
            <td class='context'>
              <pre class='context'>						) ow on ow.zip = zb.zip </pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>260</pre>
            </td>
            <td class='context'>
              <pre class='context'>						where zb.zip not in (#{az.length == 0 ? &quot;&#39;&#39;&quot; : az.join(&#39;,&#39;)}) and o.id in (#{fc.map(&amp;:id).join(&#39;,&#39;)}) </pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>261</pre>
            </td>
            <td class='context'>
              <pre class='context'>						order by zb.zip, dist) sq </pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>262</pre>
            </td>
            <td class='context'>
              <pre class='context'>					where geom is not null </pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>263</pre>
            </td>
            <td class='context'>
              <pre class='context'>					order by dist </pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>264</pre>
            </td>
            <td class='context'>
              <pre class='context'>					limit #{fc.length * 50};</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>265</pre>
            </td>
            <td class='context'>
              <pre class='context'>					SQL</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>Api::OfficeController</td>
      <td>process_zcr</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context101');toggle('message101');toggle('full_message101')" >Possible SQL injection near line 517: <span class="code">ZipBoundary.find_by_sql(&quot;select zb.zip \nfrom zip_boundaries zb \nleft join (\n\tselect oc.zip \n\tfrom office_crs oc \n\tjoin offices o on o.id = oc.office_id \n\twhere o.client_id = #{<span class="user_input">cid</span>}\n) oo on oo.zip::varchar = zb.zip \nwhere ST_DWithin(ST_SetSRID(ST_Point(#{fc.lon}, #{fc.lat}),4326)::geography, ST_SetSRID(ST_Point(zb.lon, zb.lat),4326)::geography, 16093) and oo.zip is null;\n&quot;)</span><table id='context101' class='context' style='display:none'><caption>app/controllers/api/office_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>512</pre>
          </td>
          <td class='context'>
            <pre class='context'>					from zip_boundaries zb </pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>513</pre>
            </td>
            <td class='context'>
              <pre class='context'>					left join (</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>514</pre>
            </td>
            <td class='context'>
              <pre class='context'>						select oc.zip </pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>515</pre>
            </td>
            <td class='context'>
              <pre class='context'>						from office_crs oc </pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>516</pre>
            </td>
            <td class='context'>
              <pre class='context'>						join offices o on o.id = oc.office_id </pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>517</pre>
            </td>
            <td class='context'>
              <pre class='context'>						where o.client_id = #{cid}</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>518</pre>
            </td>
            <td class='context'>
              <pre class='context'>					) oo on oo.zip::varchar = zb.zip </pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>519</pre>
            </td>
            <td class='context'>
              <pre class='context'>					where ST_DWithin(ST_SetSRID(ST_Point(#{fc.lon}, #{fc.lat}),4326)::geography, ST_SetSRID(ST_Point(zb.lon, zb.lat),4326)::geography, 16093) and oo.zip is null;</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>520</pre>
            </td>
            <td class='context'>
              <pre class='context'>					SQL</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>521</pre>
            </td>
            <td class='context'>
              <pre class='context'>				pz = rs.map(&amp;:zip)</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>522</pre>
            </td>
            <td class='context'>
              <pre class='context'>			end</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>Api::OfficeController</td>
      <td>process_zcr</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context102');toggle('message102');toggle('full_message102')" ><span id='message102' style='display:block'>Possible SQL injection near line 532: ...</span><span id='full_message102' style='display:none'>Possible SQL injection near line 532: <span class="code">General.find_by_sql(&quot;select zipcrid as cr \nfrom cr_centroids \nwhere totrescnt &gt;= 2 #{if ((Preference.find_by(:client_id =&gt; cid, :key =&gt; :uses_po_boxes).value rescue nil) == &quot;true&quot;) then   &quot;&quot; else   &quot;and cr not like &#39;B%&#39;&quot; end} and zip in (&#39;#{&quot;#{<span class="user_input">z</span>}&quot;}&#39;) \norder by zipcrid;\n&quot;)</span></span><table id='context102' class='context' style='display:none'><caption>app/controllers/api/office_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>527</pre>
          </td>
          <td class='context'>
            <pre class='context'>			pz.each { |z| z.length == 5 ? zs &lt;&lt; z : cs &lt;&lt; z }</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>528</pre>
            </td>
            <td class='context'>
              <pre class='context'>			if zs.length &gt; 0</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>529</pre>
            </td>
            <td class='context'>
              <pre class='context'>				crs = General.find_by_sql(&lt;&lt;~SQL)</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>530</pre>
            </td>
            <td class='context'>
              <pre class='context'>					select zipcrid as cr </pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>531</pre>
            </td>
            <td class='context'>
              <pre class='context'>					from cr_centroids </pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>532</pre>
            </td>
            <td class='context'>
              <pre class='context'>					where totrescnt &gt;= 2 #{po ? &quot;&quot; : &quot;and cr not like &#39;B%&#39;&quot;} and zip in (&#39;#{zs.join(&quot;&#39;,&#39;&quot;)}&#39;) </pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>533</pre>
            </td>
            <td class='context'>
              <pre class='context'>					order by zipcrid;</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>534</pre>
            </td>
            <td class='context'>
              <pre class='context'>					SQL</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>535</pre>
            </td>
            <td class='context'>
              <pre class='context'>				pz = cs + crs.map(&amp;:cr)</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>536</pre>
            </td>
            <td class='context'>
              <pre class='context'>			end</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>537</pre>
            </td>
            <td class='context'>
              <pre class='context'>		end</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>Api::TextController</td>
      <td>index</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context105');toggle('message105');toggle('full_message105')" ><span id='message105' style='display:block'>Possible SQL injection near line 38: ...</span><span id='full_message105' style='display:none'>Possible SQL injection near line 38: <span class="code">General.find_by_sql([&quot;with mie as (\n\tselect *\n\tfrom message_in_extracts\n\twhere client_id = :cid\n\t#{if Office.where(:client_id =&gt; @authorized_user.authorized_client(params[:client_id], [&quot;Administrator&quot;, &quot;User&quot;, &quot;Engagement&quot;]).id, :active =&gt; true, :sms_enabled =&gt; true).where((&quot;id in (#{get_data_filters(@authorized_user, @authorized_user.authorized_client(params[:client_id], [&quot;Administrator&quot;, &quot;User&quot;, &quot;Engagement&quot;]).id)})&quot; or &quot;&quot;)).select(:id, :name, :sms_enabled, :sms_phone, :sms_phone2, :sms_phone3, :street1, :street2, :city, :state).order(&quot;name&quot;).map(&amp;&quot;sms_phone#{(@authorized_user.reload.active_text_filter or &quot;&quot;)}&quot;.to_sym).compact_blank.join(&quot;,&quot;).chomp(&quot;,&quot;) and (not Office.where(:client_id =&gt; @authorized_user.authorized_client(params[:client_id], [&quot;Administrator&quot;, &quot;User&quot;, &quot;Engagement&quot;]).id, :active =&gt; true, :sms_enabled =&gt; true).where((&quot;id in (#{get_data_filters(@authorized_user, @authorized_user.authorized_client(params[:client_id], [&quot;Administrator&quot;, &quot;User&quot;, &quot;Engagement&quot;]).id)})&quot; or &quot;&quot;)).select(:id, :name, :sms_enabled, :sms_phone, :sms_phone2, :sms_phone3, :street1, :street2, :city, :state).order(&quot;name&quot;).map(&amp;&quot;sms_phone#{(@authorized_user.reload.active_text_filter or &quot;&quot;)}&quot;.to_sym).compact_blank.join(&quot;,&quot;).chomp(&quot;,&quot;).empty?) then   &quot;and \&quot;to\&quot; in (#{Office.where(:client_id =&gt; @authorized_user.authorized_client(params[:client_id], [&quot;Administrator&quot;, &quot;User&quot;, &quot;Engagement&quot;]).id, :active =&gt; true, :sms_enabled =&gt; true).where((&quot;id in (#{get_data_filters(@authorized_user, @authorized_user.authorized_client(params[:client_id], [&quot;Administrator&quot;, &quot;User&quot;, &quot;Engagement&quot;]).id)})&quot; or &quot;&quot;)).select(:id, :name, :sms_enabled, :sms_phone, :sms_phone2, :sms_phone3, :street1, :street2, :city, :state).order(&quot;name&quot;).map(&amp;&quot;sms_phone#{(@authorized_user.reload.active_text_filter or &quot;&quot;)}&quot;.to_sym).compact_blank.join(&quot;,&quot;).chomp(&quot;,&quot;)})&quot; end}\n\tand (updated_at &gt; &#39;#{((<span class="user_input">@authorized_user.reload.message_refresh</span> or Time.current) or (Time.current - 15.days))}&#39; or received_at &gt; &#39;#{((<span class="user_input">@authorized_user.reload.message_refresh</span> or Time.current) or (Time.current - 15.days))}&#39; or viewed_at &gt; &#39;#{((<span class="user_input">@authorized_user.reload.message_refresh</span> or Time.current) or (Time.current - 15.days))}&#39; or inactive_at &gt; &#39;#{((<span class="user_input">@authorized_user.reload.message_refresh</span> or Time.current) or (Time.current - 15.days))}&#39;)\n)\nselect * from (\n\tselect distinct on (mi.from) mi.from::text as pat_phone, o.id as office_id, o.name as office, o.sms_phone, mi.id, received_at, viewed_at, inactive_at, sf.phone, sf.pid, sf.title, sf.f_name, sf.m_name, sf.l_name, sf.suffix, sf.hcp_f_name, sf.hcp_l_name, sf.consent, sf.hipaa_consented_at, sf.nudge_name, mi.message\n\tfrom mie mi\n\tleft join message_opt_outs moo on moo.message_in_extract_id = mi.id\n\tleft join (\n\t\tselect distinct on (np.phone) np.phone, seq, pid, title, f_name, m_name, l_name, suffix, hcp_f_name, hcp_l_name, hipaa_consent_id is not null as consent, hipaa_consented_at, office_id, nudge_name\n\t\tfrom (\n\t\t\t(select distinct on (mi1.from) mi1.from as phone, p.id as pid, p.title, p.f_name, p.m_name, p.l_name, p.suffix, viewed_at, coalesce(a.hcp_f_name, p.hcp_f_name) as hcp_f_name, coalesce(a.hcp_l_name, p.hcp_l_name) as hcp_l_name, p.hipaa_consent_id, mv_p.hipaa_consented_at, coalesce(pt.office_id, po.office_id, a.office_id, mi1.office_id) as office_id, nudge_name, 0 as seq\n\t\t\tfrom mie mi1\n\t\t\tjoin mv_patient_phone_name p on mi1.client_id = p.client_id and mi1.from = p.phone\n\t\t\tjoin mv_patients mv_p on mi1.client_id = mv_p.client_id and p.id = mv_p.id\n\t\t\tleft join (select *, 1 as included from provider_offices) po on lower(po.f_name) = lower(p.hcp_f_name) and lower(po.l_name) = lower(p.hcp_l_name)\n\t\t\tleft join appointments a on p.id = a.patient_id and a.office_id = mv_p.office_id\n\t\t\tleft join (select *, 1 as included from provider_offices where f_name = &#39;*&#39; and l_name = &#39;*&#39;) pt on mi1.office_id = pt.office_id\n\t\t\t#{(params[:refresh] == &quot;true&quot;) ? (&quot;&quot;) : (&quot;where mi1.inactive_at is null&quot;)}\n\t\t\torder by mi1.from, p.mout_id nulls last, pt.included nulls last, po.included nulls last, p.rel_priority_adj nulls last, appt_at desc nulls last, p.birthdate nulls last, p.updated_at desc, p.hcp_l_name nulls last)\n\t\t) np order by phone, seq\n\t) sf on sf.phone = mi.from\n\tleft join (select distinct on (message_in_extract_id) message_in_extract_id, office_id, 1 as included from message_forwards order by message_in_extract_id, created_at desc) mf on mi.id = mf.message_in_extract_id\n\tjoin (select * from offices where sms_enabled = &#39;t&#39;) o on o.id = coalesce(sf.office_id, mi.office_id, mf.office_id)\n\twhere mi.client_id = :cid\n\t  and moo.id is null\n\t  #{(params[:refresh] == &quot;true&quot;) ? (&quot;&quot;) : (&quot;and inactive_at is null&quot;)}\n\torder by mi.from, received_at desc\n) sq\n#{unless Office.where(:client_id =&gt; @authorized_user.authorized_client(params[:client_id], [&quot;Administrator&quot;, &quot;User&quot;, &quot;Engagement&quot;]).id, :active =&gt; true, :sms_enabled =&gt; true).where((&quot;id in (#{get_data_filters(@authorized_user, @authorized_user.authorized_client(params[:client_id], [&quot;Administrator&quot;, &quot;User&quot;, &quot;Engagement&quot;]).id)})&quot; or &quot;&quot;)).select(:id, :name, :sms_enabled, :sms_phone, :sms_phone2, :sms_phone3, :street1, :street2, :city, :state).order(&quot;name&quot;).map(&amp;:id).join(&quot;,&quot;).empty? then   &quot;where office_id in (#{Office.where(:client_id =&gt; @authorized_user.authorized_client(params[:client_id], [&quot;Administrator&quot;, &quot;User&quot;, &quot;Engagement&quot;]).id, :active =&gt; true, :sms_enabled =&gt; true).where((&quot;id in (#{get_data_filters(@authorized_user, @authorized_user.authorized_client(params[:client_id], [&quot;Administrator&quot;, &quot;User&quot;, &quot;Engagement&quot;]).id)})&quot; or &quot;&quot;)).select(:id, :name, :sms_enabled, :sms_phone, :sms_phone2, :sms_phone3, :street1, :street2, :city, :state).order(&quot;name&quot;).map(&amp;:id).join(&quot;,&quot;)})&quot; end}\norder by received_at desc;\n&quot;, { :cid =&gt; @authorized_user.authorized_client(params[:client_id], [&quot;Administrator&quot;, &quot;User&quot;, &quot;Engagement&quot;]).id }])</span></span><table id='context105' class='context' style='display:none'><caption>app/controllers/api/text_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>33</pre>
          </td>
          <td class='context'>
            <pre class='context'>				with mie as (</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>34</pre>
            </td>
            <td class='context'>
              <pre class='context'>					select *</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>35</pre>
            </td>
            <td class='context'>
              <pre class='context'>					from message_in_extracts</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>36</pre>
            </td>
            <td class='context'>
              <pre class='context'>					where client_id = :cid</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>37</pre>
            </td>
            <td class='context'>
              <pre class='context'>					#{&quot;and \&quot;to\&quot; in (#{filter_phones})&quot; if filter_phones &amp;&amp; !filter_phones.empty?}</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>38</pre>
            </td>
            <td class='context'>
              <pre class='context'>					and (updated_at &gt; &#39;#{aumr}&#39; or received_at &gt; &#39;#{aumr}&#39; or viewed_at &gt; &#39;#{aumr}&#39; or inactive_at &gt; &#39;#{aumr}&#39;)</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>39</pre>
            </td>
            <td class='context'>
              <pre class='context'>				)</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>40</pre>
            </td>
            <td class='context'>
              <pre class='context'>				select * from (</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>41</pre>
            </td>
            <td class='context'>
              <pre class='context'>					select distinct on (mi.from) mi.from::text as pat_phone, o.id as office_id, o.name as office, o.sms_phone, mi.id, received_at, viewed_at, inactive_at, sf.phone, sf.pid, sf.title, sf.f_name, sf.m_name, sf.l_name, sf.suffix, sf.hcp_f_name, sf.hcp_l_name, sf.consent, sf.hipaa_consented_at, sf.nudge_name, mi.message</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>42</pre>
            </td>
            <td class='context'>
              <pre class='context'>					from mie mi</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>43</pre>
            </td>
            <td class='context'>
              <pre class='context'>					left join message_opt_outs moo on moo.message_in_extract_id = mi.id</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>Api::TextController</td>
      <td>conversation</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context106');toggle('message106');toggle('full_message106')" ><span id='message106' style='display:block'>Possible SQL injection near line 370: ...</span><span id='full_message106' style='display:none'>Possible SQL injection near line 370: <span class="code">General.find_by_sql([&quot;select * from (\n\tselect message, mo.id, coalesce(mo.processed_at, mo.created_at) as created_at, mo.processed_at as viewed_at, p.name as sent_by, 0 as incoming, mo.send_at_local as send_at, mm.media_urls, mm.media_types\n\tfrom message_out_details mo\n\tleft join people p on p.id = mo.person_id\n\tleft join (select message_id, array_agg(case when media_url like &#39;https://relevant-attachments-private%&#39; then &#39;#{<span class="user_input">ActionController::Base.helpers.image_url(&quot;file_pending.png&quot;)</span>}&#39; else media_url end) as media_urls, array_agg(case when media_url like &#39;https://relevant-attachments-private%&#39; then &#39;image/png&#39; else media_type end) as media_types\n\t\tfrom message_mms_media\n\t\twhere message_type = &#39;MessageOutDetail&#39;\n\t\tgroup by message_id\n\t) mm on mo.id = mm.message_id\n\twhere client_id = :cid\n\tand mo.to = :tp\n\t#{if (@authorized_user.authorized_client(params[:client_id], [&quot;Administrator&quot;, &quot;User&quot;, &quot;Engagement&quot;]).id != 1) and (Sanitize.phone(params[:phone_from]) and (Sanitize.phone(params[:phone_from]).length &gt; 0)) then   &quot;and mo.from = :fp&quot; end}\n\tand message_type = &#39;Text&#39;\nunion all\n\tselect message, mi.id, received_at as created_at, viewed_at, null as sent_by, 1 as incoming, null as send_at, mm.media_urls, mm.media_types\n\tfrom message_in_extracts mi\n\tleft join (select message_id, array_agg(media_url) as media_urls, array_agg(media_type) as media_types\n\t\tfrom message_mms_media\n\t\twhere message_type = &#39;MessageInExtract&#39;\n\t\tgroup by message_id\n\t) mm on mi.id = mm.message_id\n\twhere client_id = :cid\n\tand mi.from = :tp\n\t#{if (@authorized_user.authorized_client(params[:client_id], [&quot;Administrator&quot;, &quot;User&quot;, &quot;Engagement&quot;]).id != 1) and (Sanitize.phone(params[:phone_from]) and (Sanitize.phone(params[:phone_from]).length &gt; 0)) then   &quot;and mi.to = :fp&quot; end}\n) mn\nwhere created_at &gt; now() - interval &#39;13 months&#39;\norder by created_at, send_at asc;\n&quot;, { :cid =&gt; @authorized_user.authorized_client(params[:client_id], [&quot;Administrator&quot;, &quot;User&quot;, &quot;Engagement&quot;]).id, :tp =&gt; Sanitize.phone(params[:phone_to]), :fp =&gt; Sanitize.phone(params[:phone_from]) }])</span></span><table id='context106' class='context' style='display:none'><caption>app/controllers/api/text_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>365</pre>
          </td>
          <td class='context'>
            <pre class='context'>			rs = General.find_by_sql [&lt;&lt;~SQL, {cid: client.id, tp: tp, fp: fp}]</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>366</pre>
            </td>
            <td class='context'>
              <pre class='context'>				select * from (</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>367</pre>
            </td>
            <td class='context'>
              <pre class='context'>					select message, mo.id, coalesce(mo.processed_at, mo.created_at) as created_at, mo.processed_at as viewed_at, p.name as sent_by, 0 as incoming, mo.send_at_local as send_at, mm.media_urls, mm.media_types</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>368</pre>
            </td>
            <td class='context'>
              <pre class='context'>					from message_out_details mo</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>369</pre>
            </td>
            <td class='context'>
              <pre class='context'>					left join people p on p.id = mo.person_id</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>370</pre>
            </td>
            <td class='context'>
              <pre class='context'>					left join (select message_id, array_agg(case when media_url like &#39;https://relevant-attachments-private%&#39; then &#39;#{pending_file_url}&#39; else media_url end) as media_urls, array_agg(case when media_url like &#39;https://relevant-attachments-private%&#39; then &#39;image/png&#39; else media_type end) as media_types</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>371</pre>
            </td>
            <td class='context'>
              <pre class='context'>						from message_mms_media</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>372</pre>
            </td>
            <td class='context'>
              <pre class='context'>						where message_type = &#39;MessageOutDetail&#39;</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>373</pre>
            </td>
            <td class='context'>
              <pre class='context'>						group by message_id</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>374</pre>
            </td>
            <td class='context'>
              <pre class='context'>					) mm on mo.id = mm.message_id</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>375</pre>
            </td>
            <td class='context'>
              <pre class='context'>					where client_id = :cid</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>Campaigns::GetCanceledApptCampaigns</td>
      <td>query</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context109');toggle('message109');toggle('full_message109')" >Possible SQL injection near line 86: <span class="code">General.find_by_sql([&quot;SELECT \n    mv.client_id,\n    mv.patient_id,\n    p.source_id,\n    mv.individual_id,\n    mv.f_name,\n    mv.l_name,\n    mv.phones,\n    mv.office_id,\n    mv.office_name,\n    mv.sms_phone AS office_phone,\n    mv.appt_name,\n    mv.hcp_f_name,\n    mv.hcp_l_name,\n    mv.last_appt_at,\n    lc.message_type AS last_com_type,\n    lc.last_at AS last_com_at,\n    na.next_appt\nFROM mv_canceled_appt mv\nJOIN (\n    SELECT id, source_id FROM patients\n) p ON p.id = mv.patient_id\nLEFT JOIN LATERAL (\n    SELECT appt_at AS next_appt\n    FROM appointments\n    WHERE \n        patient_id = mv.patient_id\n        AND appt_at::date &gt; now()::date\n        AND category IN (&#39;Confirmed&#39;, &#39;Not Confirmed&#39;)\n    ORDER BY appt_at ASC\n    LIMIT 1\n) na ON TRUE\nLEFT JOIN LATERAL (\n    SELECT message_type, last_at\n    FROM (\n        SELECT \n            message_type, \n            processed_at AS last_at\n        FROM message_out_details \n        WHERE individual_id = mv.individual_id AND individual_id IS NOT NULL\n        UNION ALL\n        SELECT \n            &#39;Call&#39;::text AS message_type, \n            created_at AS last_at\n        FROM callcenter_logs \n        WHERE individual_id = mv.individual_id AND status NOT IN (&#39;Invalid&#39;)\n    ) sq\n    ORDER BY last_at DESC\n    LIMIT 1\n) lc ON TRUE\nWHERE mv.client_id = :cid\n#{<span class="user_input">df_query</span>}\n#{applied_filters}\nORDER BY \n    mv.office_name,\n    mv.hcp_f_name,\n    mv.hcp_l_name,\n    mv.f_name,\n    mv.l_name\n#{pagination}\n&quot;, { :cid =&gt; client_id }])</span><table id='context109' class='context' style='display:none'><caption>app/queries/campaigns/get_canceled_appt_campaigns.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>81</pre>
          </td>
          <td class='context'>
            <pre class='context'>            ) sq</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>82</pre>
            </td>
            <td class='context'>
              <pre class='context'>            ORDER BY last_at DESC</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>83</pre>
            </td>
            <td class='context'>
              <pre class='context'>            LIMIT 1</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>84</pre>
            </td>
            <td class='context'>
              <pre class='context'>        ) lc ON TRUE</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>85</pre>
            </td>
            <td class='context'>
              <pre class='context'>        WHERE mv.client_id = :cid</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>86</pre>
            </td>
            <td class='context'>
              <pre class='context'>        #{df_query}</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>87</pre>
            </td>
            <td class='context'>
              <pre class='context'>        #{applied_filters}</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>88</pre>
            </td>
            <td class='context'>
              <pre class='context'>        ORDER BY </pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>89</pre>
            </td>
            <td class='context'>
              <pre class='context'>            mv.office_name,</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>90</pre>
            </td>
            <td class='context'>
              <pre class='context'>            mv.hcp_f_name,</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>91</pre>
            </td>
            <td class='context'>
              <pre class='context'>            mv.hcp_l_name,</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>Campaigns::GetCnsCampaigns</td>
      <td>query</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context110');toggle('message110');toggle('full_message110')" ><span id='message110' style='display:block'>Possible SQL injection near line 63: ...</span><span id='full_message110' style='display:none'>Possible SQL injection near line 63: <span class="code">General.find_by_sql([&quot;SELECT \n  mv.individual_id,\n  p.source_id,\n  mv.office_id,\n  mv.office_name,\n  mv.sms_phone AS office_phone,\n  mv.f_name,\n  mv.l_name,\n  mv.l_loss_level,\n  mv.r_loss_level,\n  mv.phones,\n  mv.hcp_f_name,\n  mv.hcp_l_name,\n  mv.prevcom,\n  lv.last_appt_at,\n  lc.message_type AS last_com_type,\n  lc.last_at AS last_com_at,\n  NULL::timestamp AS next_appt\nFROM mv_cns mv\nJOIN (\n  SELECT id, source_id FROM patients\n) p ON p.id = mv.patient_id\nLEFT JOIN LATERAL (\n  SELECT appt_at AS last_appt_at\n  FROM appointments\n  WHERE \n    patient_id = mv.patient_id\n    AND appt_at::date BETWEEN (now() - INTERVAL &#39;10 years&#39;)::date AND now()::date\n    #{<span class="user_input">ca</span>}\n  ORDER BY appt_at DESC\n  LIMIT 1\n) lv ON TRUE\nLEFT JOIN LATERAL (\n  SELECT individual_id, message_type, last_at\n  FROM (\n    SELECT individual_id, message_type, processed_at AS last_at\n    FROM message_out_details\n    WHERE individual_id IS NOT NULL\n    UNION\n    SELECT individual_id, &#39;Call&#39;::text AS message_type, created_at AS last_at\n    FROM callcenter_logs\n    WHERE status NOT IN (&#39;Invalid&#39;)\n  ) sq\n  WHERE sq.individual_id = mv.individual_id\n  ORDER BY last_at DESC\n  LIMIT 1\n) lc ON TRUE\nWHERE mv.client_id = :cid\n#{df_query}\n#{&quot;and #{filters}&quot; unless filters.blank?}\nORDER BY mv.office_name, mv.hcp_f_name, mv.hcp_l_name, mv.f_name, mv.l_name\n#{pagination}\n&quot;, { :cid =&gt; client_id }])</span></span><table id='context110' class='context' style='display:none'><caption>app/queries/campaigns/get_cns_campaigns.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>58</pre>
          </td>
          <td class='context'>
            <pre class='context'>        SELECT appt_at AS last_appt_at</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>59</pre>
            </td>
            <td class='context'>
              <pre class='context'>        FROM appointments</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>60</pre>
            </td>
            <td class='context'>
              <pre class='context'>        WHERE </pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>61</pre>
            </td>
            <td class='context'>
              <pre class='context'>          patient_id = mv.patient_id</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>62</pre>
            </td>
            <td class='context'>
              <pre class='context'>          AND appt_at::date BETWEEN (now() - INTERVAL &#39;10 years&#39;)::date AND now()::date</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>63</pre>
            </td>
            <td class='context'>
              <pre class='context'>          #{ca}</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>64</pre>
            </td>
            <td class='context'>
              <pre class='context'>        ORDER BY appt_at DESC</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>65</pre>
            </td>
            <td class='context'>
              <pre class='context'>        LIMIT 1</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>66</pre>
            </td>
            <td class='context'>
              <pre class='context'>      ) lv ON TRUE</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>67</pre>
            </td>
            <td class='context'>
              <pre class='context'>      LEFT JOIN LATERAL (</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>68</pre>
            </td>
            <td class='context'>
              <pre class='context'>        SELECT individual_id, message_type, last_at</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>Campaigns::GetNsCampaigns</td>
      <td>query</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context111');toggle('message111');toggle('full_message111')" >Possible SQL injection near line 78: <span class="code">General.find_by_sql([&quot;SELECT \n    mv.client_id, mv.patient_id, \n    p.source_id, mv.individual_id, \n    mv.f_name, mv.l_name, mv.phones, \n    mv.office_id, mv.office_name, \n    mv.sms_phone AS office_phone, \n    mv.appt_name, mv.hcp_f_name, mv.hcp_l_name, \n    mv.last_appt_at, \n    lc.message_type AS last_com_type, \n    lc.last_at AS last_com_at, \n    na.next_appt\nFROM mv_noshow mv\nJOIN (\n    SELECT id, source_id FROM patients\n) p ON p.id = mv.patient_id\nLEFT JOIN LATERAL (\n    SELECT appt_at AS next_appt\n    FROM appointments\n    WHERE appointments.patient_id = mv.patient_id\n      AND appt_at::date &gt; CURRENT_DATE\n      AND category IN (&#39;Confirmed&#39;, &#39;Not Confirmed&#39;)\n    ORDER BY appt_at ASC\n    LIMIT 1\n) na ON TRUE\nLEFT JOIN LATERAL (\n    SELECT message_type, last_at FROM (\n        SELECT message_type, processed_at AS last_at\n        FROM message_out_details\n        WHERE individual_id = mv.individual_id\n          AND individual_id IS NOT NULL\n\n        UNION ALL\n\n        SELECT &#39;Call&#39;::text AS message_type, created_at AS last_at\n        FROM callcenter_logs\n        WHERE individual_id = mv.individual_id\n          AND status NOT IN (&#39;Invalid&#39;)\n    ) AS all_coms\n    ORDER BY last_at DESC\n    LIMIT 1\n) lc ON TRUE\n\nWHERE mv.client_id = :cid\n#{<span class="user_input">df_query</span>}\n#{applied_filters}\nORDER BY mv.office_name, mv.hcp_f_name, mv.hcp_l_name, mv.f_name, mv.l_name\n#{pagination}\n&quot;, { :cid =&gt; client_id }])</span><table id='context111' class='context' style='display:none'><caption>app/queries/campaigns/get_ns_campaigns.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>73</pre>
          </td>
          <td class='context'>
            <pre class='context'>            ORDER BY last_at DESC</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>74</pre>
            </td>
            <td class='context'>
              <pre class='context'>            LIMIT 1</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>75</pre>
            </td>
            <td class='context'>
              <pre class='context'>        ) lc ON TRUE</pre>
            </td>
          </tr>
          <tr class='context alt near_error'>
            <td class='context_line'>
              <pre class='context'>77</pre>
            </td>
            <td class='context'>
              <pre class='context'>        WHERE mv.client_id = :cid</pre>
            </td>
          </tr>
          <tr class='context error'>
            <td class='context_line'>
              <pre class='context'>78</pre>
            </td>
            <td class='context'>
              <pre class='context'>        #{df_query}</pre>
            </td>
          </tr>
          <tr class='context alt near_error'>
            <td class='context_line'>
              <pre class='context'>79</pre>
            </td>
            <td class='context'>
              <pre class='context'>        #{applied_filters}</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>80</pre>
            </td>
            <td class='context'>
              <pre class='context'>        ORDER BY mv.office_name, mv.hcp_f_name, mv.hcp_l_name, mv.f_name, mv.l_name</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>81</pre>
            </td>
            <td class='context'>
              <pre class='context'>        #{pagination}</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>82</pre>
            </td>
            <td class='context'>
              <pre class='context'>      SQL</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>83</pre>
            </td>
            <td class='context'>
              <pre class='context'>  end</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>Campaigns::GetTnsCampaigns</td>
      <td>query</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context112');toggle('message112');toggle('full_message112')" >Possible SQL injection near line 63: <span class="code">General.find_by_sql([&quot;SELECT \n    mt.individual_id, \n    p.source_id, \n    mt.office_id, \n    mt.office_name, \n    mt.sms_phone AS office_phone, \n    mt.f_name, \n    mt.l_name, \n    mt.l_loss_level, \n    mt.r_loss_level, \n    mt.phones, \n    mt.hcp_f_name, \n    mt.hcp_l_name, \n    mt.prevcom, \n    lv.last_appt_at, \n    lc.message_type AS last_com_type, \n    lc.last_at AS last_com_at, \n    next_appt\nFROM mv_tns mt\nJOIN (\n    SELECT id, source_id FROM patients\n) p ON p.id = mt.patient_id\nLEFT JOIN LATERAL (\n    SELECT appt_at AS last_appt_at\n    FROM appointments\n    WHERE \n        patient_id = mt.patient_id\n        AND appt_at::date BETWEEN (now() - INTERVAL &#39;10 years&#39;)::date AND now()::date\n        #{<span class="user_input">ca</span>}\n    ORDER BY appt_at DESC\n    LIMIT 1\n) lv ON TRUE\nLEFT JOIN LATERAL (\n    SELECT message_type, last_at\n    FROM (\n        SELECT \n            message_type, \n            processed_at AS last_at\n        FROM message_out_details \n        WHERE individual_id = mt.individual_id AND individual_id IS NOT NULL\n        UNION ALL\n        SELECT \n            &#39;Call&#39;::text AS message_type, \n            created_at AS last_at\n        FROM callcenter_logs \n        WHERE individual_id = mt.individual_id AND status NOT IN (&#39;Invalid&#39;)\n    ) AS combined_logs\n    ORDER BY last_at DESC\n    LIMIT 1\n) lc ON TRUE\nWHERE mt.client_id = :cid\n#{df_query}\n#{applied_filters}\nORDER BY \n    mt.office_name, \n    mt.hcp_f_name, \n    mt.hcp_l_name, \n    mt.f_name, \n    mt.l_name\n#{pagination}\n&quot;, { :cid =&gt; client_id }])</span><table id='context112' class='context' style='display:none'><caption>app/queries/campaigns/get_tns_campaigns.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>58</pre>
          </td>
          <td class='context'>
            <pre class='context'>          SELECT appt_at AS last_appt_at</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>59</pre>
            </td>
            <td class='context'>
              <pre class='context'>          FROM appointments</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>60</pre>
            </td>
            <td class='context'>
              <pre class='context'>          WHERE </pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>61</pre>
            </td>
            <td class='context'>
              <pre class='context'>              patient_id = mt.patient_id</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>62</pre>
            </td>
            <td class='context'>
              <pre class='context'>              AND appt_at::date BETWEEN (now() - INTERVAL &#39;10 years&#39;)::date AND now()::date</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>63</pre>
            </td>
            <td class='context'>
              <pre class='context'>              #{ca}</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>64</pre>
            </td>
            <td class='context'>
              <pre class='context'>          ORDER BY appt_at DESC</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>65</pre>
            </td>
            <td class='context'>
              <pre class='context'>          LIMIT 1</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>66</pre>
            </td>
            <td class='context'>
              <pre class='context'>      ) lv ON TRUE</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>67</pre>
            </td>
            <td class='context'>
              <pre class='context'>      LEFT JOIN LATERAL (</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>68</pre>
            </td>
            <td class='context'>
              <pre class='context'>          SELECT message_type, last_at</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>Campaigns::GetUpgradeCampaigns</td>
      <td>query</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context113');toggle('message113');toggle('full_message113')" >Possible SQL injection near line 63: <span class="code">General.find_by_sql([&quot;SELECT *\nFROM (\n  SELECT\n    ug.individual_id,\n    p.source_id,\n    ug.office_id AS office_id,\n    ug.office_name,\n    ug.sms_phone AS office_phone,\n    ug.f_name,\n    ug.l_name,\n    ug.phones,\n    ug.hcp_f_name,\n    ug.hcp_l_name,\n    ug.prevcom,\n    ug.regard_at,\n    lv.last_appt_at,\n    lc.message_type AS last_com_type,\n    lc.last_at AS last_com_at,\n    na.next_appt\n  FROM mv_upgrades ug\n  JOIN patients p\n    ON p.id = ug.patient_id\n  LEFT JOIN LATERAL (\n    SELECT appt_at AS last_appt_at\n    FROM appointments\n    WHERE patient_id = ug.patient_id\n      AND appt_at &gt;= now() - interval &#39;10 years&#39;\n      AND appt_at &lt; now()\n      #{<span class="user_input">ca</span>}\n    ORDER BY appt_at DESC\n    LIMIT 1\n  ) lv ON TRUE\n  LEFT JOIN LATERAL (\n    SELECT appt_at AS next_appt\n    FROM appointments\n    WHERE patient_id = ug.patient_id\n      AND appt_at &gt; now()\n      AND category IN (&#39;Confirmed&#39;, &#39;Not Confirmed&#39;)\n    ORDER BY appt_at\n    LIMIT 1\n  ) na ON TRUE\n  LEFT JOIN LATERAL (\n    (\n      SELECT message_type, processed_at AS last_at\n      FROM message_out_details\n      WHERE individual_id = ug.individual_id\n      ORDER BY processed_at DESC\n      LIMIT 1\n    )\n    UNION ALL\n    (\n      SELECT &#39;Call&#39;::text AS message_type, created_at AS last_at\n      FROM callcenter_logs\n      WHERE individual_id = ug.individual_id\n        AND status NOT IN (&#39;Invalid&#39;)\n      ORDER BY created_at DESC\n      LIMIT 1\n    )\n    ORDER BY last_at DESC\n    LIMIT 1\n  ) lc ON TRUE\n  WHERE ug.client_id = :cid\n) base\nWHERE 1=1\n#{applied_filters}\n#{df_query}\nORDER BY\n  office_name,\n  hcp_f_name,\n  hcp_l_name,\n  f_name,\n  l_name\n#{pagination}\n&quot;, { :cid =&gt; client_id }])</span><table id='context113' class='context' style='display:none'><caption>app/queries/campaigns/get_upgrade_campaigns.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>58</pre>
          </td>
          <td class='context'>
            <pre class='context'>            SELECT appt_at AS last_appt_at</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>59</pre>
            </td>
            <td class='context'>
              <pre class='context'>            FROM appointments</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>60</pre>
            </td>
            <td class='context'>
              <pre class='context'>            WHERE patient_id = ug.patient_id</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>61</pre>
            </td>
            <td class='context'>
              <pre class='context'>              AND appt_at &gt;= now() - interval &#39;10 years&#39;</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>62</pre>
            </td>
            <td class='context'>
              <pre class='context'>              AND appt_at &lt; now()</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>63</pre>
            </td>
            <td class='context'>
              <pre class='context'>              #{ca}</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>64</pre>
            </td>
            <td class='context'>
              <pre class='context'>            ORDER BY appt_at DESC</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>65</pre>
            </td>
            <td class='context'>
              <pre class='context'>            LIMIT 1</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>66</pre>
            </td>
            <td class='context'>
              <pre class='context'>          ) lv ON TRUE</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>67</pre>
            </td>
            <td class='context'>
              <pre class='context'>          LEFT JOIN LATERAL (</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>68</pre>
            </td>
            <td class='context'>
              <pre class='context'>            SELECT appt_at AS next_appt</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>Campaigns::GetWarrantyCampaigns</td>
      <td>query</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context114');toggle('message114');toggle('full_message114')" >Possible SQL injection near line 63: <span class="code">General.find_by_sql([&quot;SELECT \n    mv.individual_id,\n    p.source_id,\n    mv.office_id,\n    mv.office_name,\n    mv.sms_phone AS office_phone,\n    mv.f_name,\n    mv.l_name,\n    mv.phones,\n    mv.hcp_f_name,\n    mv.hcp_l_name,\n    mv.prevcom,\n    mv.regard_at AS purchased_at,\n    mv.warranty_exp_at,\n    lv.last_appt_at,\n    lc.message_type AS last_com_type,\n    lc.last_at AS last_com_at,\n    na.next_appt\nFROM mv_exp_warranty mv\nJOIN (\n    SELECT id, source_id FROM patients\n) p ON p.id = mv.patient_id\nLEFT JOIN LATERAL (\n    SELECT appt_at AS last_appt_at\n    FROM appointments\n    WHERE \n        patient_id = mv.patient_id\n        AND appt_at::date BETWEEN (now() - INTERVAL &#39;10 years&#39;)::date AND now()::date\n        #{<span class="user_input">ca</span>}\n    ORDER BY appt_at DESC\n    LIMIT 1\n) lv ON TRUE\nLEFT JOIN LATERAL (\n    SELECT appt_at AS next_appt\n    FROM appointments\n    WHERE \n        patient_id = mv.patient_id\n        AND appt_at::date &gt; now()::date\n        AND category IN (&#39;Confirmed&#39;, &#39;Not Confirmed&#39;)\n    ORDER BY appt_at ASC\n    LIMIT 1\n) na ON TRUE\nLEFT JOIN LATERAL (\n    SELECT message_type, last_at\n    FROM (\n        SELECT \n            message_type, \n            processed_at AS last_at\n        FROM message_out_details \n        WHERE individual_id = mv.individual_id AND individual_id IS NOT NULL\n        UNION ALL\n        SELECT \n            &#39;Call&#39;::text AS message_type, \n            created_at AS last_at\n        FROM callcenter_logs \n        WHERE individual_id = mv.individual_id AND status NOT IN (&#39;Invalid&#39;)\n    ) sq\n    ORDER BY last_at DESC\n    LIMIT 1\n) lc ON TRUE\nWHERE mv.client_id = :cid\n#{df_query}\n#{applied_filters}\nORDER BY \n    mv.office_name,\n    mv.hcp_f_name,\n    mv.hcp_l_name,\n    mv.f_name,\n    mv.l_name\n#{pagination}\n&quot;, { :cid =&gt; client_id }])</span><table id='context114' class='context' style='display:none'><caption>app/queries/campaigns/get_warranty_campaigns.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>58</pre>
          </td>
          <td class='context'>
            <pre class='context'>            SELECT appt_at AS last_appt_at</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>59</pre>
            </td>
            <td class='context'>
              <pre class='context'>            FROM appointments</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>60</pre>
            </td>
            <td class='context'>
              <pre class='context'>            WHERE </pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>61</pre>
            </td>
            <td class='context'>
              <pre class='context'>                patient_id = mv.patient_id</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>62</pre>
            </td>
            <td class='context'>
              <pre class='context'>                AND appt_at::date BETWEEN (now() - INTERVAL &#39;10 years&#39;)::date AND now()::date</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>63</pre>
            </td>
            <td class='context'>
              <pre class='context'>                #{ca}</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>64</pre>
            </td>
            <td class='context'>
              <pre class='context'>            ORDER BY appt_at DESC</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>65</pre>
            </td>
            <td class='context'>
              <pre class='context'>            LIMIT 1</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>66</pre>
            </td>
            <td class='context'>
              <pre class='context'>        ) lv ON TRUE</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>67</pre>
            </td>
            <td class='context'>
              <pre class='context'>        LEFT JOIN LATERAL (</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>68</pre>
            </td>
            <td class='context'>
              <pre class='context'>            SELECT appt_at AS next_appt</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>GetAllNudgeAppointments</td>
      <td>query</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context115');toggle('message115');toggle('full_message115')" ><span id='message115' style='display:block'>Possible SQL injection near line 33: ...</span><span id='full_message115' style='display:none'>Possible SQL injection near line 33: <span class="code">General.find_by_sql([&quot;with ap as (\n\tselect a.*, p.id as pid\n\tfrom appointments a\n\tjoin patients p on a.patient_id = p.id\n\twhere client_id = :cid\n\tand appt_at between :tdate::date and :tdate::date + interval &#39;1 day&#39;\n\t#{<span class="user_input">preference_key</span>}\n)\nselect p.id as patient_id, p.email, p.phones, p.phone_text as textable_phone, a.id as appointment_id,\n\tcase when p.phone_text is null then false else true end as textable, a.appt_at,\n\tcoalesce(a.source_created_at, a.created_at) as created_at, a.confirmed_at, a.confirmed_by,\n\ta.confirmed_type, o.name as office_name, a.status, coalesce(nullif(trim(concat(a.hcp_f_name, &#39; &#39;, a.hcp_l_name)),&#39;&#39;),\n\tnullif(trim(concat(p.hcp_f_name, &#39; &#39;, p.hcp_l_name)),&#39;&#39;)) as provider, trim(concat(p.f_name, &#39; &#39;, p.l_name))\n\tas patient_name, coalesce(o.sms_phone, o.phone, rp.phone) as office_phone, ms.message_list,\n\tcase when p.hipaa_consent_id is null then false else true end as consent, test_type, test_id\nfrom ap a\njoin mv_patients p on a.patient_id = p.id\njoin offices o on a.office_id = o.id\nleft join (select distinct on (office_id) * from relevant_phones order by office_id) rp on o.id = rp.office_id\nleft join (\n\tselect individual_id, regard_type, regard_id,\n\t\tarray_agg(concat(action_ofs, &#39; Day &#39;,message_type, &#39; on &#39;, to_char(processed_at, &#39;Mon DD, YYYY&#39;))) as message_list\n\tfrom message_out_details mo\n\tjoin touch_steps ts on ts.id = mo.touch_step_id\n\twhere client_id = :cid\n\tand regard_id is not null\n\tand regard_type = &#39;Appointment&#39;\n\tand regard_id in (select id from ap)\n\tgroup by individual_id, regard_type, regard_id\n) ms on p.individual_id = ms.individual_id and a.id = ms.regard_id\nleft join (\n\tselect distinct on (appointment_id) appointment_id, test_type, test_id\n\tfrom appointment_tests\n\twhere tested_at &gt; now() - interval &#39;1 months&#39;\n\torder by appointment_id, tested_at desc) ats on a.id = ats.appointment_id\nwhere p.client_id = :cid\n#{applied_filters}\n#{df_query}\norder by o.name, a.appt_at\n#{pagination}\n&quot;, { :cid =&gt; client_id, :tdate =&gt; interval_date.strftime(&quot;%Y-%m-%d&quot;) }])</span></span><table id='context115' class='context' style='display:none'><caption>app/queries/get_all_nudge_appointments.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>28</pre>
          </td>
          <td class='context'>
            <pre class='context'>				select a.*, p.id as pid</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>29</pre>
            </td>
            <td class='context'>
              <pre class='context'>				from appointments a</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>30</pre>
            </td>
            <td class='context'>
              <pre class='context'>				join patients p on a.patient_id = p.id</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>31</pre>
            </td>
            <td class='context'>
              <pre class='context'>				where client_id = :cid</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>32</pre>
            </td>
            <td class='context'>
              <pre class='context'>				and appt_at between :tdate::date and :tdate::date + interval &#39;1 day&#39;</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>33</pre>
            </td>
            <td class='context'>
              <pre class='context'>				#{preference_key}</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>34</pre>
            </td>
            <td class='context'>
              <pre class='context'>			)</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>35</pre>
            </td>
            <td class='context'>
              <pre class='context'>			select p.id as patient_id, p.email, p.phones, p.phone_text as textable_phone, a.id as appointment_id,</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>36</pre>
            </td>
            <td class='context'>
              <pre class='context'>				case when p.phone_text is null then false else true end as textable, a.appt_at,</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>37</pre>
            </td>
            <td class='context'>
              <pre class='context'>				coalesce(a.source_created_at, a.created_at) as created_at, a.confirmed_at, a.confirmed_by,</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>38</pre>
            </td>
            <td class='context'>
              <pre class='context'>				a.confirmed_type, o.name as office_name, a.status, coalesce(nullif(trim(concat(a.hcp_f_name, &#39; &#39;, a.hcp_l_name)),&#39;&#39;),</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>GetAllTextMessages</td>
      <td>single_query_with_count</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context116');toggle('message116');toggle('full_message116')" ><span id='message116' style='display:block'>Possible SQL injection near line 50: ...</span><span id='full_message116' style='display:none'>Possible SQL injection near line 50: <span class="code">General.find_by_sql([&quot;      WITH\n      -- 1) pull all outgoing Text messages\n      out_msgs AS (\n        SELECT\n          id            AS message_id,\n          \&quot;to\&quot;          AS phone,\n          office_id,\n          created_at,\n          now() as viewed_at\n        FROM message_out_details\n        WHERE client_id = :cid\n          AND message_type = &#39;Text&#39;\n          #{<span class="user_input">&quot;AND #{date_filter}&quot; if date_filter</span>}\n          #{&quot;AND #{office_filter}&quot; if office_filter}\n      ),\n      -- 2) pull all incoming messages\n      in_msgs AS (\n        SELECT\n          id            AS message_id,\n          ( \&quot;from\&quot; )::text  AS phone,\n          office_id,\n          created_at,\n          viewed_at\n        FROM message_in_extracts\n        WHERE client_id = :cid\n        #{<span class="user_input">&quot;AND #{date_filter}&quot; if date_filter</span>}\n        #{&quot;AND #{office_filter}&quot; if office_filter}\n      ),\n      -- 3) pick latest forward per incoming message\n      forwarded AS (\n        SELECT DISTINCT ON (message_in_extract_id)\n          message_in_extract_id,\n          office_id\n        FROM message_forwards\n        WHERE 1=1\n        #{<span class="user_input">&quot;AND #{date_filter}&quot; if date_filter</span>}\n        #{&quot;AND #{office_filter}&quot; if office_filter}\n        ORDER BY message_in_extract_id, created_at DESC\n      ),\n      -- 4) union them into one stream,\n      --    and apply forward\u2010override for incoming\n      all_msgs AS (\n        SELECT\n          &#39;out&#39;        AS direction,\n          message_id,\n          phone,\n          office_id,\n          created_at,\n          viewed_at\n        FROM out_msgs\n        UNION ALL\n        SELECT\n          &#39;in&#39;         AS direction,\n          im.message_id,\n          im.phone,\n          COALESCE(f.office_id, im.office_id) AS office_id,\n          im.created_at,\n          im.viewed_at\n        FROM in_msgs AS im\n        LEFT JOIN forwarded AS f\n          ON f.message_in_extract_id = im.message_id\n      ),\n      -- 5) build your \&quot;best\&quot; contact record per phone:\n      --    patients &gt; mv_names, most\u2010recent appt used for HCP names\n      phone_contacts AS (\n        SELECT\n          phone,\n          pid, title, f_name, m_name, l_name, suffix,\n          hcp_f_name, hcp_l_name,\n          consent, hipaa_consented_at,\n          ROW_NUMBER() OVER (\n            PARTITION BY phone\n            ORDER BY source_rank, seq\n          ) AS rn\n        FROM (\n          -- patient phones\n          SELECT\n            pp.phone,\n            p.id            AS pid,\n            p.title,\n            p.f_name, p.m_name, p.l_name, p.suffix,\n            COALESCE(p.hcp_f_name, a.hcp_f_name) AS hcp_f_name,\n            COALESCE(p.hcp_l_name, a.hcp_l_name) AS hcp_l_name,\n            (p.hipaa_consent_id IS NOT NULL)  AS consent,\n            p.hipaa_consented_at,\n            0              AS seq,\n            0              AS source_rank\n          FROM patients p\n          JOIN patients_phones pp\n            ON pp.patient_id = p.id\n          JOIN mv_patient_phone_name mvpn ON mvpn.id = p.id and mvpn.client_id = :cid\n          LEFT JOIN appointments a\n            ON a.patient_id = p.id\n          WHERE p.client_id = :cid\n          #{&quot;AND #{patient_name_filter}&quot; if name_filter}\n          #{&quot;AND pp.#{phone_filter}&quot; if phone_filter}\n          #{&quot;AND #{hcp_filter}&quot; if hcp_filter}\n\n          UNION ALL\n\n          -- fallback names from mv_names\n          SELECT\n            m.phone,\n            0               AS pid,\n            m.title, m.f_name, m.m_name, m.l_name, m.suffix,\n            &#39;&#39;              AS hcp_f_name,\n            &#39;&#39;              AS hcp_l_name,\n            FALSE           AS consent,\n            NULL            AS hipaa_consented_at,\n            1               AS seq,\n            1               AS source_rank\n          FROM mv_names m\n          WHERE m.client_id = :cid\n          #{&quot;AND #{name_filter}&quot; if name_filter}\n          #{&quot;AND #{phone_filter}&quot; if phone_filter}\n        ) t\n      ),\n      -- 6) aggregated results with window function for total count\n      aggregated AS (\n        SELECT\n          m.office_id,\n          m.phone,\n          pc.pid,\n          pc.title,\n          pc.f_name, pc.m_name, pc.l_name,\n          pc.suffix,\n          pc.hcp_f_name, pc.hcp_l_name,\n          COUNT(*)                           AS total,\n          COUNT(*) FILTER (WHERE m.viewed_at IS NULL) AS unviewed,\n          pc.consent,\n          pc.hipaa_consented_at,\n          COUNT(*) OVER () AS total_count  -- Total count across all groups\n        FROM all_msgs AS m\n        JOIN phone_contacts AS pc\n          ON pc.phone = m.phone\n          AND pc.rn = 1                        -- pick only the top-ranked contact\n        WHERE #{[date_filter, name_filter, office_filter, (&quot;m.&quot; + phone_filter) if phone_filter].compact.join(&quot; AND &quot;)}\n        GROUP BY\n          m.office_id,\n          m.phone,\n          pc.pid, pc.title, pc.f_name, pc.m_name, pc.l_name, pc.suffix,\n          pc.hcp_f_name, pc.hcp_l_name,\n          pc.consent,\n          pc.hipaa_consented_at\n        ORDER BY m.office_id, m.phone\n      )\n      -- 7) Apply pagination\n      SELECT *\n      FROM aggregated\n      #{offparam};\n&quot;, { :cid =&gt; client_id }])</span></span><table id='context116' class='context' style='display:none'><caption>app/queries/get_all_text_messages.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>45</pre>
          </td>
          <td class='context'>
            <pre class='context'>          created_at,</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>46</pre>
            </td>
            <td class='context'>
              <pre class='context'>          now() as viewed_at</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>47</pre>
            </td>
            <td class='context'>
              <pre class='context'>        FROM message_out_details</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>48</pre>
            </td>
            <td class='context'>
              <pre class='context'>        WHERE client_id = :cid</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>49</pre>
            </td>
            <td class='context'>
              <pre class='context'>          AND message_type = &#39;Text&#39;</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>50</pre>
            </td>
            <td class='context'>
              <pre class='context'>          #{&quot;AND #{date_filter}&quot; if date_filter}</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>51</pre>
            </td>
            <td class='context'>
              <pre class='context'>          #{&quot;AND #{office_filter}&quot; if office_filter}</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>52</pre>
            </td>
            <td class='context'>
              <pre class='context'>      ),</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>53</pre>
            </td>
            <td class='context'>
              <pre class='context'>      -- 2) pull all incoming messages</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>54</pre>
            </td>
            <td class='context'>
              <pre class='context'>      in_msgs AS (</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>55</pre>
            </td>
            <td class='context'>
              <pre class='context'>        SELECT</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>GetAllTextMessages</td>
      <td>get_simple_count</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context117');toggle('message117');toggle('full_message117')" ><span id='message117' style='display:block'>Possible SQL injection near line 221: ...</span><span id='full_message117' style='display:none'>Possible SQL injection near line 221: <span class="code">General.find_by_sql([&quot;SELECT COUNT(DISTINCT CONCAT(m.office_id, &#39;-&#39;, m.phone)) as total_count\nFROM (\n  SELECT office_id, \&quot;to\&quot; as phone\n  FROM message_out_details\n  WHERE client_id = :cid\n    AND message_type = &#39;Text&#39;\n    #{<span class="user_input">&quot;AND #{date_filter}&quot; if date_filter</span>}\n    #{&quot;AND #{office_filter}&quot; if office_filter}\n\n  UNION\n\n  SELECT\n    COALESCE(f.office_id, mie.office_id) as office_id,\n    mie.\&quot;from\&quot; as phone\n  FROM message_in_extracts mie\n  LEFT JOIN (\n    SELECT DISTINCT ON (message_in_extract_id)\n      message_in_extract_id,\n      office_id\n    FROM message_forwards\n    WHERE 1=1\n    #{<span class="user_input">&quot;AND #{date_filter}&quot; if date_filter</span>}\n    #{&quot;AND #{office_filter}&quot; if office_filter}\n    ORDER BY message_in_extract_id, created_at DESC\n  ) f ON f.message_in_extract_id = mie.id\n  WHERE mie.client_id = :cid\n  #{<span class="user_input">&quot;AND #{date_filter}&quot; if date_filter</span>}\n  #{&quot;AND #{office_filter}&quot; if office_filter}\n) m\n#{if phone_filter then   &quot;WHERE m.phone = &#39;#{phone_filter.gsub(/[^0-9]/, &quot;&quot;)}&#39;&quot; else   &quot;&quot; end}\n&quot;, { :cid =&gt; client_id }])</span></span><table id='context117' class='context' style='display:none'><caption>app/queries/get_all_text_messages.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>216</pre>
          </td>
          <td class='context'>
            <pre class='context'>      FROM (</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>217</pre>
            </td>
            <td class='context'>
              <pre class='context'>        SELECT office_id, &quot;to&quot; as phone</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>218</pre>
            </td>
            <td class='context'>
              <pre class='context'>        FROM message_out_details</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>219</pre>
            </td>
            <td class='context'>
              <pre class='context'>        WHERE client_id = :cid</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>220</pre>
            </td>
            <td class='context'>
              <pre class='context'>          AND message_type = &#39;Text&#39;</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>221</pre>
            </td>
            <td class='context'>
              <pre class='context'>          #{&quot;AND #{date_filter}&quot; if date_filter}</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>222</pre>
            </td>
            <td class='context'>
              <pre class='context'>          #{&quot;AND #{office_filter}&quot; if office_filter}</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>224</pre>
            </td>
            <td class='context'>
              <pre class='context'>        UNION</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>226</pre>
            </td>
            <td class='context'>
              <pre class='context'>        SELECT</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>GetAllTextMessages</td>
      <td>query</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context118');toggle('message118');toggle('full_message118')" ><span id='message118' style='display:block'>Possible SQL injection near line 264: ...</span><span id='full_message118' style='display:none'>Possible SQL injection near line 264: <span class="code">General.find_by_sql([&quot;      WITH\n      -- 1) pull all outgoing Text messages\n      out_msgs AS (\n        SELECT\n          id            AS message_id,\n          \&quot;to\&quot;          AS phone,\n          office_id,\n          created_at,\n          now() as viewed_at\n        FROM message_out_details\n        WHERE client_id = :cid\n          AND message_type = &#39;Text&#39;\n          #{<span class="user_input">&quot;AND #{date_filter}&quot; if date_filter</span>}\n          #{&quot;AND #{office_filter}&quot; if office_filter}\n      ),\n      -- 2) pull all incoming messages\n      in_msgs AS (\n        SELECT\n          id            AS message_id,\n          ( \&quot;from\&quot; )::text  AS phone,\n          office_id,\n          created_at,\n          viewed_at\n        FROM message_in_extracts\n        WHERE client_id = :cid\n        #{<span class="user_input">&quot;AND #{date_filter}&quot; if date_filter</span>}\n        #{&quot;AND #{office_filter}&quot; if office_filter}\n      ),\n      -- 3) pick latest forward per incoming message\n      forwarded AS (\n        SELECT DISTINCT ON (message_in_extract_id)\n          message_in_extract_id,\n          office_id\n        FROM message_forwards\n        WHERE 1=1\n        #{<span class="user_input">&quot;AND #{date_filter}&quot; if date_filter</span>}\n        #{&quot;AND #{office_filter}&quot; if office_filter}\n        ORDER BY message_in_extract_id, created_at DESC\n      ),\n      -- 4) union them into one stream,\n      --    and apply forward\u2010override for incoming\n      all_msgs AS (\n        SELECT\n          &#39;out&#39;        AS direction,\n          message_id,\n          phone,\n          office_id,\n          created_at,\n          viewed_at\n        FROM out_msgs\n        UNION ALL\n        SELECT\n          &#39;in&#39;         AS direction,\n          im.message_id,\n          im.phone,\n          COALESCE(f.office_id, im.office_id) AS office_id,\n          im.created_at,\n          im.viewed_at\n        FROM in_msgs AS im\n        LEFT JOIN forwarded AS f\n          ON f.message_in_extract_id = im.message_id\n      ),\n      -- 5) build your \&quot;best\&quot; contact record per phone:\n      --    patients &gt; mv_names, most\u2010recent appt used for HCP names\n      phone_contacts AS (\n        SELECT\n          phone,\n          pid, title, f_name, m_name, l_name, suffix,\n          hcp_f_name, hcp_l_name,\n          consent, hipaa_consented_at,\n          ROW_NUMBER() OVER (\n            PARTITION BY phone\n            ORDER BY source_rank, seq\n          ) AS rn\n        FROM (\n          -- patient phones\n          SELECT\n            pp.phone,\n            p.id            AS pid,\n            p.title,\n            p.f_name, p.m_name, p.l_name, p.suffix,\n            COALESCE(a.hcp_f_name, p.hcp_f_name) AS hcp_f_name,\n            COALESCE(a.hcp_l_name, p.hcp_l_name) AS hcp_l_name,\n            (p.hipaa_consent_id IS NOT NULL)  AS consent,\n            p.hipaa_consented_at,\n            0              AS seq,\n            0              AS source_rank\n          FROM patients p\n          JOIN patients_phones pp\n            ON pp.patient_id = p.id\n          LEFT JOIN appointments a\n            ON a.patient_id = p.id\n          WHERE p.client_id = :cid\n          #{&quot;AND #{name_filter}&quot; if name_filter}\n          #{&quot;AND #{phone_filter}&quot; if phone_filter}\n          #{&quot;AND #{hcp_filter}&quot; if hcp_filter}\n\n          UNION ALL\n\n          -- fallback names from mv_names\n          SELECT\n            m.phone,\n            0               AS pid,\n            m.title, m.f_name, m.m_name, m.l_name, m.suffix,\n            &#39;&#39;              AS hcp_f_name,\n            &#39;&#39;              AS hcp_l_name,\n            FALSE           AS consent,\n            NULL            AS hipaa_consented_at,\n            1               AS seq,\n            1               AS source_rank\n          FROM mv_names m\n          WHERE m.client_id = :cid\n          #{&quot;AND #{name_filter}&quot; if name_filter}\n          #{&quot;AND #{phone_filter}&quot; if phone_filter}\n        ) t\n      )\n      -- 6) final aggregation\n      SELECT\n        m.office_id,\n        m.phone,\n        pc.pid,\n        pc.title,\n        pc.f_name, pc.m_name, pc.l_name,\n        pc.suffix,\n        pc.hcp_f_name, pc.hcp_l_name,\n        COUNT(*)                           AS total,\n        COUNT(*) FILTER (WHERE m.viewed_at IS NULL) AS unviewed,\n        pc.consent,\n        pc.hipaa_consented_at\n      FROM all_msgs AS m\n      JOIN phone_contacts AS pc\n        ON pc.phone = m.phone\n        AND pc.rn = 1                        -- pick only the top-ranked contact\n      WHERE #{[date_filter, name_filter, office_filter, (&quot;m.&quot; + phone_filter) if phone_filter].compact.join(&quot; AND &quot;)}\n      GROUP BY\n        m.office_id,\n        m.phone,\n        pc.pid, pc.title, pc.f_name, pc.m_name, pc.l_name, pc.suffix,\n        pc.hcp_f_name, pc.hcp_l_name,\n        pc.consent,\n        pc.hipaa_consented_at\n      ORDER BY m.office_id, m.phone\n      #{offparam};\n&quot;, { :cid =&gt; client_id }])</span></span><table id='context118' class='context' style='display:none'><caption>app/queries/get_all_text_messages.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>259</pre>
          </td>
          <td class='context'>
            <pre class='context'>          created_at,</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>260</pre>
            </td>
            <td class='context'>
              <pre class='context'>          now() as viewed_at</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>261</pre>
            </td>
            <td class='context'>
              <pre class='context'>        FROM message_out_details</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>262</pre>
            </td>
            <td class='context'>
              <pre class='context'>        WHERE client_id = :cid</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>263</pre>
            </td>
            <td class='context'>
              <pre class='context'>          AND message_type = &#39;Text&#39;</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>264</pre>
            </td>
            <td class='context'>
              <pre class='context'>          #{&quot;AND #{date_filter}&quot; if date_filter}</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>265</pre>
            </td>
            <td class='context'>
              <pre class='context'>          #{&quot;AND #{office_filter}&quot; if office_filter}</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>266</pre>
            </td>
            <td class='context'>
              <pre class='context'>      ),</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>267</pre>
            </td>
            <td class='context'>
              <pre class='context'>      -- 2) pull all incoming messages</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>268</pre>
            </td>
            <td class='context'>
              <pre class='context'>      in_msgs AS (</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>269</pre>
            </td>
            <td class='context'>
              <pre class='context'>        SELECT</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>GetFamilyTree</td>
      <td>query</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context119');toggle('message119');toggle('full_message119')" >Possible SQL injection near line 42: <span class="code">General.find_by_sql([&quot;WITH target_phones AS (\n\tSELECT DISTINCT pp.phone\n\tFROM patients p\n\tJOIN patients_phones pp ON p.id = pp.patient_id\n\tJOIN offices o on o.id = p.office_id\n\tWHERE\n\t\tp.client_id = :cid AND\n\t\tLENGTH(pp.phone) = 10 AND\n\t\tpp.phone !~ &#39;^(d)\x01{9}$&#39;\n\t\t#{<span class="user_input">applied_filters</span>}\n),\nfamily_members AS (\nSELECT\n\t\tp.id,\n\t\tpp.phone,\n\t\tp.source_id,\n\t\tCONCAT(p.f_name, &#39; &#39;, p.m_name, &#39; &#39;, p.l_name) AS full_name,\n\t\tp.birthdate AS birthdate,\n\t\tDATE_PART(&#39;year&#39;, AGE(p.birthdate))::int AS age,\n\t\tp.patient_type,\n\t\tp.rel_priority\n\tFROM patients_phones pp\n\tJOIN patients p ON p.id = pp.patient_id\n\tWHERE pp.phone IN (SELECT phone FROM target_phones)\n\tAND p.client_id = :cid\n),\n\nrepresentatives AS (\n\tSELECT\n\t\tphone,\n\t\tLOWER(CONCAT(f_name, &#39; &#39;, l_name)) AS rep_name\n\tFROM mv_patient_phone_name\n\tWHERE client_id=:cid AND phone::TEXT IN (SELECT phone FROM target_phones)\n)\n\nSELECT\nDISTINCT\n\tfm.phone,\n\tfm.source_id,\n\tfm.full_name,\n\tfm.birthdate,\n\tfm.age,\n\tfm.patient_type,\n\tcase\n\twhen fm.rel_priority = 1 then &#39;Mother&#39;\n\twhen fm.rel_priority = 2 then &#39;Father&#39;\n\twhen fm.rel_priority = 3 then &#39;Parent, Child is the Patient&#39;\n\twhen fm.rel_priority = 6 then &#39;Spouse&#39;\n\telse &#39;Patient&#39;\n\tend as relation,\n\tCASE\n\t\tWHEN LOWER(fm.full_name) = reps.rep_name THEN TRUE\n\t\tELSE FALSE\n\tEND AS representative\nFROM family_members fm\nINNER JOIN representatives reps ON fm.phone = reps.phone::TEXT\nORDER BY fm.phone, representative DESC\n#{pagination ? (paginate) : (&quot;&quot;)}\n&quot;, { :cid =&gt; client_id }])</span><table id='context119' class='context' style='display:none'><caption>app/queries/get_family_tree.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>37</pre>
          </td>
          <td class='context'>
            <pre class='context'>				JOIN offices o on o.id = p.office_id</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>38</pre>
            </td>
            <td class='context'>
              <pre class='context'>				WHERE</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>39</pre>
            </td>
            <td class='context'>
              <pre class='context'>					p.client_id = :cid AND</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>40</pre>
            </td>
            <td class='context'>
              <pre class='context'>					LENGTH(pp.phone) = 10 AND</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>41</pre>
            </td>
            <td class='context'>
              <pre class='context'>					pp.phone !~ &#39;^(\d)\1{9}$&#39;</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>42</pre>
            </td>
            <td class='context'>
              <pre class='context'>					#{applied_filters}</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>43</pre>
            </td>
            <td class='context'>
              <pre class='context'>			),</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>44</pre>
            </td>
            <td class='context'>
              <pre class='context'>			family_members AS (</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>45</pre>
            </td>
            <td class='context'>
              <pre class='context'>			SELECT</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>46</pre>
            </td>
            <td class='context'>
              <pre class='context'>					p.id,</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>47</pre>
            </td>
            <td class='context'>
              <pre class='context'>					pp.phone,</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>GetPatients</td>
      <td>query</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context120');toggle('message120');toggle('full_message120')" ><span id='message120' style='display:block'>Possible SQL injection near line 69: ...</span><span id='full_message120' style='display:none'>Possible SQL injection near line 69: <span class="code">General.find_by_sql([&quot;WITH last_appointment AS (\n    SELECT DISTINCT ON (sa.patient_id)\n          sa.patient_id,\n          sa.office_id\n    FROM appointments sa\n    JOIN patients sp ON sa.patient_id = sp.id\n    WHERE sp.client_id = :cid\n      AND sa.appt_at BETWEEN NOW() - interval &#39;2 years&#39; and NOW()\n      AND sa.category in (&#39;Completed&#39;)\n    ORDER BY sa.patient_id, sa.appt_at DESC\n),\nnext_appointment AS (\n    SELECT DISTINCT ON (sa.patient_id)\n          sa.patient_id,\n          sa.appt_at AS next_appt\n    FROM appointments sa\n    JOIN patients sp ON sp.id = sa.patient_id\n    WHERE sp.client_id = :cid\n      AND sa.appt_at &gt; NOW()\n      AND sa.category in (&#39;Confirmed&#39;, &#39;Not Confirmed&#39;)\n    ORDER BY sa.patient_id, sa.appt_at ASC\n)\nSELECT * FROM (\n  SELECT\n    #{(&quot;distinct on (mv.id) mv.id, mv.client_id, mv.f_name, mv.m_name, mv.l_name, mv.birthdate, mv.email, mv.phone_text, o.id as office_id&quot; or &quot;mv.id, mv.source_id, o.id as office_id, o.name as office_name, o.sms_phone as office_phone, mv.f_name, mv.m_name, mv.l_name, mv.birthdate, mv.individual_id, mv.email, mv.client_id, mv.hcp_f_name, mv.hcp_l_name, mv.phones, mv.phone_text, case when mv.hipaa_consent_id is null then false else true end as consent, mv.hipaa_consented_at, next_appt&quot;)}\n  FROM mv_patients mv\n  JOIN patients p ON p.id = mv.id\n  LEFT JOIN last_appointment la ON la.patient_id = mv.id\n  LEFT JOIN next_appointment apt ON apt.patient_id = mv.id\n  LEFT JOIN offices o ON o.id = COALESCE(mv.office_id, la.office_id)\n  WHERE mv.client_id = :cid\n    #{<span class="user_input">applied_filters</span>}\n    #{df_query}\n) q\nORDER BY l_name, f_name\n#{pagination ? (paginate) : (&quot;&quot;)}\n&quot;, { :cid =&gt; client_id }])</span></span><table id='context120' class='context' style='display:none'><caption>app/queries/get_patients.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>64</pre>
          </td>
          <td class='context'>
            <pre class='context'>        JOIN patients p ON p.id = mv.id</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>65</pre>
            </td>
            <td class='context'>
              <pre class='context'>        LEFT JOIN last_appointment la ON la.patient_id = mv.id</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>66</pre>
            </td>
            <td class='context'>
              <pre class='context'>        LEFT JOIN next_appointment apt ON apt.patient_id = mv.id</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>67</pre>
            </td>
            <td class='context'>
              <pre class='context'>        LEFT JOIN offices o ON o.id = COALESCE(mv.office_id, la.office_id)</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>68</pre>
            </td>
            <td class='context'>
              <pre class='context'>        WHERE mv.client_id = :cid</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>69</pre>
            </td>
            <td class='context'>
              <pre class='context'>          #{applied_filters}</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>70</pre>
            </td>
            <td class='context'>
              <pre class='context'>          #{df_query}</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>71</pre>
            </td>
            <td class='context'>
              <pre class='context'>      ) q</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>72</pre>
            </td>
            <td class='context'>
              <pre class='context'>      ORDER BY l_name, f_name</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>73</pre>
            </td>
            <td class='context'>
              <pre class='context'>      #{pagination ? paginate : &#39;&#39;}</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>74</pre>
            </td>
            <td class='context'>
              <pre class='context'>    SQL</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>NudgeSubstituter</td>
      <td>do_substitution</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context150');toggle('message150');toggle('full_message150')" >Possible SQL injection near line 142: <span class="code">ActiveRecord::Base.connection.execute(&quot;select code from short_urls where fwd_to = &#39;#{<span class="user_input">/\[\[short_url\s(.*?)\]\]/.match(msg)[1] rescue nil</span>}&#39;&quot;)</span><table id='context150' class='context' style='display:none'><caption>app/controllers/concerns/nudge_substituter.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>137</pre>
          </td>
          <td class='context'>
            <pre class='context'>      msg = msg.gsub(/\[\[purchase_addr3\]\]/i, purchases.collect{ |prod| prod[&#39;purchase_fields&#39;][&#39;addr3&#39;] }.uniq.compact.join(&#39;, &#39;)) rescue msg</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>138</pre>
            </td>
            <td class='context'>
              <pre class='context'>    end</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>139</pre>
            </td>
            <td class='context'>
              <pre class='context'>    # these can have sub tags and need to be processed last</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>140</pre>
            </td>
            <td class='context'>
              <pre class='context'>    tu = /\[\[short_url\s(.*?)\]\]/.match(msg)[1] rescue nil</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>141</pre>
            </td>
            <td class='context'>
              <pre class='context'>    if tu</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>142</pre>
            </td>
            <td class='context'>
              <pre class='context'>      id = ActiveRecord::Base.connection.execute(&quot;select code from short_urls where fwd_to = &#39;#{tu}&#39;&quot;).first[&#39;code&#39;] rescue nil</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>143</pre>
            </td>
            <td class='context'>
              <pre class='context'>      unless id</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>144</pre>
            </td>
            <td class='context'>
              <pre class='context'>        id = SecureRandom.hex(5).upcase</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>145</pre>
            </td>
            <td class='context'>
              <pre class='context'>        ActiveRecord::Base.connection.execute(&quot;insert into short_urls (code, fwd_to, created_at, updated_at) values (&#39;#{id}&#39;, &#39;#{tu}&#39;, now(), now());&quot;)</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>146</pre>
            </td>
            <td class='context'>
              <pre class='context'>      end</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>147</pre>
            </td>
            <td class='context'>
              <pre class='context'>      msg = msg.gsub(/\[\[short_url\s(.*?)\]\]/i, &quot;https://relevantlocal.com/m/#{id}&quot;) rescue msg</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>NudgeSubstituter</td>
      <td>do_substitution</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context151');toggle('message151');toggle('full_message151')" ><span id='message151' style='display:block'>Possible SQL injection near line 145: ...</span><span id='full_message151' style='display:none'>Possible SQL injection near line 145: <span class="code">ActiveRecord::Base.connection.execute(&quot;insert into short_urls (code, fwd_to, created_at, updated_at) values (&#39;#{<span class="user_input">SecureRandom.hex(5).upcase</span>}&#39;, &#39;#{/\[\[short_url\s(.*?)\]\]/.match(msg)[1] rescue nil}&#39;, now(), now());&quot;)</span></span><table id='context151' class='context' style='display:none'><caption>app/controllers/concerns/nudge_substituter.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>140</pre>
          </td>
          <td class='context'>
            <pre class='context'>    tu = /\[\[short_url\s(.*?)\]\]/.match(msg)[1] rescue nil</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>141</pre>
            </td>
            <td class='context'>
              <pre class='context'>    if tu</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>142</pre>
            </td>
            <td class='context'>
              <pre class='context'>      id = ActiveRecord::Base.connection.execute(&quot;select code from short_urls where fwd_to = &#39;#{tu}&#39;&quot;).first[&#39;code&#39;] rescue nil</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>143</pre>
            </td>
            <td class='context'>
              <pre class='context'>      unless id</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>144</pre>
            </td>
            <td class='context'>
              <pre class='context'>        id = SecureRandom.hex(5).upcase</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>145</pre>
            </td>
            <td class='context'>
              <pre class='context'>        ActiveRecord::Base.connection.execute(&quot;insert into short_urls (code, fwd_to, created_at, updated_at) values (&#39;#{id}&#39;, &#39;#{tu}&#39;, now(), now());&quot;)</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>146</pre>
            </td>
            <td class='context'>
              <pre class='context'>      end</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>147</pre>
            </td>
            <td class='context'>
              <pre class='context'>      msg = msg.gsub(/\[\[short_url\s(.*?)\]\]/i, &quot;https://relevantlocal.com/m/#{id}&quot;) rescue msg</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>148</pre>
            </td>
            <td class='context'>
              <pre class='context'>    end</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>149</pre>
            </td>
            <td class='context'>
              <pre class='context'>    return msg</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>150</pre>
            </td>
            <td class='context'>
              <pre class='context'>  end</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>PatientSegmentService</td>
      <td>s(:self).dx_summary</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context152');toggle('message152');toggle('full_message152')" ><span id='message152' style='display:block'>Possible SQL injection near line 136: ...</span><span id='full_message152' style='display:none'>Possible SQL injection near line 136: <span class="code">ActiveRecord::Base.connection.exec_query(&quot;-- Optimized Summary Report with Age Filtering\nWITH RECURSIVE\n-- Get segment filters (age ranges)\nsegment_age_filters AS (\n  SELECT\n    sf.disease_segment_id AS segment_id,\n    sf.filter_min::integer AS age_min,\n    sf.filter_max::integer AS age_max\n  FROM segment_filters sf\n  WHERE sf.disease_segment_id IN (#{<span class="user_input">segment_ids.join(&quot;,&quot;)</span>})\n    AND sf.filter_type = &#39;age&#39;\n),\n\n-- Pre-split dx codes once (reusable)\nsegment_dx_codes AS (\n  SELECT\n    ds.id AS segment_id,\n    ds.name AS segment_name,\n    ds.amount,\n    ds.compliance_period,\n    ds.past_due_period,\n    trim(dx_code) AS dx_code\n  FROM disease_segments ds\n  CROSS JOIN LATERAL regexp_split_to_table(ds.dx_codes, &#39;,&#39;) AS dx_code\n  WHERE ds.id IN (#{<span class="user_input">segment_ids.join(&quot;,&quot;)</span>})\n    AND ds.dx_codes IS NOT NULL\n    AND ds.dx_codes != &#39;&#39;\n),\n\n-- Get all matching patient-dx combinations with age filtering\npatient_segment_match AS (\n  SELECT DISTINCT\n    sdc.segment_id,\n    sdc.segment_name,\n    sdc.amount,\n    sdc.compliance_period,\n    sdc.past_due_period,\n    p.id AS patient_id,\n    pdx.id AS patient_dx_code_id,\n    pdx.date_onset_sypmt AS dx_onset_sypmt\n  FROM segment_dx_codes sdc\n  JOIN patient_dx_codes pdx ON pdx.dx_code LIKE sdc.dx_code || &#39;%&#39;\n  JOIN mv_patients p ON p.id = pdx.patient_id\n  LEFT JOIN segment_age_filters saf ON saf.segment_id = sdc.segment_id\n  WHERE 1=1\n    #{office_ids.any? ? (&quot;AND p.office_id IN (#{office_ids.join(&quot;,&quot;)})&quot;) : (&quot;&quot;)}\n    -- Apply age filter if exists for this segment\n    AND (\n      saf.segment_id IS NULL  -- No age filter for this segment\n      OR (\n        EXTRACT(YEAR FROM AGE(CURRENT_DATE, p.birthdate))::integer &gt;= saf.age_min\n        AND (\n          saf.age_max IS NULL\n          OR EXTRACT(YEAR FROM AGE(CURRENT_DATE, p.birthdate))::integer &lt;= saf.age_max\n        )\n      )\n    )\n),\n\n-- Get last appointments efficiently (single scan)\npatient_last_appointments AS (\n  SELECT\n    psm.segment_id,\n    psm.patient_id,\n    MAX(a.appt_at) AS last_visit\n  FROM patient_segment_match psm\n  JOIN appointment_patient_dx_codes apdx ON apdx.patient_dx_codes_id = psm.patient_dx_code_id\n  JOIN appointments a ON a.id = apdx.appointment_id AND a.patient_id = psm.patient_id\n  GROUP BY psm.segment_id, psm.patient_id\n),\n\n-- Combine and categorize\ncategorized AS (\n  SELECT\n    psm.segment_id,\n    psm.segment_name,\n    psm.amount,\n    psm.compliance_period,\n    psm.past_due_period,\n    psm.patient_id,\n    COALESCE(pla.last_visit, NULL) AS last_visit,\n    CASE\n      -- Compliant: last visit within compliance_period months from today\n      WHEN pla.last_visit IS NOT NULL\n        AND pla.last_visit &gt;= (CURRENT_DATE - (INTERVAL &#39;1 month&#39; * psm.compliance_period))\n        THEN &#39;compliant&#39;\n      -- Eligible: last visit between compliance_period and past_due_period months ago\n      WHEN pla.last_visit IS NOT NULL\n        AND pla.last_visit &gt;= (CURRENT_DATE - (INTERVAL &#39;1 month&#39; * psm.past_due_period))\n        AND pla.last_visit &lt; (CURRENT_DATE - (INTERVAL &#39;1 month&#39; * psm.compliance_period))\n        THEN &#39;eligible&#39;\n      -- Past Due: last visit older than past_due_period OR no visit at all\n      ELSE &#39;past_due&#39;\n    END AS category\n  FROM patient_segment_match psm\n  LEFT JOIN patient_last_appointments pla\n    ON pla.segment_id = psm.segment_id\n    AND pla.patient_id = psm.patient_id\n)\n\nSELECT\n  c.segment_id AS id,\n  c.segment_name AS name,\n  COUNT(DISTINCT c.patient_id) AS total_patients,\n  COUNT(DISTINCT CASE WHEN c.category = &#39;compliant&#39; THEN c.patient_id END) AS compliant_patients,\n  COUNT(DISTINCT CASE WHEN c.category = &#39;eligible&#39;  THEN c.patient_id END) AS eligible_patients,\n  COUNT(DISTINCT CASE WHEN c.category = &#39;past_due&#39;  THEN c.patient_id END) AS past_due_patients,\n  (MAX(c.amount) * (\n    COUNT(DISTINCT CASE WHEN c.category IN (&#39;eligible&#39;,&#39;past_due&#39;) THEN c.patient_id END)\n  ))::numeric(18,2) AS lost_amount\nFROM categorized c\nGROUP BY c.segment_id, c.segment_name\nORDER BY c.segment_name;\n&quot;)</span></span><table id='context152' class='context' style='display:none'><caption>app/services/patient_segment_service.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>131</pre>
          </td>
          <td class='context'>
            <pre class='context'>      FROM categorized c</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>132</pre>
            </td>
            <td class='context'>
              <pre class='context'>      GROUP BY c.segment_id, c.segment_name</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>133</pre>
            </td>
            <td class='context'>
              <pre class='context'>      ORDER BY c.segment_name;</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>134</pre>
            </td>
            <td class='context'>
              <pre class='context'>    SQL</pre>
            </td>
          </tr>
          <tr class='context error'>
            <td class='context_line'>
              <pre class='context'>136</pre>
            </td>
            <td class='context'>
              <pre class='context'>    ActiveRecord::Base.connection.exec_query(sql)</pre>
            </td>
          </tr>
          <tr class='context alt near_error'>
            <td class='context_line'>
              <pre class='context'>137</pre>
            </td>
            <td class='context'>
              <pre class='context'>  end</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>139</pre>
            </td>
            <td class='context'>
              <pre class='context'>  def self.cpt_summary(segment_ids, office_ids = [])</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>140</pre>
            </td>
            <td class='context'>
              <pre class='context'>    return [] if segment_ids.empty?</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>PatientSegmentService</td>
      <td>s(:self).cpt_summary</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context153');toggle('message153');toggle('full_message153')" ><span id='message153' style='display:block'>Possible SQL injection near line 300: ...</span><span id='full_message153' style='display:none'>Possible SQL injection near line 300: <span class="code">ActiveRecord::Base.connection.exec_query(&quot;WITH RECURSIVE\n-- Get segment age filters\nsegment_age_filters AS (\n  SELECT\n    sf.disease_segment_id AS segment_id,\n    sf.filter_min::integer AS age_min,\n    sf.filter_max::integer AS age_max\n  FROM segment_filters sf\n  WHERE sf.disease_segment_id IN (#{<span class="user_input">segment_ids.join(&quot;,&quot;)</span>})\n    AND sf.filter_type = &#39;age&#39;\n),\n\n-- Get all patients for the office(s) with age calculation\nall_office_patients AS (\n  SELECT DISTINCT\n    p.id AS patient_id,\n    EXTRACT(YEAR FROM AGE(CURRENT_DATE, p.birthdate))::integer AS patient_age\n  FROM mv_patients p\n  WHERE 1=1\n    #{office_ids.any? ? (&quot;AND p.office_id IN (#{office_ids.join(&quot;,&quot;)})&quot;) : (&quot;&quot;)}\n    AND p.birthdate IS NOT NULL\n),\n\n-- Pre-split cpt codes\nsegment_cpt_codes AS (\n  SELECT\n    ds.id AS segment_id,\n    ds.name AS segment_name,\n    ds.amount,\n    ds.compliance_period,\n    ds.past_due_period,\n    trim(cpt_code) AS cpt_code\n  FROM disease_segments ds\n  CROSS JOIN LATERAL regexp_split_to_table(ds.cpt_codes, &#39;,&#39;) AS cpt_code\n  WHERE ds.id IN (#{<span class="user_input">segment_ids.join(&quot;,&quot;)</span>})\n    AND ds.cpt_codes IS NOT NULL\n    AND ds.cpt_codes != &#39;&#39;\n),\n\n-- Filter patients by age criteria for each segment\npatients_in_age_range AS (\n  SELECT DISTINCT\n    scc.segment_id,\n    scc.segment_name,\n    scc.amount,\n    scc.compliance_period,\n    scc.past_due_period,\n    aop.patient_id,\n    aop.patient_age\n  FROM all_office_patients aop\n  CROSS JOIN (\n    SELECT DISTINCT\n      segment_id,\n      segment_name,\n      amount,\n      compliance_period,\n      past_due_period\n    FROM segment_cpt_codes\n  ) scc\n  LEFT JOIN segment_age_filters saf ON saf.segment_id = scc.segment_id\n  WHERE (\n    saf.segment_id IS NULL  -- No age filter for this segment\n    OR (\n      aop.patient_age &gt;= saf.age_min\n      AND (\n        saf.age_max IS NULL\n        OR aop.patient_age &lt;= saf.age_max\n      )\n    )\n  )\n),\n\n-- Get patients who purchased matching CPT codes (with age filter applied)\npatient_segment_match AS (\n  SELECT DISTINCT\n    scc.segment_id,\n    scc.segment_name,\n    scc.amount,\n    scc.compliance_period,\n    scc.past_due_period,\n    p.id AS patient_id,\n    pur.id AS purchase_id,\n    pur.appointment_id,\n    scc.cpt_code\n  FROM segment_cpt_codes scc\n  JOIN purchases pur ON pur.fields-&gt;&gt;&#39;cpt4_code_id&#39; = scc.cpt_code\n  JOIN mv_patients p ON p.id = pur.patient_id\n  LEFT JOIN segment_age_filters saf ON saf.segment_id = scc.segment_id\n  WHERE 1=1\n    #{office_ids.any? ? (&quot;AND p.office_id IN (#{office_ids.join(&quot;,&quot;)})&quot;) : (&quot;&quot;)}\n    -- Apply age filter if exists for this segment\n    AND (\n      saf.segment_id IS NULL  -- No age filter for this segment\n      OR (\n        EXTRACT(YEAR FROM AGE(CURRENT_DATE, p.birthdate))::integer &gt;= saf.age_min\n        AND (\n          saf.age_max IS NULL\n          OR EXTRACT(YEAR FROM AGE(CURRENT_DATE, p.birthdate))::integer &lt;= saf.age_max\n        )\n      )\n    )\n),\n\n-- Get last appointment with matching CPT code\npatient_last_appointments AS (\n  SELECT\n    psm.segment_id,\n    psm.patient_id,\n    MAX(a.appt_at) AS last_visit\n  FROM patient_segment_match psm\n  JOIN purchases pur ON pur.patient_id = psm.patient_id\n    AND pur.fields-&gt;&gt;&#39;cpt4_code_id&#39; = psm.cpt_code\n  JOIN appointments a ON a.id = pur.appointment_id\n  GROUP BY psm.segment_id, psm.patient_id\n),\n\n-- Categorize ALL patients in age range for each segment\ncategorized AS (\n  SELECT\n    piar.segment_id,\n    piar.segment_name,\n    piar.amount,\n    piar.compliance_period,\n    piar.past_due_period,\n    piar.patient_id,\n    COALESCE(pla.last_visit, NULL) AS last_visit,\n    CASE\n      WHEN pla.last_visit IS NOT NULL\n        AND pla.last_visit &gt;= (CURRENT_DATE - (INTERVAL &#39;1 month&#39; * piar.compliance_period))\n        THEN &#39;compliant&#39;\n      WHEN pla.last_visit IS NOT NULL\n        AND pla.last_visit &gt;= (CURRENT_DATE - (INTERVAL &#39;1 month&#39; * piar.past_due_period))\n        AND pla.last_visit &lt; (CURRENT_DATE - (INTERVAL &#39;1 month&#39; * piar.compliance_period))\n        THEN &#39;eligible&#39;\n      ELSE &#39;past_due&#39;\n    END AS category\n  FROM patients_in_age_range piar\n  LEFT JOIN patient_last_appointments pla\n    ON pla.segment_id = piar.segment_id\n    AND pla.patient_id = piar.patient_id\n)\n\nSELECT\n  c.segment_id AS id,\n  c.segment_name AS name,\n  COUNT(DISTINCT c.patient_id) AS total_patients,\n  COUNT(DISTINCT CASE WHEN c.category = &#39;compliant&#39; THEN c.patient_id END) AS compliant_patients,\n  COUNT(DISTINCT CASE WHEN c.category = &#39;eligible&#39;  THEN c.patient_id END) AS eligible_patients,\n  COUNT(DISTINCT CASE WHEN c.category = &#39;past_due&#39;  THEN c.patient_id END) AS past_due_patients,\n  (MAX(c.amount) * (\n    COUNT(DISTINCT CASE WHEN c.category IN (&#39;eligible&#39;,&#39;past_due&#39;) THEN c.patient_id END)\n  ))::numeric(18,2) AS lost_amount\nFROM categorized c\nGROUP BY c.segment_id, c.segment_name\nORDER BY c.segment_name;\n&quot;)</span></span><table id='context153' class='context' style='display:none'><caption>app/services/patient_segment_service.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>295</pre>
          </td>
          <td class='context'>
            <pre class='context'>      FROM categorized c</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>296</pre>
            </td>
            <td class='context'>
              <pre class='context'>      GROUP BY c.segment_id, c.segment_name</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>297</pre>
            </td>
            <td class='context'>
              <pre class='context'>      ORDER BY c.segment_name;</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>298</pre>
            </td>
            <td class='context'>
              <pre class='context'>    SQL</pre>
            </td>
          </tr>
          <tr class='context error'>
            <td class='context_line'>
              <pre class='context'>300</pre>
            </td>
            <td class='context'>
              <pre class='context'>    ActiveRecord::Base.connection.exec_query(sql)</pre>
            </td>
          </tr>
          <tr class='context alt near_error'>
            <td class='context_line'>
              <pre class='context'>301</pre>
            </td>
            <td class='context'>
              <pre class='context'>  end</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>303</pre>
            </td>
            <td class='context'>
              <pre class='context'>  # Optional: get patient list for one segment (same as before)</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>304</pre>
            </td>
            <td class='context'>
              <pre class='context'>  def self.list(segment)</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>305</pre>
            </td>
            <td class='context'>
              <pre class='context'>    dx_patterns = regex_patterns(segment.dx_codes)</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>PatientSegmentService</td>
      <td>s(:self).list</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context154');toggle('message154');toggle('full_message154')" >Possible SQL injection near line 313: <span class="code">ActiveRecord::Base.connection.exec_query(&quot;SELECT DISTINCT p.id, p.f_name, p.l_name\nFROM patient_dx_codes d\nJOIN patient p ON p.id = d.patient_id\nWHERE #{<span class="user_input">regex_patterns(segment.dx_codes).map do  &quot;d.dx_code ~ &#39;#{p}&#39;&quot;  end.join(&quot; OR &quot;)</span>}\nORDER BY p.l_name, p.f_name\n&quot;)</span><table id='context154' class='context' style='display:none'><caption>app/services/patient_segment_service.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>308</pre>
          </td>
          <td class='context'>
            <pre class='context'>      FROM patient_dx_codes d</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>309</pre>
            </td>
            <td class='context'>
              <pre class='context'>      JOIN patient p ON p.id = d.patient_id</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>310</pre>
            </td>
            <td class='context'>
              <pre class='context'>      WHERE #{dx_patterns.map { |p| &quot;d.dx_code ~ &#39;#{p}&#39;&quot; }.join(&#39; OR &#39;)}</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>311</pre>
            </td>
            <td class='context'>
              <pre class='context'>      ORDER BY p.l_name, p.f_name</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>312</pre>
            </td>
            <td class='context'>
              <pre class='context'>    SQL</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>313</pre>
            </td>
            <td class='context'>
              <pre class='context'>    ActiveRecord::Base.connection.exec_query(sql)</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>314</pre>
            </td>
            <td class='context'>
              <pre class='context'>  end</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>316</pre>
            </td>
            <td class='context'>
              <pre class='context'>  def self.monthly_trend(segment_id, office_ids, months_back = 6)</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>317</pre>
            </td>
            <td class='context'>
              <pre class='context'>    segment = DiseaseSegment.find(segment_id)</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>PatientSegmentService</td>
      <td>s(:self).dx_monthly_trend</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context155');toggle('message155');toggle('full_message155')" ><span id='message155' style='display:block'>Possible SQL injection near line 527: ...</span><span id='full_message155' style='display:none'>Possible SQL injection near line 527: <span class="code">ActiveRecord::Base.connection.exec_query(&quot;-- Optimized Trend Report with Age Filtering and Messaging Stats\nWITH RECURSIVE\n-- Get segment filters (age ranges)\nsegment_age_filters AS (\n  SELECT\n    sf.disease_segment_id AS segment_id,\n    sf.filter_min::integer AS age_min,\n    sf.filter_max::integer AS age_max\n  FROM segment_filters sf\n  WHERE sf.disease_segment_id = #{<span class="user_input">segment_id</span>}\n    AND sf.filter_type = &#39;age&#39;\n),\n\n-- Generate months\nmonths AS (\n  SELECT\n    date_trunc(&#39;month&#39;, CURRENT_DATE) - INTERVAL &#39;1 month&#39; * n AS month_start,\n    CASE\n      WHEN date_trunc(&#39;month&#39;, CURRENT_DATE) - INTERVAL &#39;1 month&#39; * n = date_trunc(&#39;month&#39;, CURRENT_DATE)\n        THEN CURRENT_DATE\n      ELSE\n        (date_trunc(&#39;month&#39;, CURRENT_DATE) - INTERVAL &#39;1 month&#39; * n) + INTERVAL &#39;1 month&#39; - INTERVAL &#39;1 day&#39;\n    END AS reference_date\n  FROM generate_series(0, #{(months_back.to_i - 1)}, 1) AS n\n),\n\n-- Pre-split dx codes once\nsegment_dx_codes AS (\n  SELECT\n    ds.id AS segment_id,\n    ds.name AS segment_name,\n    ds.amount,\n    ds.compliance_period,\n    ds.past_due_period,\n    ds.query_type_id,\n    trim(dx_code) AS dx_code\n  FROM disease_segments ds\n  CROSS JOIN LATERAL regexp_split_to_table(ds.dx_codes, &#39;,&#39;) AS dx_code\n  WHERE ds.id IN (#{<span class="user_input">segment_id</span>})\n    AND ds.dx_codes IS NOT NULL\n    AND ds.dx_codes != &#39;&#39;\n),\n\n-- Get all matching patients once with age filtering\nsegment_patients AS (\n  SELECT DISTINCT\n    sdc.segment_id,\n    sdc.segment_name,\n    sdc.amount,\n    sdc.compliance_period,\n    sdc.past_due_period,\n    sdc.query_type_id,\n    p.id AS patient_id,\n    p.phone_text AS patient_phone,\n    MIN(pdx.date_onset_sypmt) AS dx_onset_sypmt,\n    array_agg(DISTINCT pdx.id) AS patient_dx_code_ids\n  FROM segment_dx_codes sdc\n  JOIN patient_dx_codes pdx ON pdx.dx_code LIKE sdc.dx_code || &#39;%&#39;\n  JOIN mv_patients p ON p.id = pdx.patient_id\n  LEFT JOIN segment_age_filters saf ON saf.segment_id = sdc.segment_id\n  WHERE 1=1\n    #{office_ids.any? ? (&quot;AND p.office_id IN (#{office_ids.join(&quot;,&quot;)})&quot;) : (&quot;&quot;)}\n    -- Apply age filter if exists for this segment\n    AND (\n      saf.segment_id IS NULL  -- No age filter for this segment\n      OR (\n        EXTRACT(YEAR FROM AGE(CURRENT_DATE, p.birthdate))::integer &gt;= saf.age_min\n        AND (\n          saf.age_max IS NULL\n          OR EXTRACT(YEAR FROM AGE(CURRENT_DATE, p.birthdate))::integer &lt;= saf.age_max\n        )\n      )\n    )\n  GROUP BY sdc.segment_id, sdc.segment_name, sdc.amount, sdc.compliance_period, sdc.past_due_period, sdc.query_type_id, p.id, p.phone_text\n),\n\n-- Get ALL appointments for segment patients at once (instead of per-month subquery)\npatient_appointments AS (\n  SELECT\n    sp.segment_id,\n    sp.patient_id,\n    a.appt_at,\n    a.id AS appointment_id\n  FROM segment_patients sp\n  JOIN appointment_patient_dx_codes apdx ON apdx.patient_dx_codes_id = ANY(sp.patient_dx_code_ids)\n  JOIN appointments a ON a.id = apdx.appointment_id AND a.patient_id = sp.patient_id\n),\n\n-- For each patient-month combination, calculate last visit\npatient_month_status AS (\n  SELECT\n    sp.segment_id,\n    sp.segment_name,\n    sp.amount,\n    sp.compliance_period,\n    sp.past_due_period,\n    sp.query_type_id,\n    sp.patient_id,\n    sp.patient_phone,\n    sp.dx_onset_sypmt,\n    m.month_start,\n    m.reference_date,\n    (\n      SELECT MAX(pa.appt_at)\n      FROM patient_appointments pa\n      WHERE pa.segment_id = sp.segment_id\n        AND pa.patient_id = sp.patient_id\n        AND pa.appt_at &lt;= m.reference_date\n    ) AS last_visit\n  FROM segment_patients sp\n  CROSS JOIN months m\n  WHERE sp.dx_onset_sypmt IS NULL OR sp.dx_onset_sypmt &lt;= m.reference_date\n),\n\n-- Categorize\ncategorized AS (\n  SELECT\n    pms.segment_id,\n    pms.segment_name,\n    pms.amount,\n    pms.compliance_period,\n    pms.past_due_period,\n    pms.query_type_id,\n    pms.patient_id,\n    pms.patient_phone,\n    pms.month_start,\n    pms.reference_date,\n    pms.last_visit,\n    CASE\n      WHEN pms.last_visit IS NOT NULL\n        AND pms.last_visit &gt;= (pms.reference_date - (INTERVAL &#39;1 month&#39; * pms.compliance_period))\n        THEN &#39;compliant&#39;\n      WHEN pms.last_visit IS NOT NULL\n        AND pms.last_visit &gt;= (pms.reference_date - (INTERVAL &#39;1 month&#39; * pms.past_due_period))\n        AND pms.last_visit &lt; (pms.reference_date - (INTERVAL &#39;1 month&#39; * pms.compliance_period))\n        THEN &#39;eligible&#39;\n      ELSE &#39;past_due&#39;\n    END AS category\n  FROM patient_month_status pms\n),\n\n-- Get messaging stats for each month\nmessaging_stats AS (\n  SELECT\n    c.month_start,\n    c.query_type_id,\n    COUNT(DISTINCT CASE\n      WHEN mod.processed_at &gt;= c.month_start\n        AND mod.processed_at &lt; c.month_start + INTERVAL &#39;1 month&#39;\n      THEN c.patient_id\n    END) AS messaged_patients,\n    COUNT(DISTINCT CASE\n      WHEN mod.processed_at &gt;= c.month_start\n        AND mod.processed_at &lt; c.month_start + INTERVAL &#39;1 month&#39;\n        AND c.category = &#39;eligible&#39;\n      THEN c.patient_id\n    END) AS messaged_eligible_patients,\n    COUNT(DISTINCT CASE\n      WHEN mod.processed_at &gt;= c.month_start\n        AND mod.processed_at &lt; c.month_start + INTERVAL &#39;1 month&#39;\n        AND c.category = &#39;past_due&#39;\n      THEN c.patient_id\n    END) AS messaged_past_due_patients\n  FROM categorized c\n  LEFT JOIN nudges n ON n.query_type_id = c.query_type_id\n  LEFT JOIN touch_steps ts ON ts.nudge_id = n.id\n  LEFT JOIN message_out_details mod ON mod.touch_step_id = ts.id\n    AND mod.to = c.patient_phone\n  WHERE c.query_type_id IS NOT NULL\n  GROUP BY c.month_start, c.query_type_id\n)\n\nSELECT\n  TO_CHAR(c.month_start, &#39;YYYY-MM&#39;) AS month,\n  c.compliance_period,\n  c.past_due_period,\n  COUNT(DISTINCT c.patient_id) AS total_patients,\n  COUNT(DISTINCT CASE WHEN c.category = &#39;compliant&#39; THEN c.patient_id END) AS compliant_patients,\n  COUNT(DISTINCT CASE WHEN c.category = &#39;eligible&#39;  THEN c.patient_id END) AS eligible_patients,\n  COUNT(DISTINCT CASE WHEN c.category = &#39;past_due&#39;  THEN c.patient_id END) AS past_due_patients,\n  (MAX(c.amount) * (\n    COUNT(DISTINCT CASE WHEN c.category IN (&#39;eligible&#39;,&#39;past_due&#39;) THEN c.patient_id END)\n  ))::NUMERIC(18,2) AS lost_amount,\n  COALESCE(MAX(ms.messaged_patients), 0) AS messaged_patients,\n  COALESCE(MAX(ms.messaged_eligible_patients), 0) AS messaged_eligible_patients,\n  COALESCE(MAX(ms.messaged_past_due_patients), 0) AS messaged_past_due_patients\nFROM categorized c\nLEFT JOIN messaging_stats ms ON ms.month_start = c.month_start AND ms.query_type_id = c.query_type_id\nGROUP BY c.month_start, c.compliance_period, c.past_due_period\nORDER BY c.month_start;\n&quot;)</span></span><table id='context155' class='context' style='display:none'><caption>app/services/patient_segment_service.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>522</pre>
          </td>
          <td class='context'>
            <pre class='context'>      LEFT JOIN messaging_stats ms ON ms.month_start = c.month_start AND ms.query_type_id = c.query_type_id</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>523</pre>
            </td>
            <td class='context'>
              <pre class='context'>      GROUP BY c.month_start, c.compliance_period, c.past_due_period</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>524</pre>
            </td>
            <td class='context'>
              <pre class='context'>      ORDER BY c.month_start;</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>525</pre>
            </td>
            <td class='context'>
              <pre class='context'>    SQL</pre>
            </td>
          </tr>
          <tr class='context error'>
            <td class='context_line'>
              <pre class='context'>527</pre>
            </td>
            <td class='context'>
              <pre class='context'>    ActiveRecord::Base.connection.exec_query(sql)</pre>
            </td>
          </tr>
          <tr class='context alt near_error'>
            <td class='context_line'>
              <pre class='context'>528</pre>
            </td>
            <td class='context'>
              <pre class='context'>  end</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>530</pre>
            </td>
            <td class='context'>
              <pre class='context'>  def self.cpt_monthly_trend(segment_id, office_ids, months_back = 6)</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>531</pre>
            </td>
            <td class='context'>
              <pre class='context'>    segment = DiseaseSegment.find(segment_id)</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>PatientSegmentService</td>
      <td>s(:self).cpt_monthly_trend</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context156');toggle('message156');toggle('full_message156')" ><span id='message156' style='display:block'>Possible SQL injection near line 756: ...</span><span id='full_message156' style='display:none'>Possible SQL injection near line 756: <span class="code">ActiveRecord::Base.connection.exec_query(&quot;-- CPT-based Trend Report with Age Filtering and Messaging Stats\nWITH RECURSIVE\n-- Get segment age filters\nsegment_age_filters AS (\n  SELECT\n    sf.disease_segment_id AS segment_id,\n    sf.filter_min::integer AS age_min,\n    sf.filter_max::integer AS age_max\n  FROM segment_filters sf\n  WHERE sf.disease_segment_id = #{<span class="user_input">segment_id</span>}\n    AND sf.filter_type = &#39;age&#39;\n),\n\n-- Generate months\nmonths AS (\n  SELECT\n    date_trunc(&#39;month&#39;, CURRENT_DATE) - INTERVAL &#39;1 month&#39; * n AS month_start,\n    CASE\n      WHEN date_trunc(&#39;month&#39;, CURRENT_DATE) - INTERVAL &#39;1 month&#39; * n = date_trunc(&#39;month&#39;, CURRENT_DATE)\n        THEN CURRENT_DATE\n      ELSE\n        (date_trunc(&#39;month&#39;, CURRENT_DATE) - INTERVAL &#39;1 month&#39; * n) + INTERVAL &#39;1 month&#39; - INTERVAL &#39;1 day&#39;\n    END AS reference_date\n  FROM generate_series(0, #{(months_back.to_i - 1)}, 1) AS n\n),\n\n-- Get all patients for the office(s) with age calculation\nall_office_patients AS (\n  SELECT DISTINCT\n    p.id AS patient_id,\n    p.phone_text AS patient_phone,\n    p.created_at,\n    EXTRACT(YEAR FROM AGE(CURRENT_DATE, p.birthdate))::integer AS patient_age\n  FROM mv_patients p\n  WHERE 1=1\n    #{office_ids.any? ? (&quot;AND p.office_id IN (#{office_ids.join(&quot;,&quot;)})&quot;) : (&quot;&quot;)}\n    AND p.birthdate IS NOT NULL\n),\n\n-- Pre-split cpt codes once\nsegment_cpt_codes AS (\n  SELECT\n    ds.id AS segment_id,\n    ds.name AS segment_name,\n    ds.amount,\n    ds.compliance_period,\n    ds.past_due_period,\n    ds.query_type_id,\n    trim(cpt_code) AS cpt_code\n  FROM disease_segments ds\n  CROSS JOIN LATERAL regexp_split_to_table(ds.cpt_codes, &#39;,&#39;) AS cpt_code\n  WHERE ds.id = #{<span class="user_input">segment_id</span>}\n    AND ds.cpt_codes IS NOT NULL\n    AND ds.cpt_codes != &#39;&#39;\n),\n\n-- Get segment details\nsegment_details AS (\n  SELECT DISTINCT\n    segment_id,\n    segment_name,\n    amount,\n    compliance_period,\n    past_due_period,\n    query_type_id\n  FROM segment_cpt_codes\n  LIMIT 1\n),\n\n-- Filter patients by age criteria\npatients_in_age_range AS (\n  SELECT\n    aop.patient_id,\n    aop.patient_phone,\n    aop.created_at,\n    aop.patient_age\n  FROM all_office_patients aop\n  LEFT JOIN segment_age_filters saf ON saf.segment_id = #{<span class="user_input">segment_id</span>}\n  WHERE (\n    saf.segment_id IS NULL  -- No age filter for this segment\n    OR (\n      aop.patient_age &gt;= saf.age_min\n      AND (\n        saf.age_max IS NULL\n        OR aop.patient_age &lt;= saf.age_max\n      )\n    )\n  )\n),\n\n-- Get CPT purchases for patients in age range\npatient_cpt_purchases AS (\n  SELECT DISTINCT\n    piar.patient_id,\n    piar.patient_phone,\n    piar.created_at,\n    scc.cpt_code,\n    MIN(pur.purchased_at) AS first_purchase_date,\n    array_agg(DISTINCT pur.id) AS purchase_ids\n  FROM patients_in_age_range piar\n  CROSS JOIN segment_cpt_codes scc\n  LEFT JOIN purchases pur ON pur.fields-&gt;&gt;&#39;cpt4_code_id&#39; = scc.cpt_code\n    AND pur.patient_id = piar.patient_id\n  WHERE pur.id IS NOT NULL\n  GROUP BY piar.patient_id, piar.patient_phone, piar.created_at, scc.cpt_code\n),\n\n-- Get ALL appointments with matching CPT purchases\npatient_appointments AS (\n  SELECT\n    pcp.patient_id,\n    a.appt_at,\n    a.id AS appointment_id\n  FROM patient_cpt_purchases pcp\n  JOIN purchases pur ON pur.patient_id = pcp.patient_id\n    AND pur.fields-&gt;&gt;&#39;cpt4_code_id&#39; = pcp.cpt_code\n  JOIN appointments a ON a.id = pur.appointment_id\n),\n\n-- For each patient-month combination, calculate last visit\npatient_month_status AS (\n  SELECT\n    sd.segment_id,\n    sd.segment_name,\n    sd.amount,\n    sd.compliance_period,\n    sd.past_due_period,\n    sd.query_type_id,\n    piar.patient_id,\n    piar.patient_phone,\n    m.month_start,\n    m.reference_date,\n    (\n      SELECT MAX(pa.appt_at)\n      FROM patient_appointments pa\n      WHERE pa.patient_id = piar.patient_id\n        AND pa.appt_at &lt;= m.reference_date\n    ) AS last_visit\n  FROM patients_in_age_range piar\n  CROSS JOIN segment_details sd\n  CROSS JOIN months m\n  WHERE piar.created_at &lt;= m.reference_date\n),\n\n-- Categorize\ncategorized AS (\n  SELECT\n    pms.segment_id,\n    pms.segment_name,\n    pms.amount,\n    pms.compliance_period,\n    pms.past_due_period,\n    pms.query_type_id,\n    pms.patient_id,\n    pms.patient_phone,\n    pms.month_start,\n    pms.reference_date,\n    pms.last_visit,\n    CASE\n      WHEN pms.last_visit IS NOT NULL\n        AND pms.last_visit &gt;= (pms.reference_date - (INTERVAL &#39;1 month&#39; * pms.compliance_period))\n        THEN &#39;compliant&#39;\n      WHEN pms.last_visit IS NOT NULL\n        AND pms.last_visit &gt;= (pms.reference_date - (INTERVAL &#39;1 month&#39; * pms.past_due_period))\n        AND pms.last_visit &lt; (pms.reference_date - (INTERVAL &#39;1 month&#39; * pms.compliance_period))\n        THEN &#39;eligible&#39;\n      ELSE &#39;past_due&#39;\n    END AS category\n  FROM patient_month_status pms\n),\n\n-- Get messaging stats for each month\nmessaging_stats AS (\n  SELECT\n    c.month_start,\n    c.query_type_id,\n    COUNT(DISTINCT CASE\n      WHEN mod.processed_at &gt;= c.month_start\n        AND mod.processed_at &lt; c.month_start + INTERVAL &#39;1 month&#39;\n      THEN c.patient_id\n    END) AS messaged_patients,\n    COUNT(DISTINCT CASE\n      WHEN mod.processed_at &gt;= c.month_start\n        AND mod.processed_at &lt; c.month_start + INTERVAL &#39;1 month&#39;\n        AND c.category = &#39;eligible&#39;\n      THEN c.patient_id\n    END) AS messaged_eligible_patients,\n    COUNT(DISTINCT CASE\n      WHEN mod.processed_at &gt;= c.month_start\n        AND mod.processed_at &lt; c.month_start + INTERVAL &#39;1 month&#39;\n        AND c.category = &#39;past_due&#39;\n      THEN c.patient_id\n    END) AS messaged_past_due_patients\n  FROM categorized c\n  LEFT JOIN nudges n ON n.query_type_id = c.query_type_id\n  LEFT JOIN touch_steps ts ON ts.nudge_id = n.id\n  LEFT JOIN message_out_details mod ON mod.touch_step_id = ts.id\n    AND mod.to = c.patient_phone\n  WHERE c.query_type_id IS NOT NULL\n  GROUP BY c.month_start, c.query_type_id\n)\n\nSELECT\n  TO_CHAR(c.month_start, &#39;YYYY-MM&#39;) AS month,\n  c.compliance_period,\n  c.past_due_period,\n  COUNT(DISTINCT c.patient_id) AS total_patients,\n  COUNT(DISTINCT CASE WHEN c.category = &#39;compliant&#39; THEN c.patient_id END) AS compliant_patients,\n  COUNT(DISTINCT CASE WHEN c.category = &#39;eligible&#39;  THEN c.patient_id END) AS eligible_patients,\n  COUNT(DISTINCT CASE WHEN c.category = &#39;past_due&#39;  THEN c.patient_id END) AS past_due_patients,\n  (MAX(c.amount) * (\n    COUNT(DISTINCT CASE WHEN c.category IN (&#39;eligible&#39;,&#39;past_due&#39;) THEN c.patient_id END)\n  ))::NUMERIC(18,2) AS lost_amount,\n  COALESCE(MAX(ms.messaged_patients), 0) AS messaged_patients,\n  COALESCE(MAX(ms.messaged_eligible_patients), 0) AS messaged_eligible_patients,\n  COALESCE(MAX(ms.messaged_past_due_patients), 0) AS messaged_past_due_patients\nFROM categorized c\nLEFT JOIN messaging_stats ms ON ms.month_start = c.month_start AND ms.query_type_id = c.query_type_id\nGROUP BY c.month_start, c.compliance_period, c.past_due_period\nORDER BY c.month_start;\n&quot;)</span></span><table id='context156' class='context' style='display:none'><caption>app/services/patient_segment_service.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>751</pre>
          </td>
          <td class='context'>
            <pre class='context'>      LEFT JOIN messaging_stats ms ON ms.month_start = c.month_start AND ms.query_type_id = c.query_type_id</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>752</pre>
            </td>
            <td class='context'>
              <pre class='context'>      GROUP BY c.month_start, c.compliance_period, c.past_due_period</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>753</pre>
            </td>
            <td class='context'>
              <pre class='context'>      ORDER BY c.month_start;</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>754</pre>
            </td>
            <td class='context'>
              <pre class='context'>    SQL</pre>
            </td>
          </tr>
          <tr class='context error'>
            <td class='context_line'>
              <pre class='context'>756</pre>
            </td>
            <td class='context'>
              <pre class='context'>    ActiveRecord::Base.connection.exec_query(sql)</pre>
            </td>
          </tr>
          <tr class='context alt near_error'>
            <td class='context_line'>
              <pre class='context'>757</pre>
            </td>
            <td class='context'>
              <pre class='context'>  end</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>759</pre>
            </td>
            <td class='context'>
              <pre class='context'>  def self.average_data(trend_data)</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>760</pre>
            </td>
            <td class='context'>
              <pre class='context'>    trend_results = trend_data.to_a</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>761</pre>
            </td>
            <td class='context'>
              <pre class='context'>    return {} if trend_results.empty?</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>PatientSegmentService</td>
      <td>s(:self).dx_segment_patients_by_category</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context157');toggle('message157');toggle('full_message157')" ><span id='message157' style='display:block'>Possible SQL injection near line 921: ...</span><span id='full_message157' style='display:none'>Possible SQL injection near line 921: <span class="code">ActiveRecord::Base.connection.exec_query(&quot;-- Optimized Summary Report with Age Filtering\nWITH RECURSIVE\n-- Get segment filters (age ranges)\nsegment_age_filters AS (\n  SELECT\n    sf.disease_segment_id AS segment_id,\n    sf.filter_min::integer AS age_min,\n    CASE WHEN sf.filter_max IS NOT NULL AND sf.filter_max != &#39;&#39;\n        THEN sf.filter_max::integer\n        ELSE NULL\n    END AS age_max\n  FROM segment_filters sf\n  WHERE sf.disease_segment_id = #{<span class="user_input">segment_id</span>}\n    AND sf.filter_type = &#39;age&#39;\n),\n\n-- Pre-split dx codes once (reusable)\nsegment_dx_codes AS (\n  SELECT\n    ds.id AS segment_id,\n    ds.name AS segment_name,\n    ds.amount,\n    ds.compliance_period,\n    ds.past_due_period,\n    trim(dx_code) AS dx_code\n  FROM disease_segments ds\n  CROSS JOIN LATERAL regexp_split_to_table(ds.dx_codes, &#39;,&#39;) AS dx_code\n  WHERE ds.id IN (#{<span class="user_input">segment_id</span>})\n    AND ds.dx_codes IS NOT NULL\n    AND ds.dx_codes != &#39;&#39;\n),\n\n-- Get all matching patient-dx combinations with age filtering\npatient_segment_match AS (\n  SELECT\n    sdc.segment_id,\n    sdc.segment_name,\n    sdc.amount,\n    sdc.compliance_period,\n    sdc.past_due_period,\n    p.id AS patient_id,\n    p.f_name,\n    p.l_name,\n    p.source_id,\n    p.phone_text,\n    p.birthdate,\n    o.id AS office_id,\n    o.name AS office_name,\n    string_agg(DISTINCT pdx.dx_code, &#39;, &#39; ORDER BY pdx.dx_code) AS dx_codes,\n    MIN(pdx.date_onset_sypmt) AS earliest_diagnosis_date,\n    array_agg(DISTINCT pdx.id) AS patient_dx_code_ids\n  FROM segment_dx_codes sdc\n  JOIN patient_dx_codes pdx ON pdx.dx_code LIKE sdc.dx_code || &#39;%&#39;\n  JOIN mv_patients p ON p.id = pdx.patient_id\n  JOIN offices o ON o.id = p.office_id\n  LEFT JOIN segment_age_filters saf ON saf.segment_id = sdc.segment_id\n  WHERE 1=1\n    #{office_ids.any? ? (&quot;AND p.office_id IN (#{office_ids.join(&quot;,&quot;)})&quot;) : (&quot;&quot;)}\n    -- Apply age filter if exists for this segment\n    AND (\n      saf.segment_id IS NULL  -- No age filter for this segment\n      OR (\n        EXTRACT(YEAR FROM AGE(CURRENT_DATE, p.birthdate))::integer &gt;= saf.age_min\n        AND (\n          saf.age_max IS NULL\n          OR EXTRACT(YEAR FROM AGE(CURRENT_DATE, p.birthdate))::integer &lt;= saf.age_max\n        )\n      )\n    )\n  GROUP BY\n    sdc.segment_id, sdc.segment_name, sdc.amount,\n    sdc.compliance_period, sdc.past_due_period,\n    p.id, p.f_name, p.l_name, p.source_id, p.phone_text,\n    p.birthdate, o.id, o.name\n),\n\n-- Get last appointments efficiently (single scan)\npatient_last_appointments AS (\n  SELECT\n    psm.patient_id,\n    MAX(a.appt_at) AS last_visit\n  FROM patient_segment_match psm\n  CROSS JOIN LATERAL unnest(psm.patient_dx_code_ids) AS pdx_id\n  LEFT JOIN appointment_patient_dx_codes apdx ON apdx.patient_dx_codes_id = pdx_id\n  LEFT JOIN appointments a ON a.id = apdx.appointment_id AND a.patient_id = psm.patient_id\n  GROUP BY psm.patient_id\n),\n\nfuture_appointments AS (\n  SELECT\n    a.patient_id,\n    MIN(a.appt_at) AS appt_at\n  FROM appointments a\n  WHERE a.category IN (&#39;Confirmed&#39;, &#39;Not Confirmed&#39;)\n    AND a.appt_at &gt; now()\n  GROUP BY a.patient_id\n),\n\n-- Combine and categorize\ncategorized AS (\n  SELECT\n    psm.segment_id,\n    psm.segment_name,\n    psm.amount,\n    psm.compliance_period,\n    psm.past_due_period,\n    psm.patient_id,\n    psm.f_name,\n    psm.l_name,\n    psm.source_id,\n    psm.phone_text,\n    psm.birthdate,\n    psm.office_id,\n    psm.office_name,\n    psm.dx_codes,\n    psm.earliest_diagnosis_date,\n    pla.last_visit,\n    fa.appt_at AS future_appt,\n    CASE\n      -- Compliant: last visit within compliance_period months from today\n      WHEN pla.last_visit IS NOT NULL\n        AND pla.last_visit &gt;= (CURRENT_DATE - (INTERVAL &#39;1 month&#39; * psm.compliance_period))\n        THEN &#39;compliant&#39;\n      -- Eligible: last visit between compliance_period and past_due_period months ago\n      WHEN pla.last_visit IS NOT NULL\n        AND pla.last_visit &gt;= (CURRENT_DATE - (INTERVAL &#39;1 month&#39; * psm.past_due_period))\n        AND pla.last_visit &lt; (CURRENT_DATE - (INTERVAL &#39;1 month&#39; * psm.compliance_period))\n        THEN &#39;eligible&#39;\n      -- Past Due: last visit older than past_due_period OR no visit at all\n      ELSE &#39;past_due&#39;\n    END AS category\n  FROM patient_segment_match psm\n  LEFT JOIN patient_last_appointments pla ON pla.patient_id = psm.patient_id\n  LEFT JOIN future_appointments fa ON fa.patient_id = psm.patient_id\n)\n\nSELECT\n  *\nFROM categorized c\nWHERE c.category = &#39;#{category}&#39;\nORDER BY f_name, l_name;\n&quot;)</span></span><table id='context157' class='context' style='display:none'><caption>app/services/patient_segment_service.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>916</pre>
          </td>
          <td class='context'>
            <pre class='context'>      FROM categorized c</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>917</pre>
            </td>
            <td class='context'>
              <pre class='context'>      WHERE c.category = &#39;#{category}&#39;</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>918</pre>
            </td>
            <td class='context'>
              <pre class='context'>      ORDER BY f_name, l_name;</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>919</pre>
            </td>
            <td class='context'>
              <pre class='context'>    SQL</pre>
            </td>
          </tr>
          <tr class='context error'>
            <td class='context_line'>
              <pre class='context'>921</pre>
            </td>
            <td class='context'>
              <pre class='context'>    ActiveRecord::Base.connection.exec_query(sql)</pre>
            </td>
          </tr>
          <tr class='context alt near_error'>
            <td class='context_line'>
              <pre class='context'>922</pre>
            </td>
            <td class='context'>
              <pre class='context'>  end</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>924</pre>
            </td>
            <td class='context'>
              <pre class='context'>  def self.cpt_segment_patients_by_category(segment_id, category, office_ids = [])</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>925</pre>
            </td>
            <td class='context'>
              <pre class='context'>    sql = &lt;&lt;~SQL</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>926</pre>
            </td>
            <td class='context'>
              <pre class='context'>      WITH RECURSIVE</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>PatientSegmentService</td>
      <td>s(:self).cpt_segment_patients_by_category</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context158');toggle('message158');toggle('full_message158')" ><span id='message158' style='display:block'>Possible SQL injection near line 1093: ...</span><span id='full_message158' style='display:none'>Possible SQL injection near line 1093: <span class="code">ActiveRecord::Base.connection.exec_query(&quot;WITH RECURSIVE\n-- Get segment age filters\nsegment_age_filters AS (\n  SELECT\n    sf.disease_segment_id AS segment_id,\n    sf.filter_min::integer AS age_min,\n    sf.filter_max::integer AS age_max\n  FROM segment_filters sf\n  WHERE sf.disease_segment_id = #{<span class="user_input">segment_id</span>}\n    AND sf.filter_type = &#39;age&#39;\n),\n\n-- Get all patients for the office(s) with age calculation\nall_office_patients AS (\n  SELECT DISTINCT\n    p.id AS patient_id,\n    p.f_name,\n    p.l_name,\n    p.source_id,\n    p.phone_text,\n    p.birthdate,\n    p.office_id,\n    o.name AS office_name,\n    EXTRACT(YEAR FROM AGE(CURRENT_DATE, p.birthdate))::integer AS patient_age\n  FROM mv_patients p\n  JOIN offices o ON o.id = p.office_id\n  WHERE 1=1\n    #{office_ids.any? ? (&quot;AND p.office_id IN (#{office_ids.join(&quot;,&quot;)})&quot;) : (&quot;&quot;)}\n    AND p.birthdate IS NOT NULL\n),\n\n-- Pre-split cpt codes\nsegment_cpt_codes AS (\n  SELECT\n    ds.id AS segment_id,\n    ds.name AS segment_name,\n    ds.amount,\n    ds.compliance_period,\n    ds.past_due_period,\n    trim(cpt_code) AS cpt_code\n  FROM disease_segments ds\n  CROSS JOIN LATERAL regexp_split_to_table(ds.cpt_codes, &#39;,&#39;) AS cpt_code\n  WHERE ds.id = #{<span class="user_input">segment_id</span>}\n    AND ds.cpt_codes IS NOT NULL\n    AND ds.cpt_codes != &#39;&#39;\n),\n\n-- Filter patients by age criteria\npatients_in_age_range AS (\n  SELECT\n    aop.patient_id,\n    aop.f_name,\n    aop.l_name,\n    aop.source_id,\n    aop.phone_text,\n    aop.birthdate,\n    aop.office_id,\n    aop.office_name,\n    aop.patient_age\n  FROM all_office_patients aop\n  LEFT JOIN segment_age_filters saf ON saf.segment_id = #{<span class="user_input">segment_id</span>}\n  WHERE (\n    saf.segment_id IS NULL  -- No age filter for this segment\n    OR (\n      aop.patient_age &gt;= saf.age_min\n      AND (\n        saf.age_max IS NULL\n        OR aop.patient_age &lt;= saf.age_max\n      )\n    )\n  )\n),\n\n-- Get segment details (needed for all patients)\nsegment_details AS (\n  SELECT DISTINCT\n    segment_id,\n    segment_name,\n    amount,\n    compliance_period,\n    past_due_period\n  FROM segment_cpt_codes\n  LIMIT 1\n),\n\n-- Get CPT code info for patients who have purchased them\npatient_cpt_purchases AS (\n  SELECT\n    p.patient_id,\n    string_agg(DISTINCT scc.cpt_code, &#39;, &#39; ORDER BY scc.cpt_code) AS cpt_codes,\n    MIN(pur.purchased_at) AS earliest_purchase_date,\n    array_agg(DISTINCT pur.id) AS purchase_ids\n  FROM patients_in_age_range p\n  CROSS JOIN segment_cpt_codes scc\n  LEFT JOIN purchases pur ON pur.fields-&gt;&gt;&#39;cpt4_code_id&#39; = scc.cpt_code\n    AND pur.patient_id = p.patient_id\n  WHERE pur.id IS NOT NULL\n  GROUP BY p.patient_id\n),\n\n-- Get last appointment with matching CPT code\npatient_last_appointments AS (\n  SELECT\n    pcp.patient_id,\n    MAX(a.appt_at) AS last_visit\n  FROM patient_cpt_purchases pcp\n  CROSS JOIN LATERAL unnest(pcp.purchase_ids) AS pur_id\n  JOIN purchases pur ON pur.id = pur_id\n  JOIN appointments a ON a.id = pur.appointment_id\n  GROUP BY pcp.patient_id\n),\n\n-- Get future appointments\nfuture_appointments AS (\n  SELECT\n    a.patient_id,\n    MIN(a.appt_at) AS appt_at\n  FROM appointments a\n  WHERE a.category IN (&#39;Confirmed&#39;, &#39;Not Confirmed&#39;)\n    AND a.appt_at &gt; now()\n  GROUP BY a.patient_id\n),\n\n-- Categorize ALL patients in age range\ncategorized AS (\n  SELECT\n    sd.segment_id,\n    sd.segment_name,\n    sd.amount,\n    sd.compliance_period,\n    sd.past_due_period,\n    piar.patient_id,\n    piar.f_name,\n    piar.l_name,\n    piar.source_id,\n    piar.phone_text,\n    piar.birthdate,\n    piar.office_id,\n    piar.office_name,\n    COALESCE(pcp.cpt_codes, &#39;&#39;) AS cpt_codes,\n    pcp.earliest_purchase_date,\n    pla.last_visit,\n    fa.appt_at AS future_appt,\n    CASE\n      WHEN pla.last_visit IS NOT NULL\n        AND pla.last_visit &gt;= (CURRENT_DATE - (INTERVAL &#39;1 month&#39; * sd.compliance_period))\n        THEN &#39;compliant&#39;\n      WHEN pla.last_visit IS NOT NULL\n        AND pla.last_visit &gt;= (CURRENT_DATE - (INTERVAL &#39;1 month&#39; * sd.past_due_period))\n        AND pla.last_visit &lt; (CURRENT_DATE - (INTERVAL &#39;1 month&#39; * sd.compliance_period))\n        THEN &#39;eligible&#39;\n      ELSE &#39;past_due&#39;\n    END AS category\n  FROM patients_in_age_range piar\n  CROSS JOIN segment_details sd\n  LEFT JOIN patient_cpt_purchases pcp ON pcp.patient_id = piar.patient_id\n  LEFT JOIN patient_last_appointments pla ON pla.patient_id = piar.patient_id\n  LEFT JOIN future_appointments fa ON fa.patient_id = piar.patient_id\n)\n\nSELECT\n  *\nFROM categorized c\nWHERE c.category = &#39;#{category}&#39;\nORDER BY f_name, l_name;\n&quot;)</span></span><table id='context158' class='context' style='display:none'><caption>app/services/patient_segment_service.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>1088</pre>
          </td>
          <td class='context'>
            <pre class='context'>      FROM categorized c</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1089</pre>
            </td>
            <td class='context'>
              <pre class='context'>      WHERE c.category = &#39;#{category}&#39;</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1090</pre>
            </td>
            <td class='context'>
              <pre class='context'>      ORDER BY f_name, l_name;</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1091</pre>
            </td>
            <td class='context'>
              <pre class='context'>    SQL</pre>
            </td>
          </tr>
          <tr class='context error'>
            <td class='context_line'>
              <pre class='context'>1093</pre>
            </td>
            <td class='context'>
              <pre class='context'>    ActiveRecord::Base.connection.exec_query(sql)</pre>
            </td>
          </tr>
          <tr class='context alt near_error'>
            <td class='context_line'>
              <pre class='context'>1094</pre>
            </td>
            <td class='context'>
              <pre class='context'>  end</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1096</pre>
            </td>
            <td class='context'>
              <pre class='context'>  def self.dx_segment_patients_by_category_for_month(segment_id, category, month, office_ids = [])</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1097</pre>
            </td>
            <td class='context'>
              <pre class='context'>    # Parse the month parameter (expected format: &#39;YYYY-MM&#39;)</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1098</pre>
            </td>
            <td class='context'>
              <pre class='context'>    month_start = Date.parse(&quot;#{month}-01&quot;)</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>PatientSegmentService</td>
      <td>s(:self).dx_segment_patients_by_category_for_month</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context159');toggle('message159');toggle('full_message159')" ><span id='message159' style='display:block'>Possible SQL injection near line 1281: ...</span><span id='full_message159' style='display:none'>Possible SQL injection near line 1281: <span class="code">ActiveRecord::Base.connection.exec_query(&quot;WITH RECURSIVE\n-- Get segment filters (age ranges)\nsegment_age_filters AS (\n  SELECT\n    sf.disease_segment_id AS segment_id,\n    sf.filter_min::integer AS age_min,\n    CASE WHEN sf.filter_max IS NOT NULL AND sf.filter_max != &#39;&#39;\n        THEN sf.filter_max::integer\n        ELSE NULL\n    END AS age_max\n  FROM segment_filters sf\n  WHERE sf.disease_segment_id = #{<span class="user_input">segment_id</span>}\n    AND sf.filter_type = &#39;age&#39;\n),\n\n-- Pre-split dx codes once\nsegment_dx_codes AS (\n  SELECT\n    ds.id AS segment_id,\n    ds.name AS segment_name,\n    ds.amount,\n    ds.compliance_period,\n    ds.past_due_period,\n    trim(dx_code) AS dx_code\n  FROM disease_segments ds\n  CROSS JOIN LATERAL regexp_split_to_table(ds.dx_codes, &#39;,&#39;) AS dx_code\n  WHERE ds.id IN (#{<span class="user_input">segment_id</span>})\n    AND ds.dx_codes IS NOT NULL\n    AND ds.dx_codes != &#39;&#39;\n),\n\n-- Get all matching patients with age filtering\nsegment_patients AS (\n  SELECT DISTINCT\n    sdc.segment_id,\n    sdc.segment_name,\n    sdc.amount,\n    sdc.compliance_period,\n    sdc.past_due_period,\n    p.id AS patient_id,\n    MIN(pdx.date_onset_sypmt) AS dx_onset_sypmt,\n    array_agg(DISTINCT pdx.id) AS patient_dx_code_ids\n  FROM segment_dx_codes sdc\n  JOIN patient_dx_codes pdx ON pdx.dx_code LIKE sdc.dx_code || &#39;%&#39;\n  JOIN mv_patients p ON p.id = pdx.patient_id\n  LEFT JOIN segment_age_filters saf ON saf.segment_id = sdc.segment_id\n  WHERE 1=1\n    #{office_ids.any? ? (&quot;AND p.office_id IN (#{office_ids.join(&quot;,&quot;)})&quot;) : (&quot;&quot;)}\n    -- Apply age filter if exists for this segment\n    AND (\n      saf.segment_id IS NULL  -- No age filter for this segment\n      OR (\n        EXTRACT(YEAR FROM AGE(CURRENT_DATE, p.birthdate))::integer &gt;= saf.age_min\n        AND (\n          saf.age_max IS NULL\n          OR EXTRACT(YEAR FROM AGE(CURRENT_DATE, p.birthdate))::integer &lt;= saf.age_max\n        )\n      )\n    )\n  GROUP BY sdc.segment_id, sdc.segment_name, sdc.amount, sdc.compliance_period, sdc.past_due_period, p.id\n),\n\n-- Filter patients by diagnosis date (matching trend query)\nfiltered_patients AS (\n  SELECT *\n  FROM segment_patients\n  WHERE dx_onset_sypmt IS NULL OR dx_onset_sypmt &lt;= &#39;#{(Date.today or Date.parse(&quot;#{month}-01&quot;).end_of_month)}&#39;\n),\n\n-- Get patient details\npatient_details AS (\n  SELECT\n    fp.segment_id,\n    fp.segment_name,\n    fp.amount,\n    fp.compliance_period,\n    fp.past_due_period,\n    fp.patient_id,\n    p.f_name,\n    p.l_name,\n    p.source_id,\n    p.phone_text,\n    p.birthdate,\n    o.id AS office_id,\n    o.name AS office_name,\n    fp.dx_onset_sypmt AS earliest_diagnosis_date,\n    fp.patient_dx_code_ids,\n    string_agg(DISTINCT pdx.dx_code, &#39;, &#39; ORDER BY pdx.dx_code) AS dx_codes\n  FROM filtered_patients fp\n  JOIN mv_patients p ON p.id = fp.patient_id\n  JOIN offices o ON o.id = p.office_id\n  CROSS JOIN LATERAL unnest(fp.patient_dx_code_ids) AS pdx_id\n  JOIN patient_dx_codes pdx ON pdx.id = pdx_id\n  GROUP BY\n    fp.segment_id, fp.segment_name, fp.amount,\n    fp.compliance_period, fp.past_due_period,\n    fp.patient_id, p.f_name, p.l_name, p.source_id, p.phone_text,\n    p.birthdate, o.id, o.name, fp.dx_onset_sypmt, fp.patient_dx_code_ids\n),\n\n-- Get ALL appointments for segment patients (matching trend query)\npatient_appointments AS (\n  SELECT\n    fp.patient_id,\n    a.appt_at\n  FROM filtered_patients fp\n  JOIN appointment_patient_dx_codes apdx ON apdx.patient_dx_codes_id = ANY(fp.patient_dx_code_ids)\n  JOIN appointments a ON a.id = apdx.appointment_id AND a.patient_id = fp.patient_id\n),\n\n-- Get last visit for each patient up to reference date\npatient_last_visit AS (\n  SELECT\n    patient_id,\n    MAX(appt_at) AS last_visit\n  FROM patient_appointments\n  WHERE appt_at &lt;= &#39;#{(Date.today or Date.parse(&quot;#{month}-01&quot;).end_of_month)}&#39;\n  GROUP BY patient_id\n),\n\n-- Get future appointments\nfuture_appointments AS (\n  SELECT\n    a.patient_id,\n    MIN(a.appt_at) AS appt_at\n  FROM appointments a\n  WHERE a.category IN (&#39;Confirmed&#39;, &#39;Not Confirmed&#39;)\n    AND a.appt_at &gt; now()\n  GROUP BY a.patient_id\n),\n\n-- Categorize patients for the specific month (matching trend query logic)\ncategorized AS (\n  SELECT\n    pd.segment_id,\n    pd.segment_name,\n    pd.amount,\n    pd.compliance_period,\n    pd.past_due_period,\n    pd.patient_id,\n    pd.f_name,\n    pd.l_name,\n    pd.source_id,\n    pd.phone_text,\n    pd.birthdate,\n    pd.office_id,\n    pd.office_name,\n    pd.dx_codes,\n    pd.earliest_diagnosis_date,\n    plv.last_visit,\n    fa.appt_at AS future_appt,\n    CASE\n      WHEN plv.last_visit IS NOT NULL\n        AND plv.last_visit &gt;= (&#39;#{(Date.today or Date.parse(&quot;#{month}-01&quot;).end_of_month)}&#39;::date - (INTERVAL &#39;1 month&#39; * pd.compliance_period))\n        THEN &#39;compliant&#39;\n      WHEN plv.last_visit IS NOT NULL\n        AND plv.last_visit &gt;= (&#39;#{(Date.today or Date.parse(&quot;#{month}-01&quot;).end_of_month)}&#39;::date - (INTERVAL &#39;1 month&#39; * pd.past_due_period))\n        AND plv.last_visit &lt; (&#39;#{(Date.today or Date.parse(&quot;#{month}-01&quot;).end_of_month)}&#39;::date - (INTERVAL &#39;1 month&#39; * pd.compliance_period))\n        THEN &#39;eligible&#39;\n      ELSE &#39;past_due&#39;\n    END AS category\n  FROM patient_details pd\n  LEFT JOIN patient_last_visit plv ON plv.patient_id = pd.patient_id\n  LEFT JOIN future_appointments fa ON fa.patient_id = pd.patient_id\n)\n\nSELECT\n  *\nFROM categorized c\nWHERE c.category = &#39;#{category}&#39;\nORDER BY f_name, l_name;\n&quot;)</span></span><table id='context159' class='context' style='display:none'><caption>app/services/patient_segment_service.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>1276</pre>
          </td>
          <td class='context'>
            <pre class='context'>      FROM categorized c</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1277</pre>
            </td>
            <td class='context'>
              <pre class='context'>      WHERE c.category = &#39;#{category}&#39;</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1278</pre>
            </td>
            <td class='context'>
              <pre class='context'>      ORDER BY f_name, l_name;</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1279</pre>
            </td>
            <td class='context'>
              <pre class='context'>    SQL</pre>
            </td>
          </tr>
          <tr class='context error'>
            <td class='context_line'>
              <pre class='context'>1281</pre>
            </td>
            <td class='context'>
              <pre class='context'>    ActiveRecord::Base.connection.exec_query(sql)</pre>
            </td>
          </tr>
          <tr class='context alt near_error'>
            <td class='context_line'>
              <pre class='context'>1282</pre>
            </td>
            <td class='context'>
              <pre class='context'>  end</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1284</pre>
            </td>
            <td class='context'>
              <pre class='context'>  def self.cpt_segment_patients_by_category_for_month(segment_id, category, month, office_ids = [])</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1285</pre>
            </td>
            <td class='context'>
              <pre class='context'>    # Parse the month parameter (expected format: &#39;YYYY-MM&#39;)</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1286</pre>
            </td>
            <td class='context'>
              <pre class='context'>    month_start = Date.parse(&quot;#{month}-01&quot;)</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='med-confidence'>Medium</span></td>
      <td>PatientSegmentService</td>
      <td>s(:self).cpt_segment_patients_by_category_for_month</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context160');toggle('message160');toggle('full_message160')" ><span id='message160' style='display:block'>Possible SQL injection near line 1467: ...</span><span id='full_message160' style='display:none'>Possible SQL injection near line 1467: <span class="code">ActiveRecord::Base.connection.exec_query(&quot;WITH RECURSIVE\n-- Get segment age filters\nsegment_age_filters AS (\n  SELECT\n    sf.disease_segment_id AS segment_id,\n    sf.filter_min::integer AS age_min,\n    sf.filter_max::integer AS age_max\n  FROM segment_filters sf\n  WHERE sf.disease_segment_id = #{<span class="user_input">segment_id</span>}\n    AND sf.filter_type = &#39;age&#39;\n),\n\n-- Get all patients for the office(s) with age calculation\nall_office_patients AS (\n  SELECT DISTINCT\n    p.id AS patient_id,\n    p.f_name,\n    p.l_name,\n    p.source_id,\n    p.phone_text,\n    p.birthdate,\n    p.created_at,\n    p.office_id,\n    o.name AS office_name,\n    EXTRACT(YEAR FROM AGE(&#39;#{(Date.today or Date.parse(&quot;#{month}-01&quot;).end_of_month)}&#39;::date, p.birthdate))::integer AS patient_age\n  FROM mv_patients p\n  JOIN offices o ON o.id = p.office_id\n  WHERE 1=1\n    #{office_ids.any? ? (&quot;AND p.office_id IN (#{office_ids.join(&quot;,&quot;)})&quot;) : (&quot;&quot;)}\n    AND p.birthdate IS NOT NULL\n    AND p.created_at &lt;= &#39;#{(Date.today or Date.parse(&quot;#{month}-01&quot;).end_of_month)}&#39;\n),\n\n-- Pre-split CPT codes once\nsegment_cpt_codes AS (\n  SELECT\n    ds.id AS segment_id,\n    ds.name AS segment_name,\n    ds.amount,\n    ds.compliance_period,\n    ds.past_due_period,\n    trim(cpt_code) AS cpt_code\n  FROM disease_segments ds\n  CROSS JOIN LATERAL regexp_split_to_table(ds.cpt_codes, &#39;,&#39;) AS cpt_code\n  WHERE ds.id = #{<span class="user_input">segment_id</span>}\n    AND ds.cpt_codes IS NOT NULL\n    AND ds.cpt_codes != &#39;&#39;\n),\n\n-- Get segment details\nsegment_details AS (\n  SELECT DISTINCT\n    segment_id,\n    segment_name,\n    amount,\n    compliance_period,\n    past_due_period\n  FROM segment_cpt_codes\n  LIMIT 1\n),\n\n-- Filter patients by age criteria\npatients_in_age_range AS (\n  SELECT\n    aop.patient_id,\n    aop.f_name,\n    aop.l_name,\n    aop.source_id,\n    aop.phone_text,\n    aop.birthdate,\n    aop.created_at,\n    aop.office_id,\n    aop.office_name,\n    aop.patient_age\n  FROM all_office_patients aop\n  LEFT JOIN segment_age_filters saf ON saf.segment_id = #{<span class="user_input">segment_id</span>}\n  WHERE (\n    saf.segment_id IS NULL  -- No age filter for this segment\n    OR (\n      aop.patient_age &gt;= saf.age_min\n      AND (\n        saf.age_max IS NULL\n        OR aop.patient_age &lt;= saf.age_max\n      )\n    )\n  )\n),\n\n-- Get CPT purchases for patients in age range\npatient_cpt_purchases AS (\n  SELECT\n    piar.patient_id,\n    MIN(pur.purchased_at) AS first_purchase_date,\n    array_agg(DISTINCT pur.id) AS purchase_ids,\n    string_agg(DISTINCT pur.fields-&gt;&gt;&#39;cpt4_code_id&#39;, &#39;, &#39; ORDER BY pur.fields-&gt;&gt;&#39;cpt4_code_id&#39;) AS cpt_codes\n  FROM patients_in_age_range piar\n  CROSS JOIN segment_cpt_codes scc\n  LEFT JOIN purchases pur ON pur.fields-&gt;&gt;&#39;cpt4_code_id&#39; = scc.cpt_code\n    AND pur.patient_id = piar.patient_id\n  WHERE pur.id IS NOT NULL\n  GROUP BY piar.patient_id\n),\n\n-- Get last visit for each patient up to reference date\npatient_last_visit AS (\n  SELECT\n    pcp.patient_id,\n    MAX(a.appt_at) AS last_visit\n  FROM patient_cpt_purchases pcp\n  CROSS JOIN LATERAL unnest(pcp.purchase_ids) AS pur_id\n  JOIN purchases pur ON pur.id = pur_id\n  JOIN appointments a ON a.id = pur.appointment_id\n  WHERE a.appt_at &lt;= &#39;#{(Date.today or Date.parse(&quot;#{month}-01&quot;).end_of_month)}&#39;\n  GROUP BY pcp.patient_id\n),\n\n-- Get future appointments\nfuture_appointments AS (\n  SELECT\n    a.patient_id,\n    MIN(a.appt_at) AS appt_at\n  FROM appointments a\n  WHERE a.category IN (&#39;Confirmed&#39;, &#39;Not Confirmed&#39;)\n    AND a.appt_at &gt; now()\n  GROUP BY a.patient_id\n),\n\n-- Categorize ALL patients in age range for the specific month\ncategorized AS (\n  SELECT\n    sd.segment_id,\n    sd.segment_name,\n    sd.amount,\n    sd.compliance_period,\n    sd.past_due_period,\n    piar.patient_id,\n    piar.f_name,\n    piar.l_name,\n    piar.source_id,\n    piar.phone_text,\n    piar.birthdate,\n    piar.office_id,\n    piar.office_name,\n    COALESCE(pcp.cpt_codes, &#39;&#39;) AS cpt_codes,\n    pcp.first_purchase_date AS earliest_purchase_date,\n    plv.last_visit,\n    fa.appt_at AS future_appt,\n    CASE\n      WHEN plv.last_visit IS NOT NULL\n        AND plv.last_visit &gt;= (&#39;#{(Date.today or Date.parse(&quot;#{month}-01&quot;).end_of_month)}&#39;::date - (INTERVAL &#39;1 month&#39; * sd.compliance_period))\n        THEN &#39;compliant&#39;\n      WHEN plv.last_visit IS NOT NULL\n        AND plv.last_visit &gt;= (&#39;#{(Date.today or Date.parse(&quot;#{month}-01&quot;).end_of_month)}&#39;::date - (INTERVAL &#39;1 month&#39; * sd.past_due_period))\n        AND plv.last_visit &lt; (&#39;#{(Date.today or Date.parse(&quot;#{month}-01&quot;).end_of_month)}&#39;::date - (INTERVAL &#39;1 month&#39; * sd.compliance_period))\n        THEN &#39;eligible&#39;\n      ELSE &#39;past_due&#39;\n    END AS category\n  FROM patients_in_age_range piar\n  CROSS JOIN segment_details sd\n  LEFT JOIN patient_cpt_purchases pcp ON pcp.patient_id = piar.patient_id\n  LEFT JOIN patient_last_visit plv ON plv.patient_id = piar.patient_id\n  LEFT JOIN future_appointments fa ON fa.patient_id = piar.patient_id\n)\n\nSELECT\n  *\nFROM categorized c\nWHERE c.category = &#39;#{category}&#39;\nORDER BY f_name, l_name;\n&quot;)</span></span><table id='context160' class='context' style='display:none'><caption>app/services/patient_segment_service.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>1462</pre>
          </td>
          <td class='context'>
            <pre class='context'>      FROM categorized c</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1463</pre>
            </td>
            <td class='context'>
              <pre class='context'>      WHERE c.category = &#39;#{category}&#39;</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1464</pre>
            </td>
            <td class='context'>
              <pre class='context'>      ORDER BY f_name, l_name;</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1465</pre>
            </td>
            <td class='context'>
              <pre class='context'>    SQL</pre>
            </td>
          </tr>
          <tr class='context error'>
            <td class='context_line'>
              <pre class='context'>1467</pre>
            </td>
            <td class='context'>
              <pre class='context'>    ActiveRecord::Base.connection.exec_query(sql)</pre>
            </td>
          </tr>
          <tr class='context alt near_error'>
            <td class='context_line'>
              <pre class='context'>1468</pre>
            </td>
            <td class='context'>
              <pre class='context'>  end</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>1470</pre>
            </td>
            <td class='context'>
              <pre class='context'>  private</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>1472</pre>
            </td>
            <td class='context'>
              <pre class='context'>  def self.regex_patterns(dx_codes_string)</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='weak-confidence'>Weak</span></td>
      <td>Api::OfficeController</td>
      <td>map_features</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/dangerous_eval/">Dangerous Eval</a></td>
      <td>[913, 95]</td>
      <td><div class='warning_message' onClick="toggle('context5');toggle('message5');toggle('full_message5')" >Dynamic code evaluation near line 220: <span class="code">eval((o.lon or 0).round(4).to_s)</span><table id='context5' class='context' style='display:none'><caption>app/controllers/api/office_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>215</pre>
          </td>
          <td class='context'>
            <pre class='context'>						end</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>216</pre>
            </td>
            <td class='context'>
              <pre class='context'>					end</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>217</pre>
            </td>
            <td class='context'>
              <pre class='context'>				end</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>218</pre>
            </td>
            <td class='context'>
              <pre class='context'>				lat = o.lat.present? ? o.lat : 0</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>219</pre>
            </td>
            <td class='context'>
              <pre class='context'>				lon = o.lon.present? ? o.lon : 0</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>220</pre>
            </td>
            <td class='context'>
              <pre class='context'>				mf[:offices][:features] &lt;&lt; {type: &quot;Feature&quot;, properties: {type: &quot;office&quot;, id: o.id, region_id: o.region_id, name: o.name, address: &quot;#{o.street1}#{o.street2.blank? ? &#39;&#39; : &#39; &#39; + o.street2}, #{o.city}, #{o.state} #{o.zip}&quot;, phone: o.phone, lat: lat.round(4), lon: lon.round(4), rank: ok == 0 ? &#39;None&#39; : ok }, geometry: {type: &quot;Point&quot;, coordinates: [eval(lon.round(4).to_s), eval(lat.round(4).to_s)]}}</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>221</pre>
            </td>
            <td class='context'>
              <pre class='context'>				oc = o.office_crs</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>222</pre>
            </td>
            <td class='context'>
              <pre class='context'>				zm = oc.map { |z| &quot;&#39;#{z.zip.to_s.rjust(5, &quot;0&quot;)}&#39;&quot; }.join &#39;,&#39;</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>223</pre>
            </td>
            <td class='context'>
              <pre class='context'>				# any zips or carrier routes that have a priority of 9 (do not mail) should be shown in a different color</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>224</pre>
            </td>
            <td class='context'>
              <pre class='context'>				unless zm.blank?</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>225</pre>
            </td>
            <td class='context'>
              <pre class='context'>					az &lt;&lt; zm</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='weak-confidence'>Weak</span></td>
      <td>Api::OfficeController</td>
      <td>map_features</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/dangerous_eval/">Dangerous Eval</a></td>
      <td>[913, 95]</td>
      <td><div class='warning_message' onClick="toggle('context6');toggle('message6');toggle('full_message6')" >Dynamic code evaluation near line 232: <span class="code">eval(small_geom(z.geom))</span><table id='context6' class='context' style='display:none'><caption>app/controllers/api/office_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>227</pre>
          </td>
          <td class='context'>
            <pre class='context'>					bd = ZipBoundary.find_by_sql(&lt;&lt;~SQL)</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>228</pre>
            </td>
            <td class='context'>
              <pre class='context'>						select zip, lat, lon, ST_AsGeoJSON(ST_Simplify(geom, 0.001)) geom </pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>229</pre>
            </td>
            <td class='context'>
              <pre class='context'>						from zip_boundaries </pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>230</pre>
            </td>
            <td class='context'>
              <pre class='context'>						where zip in (#{zm});</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>231</pre>
            </td>
            <td class='context'>
              <pre class='context'>						SQL</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>232</pre>
            </td>
            <td class='context'>
              <pre class='context'>					bd.each { |z| mf[:zips][:features] &lt;&lt; {type: &quot;Feature&quot;, properties: {type: &quot;zip&quot;, zip: z.zip, o_clr: o.color, f_clr: (zr[z.zip.to_i] == 9 ? 6 : o.color), lat: z.lat.round(4), lon: z.lon.round(4), o_id: o.id }, geometry: eval(small_geom(z.geom))} if z.geom }</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>233</pre>
            </td>
            <td class='context'>
              <pre class='context'>				end</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>234</pre>
            </td>
            <td class='context'>
              <pre class='context'>				unless overload</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>235</pre>
            </td>
            <td class='context'>
              <pre class='context'>					cm = oc.map { |z| z.cr.blank? ? nil : &quot;&#39;#{z.cr}&#39;&quot; }.compact.join &#39;,&#39;</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>236</pre>
            </td>
            <td class='context'>
              <pre class='context'>					unless cm.blank?</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>237</pre>
            </td>
            <td class='context'>
              <pre class='context'>						pr = Hash[oc.pluck(:cr, :priority)]</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='weak-confidence'>Weak</span></td>
      <td>Api::OfficeController</td>
      <td>map_features</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/dangerous_eval/">Dangerous Eval</a></td>
      <td>[913, 95]</td>
      <td><div class='warning_message' onClick="toggle('context7');toggle('message7');toggle('full_message7')" >Dynamic code evaluation near line 243: <span class="code">eval(small_geom(cr.geom))</span><table id='context7' class='context' style='display:none'><caption>app/controllers/api/office_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>238</pre>
          </td>
          <td class='context'>
            <pre class='context'>						bd = CrBoundary.find_by_sql(&lt;&lt;~SQL)</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>239</pre>
            </td>
            <td class='context'>
              <pre class='context'>							select zipcrid, lat, lon, ST_AsGeoJSON(ST_Simplify(geom, 0.0004)) geom </pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>240</pre>
            </td>
            <td class='context'>
              <pre class='context'>							from cr_boundaries </pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>241</pre>
            </td>
            <td class='context'>
              <pre class='context'>							where zipcrid in (#{cm});</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>242</pre>
            </td>
            <td class='context'>
              <pre class='context'>							SQL</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>243</pre>
            </td>
            <td class='context'>
              <pre class='context'>						bd.each { |cr| mf[:crs][:features] &lt;&lt; {type: &quot;Feature&quot;, properties: {type: &quot;cr&quot;, cr: cr.zipcrid, o_clr: o.color, f_clr: (pr[cr.zipcrid] == 9 ? 6 : o.color), lat: cr.lat.round(4), lon: cr.lon.round(4), o_id: o.id }, geometry: eval(small_geom(cr.geom))} if cr.geom }</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>244</pre>
            </td>
            <td class='context'>
              <pre class='context'>					end</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>245</pre>
            </td>
            <td class='context'>
              <pre class='context'>				end</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>246</pre>
            </td>
            <td class='context'>
              <pre class='context'>			end</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>247</pre>
            </td>
            <td class='context'>
              <pre class='context'>			unless overload</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>248</pre>
            </td>
            <td class='context'>
              <pre class='context'>				# get 50 zips per office with a centroid within a 50 mile radius and not in the office footprint (80467 = 50 miles, 64374 = 40 miles, 48280 = 30 miles, 16093 = 10 miles)</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='weak-confidence'>Weak</span></td>
      <td>Api::OfficeController</td>
      <td>map_features</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/dangerous_eval/">Dangerous Eval</a></td>
      <td>[913, 95]</td>
      <td><div class='warning_message' onClick="toggle('context8');toggle('message8');toggle('full_message8')" >Dynamic code evaluation near line 266: <span class="code">eval(small_geom(z.geom))</span><table id='context8' class='context' style='display:none'><caption>app/controllers/api/office_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>261</pre>
          </td>
          <td class='context'>
            <pre class='context'>						order by zb.zip, dist) sq </pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>262</pre>
            </td>
            <td class='context'>
              <pre class='context'>					where geom is not null </pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>263</pre>
            </td>
            <td class='context'>
              <pre class='context'>					order by dist </pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>264</pre>
            </td>
            <td class='context'>
              <pre class='context'>					limit #{fc.length * 50};</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>265</pre>
            </td>
            <td class='context'>
              <pre class='context'>					SQL</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>266</pre>
            </td>
            <td class='context'>
              <pre class='context'>				bd.each { |z| mf[:other_zips][:features] &lt;&lt; {type: &quot;Feature&quot;, properties: {type: &quot;zip&quot;, zip: z.zip, o_clr: z.color, f_clr: 7, lat: z.lat.round(4), lon: z.lon.round(4), o_id: z.office_id, own: z.owner}, geometry: eval(small_geom(z.geom))}}</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>267</pre>
            </td>
            <td class='context'>
              <pre class='context'>				# add 500 carrier route features by zip within the same radius to the results</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>268</pre>
            </td>
            <td class='context'>
              <pre class='context'>				cl = client.preferences.find_by_key(:uses_cr).value rescue nil</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>269</pre>
            </td>
            <td class='context'>
              <pre class='context'>				if cl == &quot;true&quot;</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>270</pre>
            </td>
            <td class='context'>
              <pre class='context'>					zc = {}</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>271</pre>
            </td>
            <td class='context'>
              <pre class='context'>					bd = CrBoundary.find_by_sql(&lt;&lt;~SQL)</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='weak-confidence'>Weak</span></td>
      <td>Api::OfficeController</td>
      <td>map_features</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/dangerous_eval/">Dangerous Eval</a></td>
      <td>[913, 95]</td>
      <td><div class='warning_message' onClick="toggle('context9');toggle('message9');toggle('full_message9')" >Dynamic code evaluation near line 284: <span class="code">eval(small_geom(cr.geom))</span><table id='context9' class='context' style='display:none'><caption>app/controllers/api/office_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>279</pre>
          </td>
          <td class='context'>
            <pre class='context'>						order by dist </pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>280</pre>
            </td>
            <td class='context'>
              <pre class='context'>						limit #{fc.length * 500};</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>281</pre>
            </td>
            <td class='context'>
              <pre class='context'>						SQL</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>282</pre>
            </td>
            <td class='context'>
              <pre class='context'>					bd.each do |cr| </pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>283</pre>
            </td>
            <td class='context'>
              <pre class='context'>						zc[cr.zip] = [] unless zc.has_key?(cr.zip)</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>284</pre>
            </td>
            <td class='context'>
              <pre class='context'>						zc[cr.zip] &lt;&lt; {type: &quot;Feature&quot;, properties: {type: &quot;cr&quot;, cr: cr.zipcrid, o_clr: o.color, f_clr: o.color, lat: cr.lat.round(4), lon: cr.lon.round(4), o_id: cr.office_id }, geometry: eval(small_geom(cr.geom))}</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>285</pre>
            </td>
            <td class='context'>
              <pre class='context'>					end</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>286</pre>
            </td>
            <td class='context'>
              <pre class='context'>					mf[:other_crs] = zc</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>287</pre>
            </td>
            <td class='context'>
              <pre class='context'>				end</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>288</pre>
            </td>
            <td class='context'>
              <pre class='context'>			end</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>289</pre>
            </td>
            <td class='context'>
              <pre class='context'>			# show customers and prospects on the office map (customers = green, prospects = blue)</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='weak-confidence'>Weak</span></td>
      <td>Api::OfficeController</td>
      <td>map_features</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/dangerous_eval/">Dangerous Eval</a></td>
      <td>[913, 95]</td>
      <td><div class='warning_message' onClick="toggle('context10');toggle('message10');toggle('full_message10')" >Dynamic code evaluation near line 296: <span class="code">eval(g.lon.round(4).to_s)</span><table id='context10' class='context' style='display:none'><caption>app/controllers/api/office_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>291</pre>
          </td>
          <td class='context'>
            <pre class='context'>				select g.lat, g.lon, o.color </pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>292</pre>
            </td>
            <td class='context'>
              <pre class='context'>				from customers c </pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>293</pre>
            </td>
            <td class='context'>
              <pre class='context'>				join geographics g on g.individual_id = c.individual_id </pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>294</pre>
            </td>
            <td class='context'>
              <pre class='context'>				join offices o on o.id = c.office_id where o.client_id = #{client.id} and g.lat != 0 and g.lon != 0 and c.office_id in (#{fc.map(&amp;:id).join(&#39;,&#39;)});</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>295</pre>
            </td>
            <td class='context'>
              <pre class='context'>				SQL</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>296</pre>
            </td>
            <td class='context'>
              <pre class='context'>			cg.each { |g| mf[:customers][:features] &lt;&lt; {type: &quot;Feature&quot;, properties: {clr: g.color}, geometry: {type: &quot;Point&quot;, coordinates: [eval(g.lon.round(4).to_s), eval(g.lat.round(4).to_s)]}}}</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>297</pre>
            </td>
            <td class='context'>
              <pre class='context'>			pg = Geographic.find_by_sql(&lt;&lt;~SQL)</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>298</pre>
            </td>
            <td class='context'>
              <pre class='context'>				select g.lat, g.lon, o.color </pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>299</pre>
            </td>
            <td class='context'>
              <pre class='context'>				from prospects p </pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>300</pre>
            </td>
            <td class='context'>
              <pre class='context'>				join geographics g on g.individual_id = p.individual_id </pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>301</pre>
            </td>
            <td class='context'>
              <pre class='context'>				join offices o on o.id = p.office_id where o.client_id = #{client.id} and g.lat != 0 and g.lon != 0 and p.office_id in (#{fc.map(&amp;:id).join(&#39;,&#39;)});</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='weak-confidence'>Weak</span></td>
      <td>Api::OfficeController</td>
      <td>map_features</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/dangerous_eval/">Dangerous Eval</a></td>
      <td>[913, 95]</td>
      <td><div class='warning_message' onClick="toggle('context11');toggle('message11');toggle('full_message11')" >Dynamic code evaluation near line 303: <span class="code">eval(g.lon.round(4).to_s)</span><table id='context11' class='context' style='display:none'><caption>app/controllers/api/office_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>298</pre>
          </td>
          <td class='context'>
            <pre class='context'>				select g.lat, g.lon, o.color </pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>299</pre>
            </td>
            <td class='context'>
              <pre class='context'>				from prospects p </pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>300</pre>
            </td>
            <td class='context'>
              <pre class='context'>				join geographics g on g.individual_id = p.individual_id </pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>301</pre>
            </td>
            <td class='context'>
              <pre class='context'>				join offices o on o.id = p.office_id where o.client_id = #{client.id} and g.lat != 0 and g.lon != 0 and p.office_id in (#{fc.map(&amp;:id).join(&#39;,&#39;)});</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>302</pre>
            </td>
            <td class='context'>
              <pre class='context'>				SQL</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>303</pre>
            </td>
            <td class='context'>
              <pre class='context'>			pg.each { |g| mf[:prospects][:features] &lt;&lt; {type: &quot;Feature&quot;, properties: {clr: g.color}, geometry: {type: &quot;Point&quot;, coordinates: [eval(g.lon.round(4).to_s), eval(g.lat.round(4).to_s)]}}}</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>304</pre>
            </td>
            <td class='context'>
              <pre class='context'>			# add lead counts to the results</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>305</pre>
            </td>
            <td class='context'>
              <pre class='context'>			ol = Office.joins(:office_crs =&gt; :cr_geo_counts).where(&quot;offices.id in (#{fcs})&quot;)</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>306</pre>
            </td>
            <td class='context'>
              <pre class='context'>			mf[:leads][:zips] = ol.group(&quot;offices.id, office_crs.zip&quot;).sum(:leads).inject({}) { |h, (k,v)| h[k.to_s.rjust(5, &#39;0&#39;)] = v.to_i; h }</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>307</pre>
            </td>
            <td class='context'>
              <pre class='context'>			mf[:leads][:crs]  = ol.group(&quot;offices.id, office_crs.cr&quot;).sum(:leads).inject({}) { |h, (k,v)| h[k.to_s.rjust(5, &#39;0&#39;)] = v.to_i; h }</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>308</pre>
            </td>
            <td class='context'>
              <pre class='context'>			render :json =&gt; {:status =&gt; &quot;success&quot;, :data =&gt; mf}</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='weak-confidence'>Weak</span></td>
      <td>Api::MediaBuyController</td>
      <td>generate_list_url</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/file_access/">File Access</a></td>
      <td>[22]</td>
      <td><div class='warning_message' onClick="toggle('context15');toggle('message15');toggle('full_message15')" ><span id='message15' style='display:block'>Model attribute used in file name near line 225: ...</span><span id='full_message15' style='display:none'>Model attribute used in file name near line 225: <span class="code">File.delete((generate_pull_file(cid, mid, smr, true, <span class="user_input">Client.find(cid).nickname</span>) or (&quot;log/mb_#{ids.split(&quot;,&quot;).first}_to_#{ids.split(&quot;,&quot;).last}_#{smr ? (&quot;sl&quot;) : (&quot;fl&quot;)}_#{DateTime.now.strftime(&quot;%Y%m%d%H%M%S&quot;)}&quot; + &quot;.zip&quot;)))</span></span><table id='context15' class='context' style='display:none'><caption>app/controllers/api/media_buy_controller.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>220</pre>
          </td>
          <td class='context'>
            <pre class='context'>		# upload the individual file or archive and return the presigned url</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>221</pre>
            </td>
            <td class='context'>
              <pre class='context'>		ky = &quot;#{Rails.env}/#{nn}/#{Time.now.year}/#{fn}&quot;</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>222</pre>
            </td>
            <td class='context'>
              <pre class='context'>		crd = Rails.application.credentials.aws</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>223</pre>
            </td>
            <td class='context'>
              <pre class='context'>		s3 = Aws::S3::Client.new :access_key_id =&gt; crd[:access_key_id], :secret_access_key =&gt; crd[:secret_access_key], :region =&gt; crd[:region]</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>224</pre>
            </td>
            <td class='context'>
              <pre class='context'>		s3.put_object :bucket =&gt; &quot;relevant-names&quot;, :key =&gt; ky, :body =&gt; File.read(&quot;./&quot; + fn), :acl =&gt; &#39;private&#39;, :content_type =&gt; ct</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>225</pre>
            </td>
            <td class='context'>
              <pre class='context'>		File.delete fn</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>226</pre>
            </td>
            <td class='context'>
              <pre class='context'>		ps = Aws::S3::Presigner.new :client =&gt; s3</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>227</pre>
            </td>
            <td class='context'>
              <pre class='context'>		ps.presigned_url :get_object, :bucket =&gt; &quot;relevant-names&quot;, :key =&gt; ky, :expires_in =&gt; 300</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>228</pre>
            </td>
            <td class='context'>
              <pre class='context'>	end</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>230</pre>
            </td>
            <td class='context'>
              <pre class='context'>	def in_process</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='weak-confidence'>Weak</span></td>
      <td>MessageInExtractPusherSerializer</td>
      <td>message_count</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context146');toggle('message146');toggle('full_message146')" ><span id='message146' style='display:block'>Possible SQL injection near line 31: ...</span><span id='full_message146' style='display:none'>Possible SQL injection near line 31: <span class="code">object.office.message_in_extracts.where(&quot;updated_at &gt; &#39;#{<span class="user_input">(Time.current - 15.days)</span>}&#39;or received_at &gt; &#39;#{<span class="user_input">(Time.current - 15.days)</span>}&#39;\n      or viewed_at &gt; &#39;#{<span class="user_input">(Time.current - 15.days)</span>}&#39;&quot;)</span></span><table id='context146' class='context' style='display:none'><caption>app/serializers/message_in_extract_pusher_serializer.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>26</pre>
          </td>
          <td class='context'>
            <pre class='context'>    object.office.name</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>27</pre>
            </td>
            <td class='context'>
              <pre class='context'>  end</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>29</pre>
            </td>
            <td class='context'>
              <pre class='context'>  def message_count</pre>
            </td>
          </tr>
          <tr class='context alt near_error'>
            <td class='context_line'>
              <pre class='context'>30</pre>
            </td>
            <td class='context'>
              <pre class='context'>    message_refresh_time = Time.current - 15.days</pre>
            </td>
          </tr>
          <tr class='context error'>
            <td class='context_line'>
              <pre class='context'>31</pre>
            </td>
            <td class='context'>
              <pre class='context'>    object.office.message_in_extracts.where(&quot;updated_at &gt; &#39;#{message_refresh_time}&#39;or received_at &gt; &#39;#{message_refresh_time}&#39;</pre>
            </td>
          </tr>
          <tr class='context alt near_error'>
            <td class='context_line'>
              <pre class='context'>32</pre>
            </td>
            <td class='context'>
              <pre class='context'>      or viewed_at &gt; &#39;#{message_refresh_time}&#39;&quot;).where(inactive_at: nil).count</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>33</pre>
            </td>
            <td class='context'>
              <pre class='context'>  end</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>35</pre>
            </td>
            <td class='context'>
              <pre class='context'>  def name</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>36</pre>
            </td>
            <td class='context'>
              <pre class='context'>    # return &#39;Unknown Person&#39; if !object.patient || object.patient.name.empty?</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
    <tr>
      <td><span class='weak-confidence'>Weak</span></td>
      <td>MessageInExtractPusherSerializer</td>
      <td>unread_count</td>
      <td><a rel="noreferrer" href="https://brakemanscanner.org/docs/warning_types/sql_injection/">SQL Injection</a></td>
      <td>[89]</td>
      <td><div class='warning_message' onClick="toggle('context147');toggle('message147');toggle('full_message147')" ><span id='message147' style='display:block'>Possible SQL injection near line 107: ...</span><span id='full_message147' style='display:none'>Possible SQL injection near line 107: <span class="code">object.office.message_in_extracts.left_outer_joins(:message_opt_out).joins(&quot;left join mv_patient_phone_name on mv_patient_phone_name.phone = message_in_extracts.from&quot;).where(:message_opt_out =&gt; ({ :id =&gt; nil })).where(&quot;mv_patient_phone_name.id IS NULL or mv_patient_phone_name.office_id = #{object.office.id}&quot;).where(&quot;message_in_extracts.updated_at &gt; &#39;#{<span class="user_input">(Time.current - 15.days)</span>}&#39;or message_in_extracts.received_at &gt; &#39;#{<span class="user_input">(Time.current - 15.days)</span>}&#39;&quot;)</span></span><table id='context147' class='context' style='display:none'><caption>app/serializers/message_in_extract_pusher_serializer.rb</caption>      <thead style='display:none'>
        <tr>
          <th>line number</th>
          <th>line content</th>
        </tr>
      </thead>
      <tbody>
        <tr class='context first'>
          <td class='context_line'>
            <pre class='context'>102</pre>
          </td>
          <td class='context'>
            <pre class='context'>    message_refresh_time = Time.current - 15.days</pre>
          </td>
        </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>103</pre>
            </td>
            <td class='context'>
              <pre class='context'>    # TODO: =&gt; move this to separate object</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>104</pre>
            </td>
            <td class='context'>
              <pre class='context'>    @unread_count ||= object.office.message_in_extracts.left_outer_joins(:message_opt_out)</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>105</pre>
            </td>
            <td class='context'>
              <pre class='context'>                            .joins(&#39;left join mv_patient_phone_name on mv_patient_phone_name.phone = message_in_extracts.from&#39;)</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>106</pre>
            </td>
            <td class='context'>
              <pre class='context'>                            .where(message_opt_out: { id: nil }).where(&quot;mv_patient_phone_name.id IS NULL or mv_patient_phone_name.office_id = #{object.office.id}&quot;)</pre>
            </td>
          </tr>
          <tr class='context alt error'>
            <td class='context_line'>
              <pre class='context'>107</pre>
            </td>
            <td class='context'>
              <pre class='context'>                            .where(&quot;message_in_extracts.updated_at &gt; &#39;#{message_refresh_time}&#39;or message_in_extracts.received_at &gt; &#39;#{message_refresh_time}&#39;&quot;)</pre>
            </td>
          </tr>
          <tr class='context near_error'>
            <td class='context_line'>
              <pre class='context'>108</pre>
            </td>
            <td class='context'>
              <pre class='context'>                            .where(viewed_at: nil, inactive_at: nil).group(:from).count</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>109</pre>
            </td>
            <td class='context'>
              <pre class='context'>  end</pre>
            </td>
          </tr>
          <tr class='context'>
            <td class='context_line'>
              <pre class='context'>111</pre>
            </td>
            <td class='context'>
              <pre class='context'>  def message_out_detail</pre>
            </td>
          </tr>
          <tr class='context alt'>
            <td class='context_line'>
              <pre class='context'>112</pre>
            </td>
            <td class='context'>
              <pre class='context'>    @message_out_detail ||= MessageOutDetail.where(client_id: object.client_id, to: object.from, content_type: &quot;Hipaa&quot;,</pre>
            </td>
          </tr>
</tbody></table></div></td>
    </tr>
  
  </tbody>
</table>
</body></html>